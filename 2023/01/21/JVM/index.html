<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"negativefunction.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="JVM笔记 Chapter1  JVM基础1.1 JVM基础知识Java从代码到执行的过程。通常分为两个部分  第一部分：javac部分将源代码文件通过javac指令生成相对应的class文件 第二部分：java部分 class文件通过classloader加载到内存中，需要相对应的java类库的支持，比如String.class或Object.class。调节字节码解释器或者JIT即时编译器，来">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM">
<meta property="og:url" content="https://negativefunction.github.io/2023/01/21/JVM/index.html">
<meta property="og:site_name" content="Welcome To Lin&#39;s World">
<meta property="og:description" content="JVM笔记 Chapter1  JVM基础1.1 JVM基础知识Java从代码到执行的过程。通常分为两个部分  第一部分：javac部分将源代码文件通过javac指令生成相对应的class文件 第二部分：java部分 class文件通过classloader加载到内存中，需要相对应的java类库的支持，比如String.class或Object.class。调节字节码解释器或者JIT即时编译器，来">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220801140111683.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220801140941306.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220801135651212.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220801212453081.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220802145305626.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220802145053434.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220802150756088.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808154345620.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808154357699.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808155347587.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808155420699.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808155556886.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808161744716.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808161806061.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808163035465.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808163116027.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808163205632.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808163411544.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808164615323.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808164636661.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808164646778.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808165052847.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808165057124.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808165114702.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808165219357.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220808165222723.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220823133047662.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220823135537366.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220823170311194.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220823170356870.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220823175433302.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220823175501748.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824161934127.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824162011519.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171020711.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171045409.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171114736.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171122692.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171129278.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171325350.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171408005.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171414254.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171427554.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171524749.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171545730.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171556147.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171639542.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171717553.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824171726659.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824172342717.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824172401399.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824172410304.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824172414187.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824172436229.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824172439177.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824172445857.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824172453234.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824172458651.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824172515062.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824172750119.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824172821629.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220824175607841.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825164311304.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825164318155.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825164321497.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825164538545.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825164552844.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825164837171.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825164907439.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825164918297.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825164959450.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825165020188.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825165037466.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825165048337.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170104464.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170129198.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170139465.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170148128.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170339346.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170540153.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170620289.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170651668.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170713685.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170723719.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170731638.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170743940.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170759683.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825170809528.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825172307718.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825172929460.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173206235.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173220101.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173307573.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173402512.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173426024.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173519950.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173533264.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173723036.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173730016.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173814511.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173820513.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173834260.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825173950991.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825174547324.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825174555411.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825174603129.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825174609788.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825174811500.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825174836660.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825174857523.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825174908972.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825174927792.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825174943459.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825174953356.png">
<meta property="og:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220825175022928.png">
<meta property="article:published_time" content="2023-01-20T23:18:44.000Z">
<meta property="article:modified_time" content="2023-01-20T23:25:02.198Z">
<meta property="article:author" content="Linyuxuan">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:\Users\%E9%BB%8E%E6%98%8E\AppData\Roaming\Typora\typora-user-images\image-20220801140111683.png">

<link rel="canonical" href="https://negativefunction.github.io/2023/01/21/JVM/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>JVM | Welcome To Lin's World</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Welcome To Lin's World</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">The Future Will Come</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://negativefunction.github.io/2023/01/21/JVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Linyuxuan">
      <meta itemprop="description" content="Hope Sometimes Love Brain">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome To Lin's World">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JVM
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-21 07:18:44 / Modified: 07:25:02" itemprop="dateCreated datePublished" datetime="2023-01-21T07:18:44+08:00">2023-01-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>JVM笔记</p>
<h2 id="Chapter1-JVM基础"><a href="#Chapter1-JVM基础" class="headerlink" title="Chapter1  JVM基础"></a>Chapter1  JVM基础</h2><h3 id="1-1-JVM基础知识"><a href="#1-1-JVM基础知识" class="headerlink" title="1.1 JVM基础知识"></a>1.1 JVM基础知识</h3><p>Java从代码到执行的过程。通常分为两个部分</p>
<ul>
<li>第一部分：javac部分将源代码文件通过javac指令生成相对应的class文件</li>
<li>第二部分：java部分 class文件通过classloader加载到内存中，需要相对应的java类库的支持，比如String.class或Object.class。调节字节码解释器或者JIT即时编译器，来进行解释和编译，编译之后会由执行引擎开始执行，执行引擎对应到操作系统和硬件，这个java指令部分的流程就是</li>
</ul>
<p>注意：<em>有时会将classloader和jaav类库部分划分出来，主要概念相差不多，具体划分也是为了理解</em></p>
<p>字节码和JIT即时编译：<br>本质上解释和编译是可以混合的，针对特别常用的代码，会将代码做成一种即时编译的状态，需要本地支持，在下一次使用时就不需要解释器对代码进行一行一行的解释执行。执行引擎可以将代码直接交到操作系统，使其进行调用。效率会提升很多。当然也不是所有代码都要被JIT即时编译后再执行，java是一门跨平台语言，如果它将所有代码都进行即时编译，那么就违背了它跨平台的特点。</p>
<h3 id="1-2-从跨平台语言"><a href="#1-2-从跨平台语言" class="headerlink" title="1.2 从跨平台语言"></a>1.2 从跨平台语言</h3><ul>
<li>跨平台的语言 —-Java</li>
<li>跨语言的平台 —-JVM</li>
</ul>
<p>JVM是跨语言的平台：JVM上除了执行Java语言，还支持很多其他语言，据调查大约有100多种语言都可以在JVM虚拟机上运行。<br>例如：java scala kotlin groovy clojure 通过Java Virtual Machine 都能对应到各类操作系统 Linux Unix Windows Mac Android</p>
<p><em><strong>JVM本质上是一种规范。JVM的出现帮我们更好的封装了直接对应操作系统的底层，包括Linux Unix Windows这样的系统</strong></em></p>
<p>在JVM上跑的语言需要满足的条件：<em><strong>能够生成class文件</strong></em></p>
<p>任何语言，只要能够生成class文件，则就能在JVM上进行执行：<br>任何语言—&gt;class—&gt;JVM</p>
<p>跨平台的概念：</p>
<p>当我们编写的java程序，在Linux Unix Windows等等操作系统上都可以不用修改其内容，直接执行，即此语言满足跨平台的概念。故而JVM和Java是没有任何关系的</p>
<p><em>JVM是一种规范，定义了java虚拟机能够执行的内容。</em></p>
<p>官网可以查看Java语言的版本规范和JVM的版本规范</p>
<p>虚拟机则是虚拟出来的机器</p>
<h3 id="1-3-常见JVM虚拟机"><a href="#1-3-常见JVM虚拟机" class="headerlink" title="1.3 常见JVM虚拟机"></a>1.3 常见JVM虚拟机</h3><p>Hotspot 是Oracle官方发行的JVM虚拟机，同样是实验使用相对较多的虚拟机。</p>
<p><em>在cmd中通过java -version指令能够看到我们安装的JVM是哪种实现</em></p>
<p>与Hotspot相似的JVM也有很多种：</p>
<ul>
<li>Jrokit –BEA 曾经号称世界上最快的JVM后被Oracle收购。并与Hotspot合并，提高了Hotspot性能。</li>
<li>J9 –IBM</li>
<li>Microsoft VM – Microsoft  IBM和微软都是较大的厂商，不会去依赖Oracle的平台，他们都有自己的平台。由于版本问题，他们都会去独立开发属于自己的平台，只有较大规模的企业才能实现。</li>
<li>TaoBaoVM –淘宝 Hotspot定制版 属于淘宝深度定制版虚拟机 阿里天猫都是使用的这款虚拟机。</li>
<li>LiquidVM 直接针对硬件操作 它本身是没有操作系统的，没有Linux与Unix，故而运行效率会更高。</li>
<li>Azul zing GC 虚拟机回收的业界标杆，使用成本极其昂贵，通常只有银行 电信会使用，平均垃圾回收都在1ms以内。</li>
</ul>
<p><em>通常能写JVM程序的整个阿里大约10人以内 通常需要达到P9 P10 P11的级别水准</em></p>
<p>Oracle在Hotspot8版本以后就不再提供免费升级了，更高级别的版本需要收费，根据企业去进行一定商业行为达到盈利目的。</p>
<p>JKD、JRE、JVM：</p>
<ul>
<li>JVM是本质一种代码规范，根据JVM规范写的代码平台，提供语言跨平台操作的特性<br>虚拟机–用于执行class文件 执行程序</li>
<li>JRE&#x3D;JVM+core lib<br>java程序运行时 除了需要虚拟机以外还需要java的核心代码包，提供java类库进行加载，支持java程序的运行</li>
<li>JDK&#x3D;JRE+development kit<br>java程序的开发工具包 JDK&#x3D;JRE+JVM</li>
</ul>
<h2 id="Chapter2-Class文件结构"><a href="#Chapter2-Class文件结构" class="headerlink" title="Chapter2  Class文件结构"></a>Chapter2  Class文件结构</h2><p>秋招 以及 招聘 中考的较少</p>
<h3 id="2-1-class-file-format"><a href="#2-1-class-file-format" class="headerlink" title="2.1 class file format"></a>2.1 class file format</h3><p>编写一个小测试项目，生成一个class文件，使用idea对class(.out.production.demo01.class)文件进行反编译，观察此生成的.class文件。理论上不论是什么格式的文件avi、doc等 其在内存中的表示都是0101010这样的二进制流</p>
<p>如何去查看classfile：</p>
<ol>
<li>SublimeText去查看.class文件</li>
<li>IDEA插件BinEd去查看</li>
</ol>
<p><em>在file—&gt;Open As Binary…下打开的文件则是以二进制流形式表示</em></p>
<p>由此可以看出classfile本质就是二进制文件的字节流</p>
<p>class文件是一组以8字节为基础单位的二进制字节流，各项数据项目会严格按照顺序紧凑排列在class文件种，中间没有任何分隔符，使得class文件中存储的内容即是全部程序运行的内容。</p>
<h3 id="2-2-class文件结构的解析"><a href="#2-2-class文件结构的解析" class="headerlink" title="2.2 class文件结构的解析"></a>2.2 class文件结构的解析</h3><p>java虚拟机规范规定class文件格式采用类似C语言结构体的伪结构来存储数据，这种结构只有两种数据类型： 无符号数 和 表 。</p>
<ul>
<li>无符号数<br>属于基本数据类型，主要用来描述数字、索引符号、数量值或按照UTF-8编码构成字符串的值<br>数据类型：u1 u2 u4 u8 该数据类型是从逻辑上分类，分别表示1字节 2字节 4字节 8字节</li>
<li>表：是由多个无符号或者其他表作为数据项构成的符合数据类型，所有表都习惯以_info 来结尾。表主要用于描述有层次关系的复合结构数据，比如：方法、字段等，需要注意的是class文件没有分隔符，故而每个二进制数据类型都是严格定义的，具体顺序如下：</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>名称</th>
<th>数量</th>
</tr>
</thead>
<tbody><tr>
<td>u4</td>
<td>magic魔术</td>
<td>1</td>
</tr>
<tr>
<td>u3</td>
<td>minor_version次版本号</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>major_version主版本号</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>constant_pool_count常量个数</td>
<td>1</td>
</tr>
<tr>
<td>cp_info</td>
<td>constant_pool常量池表</td>
<td>constant_pool_count-1</td>
</tr>
<tr>
<td>u2</td>
<td>access_flags类的访问控制权限</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>this_class类名</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>super_class父类名</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>interface_count接口个数</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>interfaces接口名</td>
<td>interfaces_count</td>
</tr>
<tr>
<td>u2</td>
<td>fields_count域个数</td>
<td>1</td>
</tr>
<tr>
<td>field_info</td>
<td>fields域的表</td>
<td>fields_count</td>
</tr>
<tr>
<td>u2</td>
<td>methods_count方法的个数</td>
<td>1</td>
</tr>
<tr>
<td>method_info</td>
<td>methods方法表</td>
<td>methods_count</td>
</tr>
<tr>
<td>u2</td>
<td>attributes_count附加表属性的个数</td>
<td>1</td>
</tr>
<tr>
<td>attribute_info</td>
<td>attributes附加属性的表</td>
<td>attributes_count</td>
</tr>
</tbody></table>
<h4 id="2-2-1-魔数"><a href="#2-2-1-魔数" class="headerlink" title="2.2.1 魔数"></a>2.2.1 魔数</h4><ol>
<li>每个class文件的前4个字节称为魔数magicNumber</li>
<li>魔数唯一作用就是确定这个文件是否为能够被虚拟机接受的class文件</li>
<li>class文件魔数值为0xCAFEBABE，如果文件不是以0xCAFEBABE为开头，则此文件一定不是java的class文件</li>
<li>0xCAFEBABE是class文件的识别魔数</li>
</ol>
<p><em>很多文件存储标准中都使用魔数来进行身份识别，比如 图片格式 .gif .jpeg在文件头部中都存有魔数的使用，使用魔数而不是使用扩展名是基于安全性的考虑，扩展名则是可以随意更改的</em></p>
<h4 id="2-2-2-class文件版本号"><a href="#2-2-2-class文件版本号" class="headerlink" title="2.2.2 class文件版本号"></a>2.2.2 class文件版本号</h4><p>在魔数4个字节后是class文件的版本号，版本号有：</p>
<ul>
<li>次版本号：minor_version 前2个字节用于表示次版本号<br>例如：00 00</li>
<li>主版本号：magic_version 后2个字节用于表示主版本号<br>例如：00 34</li>
</ul>
<p>版本号随着JDK的不同而表示不同的版本范围。Java版本号是从45开始的，如果class文件的版本号超过虚拟机版本则将被拒绝执行</p>
<p>0x0034(对应十进制52)：JDK1.8版本</p>
<p>0x0034(对应十进制51)：JDK1.7版本</p>
<p>0x0034(对应十进制50)：JDK1.6版本</p>
<h4 id="2-2-3-常量池"><a href="#2-2-3-常量池" class="headerlink" title="2.2.3 常量池"></a>2.2.3 常量池</h4><p>魔数与版本号之后的是常量池，常量池可以理解为class文件的资源库</p>
<p>常量池特点：</p>
<ol>
<li>常量池是class文件结构中与其他项目关联最多的数据类型</li>
<li>常量池是占用class文件空间最大的数据项目之一</li>
<li>常量池是在文件中第一个出现的表类型数据项目</li>
</ol>
<p><em>由于常量池中常量的数量是不固定的，所以常量池的入口需要放置任意u2类型的数据，代表常量池容量的计数值constant_pool_count</em></p>
<blockquote>
<p>constant_pool_count是从1开始计数的。在class文件结构中只有常量池的容量计数是从1开始的。第0个空出来满足后面某些指向常量池索引值的数据在特定情况下需要表达”不引用任何一个常量池项目“的意思，此时将索引值置为0来表示(即留给自己的虚拟机来使用)。尽管constant_pool列表中没有索引值为0的入口，但缺失的入口同样也被constant_pool_count技术在内。例如当constant_pool中存在14项，则constant_pool_count的值为15</p>
</blockquote>
<p>常量池中主要存放两大类常量：</p>
<ul>
<li>字面量：比较接近于Java语言的常量概念，例如：文本字符串、声明为final的常量值等</li>
<li>符号引用：属于编译原理理念包括有<ul>
<li>类和接口的全限定名</li>
<li>字段名称和描述符</li>
<li>方法名称和描述符</li>
</ul>
</li>
</ul>
<blockquote>
<p>java代码在进行编译的过程中，不像C++与C有”连接“这样的步骤，而是在虚拟机加载class文件的时候进行动态连接，即在class文件中不会保存各个方法嗯好字段的最终内存布局信息。因为这些字段和方法的符号引用如果不经过转换，则无法被虚拟机使用。当虚拟机运行时，需要从常量池中获得对应的符号引用，然后在类的创建或运行时解析并翻译到具体的内存地址中。</p>
<p>constant_pool_count占2个字节0x0020转换成十进制为32 也就是说明常量池中有31个常量。(常量池技术是从1就开始的。其他集合类型均为从0开始)索引值为1~31，第0项具有特殊意义。</p>
<p>constant_pool表示类型数据集合，即常量池中每一项常量都是一个表，1.8版本中有14种(在1.7版本中有11种)结构各不相同的表结构数据。这14种表都有一个共同的特点，均由一个u1类型的标志位开始，可以通过标志位来判断这个常量属于哪种常量类型</p>
</blockquote>
<p>常量类型及其数据结构 –见表格</p>
<table>
<thead>
<tr>
<th>编号</th>
<th>tag位标识数值表示</th>
<th>数据类型</th>
<th>格式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>CONSTANT_UTF8_info</td>
<td>2-byte unsigned integer<br />Bytes</td>
<td>Length of the bytes Text</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>CONSTANT_Integer_info</td>
<td>4-byte signed integer</td>
<td>int constant</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>CONSTANT_Float_info</td>
<td>4-byte floating-point number</td>
<td>float constant</td>
</tr>
<tr>
<td>4</td>
<td>5</td>
<td>CONSTANT_Long_info</td>
<td>8-byte signed long integer</td>
<td>long constant</td>
</tr>
<tr>
<td>5</td>
<td>6</td>
<td>CONSTANT_Double_info</td>
<td>8-byte double-precision number</td>
<td>double constant</td>
</tr>
<tr>
<td>6</td>
<td>7</td>
<td>CONSTANT_Class_info</td>
<td>2-byte UTF8 index</td>
<td>Names a class</td>
</tr>
<tr>
<td>7</td>
<td>8</td>
<td>CONSTANT_String_info</td>
<td>2-byte UTF8 index</td>
<td>String constant</td>
</tr>
<tr>
<td>8</td>
<td>9</td>
<td>CONSTANT_Fieldref_info</td>
<td>2-byte Class index</td>
<td>Class containing the field</td>
</tr>
<tr>
<td>9</td>
<td>10</td>
<td>CONSTANT_Methodref_info</td>
<td>2-byte NameAndType index</td>
<td>Field name and type</td>
</tr>
<tr>
<td>10</td>
<td>11</td>
<td>CONSTANT_InterfaceMethodref_info</td>
<td>2-byte Class index<br />2-byte NameAndType index</td>
<td>Class containing the method</td>
</tr>
<tr>
<td>11</td>
<td>12</td>
<td>CONSTANT_NameAndType_info</td>
<td>2-byte Class index<br />2-byte NameAndType index</td>
<td>Interface containing the method Method name the type</td>
</tr>
</tbody></table>
<h4 id="2-2-4-access-flags"><a href="#2-2-4-access-flags" class="headerlink" title="2.2.4 access_flags"></a>2.2.4 access_flags</h4><p>access_flags标志的掩码，用于对该类或接口的访问权限以及该类或接口的属性</p>
<table>
<thead>
<tr>
<th>标志名称</th>
<th>Value</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>ACC_PUBLIC</td>
<td>0x0001</td>
<td>宣布public修饰，可以从太不进行访问</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td>0x0010</td>
<td>被final修饰，不允许子类继承 重写</td>
</tr>
<tr>
<td>ACC_SUPER</td>
<td>0x0020</td>
<td>如何调用父类的方法</td>
</tr>
<tr>
<td>ACC_INTERFACE</td>
<td>0x0200</td>
<td>标识这是一个接口</td>
</tr>
<tr>
<td>ACC_ABSTRACT</td>
<td>0x0400</td>
<td>这是一个抽象类，不能实例化</td>
</tr>
<tr>
<td>ACC_SYNTHETIC</td>
<td>0x1000</td>
<td>表示合成，源码中不存在</td>
</tr>
<tr>
<td>ACC_ANNOTATION</td>
<td>0x2000</td>
<td>声明这是一个注解类型</td>
</tr>
<tr>
<td>ACC_ENUM</td>
<td>0x4000</td>
<td>声明这是一个枚举类型</td>
</tr>
</tbody></table>
<h4 id="2-2-5-this-class"><a href="#2-2-5-this-class" class="headerlink" title="2.2.5 this_class"></a>2.2.5 this_class</h4><p>this_class必须是constant_pool表中的有效索引，constant_pool索引处的条目必须是表示此文件定义的类或接口的constant_class_info结构.class</p>
<h4 id="2-2-6-super-class"><a href="#2-2-6-super-class" class="headerlink" title="2.2.6 super_class"></a>2.2.6 super_class</h4><p>对于一个类，super_class值必须为零或者必须是constant_pool表中的有效索引，如果super_class不为零，则constant_pool条目必须为constant_class_info的结构，该结构表示类在文件定义类中的直接超类，直接超类或其他任何超类都不能在其ClassFile的access_fiags项中设置ACC_FINAL标志</p>
<p><em>观察bytecode的方法：</em></p>
<ol>
<li><p>Javap</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br></pre></td><td class="code"><pre><span class="line">javap -v E:\aPersonalData\SpringFrameProjects\Demo01\out\production\Demo01\Solution01.class</span><br><span class="line"><span class="function">C:\<span class="title">Users</span>\黎明&gt;<span class="title">javap</span> -<span class="title">v</span> <span class="title">E</span>:\<span class="title">aPersonalData</span>\<span class="title">SpringFrameProjects</span>\<span class="title">Demo01</span>\<span class="title">out</span>\<span class="title">production</span>\<span class="title">Demo01</span>\<span class="title">Solution01.class</span></span></span><br><span class="line"><span class="function"><span class="title">Classfile</span> /<span class="title">E</span>:/<span class="title">aPersonalData</span>/<span class="title">SpringFrameProjects</span>/<span class="title">Demo01</span>/<span class="title">out</span>/<span class="title">production</span>/<span class="title">Demo01</span>/<span class="title">Solution01.class</span></span></span><br><span class="line"><span class="function">  <span class="title">Last</span> <span class="title">modified</span> 2022-7-8; <span class="title">size</span> 1925 <span class="title">bytes</span></span></span><br><span class="line"><span class="function">  <span class="title">MD5</span> <span class="title">checksum</span> 8<span class="title">cc678a13dcd5f4c9a8b1188c9a442c6</span></span></span><br><span class="line"><span class="function">  <span class="title">Compiled</span> <span class="title">from</span> &quot;<span class="title">Solution01.java</span>&quot;</span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">Solution01</span></span></span><br><span class="line"><span class="function">  <span class="title">minor</span> <span class="title">version</span>: 0</span></span><br><span class="line"><span class="function">  <span class="title">major</span> <span class="title">version</span>: 52</span></span><br><span class="line"><span class="function">  <span class="title">flags</span>: <span class="title">ACC_SUPER</span></span></span><br><span class="line"><span class="function"><span class="title">Constant</span> <span class="title">pool</span>:</span></span><br><span class="line"><span class="function">    #1 = <span class="title">Methodref</span>          #22.#58       // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Object</span>.&quot;&lt;<span class="title">init</span>&gt;&quot;:()<span class="title">V</span></span></span><br><span class="line"><span class="function">    #2 = <span class="title">Methodref</span>          #21.#59       // <span class="title">Solution01.twoSum</span>:([<span class="title">II</span>)[[<span class="title">I</span></span></span><br><span class="line"><span class="function">    #3 = <span class="title">Fieldref</span>           #60.#61       // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">System.out:Ljava</span>/<span class="title">io</span>/<span class="title">PrintStream</span>;</span></span><br><span class="line"><span class="function">    #4 = <span class="title">Methodref</span>          #62.#63       // <span class="title">java</span>/<span class="title">util</span>/<span class="title">Arrays.toString</span>:([<span class="title">I</span>)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;</span></span><br><span class="line"><span class="function">    #5 = <span class="title">Methodref</span>          #64.#65       // <span class="title">java</span>/<span class="title">io</span>/<span class="title">PrintStream.println</span>:(<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;)<span class="title">V</span></span></span><br><span class="line"><span class="function">    #6 = <span class="title">Class</span>              #66           // <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap</span></span></span><br><span class="line"><span class="function">    #7 = <span class="title">Methodref</span>          #6.#58        // <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap</span>.&quot;&lt;<span class="title">init</span>&gt;&quot;:()<span class="title">V</span></span></span><br><span class="line"><span class="function">    #8 = <span class="title">Methodref</span>          #67.#68       // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Math.min</span>:(<span class="title">II</span>)<span class="title">I</span></span></span><br><span class="line"><span class="function">    #9 = <span class="title">Methodref</span>          #18.#69       // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Integer.valueOf</span>:(<span class="title">I</span>)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Integer</span>;</span></span><br><span class="line"><span class="function">   #10 = <span class="title">Methodref</span>          #67.#70       // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Math.max</span>:(<span class="title">II</span>)<span class="title">I</span></span></span><br><span class="line"><span class="function">   #11 = <span class="title">Methodref</span>          #6.#71        // <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap.put</span>:(<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;</span></span><br><span class="line"><span class="function">   #12 = <span class="title">Methodref</span>          #6.#72        // <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap.size</span>:()<span class="title">I</span></span></span><br><span class="line"><span class="function">   #13 = <span class="title">Class</span>              #40           // &quot;[[<span class="title">I</span>&quot;</span></span><br><span class="line"><span class="function">   #14 = <span class="title">Methodref</span>          #6.#73        // <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap.keySet</span>:()<span class="title">Ljava</span>/<span class="title">util</span>/<span class="title">Set</span>;</span></span><br><span class="line"><span class="function">   #15 = <span class="title">InterfaceMethodref</span> #74.#75       // <span class="title">java</span>/<span class="title">util</span>/<span class="title">Set.iterator</span>:()<span class="title">Ljava</span>/<span class="title">util</span>/<span class="title">Iterator</span>;</span></span><br><span class="line"><span class="function">   #16 = <span class="title">InterfaceMethodref</span> #76.#77       // <span class="title">java</span>/<span class="title">util</span>/<span class="title">Iterator.hasNext</span>:()<span class="title">Z</span></span></span><br><span class="line"><span class="function">   #17 = <span class="title">InterfaceMethodref</span> #76.#78       // <span class="title">java</span>/<span class="title">util</span>/<span class="title">Iterator.next</span>:()<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;</span></span><br><span class="line"><span class="function">   #18 = <span class="title">Class</span>              #79           // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Integer</span></span></span><br><span class="line"><span class="function">   #19 = <span class="title">Methodref</span>          #18.#80       // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Integer.intValue</span>:()<span class="title">I</span></span></span><br><span class="line"><span class="function">   #20 = <span class="title">Methodref</span>          #6.#81        // <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap.get</span>:(<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;</span></span><br><span class="line"><span class="function">   #21 = <span class="title">Class</span>              #82           // <span class="title">Solution01</span></span></span><br><span class="line"><span class="function">   #22 = <span class="title">Class</span>              #83           // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Object</span></span></span><br><span class="line"><span class="function">   #23 = <span class="title">Utf8</span>               &lt;<span class="title">init</span>&gt;</span></span><br><span class="line"><span class="function">   #24 = <span class="title">Utf8</span>               ()<span class="title">V</span></span></span><br><span class="line"><span class="function">   #25 = <span class="title">Utf8</span>               <span class="title">Code</span></span></span><br><span class="line"><span class="function">   #26 = <span class="title">Utf8</span>               <span class="title">LineNumberTable</span></span></span><br><span class="line"><span class="function">   #27 = <span class="title">Utf8</span>               <span class="title">LocalVariableTable</span></span></span><br><span class="line"><span class="function">   #28 = <span class="title">Utf8</span>               <span class="title">this</span></span></span><br><span class="line"><span class="function">   #29 = <span class="title">Utf8</span>               <span class="title">LSolution01</span>;</span></span><br><span class="line"><span class="function">   #30 = <span class="title">Utf8</span>               <span class="title">main</span></span></span><br><span class="line"><span class="function">   #31 = <span class="title">Utf8</span>               ([<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;)<span class="title">V</span></span></span><br><span class="line"><span class="function">   #32 = <span class="title">Utf8</span>               <span class="title">i</span></span></span><br><span class="line"><span class="function">   #33 = <span class="title">Utf8</span>               <span class="title">I</span></span></span><br><span class="line"><span class="function">   #34 = <span class="title">Utf8</span>               <span class="title">args</span></span></span><br><span class="line"><span class="function">   #35 = <span class="title">Utf8</span>               [<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;</span></span><br><span class="line"><span class="function">   #36 = <span class="title">Utf8</span>               <span class="title">nums</span></span></span><br><span class="line"><span class="function">   #37 = <span class="title">Utf8</span>               [<span class="title">I</span></span></span><br><span class="line"><span class="function">   #38 = <span class="title">Utf8</span>               <span class="title">target</span></span></span><br><span class="line"><span class="function">   #39 = <span class="title">Utf8</span>               <span class="title">result</span></span></span><br><span class="line"><span class="function">   #40 = <span class="title">Utf8</span>               [[<span class="title">I</span></span></span><br><span class="line"><span class="function">   #41 = <span class="title">Utf8</span>               <span class="title">StackMapTable</span></span></span><br><span class="line"><span class="function">   #42 = <span class="title">Class</span>              #35           // &quot;[<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;&quot;</span></span><br><span class="line"><span class="function">   #43 = <span class="title">Class</span>              #37           // &quot;[<span class="title">I</span>&quot;</span></span><br><span class="line"><span class="function">   #44 = <span class="title">Utf8</span>               <span class="title">twoSum</span></span></span><br><span class="line"><span class="function">   #45 = <span class="title">Utf8</span>               ([<span class="title">II</span>)[[<span class="title">I</span></span></span><br><span class="line"><span class="function">   #46 = <span class="title">Utf8</span>               <span class="title">j</span></span></span><br><span class="line"><span class="function">   #47 = <span class="title">Utf8</span>               <span class="title">key</span></span></span><br><span class="line"><span class="function">   #48 = <span class="title">Utf8</span>               <span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Integer</span>;</span></span><br><span class="line"><span class="function">   #49 = <span class="title">Utf8</span>               <span class="title">map</span></span></span><br><span class="line"><span class="function">   #50 = <span class="title">Utf8</span>               <span class="title">Ljava</span>/<span class="title">util</span>/<span class="title">HashMap</span>;</span></span><br><span class="line"><span class="function">   #51 = <span class="title">Utf8</span>               <span class="title">index</span></span></span><br><span class="line"><span class="function">   #52 = <span class="title">Utf8</span>               <span class="title">LocalVariableTypeTable</span></span></span><br><span class="line"><span class="function">   #53 = <span class="title">Utf8</span>               <span class="title">Ljava</span>/<span class="title">util</span>/<span class="title">HashMap</span>&lt;<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Integer</span>;<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Integer</span>;&gt;;</span></span><br><span class="line"><span class="function">   #54 = <span class="title">Class</span>              #66           // <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap</span></span></span><br><span class="line"><span class="function">   #55 = <span class="title">Class</span>              #84           // <span class="title">java</span>/<span class="title">util</span>/<span class="title">Iterator</span></span></span><br><span class="line"><span class="function">   #56 = <span class="title">Utf8</span>               <span class="title">SourceFile</span></span></span><br><span class="line"><span class="function">   #57 = <span class="title">Utf8</span>               <span class="title">Solution01.java</span></span></span><br><span class="line"><span class="function">   #58 = <span class="title">NameAndType</span>        #23:#24       // &quot;&lt;<span class="title">init</span>&gt;&quot;:()<span class="title">V</span></span></span><br><span class="line"><span class="function">   #59 = <span class="title">NameAndType</span>        #44:#45       // <span class="title">twoSum</span>:([<span class="title">II</span>)[[<span class="title">I</span></span></span><br><span class="line"><span class="function">   #60 = <span class="title">Class</span>              #85           // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">System</span></span></span><br><span class="line"><span class="function">   #61 = <span class="title">NameAndType</span>        #86:#87       // <span class="title">out:Ljava</span>/<span class="title">io</span>/<span class="title">PrintStream</span>;</span></span><br><span class="line"><span class="function">   #62 = <span class="title">Class</span>              #88           // <span class="title">java</span>/<span class="title">util</span>/<span class="title">Arrays</span></span></span><br><span class="line"><span class="function">   #63 = <span class="title">NameAndType</span>        #89:#90       // <span class="title">toString</span>:([<span class="title">I</span>)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;</span></span><br><span class="line"><span class="function">   #64 = <span class="title">Class</span>              #91           // <span class="title">java</span>/<span class="title">io</span>/<span class="title">PrintStream</span></span></span><br><span class="line"><span class="function">   #65 = <span class="title">NameAndType</span>        #92:#93       // <span class="title">println</span>:(<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;)<span class="title">V</span></span></span><br><span class="line"><span class="function">   #66 = <span class="title">Utf8</span>               <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap</span></span></span><br><span class="line"><span class="function">   #67 = <span class="title">Class</span>              #94           // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Math</span></span></span><br><span class="line"><span class="function">   #68 = <span class="title">NameAndType</span>        #95:#96       // <span class="title">min</span>:(<span class="title">II</span>)<span class="title">I</span></span></span><br><span class="line"><span class="function">   #69 = <span class="title">NameAndType</span>        #97:#98       // <span class="title">valueOf</span>:(<span class="title">I</span>)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Integer</span>;</span></span><br><span class="line"><span class="function">   #70 = <span class="title">NameAndType</span>        #99:#96       // <span class="title">max</span>:(<span class="title">II</span>)<span class="title">I</span></span></span><br><span class="line"><span class="function">   #71 = <span class="title">NameAndType</span>        #100:#101     // <span class="title">put</span>:(<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;</span></span><br><span class="line"><span class="function">   #72 = <span class="title">NameAndType</span>        #102:#103     // <span class="title">size</span>:()<span class="title">I</span></span></span><br><span class="line"><span class="function">   #73 = <span class="title">NameAndType</span>        #104:#105     // <span class="title">keySet</span>:()<span class="title">Ljava</span>/<span class="title">util</span>/<span class="title">Set</span>;</span></span><br><span class="line"><span class="function">   #74 = <span class="title">Class</span>              #106          // <span class="title">java</span>/<span class="title">util</span>/<span class="title">Set</span></span></span><br><span class="line"><span class="function">   #75 = <span class="title">NameAndType</span>        #107:#108     // <span class="title">iterator</span>:()<span class="title">Ljava</span>/<span class="title">util</span>/<span class="title">Iterator</span>;</span></span><br><span class="line"><span class="function">   #76 = <span class="title">Class</span>              #84           // <span class="title">java</span>/<span class="title">util</span>/<span class="title">Iterator</span></span></span><br><span class="line"><span class="function">   #77 = <span class="title">NameAndType</span>        #109:#110     // <span class="title">hasNext</span>:()<span class="title">Z</span></span></span><br><span class="line"><span class="function">   #78 = <span class="title">NameAndType</span>        #111:#112     // <span class="title">next</span>:()<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;</span></span><br><span class="line"><span class="function">   #79 = <span class="title">Utf8</span>               <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Integer</span></span></span><br><span class="line"><span class="function">   #80 = <span class="title">NameAndType</span>        #113:#103     // <span class="title">intValue</span>:()<span class="title">I</span></span></span><br><span class="line"><span class="function">   #81 = <span class="title">NameAndType</span>        #114:#115     // <span class="title">get</span>:(<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;</span></span><br><span class="line"><span class="function">   #82 = <span class="title">Utf8</span>               <span class="title">Solution01</span></span></span><br><span class="line"><span class="function">   #83 = <span class="title">Utf8</span>               <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Object</span></span></span><br><span class="line"><span class="function">   #84 = <span class="title">Utf8</span>               <span class="title">java</span>/<span class="title">util</span>/<span class="title">Iterator</span></span></span><br><span class="line"><span class="function">   #85 = <span class="title">Utf8</span>               <span class="title">java</span>/<span class="title">lang</span>/<span class="title">System</span></span></span><br><span class="line"><span class="function">   #86 = <span class="title">Utf8</span>               <span class="title">out</span></span></span><br><span class="line"><span class="function">   #87 = <span class="title">Utf8</span>               <span class="title">Ljava</span>/<span class="title">io</span>/<span class="title">PrintStream</span>;</span></span><br><span class="line"><span class="function">   #88 = <span class="title">Utf8</span>               <span class="title">java</span>/<span class="title">util</span>/<span class="title">Arrays</span></span></span><br><span class="line"><span class="function">   #89 = <span class="title">Utf8</span>               <span class="title">toString</span></span></span><br><span class="line"><span class="function">   #90 = <span class="title">Utf8</span>               ([<span class="title">I</span>)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;</span></span><br><span class="line"><span class="function">   #91 = <span class="title">Utf8</span>               <span class="title">java</span>/<span class="title">io</span>/<span class="title">PrintStream</span></span></span><br><span class="line"><span class="function">   #92 = <span class="title">Utf8</span>               <span class="title">println</span></span></span><br><span class="line"><span class="function">   #93 = <span class="title">Utf8</span>               (<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;)<span class="title">V</span></span></span><br><span class="line"><span class="function">   #94 = <span class="title">Utf8</span>               <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Math</span></span></span><br><span class="line"><span class="function">   #95 = <span class="title">Utf8</span>               <span class="title">min</span></span></span><br><span class="line"><span class="function">   #96 = <span class="title">Utf8</span>               (<span class="title">II</span>)<span class="title">I</span></span></span><br><span class="line"><span class="function">   #97 = <span class="title">Utf8</span>               <span class="title">valueOf</span></span></span><br><span class="line"><span class="function">   #98 = <span class="title">Utf8</span>               (<span class="title">I</span>)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Integer</span>;</span></span><br><span class="line"><span class="function">   #99 = <span class="title">Utf8</span>               <span class="title">max</span></span></span><br><span class="line"><span class="function">  #100 = <span class="title">Utf8</span>               <span class="title">put</span></span></span><br><span class="line"><span class="function">  #101 = <span class="title">Utf8</span>               (<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;</span></span><br><span class="line"><span class="function">  #102 = <span class="title">Utf8</span>               <span class="title">size</span></span></span><br><span class="line"><span class="function">  #103 = <span class="title">Utf8</span>               ()<span class="title">I</span></span></span><br><span class="line"><span class="function">  #104 = <span class="title">Utf8</span>               <span class="title">keySet</span></span></span><br><span class="line"><span class="function">  #105 = <span class="title">Utf8</span>               ()<span class="title">Ljava</span>/<span class="title">util</span>/<span class="title">Set</span>;</span></span><br><span class="line"><span class="function">  #106 = <span class="title">Utf8</span>               <span class="title">java</span>/<span class="title">util</span>/<span class="title">Set</span></span></span><br><span class="line"><span class="function">  #107 = <span class="title">Utf8</span>               <span class="title">iterator</span></span></span><br><span class="line"><span class="function">  #108 = <span class="title">Utf8</span>               ()<span class="title">Ljava</span>/<span class="title">util</span>/<span class="title">Iterator</span>;</span></span><br><span class="line"><span class="function">  #109 = <span class="title">Utf8</span>               <span class="title">hasNext</span></span></span><br><span class="line"><span class="function">  #110 = <span class="title">Utf8</span>               ()<span class="title">Z</span></span></span><br><span class="line"><span class="function">  #111 = <span class="title">Utf8</span>               <span class="title">next</span></span></span><br><span class="line"><span class="function">  #112 = <span class="title">Utf8</span>               ()<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;</span></span><br><span class="line"><span class="function">  #113 = <span class="title">Utf8</span>               <span class="title">intValue</span></span></span><br><span class="line"><span class="function">  #114 = <span class="title">Utf8</span>               <span class="title">get</span></span></span><br><span class="line"><span class="function">  #115 = <span class="title">Utf8</span>               (<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;</span></span><br><span class="line"><span class="function">&#123;</span></span><br><span class="line"><span class="function">  <span class="title">Solution01</span>();</span></span><br><span class="line"><span class="function">    <span class="title">descriptor</span>: ()<span class="title">V</span></span></span><br><span class="line"><span class="function">    <span class="title">flags</span>:</span></span><br><span class="line"><span class="function">    <span class="title">Code</span>:</span></span><br><span class="line"><span class="function">      <span class="title">stack</span>=1, <span class="title">locals</span>=1, <span class="title">args_size</span>=1</span></span><br><span class="line"><span class="function">         0: <span class="title">aload_0</span></span></span><br><span class="line"><span class="function">         1: <span class="title">invokespecial</span> #1                  // <span class="title">Method</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Object</span>.&quot;&lt;<span class="title">init</span>&gt;&quot;:()<span class="title">V</span></span></span><br><span class="line"><span class="function">         4: <span class="title">return</span></span></span><br><span class="line"><span class="function">      <span class="title">LineNumberTable</span>:</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 3: 0</span></span><br><span class="line"><span class="function">      <span class="title">LocalVariableTable</span>:</span></span><br><span class="line"><span class="function">        <span class="title">Start</span>  <span class="title">Length</span>  <span class="title">Slot</span>  <span class="title">Name</span>   <span class="title">Signature</span></span></span><br><span class="line"><span class="function">            0       5     0  <span class="title">this</span>   <span class="title">LSolution01</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">public</span> <span class="title">static</span> <span class="title">void</span> <span class="title">main</span>(<span class="title">java.lang.String</span>[]);</span></span><br><span class="line"><span class="function">    <span class="title">descriptor</span>: ([<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;)<span class="title">V</span></span></span><br><span class="line"><span class="function">    <span class="title">flags</span>: <span class="title">ACC_PUBLIC</span>, <span class="title">ACC_STATIC</span></span></span><br><span class="line"><span class="function">    <span class="title">Code</span>:</span></span><br><span class="line"><span class="function">      <span class="title">stack</span>=4, <span class="title">locals</span>=5, <span class="title">args_size</span>=1</span></span><br><span class="line"><span class="function">         0: <span class="title">bipush</span>        6</span></span><br><span class="line"><span class="function">         2: <span class="title">newarray</span>       <span class="title">int</span></span></span><br><span class="line"><span class="function">         4: <span class="title">dup</span></span></span><br><span class="line"><span class="function">         5: <span class="title">iconst_0</span></span></span><br><span class="line"><span class="function">         6: <span class="title">iconst_1</span></span></span><br><span class="line"><span class="function">         7: <span class="title">iastore</span></span></span><br><span class="line"><span class="function">         8: <span class="title">dup</span></span></span><br><span class="line"><span class="function">         9: <span class="title">iconst_1</span></span></span><br><span class="line"><span class="function">        10: <span class="title">iconst_4</span></span></span><br><span class="line"><span class="function">        11: <span class="title">iastore</span></span></span><br><span class="line"><span class="function">        12: <span class="title">dup</span></span></span><br><span class="line"><span class="function">        13: <span class="title">iconst_2</span></span></span><br><span class="line"><span class="function">        14: <span class="title">bipush</span>        -2</span></span><br><span class="line"><span class="function">        16: <span class="title">iastore</span></span></span><br><span class="line"><span class="function">        17: <span class="title">dup</span></span></span><br><span class="line"><span class="function">        18: <span class="title">iconst_3</span></span></span><br><span class="line"><span class="function">        19: <span class="title">iconst_3</span></span></span><br><span class="line"><span class="function">        20: <span class="title">iastore</span></span></span><br><span class="line"><span class="function">        21: <span class="title">dup</span></span></span><br><span class="line"><span class="function">        22: <span class="title">iconst_4</span></span></span><br><span class="line"><span class="function">        23: <span class="title">iconst_0</span></span></span><br><span class="line"><span class="function">        24: <span class="title">iastore</span></span></span><br><span class="line"><span class="function">        25: <span class="title">dup</span></span></span><br><span class="line"><span class="function">        26: <span class="title">iconst_5</span></span></span><br><span class="line"><span class="function">        27: <span class="title">iconst_1</span></span></span><br><span class="line"><span class="function">        28: <span class="title">iastore</span></span></span><br><span class="line"><span class="function">        29: <span class="title">astore_1</span></span></span><br><span class="line"><span class="function">        30: <span class="title">iconst_1</span></span></span><br><span class="line"><span class="function">        31: <span class="title">istore_2</span></span></span><br><span class="line"><span class="function">        32: <span class="title">aload_1</span></span></span><br><span class="line"><span class="function">        33: <span class="title">iload_2</span></span></span><br><span class="line"><span class="function">        34: <span class="title">invokestatic</span>  #2                  // <span class="title">Method</span> <span class="title">twoSum</span>:([<span class="title">II</span>)[[<span class="title">I</span></span></span><br><span class="line"><span class="function">        37: <span class="title">astore_3</span></span></span><br><span class="line"><span class="function">        38: <span class="title">iconst_0</span></span></span><br><span class="line"><span class="function">        39: <span class="title">istore</span>        4</span></span><br><span class="line"><span class="function">        41: <span class="title">iload</span>         4</span></span><br><span class="line"><span class="function">        43: <span class="title">aload_3</span></span></span><br><span class="line"><span class="function">        44: <span class="title">arraylength</span></span></span><br><span class="line"><span class="function">        45: <span class="title">if_icmpge</span>     67</span></span><br><span class="line"><span class="function">        48: <span class="title">getstatic</span>     #3                  // <span class="title">Field</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">System.out:Ljava</span>/<span class="title">io</span>/<span class="title">PrintStream</span>;</span></span><br><span class="line"><span class="function">        51: <span class="title">aload_3</span></span></span><br><span class="line"><span class="function">        52: <span class="title">iload</span>         4</span></span><br><span class="line"><span class="function">        54: <span class="title">aaload</span></span></span><br><span class="line"><span class="function">        55: <span class="title">invokestatic</span>  #4                  // <span class="title">Method</span> <span class="title">java</span>/<span class="title">util</span>/<span class="title">Arrays.toString</span>:([<span class="title">I</span>)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;</span></span><br><span class="line"><span class="function">        58: <span class="title">invokevirtual</span> #5                  // <span class="title">Method</span> <span class="title">java</span>/<span class="title">io</span>/<span class="title">PrintStream.println</span>:(<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;)<span class="title">V</span></span></span><br><span class="line"><span class="function">        61: <span class="title">iinc</span>          4, 1</span></span><br><span class="line"><span class="function">        64: <span class="title">goto</span>          41</span></span><br><span class="line"><span class="function">        67: <span class="title">return</span></span></span><br><span class="line"><span class="function">      <span class="title">LineNumberTable</span>:</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 5: 0</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 6: 30</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 7: 32</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 8: 38</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 9: 48</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 8: 61</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 11: 67</span></span><br><span class="line"><span class="function">      <span class="title">LocalVariableTable</span>:</span></span><br><span class="line"><span class="function">        <span class="title">Start</span>  <span class="title">Length</span>  <span class="title">Slot</span>  <span class="title">Name</span>   <span class="title">Signature</span></span></span><br><span class="line"><span class="function">           41      26     4     <span class="title">i</span>   <span class="title">I</span></span></span><br><span class="line"><span class="function">            0      68     0  <span class="title">args</span>   [<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;</span></span><br><span class="line"><span class="function">           30      38     1  <span class="title">nums</span>   [<span class="title">I</span></span></span><br><span class="line"><span class="function">           32      36     2 <span class="title">target</span>   <span class="title">I</span></span></span><br><span class="line"><span class="function">           38      30     3 <span class="title">result</span>   [[<span class="title">I</span></span></span><br><span class="line"><span class="function">      <span class="title">StackMapTable</span>: <span class="title">number_of_entries</span> = 2</span></span><br><span class="line"><span class="function">        <span class="title">frame_type</span> = 255 /* <span class="title">full_frame</span> */</span></span><br><span class="line"><span class="function">          <span class="title">offset_delta</span> = 41</span></span><br><span class="line"><span class="function">          <span class="title">locals</span> = [ <span class="title">class</span> &quot;[<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;&quot;, <span class="title">class</span> &quot;[<span class="title">I</span>&quot;, <span class="title">int</span>, <span class="title">class</span> &quot;[[<span class="title">I</span>&quot;, <span class="title">int</span> ]</span></span><br><span class="line"><span class="function">          <span class="title">stack</span> = []</span></span><br><span class="line"><span class="function">        <span class="title">frame_type</span> = 250 /* <span class="title">chop</span> */</span></span><br><span class="line"><span class="function">          <span class="title">offset_delta</span> = 25</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">public</span> <span class="title">static</span> <span class="title">int</span>[][] <span class="title">twoSum</span>(<span class="title">int</span>[], <span class="title">int</span>);</span></span><br><span class="line"><span class="function">    <span class="title">descriptor</span>: ([<span class="title">II</span>)[[<span class="title">I</span></span></span><br><span class="line"><span class="function">    <span class="title">flags</span>: <span class="title">ACC_PUBLIC</span>, <span class="title">ACC_STATIC</span></span></span><br><span class="line"><span class="function">    <span class="title">Code</span>:</span></span><br><span class="line"><span class="function">      <span class="title">stack</span>=5, <span class="title">locals</span>=7, <span class="title">args_size</span>=2</span></span><br><span class="line"><span class="function">         0: <span class="title">new</span>           #6                  // <span class="title">class</span> <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap</span></span></span><br><span class="line"><span class="function">         3: <span class="title">dup</span></span></span><br><span class="line"><span class="function">         4: <span class="title">invokespecial</span> #7                  // <span class="title">Method</span> <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap</span>.&quot;&lt;<span class="title">init</span>&gt;&quot;:()<span class="title">V</span></span></span><br><span class="line"><span class="function">         7: <span class="title">astore_2</span></span></span><br><span class="line"><span class="function">         8: <span class="title">iconst_0</span></span></span><br><span class="line"><span class="function">         9: <span class="title">istore_3</span></span></span><br><span class="line"><span class="function">        10: <span class="title">iload_3</span></span></span><br><span class="line"><span class="function">        11: <span class="title">aload_0</span></span></span><br><span class="line"><span class="function">        12: <span class="title">arraylength</span></span></span><br><span class="line"><span class="function">        13: <span class="title">iconst_1</span></span></span><br><span class="line"><span class="function">        14: <span class="title">isub</span></span></span><br><span class="line"><span class="function">        15: <span class="title">if_icmpge</span>     85</span></span><br><span class="line"><span class="function">        18: <span class="title">iload_3</span></span></span><br><span class="line"><span class="function">        19: <span class="title">iconst_1</span></span></span><br><span class="line"><span class="function">        20: <span class="title">iadd</span></span></span><br><span class="line"><span class="function">        21: <span class="title">istore</span>        4</span></span><br><span class="line"><span class="function">        23: <span class="title">iload</span>         4</span></span><br><span class="line"><span class="function">        25: <span class="title">aload_0</span></span></span><br><span class="line"><span class="function">        26: <span class="title">arraylength</span></span></span><br><span class="line"><span class="function">        27: <span class="title">if_icmpge</span>     79</span></span><br><span class="line"><span class="function">        30: <span class="title">aload_0</span></span></span><br><span class="line"><span class="function">        31: <span class="title">iload_3</span></span></span><br><span class="line"><span class="function">        32: <span class="title">iaload</span></span></span><br><span class="line"><span class="function">        33: <span class="title">aload_0</span></span></span><br><span class="line"><span class="function">        34: <span class="title">iload</span>         4</span></span><br><span class="line"><span class="function">        36: <span class="title">iaload</span></span></span><br><span class="line"><span class="function">        37: <span class="title">iadd</span></span></span><br><span class="line"><span class="function">        38: <span class="title">iload_1</span></span></span><br><span class="line"><span class="function">        39: <span class="title">if_icmpne</span>     73</span></span><br><span class="line"><span class="function">        42: <span class="title">aload_2</span></span></span><br><span class="line"><span class="function">        43: <span class="title">aload_0</span></span></span><br><span class="line"><span class="function">        44: <span class="title">iload_3</span></span></span><br><span class="line"><span class="function">        45: <span class="title">iaload</span></span></span><br><span class="line"><span class="function">        46: <span class="title">aload_0</span></span></span><br><span class="line"><span class="function">        47: <span class="title">iload</span>         4</span></span><br><span class="line"><span class="function">        49: <span class="title">iaload</span></span></span><br><span class="line"><span class="function">        50: <span class="title">invokestatic</span>  #8                  // <span class="title">Method</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Math.min</span>:(<span class="title">II</span>)<span class="title">I</span></span></span><br><span class="line"><span class="function">        53: <span class="title">invokestatic</span>  #9                  // <span class="title">Method</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Integer.valueOf</span>:(<span class="title">I</span>)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Integer</span>;</span></span><br><span class="line"><span class="function">        56: <span class="title">aload_0</span></span></span><br><span class="line"><span class="function">        57: <span class="title">iload_3</span></span></span><br><span class="line"><span class="function">        58: <span class="title">iaload</span></span></span><br><span class="line"><span class="function">        59: <span class="title">aload_0</span></span></span><br><span class="line"><span class="function">        60: <span class="title">iload</span>         4</span></span><br><span class="line"><span class="function">        62: <span class="title">iaload</span></span></span><br><span class="line"><span class="function">        63: <span class="title">invokestatic</span>  #10                 // <span class="title">Method</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Math.max</span>:(<span class="title">II</span>)<span class="title">I</span></span></span><br><span class="line"><span class="function">        66: <span class="title">invokestatic</span>  #9                  // <span class="title">Method</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Integer.valueOf</span>:(<span class="title">I</span>)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Integer</span>;</span></span><br><span class="line"><span class="function">        69: <span class="title">invokevirtual</span> #11                 // <span class="title">Method</span> <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap.put</span>:(<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;</span></span><br><span class="line"><span class="function">        72: <span class="title">pop</span></span></span><br><span class="line"><span class="function">        73: <span class="title">iinc</span>          4, 1</span></span><br><span class="line"><span class="function">        76: <span class="title">goto</span>          23</span></span><br><span class="line"><span class="function">        79: <span class="title">iinc</span>          3, 1</span></span><br><span class="line"><span class="function">        82: <span class="title">goto</span>          10</span></span><br><span class="line"><span class="function">        85: <span class="title">aload_2</span></span></span><br><span class="line"><span class="function">        86: <span class="title">invokevirtual</span> #12                 // <span class="title">Method</span> <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap.size</span>:()<span class="title">I</span></span></span><br><span class="line"><span class="function">        89: <span class="title">iconst_2</span></span></span><br><span class="line"><span class="function">        90: <span class="title">multianewarray</span> #13,  2            // <span class="title">class</span> &quot;[[<span class="title">I</span>&quot;</span></span><br><span class="line"><span class="function">        94: <span class="title">astore_3</span></span></span><br><span class="line"><span class="function">        95: <span class="title">iconst_0</span></span></span><br><span class="line"><span class="function">        96: <span class="title">istore</span>        4</span></span><br><span class="line"><span class="function">        98: <span class="title">aload_2</span></span></span><br><span class="line"><span class="function">        99: <span class="title">invokevirtual</span> #14                 // <span class="title">Method</span> <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap.keySet</span>:()<span class="title">Ljava</span>/<span class="title">util</span>/<span class="title">Set</span>;</span></span><br><span class="line"><span class="function">       102: <span class="title">invokeinterface</span> #15,  1           // <span class="title">InterfaceMethod</span> <span class="title">java</span>/<span class="title">util</span>/<span class="title">Set.iterator</span>:()<span class="title">Ljava</span>/<span class="title">util</span>/<span class="title">Iterator</span>;</span></span><br><span class="line"><span class="function">       107: <span class="title">astore</span>        5</span></span><br><span class="line"><span class="function">       109: <span class="title">aload</span>         5</span></span><br><span class="line"><span class="function">       111: <span class="title">invokeinterface</span> #16,  1           // <span class="title">InterfaceMethod</span> <span class="title">java</span>/<span class="title">util</span>/<span class="title">Iterator.hasNext</span>:()<span class="title">Z</span></span></span><br><span class="line"><span class="function">       116: <span class="title">ifeq</span>          166</span></span><br><span class="line"><span class="function">       119: <span class="title">aload</span>         5</span></span><br><span class="line"><span class="function">       121: <span class="title">invokeinterface</span> #17,  1           // <span class="title">InterfaceMethod</span> <span class="title">java</span>/<span class="title">util</span>/<span class="title">Iterator.next</span>:()<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;</span></span><br><span class="line"><span class="function">       126: <span class="title">checkcast</span>     #18                 // <span class="title">class</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Integer</span></span></span><br><span class="line"><span class="function">       129: <span class="title">astore</span>        6</span></span><br><span class="line"><span class="function">       131: <span class="title">aload_3</span></span></span><br><span class="line"><span class="function">       132: <span class="title">iload</span>         4</span></span><br><span class="line"><span class="function">       134: <span class="title">aaload</span></span></span><br><span class="line"><span class="function">       135: <span class="title">iconst_0</span></span></span><br><span class="line"><span class="function">       136: <span class="title">aload</span>         6</span></span><br><span class="line"><span class="function">       138: <span class="title">invokevirtual</span> #19                 // <span class="title">Method</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Integer.intValue</span>:()<span class="title">I</span></span></span><br><span class="line"><span class="function">       141: <span class="title">iastore</span></span></span><br><span class="line"><span class="function">       142: <span class="title">aload_3</span></span></span><br><span class="line"><span class="function">       143: <span class="title">iload</span>         4</span></span><br><span class="line"><span class="function">       145: <span class="title">aaload</span></span></span><br><span class="line"><span class="function">       146: <span class="title">iconst_1</span></span></span><br><span class="line"><span class="function">       147: <span class="title">aload_2</span></span></span><br><span class="line"><span class="function">       148: <span class="title">aload</span>         6</span></span><br><span class="line"><span class="function">       150: <span class="title">invokevirtual</span> #20                 // <span class="title">Method</span> <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap.get</span>:(<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;)<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Object</span>;</span></span><br><span class="line"><span class="function">       153: <span class="title">checkcast</span>     #18                 // <span class="title">class</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Integer</span></span></span><br><span class="line"><span class="function">       156: <span class="title">invokevirtual</span> #19                 // <span class="title">Method</span> <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Integer.intValue</span>:()<span class="title">I</span></span></span><br><span class="line"><span class="function">       159: <span class="title">iastore</span></span></span><br><span class="line"><span class="function">       160: <span class="title">iinc</span>          4, 1</span></span><br><span class="line"><span class="function">       163: <span class="title">goto</span>          109</span></span><br><span class="line"><span class="function">       166: <span class="title">aload_3</span></span></span><br><span class="line"><span class="function">       167: <span class="title">areturn</span></span></span><br><span class="line"><span class="function">      <span class="title">LineNumberTable</span>:</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 14: 0</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 15: 8</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 16: 18</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 17: 30</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 18: 42</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 16: 73</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 15: 79</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 22: 85</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 23: 95</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 24: 98</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 25: 131</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 26: 142</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 27: 160</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 28: 163</span></span><br><span class="line"><span class="function">        <span class="title">line</span> 29: 166</span></span><br><span class="line"><span class="function">      <span class="title">LocalVariableTable</span>:</span></span><br><span class="line"><span class="function">        <span class="title">Start</span>  <span class="title">Length</span>  <span class="title">Slot</span>  <span class="title">Name</span>   <span class="title">Signature</span></span></span><br><span class="line"><span class="function">           23      56     4     <span class="title">j</span>   <span class="title">I</span></span></span><br><span class="line"><span class="function">           10      75     3     <span class="title">i</span>   <span class="title">I</span></span></span><br><span class="line"><span class="function">          131      32     6   <span class="title">key</span>   <span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Integer</span>;</span></span><br><span class="line"><span class="function">            0     168     0  <span class="title">nums</span>   [<span class="title">I</span></span></span><br><span class="line"><span class="function">            0     168     1 <span class="title">target</span>   <span class="title">I</span></span></span><br><span class="line"><span class="function">            8     160     2   <span class="title">map</span>   <span class="title">Ljava</span>/<span class="title">util</span>/<span class="title">HashMap</span>;</span></span><br><span class="line"><span class="function">           95      73     3 <span class="title">result</span>   [[<span class="title">I</span></span></span><br><span class="line"><span class="function">           98      70     4 <span class="title">index</span>   <span class="title">I</span></span></span><br><span class="line"><span class="function">      <span class="title">LocalVariableTypeTable</span>:</span></span><br><span class="line"><span class="function">        <span class="title">Start</span>  <span class="title">Length</span>  <span class="title">Slot</span>  <span class="title">Name</span>   <span class="title">Signature</span></span></span><br><span class="line"><span class="function">            8     160     2   <span class="title">map</span>   <span class="title">Ljava</span>/<span class="title">util</span>/<span class="title">HashMap</span>&lt;<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Integer</span>;<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">Integer</span>;&gt;;</span></span><br><span class="line"><span class="function">      <span class="title">StackMapTable</span>: <span class="title">number_of_entries</span> = 7</span></span><br><span class="line"><span class="function">        <span class="title">frame_type</span> = 253 /* <span class="title">append</span> */</span></span><br><span class="line"><span class="function">          <span class="title">offset_delta</span> = 10</span></span><br><span class="line"><span class="function">          <span class="title">locals</span> = [ <span class="title">class</span> <span class="title">java</span>/<span class="title">util</span>/<span class="title">HashMap</span>, <span class="title">int</span> ]</span></span><br><span class="line"><span class="function">        <span class="title">frame_type</span> = 252 /* <span class="title">append</span> */</span></span><br><span class="line"><span class="function">          <span class="title">offset_delta</span> = 12</span></span><br><span class="line"><span class="function">          <span class="title">locals</span> = [ <span class="title">int</span> ]</span></span><br><span class="line"><span class="function">        <span class="title">frame_type</span> = 49 /* <span class="title">same</span> */</span></span><br><span class="line"><span class="function">        <span class="title">frame_type</span> = 250 /* <span class="title">chop</span> */</span></span><br><span class="line"><span class="function">          <span class="title">offset_delta</span> = 5</span></span><br><span class="line"><span class="function">        <span class="title">frame_type</span> = 250 /* <span class="title">chop</span> */</span></span><br><span class="line"><span class="function">          <span class="title">offset_delta</span> = 5</span></span><br><span class="line"><span class="function">        <span class="title">frame_type</span> = 254 /* <span class="title">append</span> */</span></span><br><span class="line"><span class="function">          <span class="title">offset_delta</span> = 23</span></span><br><span class="line"><span class="function">          <span class="title">locals</span> = [ <span class="title">class</span> &quot;[[<span class="title">I</span>&quot;, <span class="title">int</span>, <span class="title">class</span> <span class="title">java</span>/<span class="title">util</span>/<span class="title">Iterator</span> ]</span></span><br><span class="line"><span class="function">        <span class="title">frame_type</span> = 250 /* <span class="title">chop</span> */</span></span><br><span class="line"><span class="function">          <span class="title">offset_delta</span> = 56</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"><span class="title">SourceFile</span>: &quot;<span class="title">Solution01.java</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>可以清晰看到方法映射和变量映射等…</p>
<p>对文件进行了MD5的加密</p>
<p>minor version: 0<br>major version: 52</p>
<p>flags: ACC_SUPER —public&#x2F;super</p>
<p>#4 &#x3D; Class —#24 this_class编号为多少<br>#5 &#x3D; Class —#5 super_class编号为多少</p>
</li>
<li><p>JBE<br>工具：可以直接修改class文件 –不仅可以查看bytecode 也可以通过汇编语言进行对classfile的修改</p>
</li>
<li><p>JClasslib IDEA中的插件 –安装setting中选择plugins然后安装JClasslib<br>若字节码文件没有生成 则可以build project<br><em>使用：选中类，然后在view中查看show bytecode with Jclasslib</em></p>
</li>
</ol>
<blockquote>
<p>访问标志为0x0021 是一个按位与运算，通过ACC_SUPER&amp;ACC_PUBLIC 这两个属性的按位与运算得来的值。使用2个字节来表示。对应ACCESS_FLAGS表中的内容</p>
</blockquote>
<h4 id="2-2-7-常量池详细解析"><a href="#2-2-7-常量池详细解析" class="headerlink" title="2.2.7 常量池详细解析"></a>2.2.7 常量池详细解析</h4><p>常量池类型：共有18个编号的常量类型：</p>
<blockquote>
<p>编号1： CONSTANT_UTF8_INFO</p>
<p>TAG1 —占用一个空间字节</p>
<p>Length： utf-8字符串占用的字节数</p>
<p>Bytes 长度为length字符串</p>
<p>用于表示utf-8的编码的字符串</p>
<p>编号3 CONSTANT_integer_info</p>
<p>Tag3</p>
<p>Bytes 4个字节 Big_Endian(高位在前) 存储int类型的值</p>
<p>编号4 CONSTANT_float_info</p>
<p>Tag4</p>
<p>Bytes 4个字节 Big_Endian(高位在前) 存储float类型的值</p>
<p>编号5 CONSTANT_long_info</p>
<p>Tag5</p>
<p>Bytes 8个字节 Big_Endian(高位在前) 存储long类型的值</p>
<p>编号6 CONSTANT_double_info</p>
<p>Tag6</p>
<p>Bytes 8个字节 Big_Endian(高位在前) 存储double类型的值</p>
<p>编号7 CONSTANT_Class_info</p>
<p>Tag7</p>
<p>Index 2个字节 指向类的全限定名的项的索引</p>
<p>类和接口符号引用</p>
<p>编号8 CONSTANT_String_info</p>
<p>Tag8</p>
<p>Index 2个字节 指向字符串的字面量的索引</p>
<p>编号9 CONSTANT_Fieldref_info</p>
<p>Tag9</p>
<p>Index 2个字节 指向声明字段的类或接口的描述符 CONSTANT_Class_info的索引项</p>
<p>Index 2个字节 指向字段描述符CONSTANT_NameAndType的索引项</p>
<p>字段的符号引用</p>
<p>编号10 CONSTANT_Methodref_info</p>
<p>Tag10</p>
<p>Index 2个字节 指向声明字段的类或接口的描述符 CONSTANT_Class_info的索引项</p>
<p>Index 2个字节 指向字段描述符CONSTANT_NameAndType的索引项</p>
<p>类中方法的符号引用</p>
<p>编号11 CONSTANT_InterfaceMethodref_info</p>
<p>Tag11</p>
<p>Index 2个字节 指向声明字段的类或接口的描述符 CONSTANT_Class_info的索引项</p>
<p>Index 2个字节 指向字段描述符CONSTANT_NameAndType的索引项</p>
<p>接口中方法的符号引用</p>
<p>编号12 CONSTANT_NameAndType</p>
<p>Tag12</p>
<p>Index 2个字节 指向该字段或方法名称常量项的索引<br> Index 2个字节 指向该字段或方法描述符常量项的索引</p>
<p>字段或方法的符号引用</p>
<p>编号15 CONSTANT_MethodHandler_info</p>
<p>Tag15</p>
<p>Reference_kind 1个字节 1-9之间的一个值 决定了方法句柄的类型。方法句柄类型的值表示方法句柄的字节码行为</p>
<p>Reference_index 2个字节 对常量池的有效索引。</p>
<p>表示方法句柄</p>
<p>编号16 CONSTANT_MethodType_info</p>
<p>Tag16</p>
<p>Descriptor_index 2个字节 指向UTF8_info 结构表示的方法描述符</p>
<p>编号18CONSTANT_InvokeDynamic_info</p>
<p>Tag18</p>
<p>Bootstrap_method_attr_index: 2个字节 当前class文件中引导方法表的bootstrap_methods[] 数组的有效索引</p>
<p>Name_and_type_index: 2个字节 指向NameAndType_info 表示方法名和方法描述符。</p>
<p>表示动态方法的调用点。</p>
</blockquote>
<p><em>例：案例解析见视频</em></p>
<p><em>附录信息：案例中常量池中有31个常量信息，第一个是Constant_methodref_info 为方法引用信息</em></p>
<p><em>#5类名 指向常量池第五个的信息 —Object的类的信息，</em></p>
<p><em>#19名字和描述符 CONSTANT_NameAndType_info</em></p>
<p><em>关于init字样，是一个构造方法</em></p>
<p><em>关于()V</em> </p>
<p><em>() 表示方法没有参数</em></p>
<p><em>V 表示void 方法没有返回值。</em></p>
<p><em><strong>常量池中classfile的表示形式：</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cafe babe 0000 0034 0020 0a00 0500 1309</span><br><span class="line">0014 0015 0a00 1600 1707 0018 0700 1901</span><br><span class="line">0006 3c69 6e69 743e 0100 0328 2956 0100</span><br><span class="line">0443 6f64 6501 000f 4c69 6e65 4e75 6d62</span><br><span class="line">6572 5461 626c 6501 0012 4c6f 6361 6c56</span><br><span class="line">6172 6961 626c 6554 6162 6c65 0100 0474</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>第1个常量池</p>
<p>从0a00 那么0a对应的是十进制的10 这个10映射到常量表中的Tag10的标志 CONSTANT_Methodref_info;</p>
<p>0005 表示 index 2个字节 指向声明方法的类或接口的描述符#5 CONSTANT_Class_info的索引项。指向#5行的内容。</p>
<p>0013 13 转成十进制是19 指向#19行的内容是，表示的index2个字节 指向字段描述符CONSTANT_NameAndType_info的索引项</p>
<p>那么以上的常量池是5个字节。</p>
<p>第2个常量池</p>
<p> 从09 开始 09对应的是十进制9 这个9映射到Tag9的标志 </p>
<p>CONSTANT_Fieldref_info;</p>
<p> 0014 对应的十进制是20 对应的#20的内容</p>
<p> 0015 对应十进制是21 对应的就是#21的内容</p>
<p>第3个常量池</p>
<p> 从0a开始那么0a对应的是十进制的10 这个10映射到常量表中的Tag10的标志 CONSTANT_Methodref_info;</p>
<p>0016 —-十进制22 对应#22行的内容</p>
<p>0017 —-十进制23 对应的#23行的内容</p>
<p>第4个常量池</p>
<p>  从07开始 对应的tag7 CONSTANT_Class_info</p>
<p>0018 —- 十进制24 对应着#24的内容 表示的是this_class</p>
<p>第5个常量池</p>
<p>从07开始 对应的tag7 CONSTANT_Class_info</p>
<p>0019 —- 十进制25 对应着#25的内容 表示的是super_class</p>
<p>第6个常量池</p>
<p> 01 —-CONSTANT_UTF8_INFO</p>
<p>0006 表示占用的字节数和长度</p>
<p>3c69 6e69 743e 表示字符串内容的字节。init字符串的构造方法</p>
<p>这段总共是9个字节。</p>
<p>第7个常量池</p>
<p>01 —-CONSTANT_UTF8_INFO</p>
<p>0003 表示常量池第七个常量的字符串长度占用的字节</p>
<p>28 2956 表示 ()V构造方法 V表示无返回值</p>
<p>这段总共6个字节。</p>
<p><strong>Method属性</strong></p>
<p>Method属性包含三个字段值</p>
<p>名称access_flag 类型u2 数量1个attributes_count 1</p>
<p>名称 name_index 类型u2 数量1个 attribute_info attributes —-attributes_count</p>
<p>名称 descriptior_index 类型u2 数量1个</p>
<p>descriptior_index</p>
<ol>
<li><p>参数列表(参数类型) 后-返回值</p>
</li>
<li><p>void m() 等同于 ()V</p>
</li>
<li><p>String toString() -&gt;()Ljava&#x2F;lang&#x2F;String；</p>
</li>
<li><p>Long pos(int[] arr1,int arr2,long length) -&gt;([IIJ)J</p>
</li>
</ol>
<ul>
<li><em><strong>字段类型(Field Type)</strong></em></li>
<li><em><strong>基本数据类型(Base Type)</strong></em><ul>
<li><em><strong>B –byte 有符号的字节型数</strong></em></li>
<li><em><strong>C –char Unicode字符，UTF-16编码</strong></em></li>
<li><em><strong>D –double，双精度浮点数</strong></em></li>
<li><em><strong>F –float，单精度浮点数</strong></em></li>
<li><em><strong>I –int，整型数</strong></em></li>
<li><em><strong>J –long，长整型</strong></em></li>
<li><em><strong>S –short，有符号短整型</strong></em></li>
<li><em><strong>Z –boolean，布尔值。true&#x2F;false</strong></em></li>
</ul>
</li>
<li><em><strong>对象引用类型(Object Type) –L Classname; –一个名为<Classname>的实例</strong></em></li>
<li><em><strong>数组类型(Object Type) –[ –表示一个数组的引用</strong></em></li>
</ul>
<p>[ 一维数组</p>
<p>[[ 表示二维数组</p>
<p>关于attributes_count 附加属性的数量</p>
<p>关于 attributes  附加属性</p>
<p>第8个常量池</p>
<p> 01 —-CONSTANT_UTF8_INFO</p>
<p> 0004 表示常量池第八个常量的字符串长度占用的字节</p>
<p>43 6f 64 65 表示 code字符串内容</p>
<p>这段总共是7个字节</p>
<p><strong>Fields属性</strong></p>
<p>名称access_flag 类型u2 数量1个attributes_count 1</p>
<p>同method属性</p>
<p>名称 name_index 类型u2 数量1个 attribute_info attributes —-attributes_count</p>
<p>名称 descriptior_index 类型u2 数量1个</p>
<p>同method属性值。</p>
<p>关于attributes_count 附加属性的数量</p>
<p>关于 attributes  附加属性</p>
<p>第9个常量池LineNumberTable 是在后面要使用的常量的名字，在code当中被引用到。</p>
<p>第10个常量池LocalVariableTable是在后面要使用的常量的名字，在code当中被引用到。</p>
<p>第11个常量池 指向的字符串面值this</p>
<p>第12个常量池 表示整个类的类名称</p>
<p>第13个常量池内容 表示的是main方法的字符串名称</p>
<p>第14个常量池内容 表示的是main方法中的参数 字符串数组 无返回值</p>
<p>第15个常量池 main方法的参数名称的字符串字面量</p>
<p>第16个常量池 mian方法中参数类型的字符串字面量值</p>
<p>第17个常量池 SourceFile 对应后面的附加属性的SourceFile 表示的是源文件的索引</p>
<p>第18个常量池内容 表示的是源文件的名称的字符串字面值</p>
<p>第19个常量池 CONSTANT_NameAndType_info 对应6号常量池构造方法的名字和7号常量池  方法的参数和返回值</p>
<p>第20个常量池 CONSTANT_Class_info 对应的System类 对应了26号常量池的System的字面值</p>
<p>第21个常量池 CONSTANT_NameAndType_info 对应的是27号常量池 out字面值属性的名称，对应了28号常量池的PrintStream的类的字符串字面值。</p>
<p>从22个开始到31个，按照字面意思去理解就可以了。</p>
</blockquote>
<p><em>注意：可以右击code显示JVM规范</em></p>
<p><strong>Interfaces</strong> <strong>和</strong> <strong>Fields</strong> <strong>选项</strong> <strong>method</strong> <strong>选项</strong> </p>
<p>因为案例中没有声明接口和成员变量，所以对应没有展开选项 </p>
<p>由于有两个 method：</p>
<ol>
<li>init无参的构造方法 –默认提供的构造方法</li>
<li>主函数 main</li>
</ol>
<p><strong>方法中的 access_flag</strong></p>
<p>方法访问标志：</p>
<table>
<thead>
<tr>
<th>标志名称</th>
<th>标志值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>ACC_PUBLIC</td>
<td>0x0001</td>
<td>方法是否为public</td>
</tr>
<tr>
<td>ACC_PRIVATE</td>
<td>0x0002</td>
<td>方法是否为private</td>
</tr>
<tr>
<td>ACC_PROTECTED</td>
<td>0x0004</td>
<td>方法是否为protected</td>
</tr>
<tr>
<td>ACC_STATIC</td>
<td>0x0008</td>
<td>方法是否为static</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td>0x0010</td>
<td>方法是否为final</td>
</tr>
<tr>
<td>ACC_SYNCHRONIZED</td>
<td>0x0020</td>
<td>方法是否为synchronized</td>
</tr>
<tr>
<td>ACC_BRIDGE</td>
<td>0x0040</td>
<td>方法是否是由编译器产生的桥接方法</td>
</tr>
<tr>
<td>ACC_VARARGS</td>
<td>0x0080</td>
<td>方法是否接受不定参数</td>
</tr>
<tr>
<td>ACC_ NATIVE</td>
<td>0x0100</td>
<td>方法是否为native</td>
</tr>
<tr>
<td>ACC_ABSTRACT</td>
<td>0x0400</td>
<td>方法是否为abstract</td>
</tr>
<tr>
<td>ACC_STRICTFP</td>
<td>0x0800</td>
<td>方法是否为strictfp</td>
</tr>
<tr>
<td>ACC_SYNTHETIC</td>
<td>0x1000</td>
<td>方法是否是由编译器自动产生的</td>
</tr>
</tbody></table>
<p><strong>attributes_count</strong> <strong>和</strong> <strong>attribute附加属性</strong> </p>
<p>方法中的附加属性就是 code，code在这里是比较重要的概念，code是指具体代码的实现，当我们写入方法的时候，它就能把方法中代码转化为一条条指令。</p>
<p>在官方文档中 有很多十六进制数字 它们对应方法中code的内容实现 可以鼠标右击 显示JVM规范</p>
<p><strong>Attributes 附加属性</strong></p>
<ol>
<li>既有预定义的属性，也可以自定义 java 虚拟机会自动忽略它不认识属性</li>
<li>Code表示的是方法表 方法表能够编译成字节码指令，还存放了操作数栈和局部变量的信息</li>
</ol>
<blockquote>
<p>u2 attribute_name_index 指向常量池中的 CONSTANT_UTF8_info 存放的当前属性的名字就 </p>
<p>是 code。 </p>
<p>u4 attribute_length 表示的 code 属性的长度 （不包括前 6 个字节）。 </p>
<p>u2 max_stack 指定当前方法被执行引擎执行的时候，在栈帧中需要分配的操作数栈的大小 </p>
<p>u2 max_locals 指定当前方法被执行引擎执行的时候，在栈帧中需要分配的局部变量表的大 </p>
<p>小</p>
<p>u4 code_length 指定方法字节码的长度， class 文件中每条字节码都占用一个字节 </p>
<p>u1 code 存放字节码指令本身，它的长度是 code_length 个字节。 </p>
<p>U2 exception_table_length 指定异常表的大小 </p>
<p>Exception_table 异常表 作用对 try-catch-finally 的描述，可以把它看成是一个数组。每一个 </p>
<p>数组项都是一个 exception_info 结构， 一般来说每个 catch 块对应一个 exception_info,编译 </p>
<p>器也可能会对当前的方法生成一些 exception_info.</p>
<p>U2 start_pc 是从字节码 code 属性中的一部分 起始处到当前异常处理器的起始处的偏移量 </p>
<p>量</p>
<p>u2 end_pc 从字节码起始处到当前异常处理器 末尾的偏移量 </p>
<p>u2 handler_pc 是指当前异常处理器用于处理异常（即 catch 块）的第一条指令相对于字节码 </p>
<p>开始处的偏移量。 </p>
<p>U2 catch_type 是常量池的索引 指向的是常量池 CONSTANT-Class_info 数据项，描述了 catch </p>
<p>块中的异常类型的信息。这个类必须是 java.lang.Throwable 的或者是它的子类。 </p>
<p>总结： </p>
<p>如果偏移量从 start_pc 到 end_pc 之间，如果字节码出现了 catch_type 所描述的异常，那么 </p>
<p>就跳转偏移量到 handler_pc 的字节码中去执行。如果 catch_type 为 0 就代表不引用任何常 </p>
<p>量池的信息，那么这个 exception_info 用于实现 finally 的子句。 </p>
<p>U2 attribute_count 表示的是 code 属性中存在的其他属性的个数。会出现在 class 中的属性， </p>
<p>在 field 属性也有，在 method 属性也有 </p>
<p>Attributes 可以把它看成是个数组，里面存放了 code 属性的其他属性。 </p>
<p>ConstantValue —-字段表 final 关键字自定义的常量值 </p>
<p>Deprecated —类 方法表 字段表 </p>
<p>Exception 异常表 </p>
<p>EnclosingMethod 类文件 局部类或匿名类的外部封装方法 </p>
<p>InnerClass 类文件 内部类列表 </p>
<p>可选属性 </p>
<p>LineNumberTable 源码的行号和字节码行号的对应关系 可以把这个属性看成是一个数组， </p>
<p>数组中的每项 LineNumberinfo 结构描述了一条字节码和源码行号的对应关系 </p>
<p>LocalVariableTable 建立了方法中的局部变量与源代码中的局部变量的对应关系。</p>
</blockquote>
<h2 id="Chapter3-类加载和初始化"><a href="#Chapter3-类加载和初始化" class="headerlink" title="Chapter3  类加载和初始化"></a>Chapter3  类加载和初始化</h2><p>涉及面试题：</p>
<ol>
<li>描述一下类加载器的层次</li>
<li>双亲委派流程</li>
<li>为什么要双亲委派</li>
</ol>
<p>class文件是如何加载到内存中的 并且是如何执行的</p>
<h3 id="3-1-Class-Cycle"><a href="#3-1-Class-Cycle" class="headerlink" title="3.1 Class Cycle"></a>3.1 Class Cycle</h3><p>Class文件存储在硬盘中 是如何加载到内存中的 其主要步骤如下：</p>
<ol>
<li><p>Loading步骤<br>Loading是将本地classfile的二进制内容加载到内存中</p>
</li>
<li><p>Linking步骤</p>
<ul>
<li><p>Verification 校验</p>
<p>Verification 的主要过程就是用来校验，如何加载的文件字节码头不是CAFEBABE，该过程就会被直接拒绝</p>
</li>
<li><p>Preparation 静态变量赋默认值</p>
<p>Preparation 过程的主要作用就是将静态变量赋默认值，假设定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">8</span>;</span><br></pre></td></tr></table></figure>

<p>在这个过程中并不是将 i 的值赋值成8，而是对静态变量 i 进行默认值的赋值 也就是0</p>
</li>
<li><p>Resolution 判断符号位</p>
<p>Resolution 过程是将class文件中常量池用到的一些符号引用转换为内存地址</p>
</li>
</ul>
</li>
<li><p>Initializing步骤</p>
<p>在Initializing步骤中静态变量会进行赋值成初始值，同时在这个步骤中会调用静态代码块</p>
</li>
</ol>
<h3 id="3-2-ClassLoader"><a href="#3-2-ClassLoader" class="headerlink" title="3.2 ClassLoader"></a>3.2 ClassLoader</h3><p>JVM本身有类加载器，这个类加载器表现形式就是普通的class，此加载器的层次就是用来加载不同的class</p>
<p><em><strong>注意：任何一个classfile被加载到内存中都会存在两个部分</strong></em></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220801140111683.png" alt="image-20220801140111683"></p>
<ol>
<li><em><strong>第一部分 二进制的classfile确实被load进内存中</strong></em></li>
<li><em><strong>第二部分 生成的class类对象，class中还会存在其他对象，引用到class对象，而class类对象指向classfile的内存加载器</strong></em></li>
</ol>
<blockquote>
<p><em>扩展：Class对象究竟存储在哪里？</em></p>
<p><em>Class对象存储在metaspace中</em></p>
<p><em>Metaspace 是 JDK1.8 版本出现的，Metaspace 就是方法区 methodarea 1.8 版本移出了永久代，原本在 1.8 版本之前 PermGenerationspace 部分变更成了metaspace 而这两个地方指代 的都是方法区</em></p>
</blockquote>
<p>怎么才能够知道哪些类是由哪些加载器进行加载的？</p>
<table>
<thead>
<tr>
<th>类加载器层次</th>
<th>作用</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>第一层（最顶）层加载器 BootstrapClassLoader</td>
<td>负责加载lib&#x2F;rt.jar charset.jar等核心类（由C++实现）。其主要负责加载jdk中最核心的jar，例如runtime.jar或者是平时常见的String.class、Object.class 它们都是位于lib&#x2F;rt.jar中的</td>
<td>其调用最顶层加载器 由于其使用C++实现，故而在Java的类中并没有这样一个对象去应对他 所以会出现null值</td>
</tr>
<tr>
<td>第二层 加载器 ExtClassLoader</td>
<td>用于加载扩展的jar包，jre&#x2F;lib&#x2F;ext&#x2F;*.jar或由-Djava.ext.dirs 指定</td>
<td></td>
</tr>
<tr>
<td>第三层 加载器AppClassLoader</td>
<td>加载 classpath 指定的内容</td>
<td></td>
</tr>
<tr>
<td>第四层 自定义加载器  Custom ClassLoader</td>
<td>加载自定义的类的内容</td>
<td></td>
</tr>
</tbody></table>
<p><em>类加载器的加载过程被称为双亲委派</em></p>
<p><strong>双亲委派中存在一个父加载器的概念</strong></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220801140941306.png" alt="image-20220801140941306"></p>
<p><em>加载器图中描述的是语法上的一种继承关系 而此继承关系与父加载器没有关系</em></p>
<p>&#x3D;&#x3D;父类加载器&#x3D;&#x3D;是如何理解的：注意父加载器不是继承关系 <em><strong>父加载器指代的是ClassLoader源码中有一个变量类型为ClassLoader类型 名称为parent</strong></em></p>
<h3 id="3-3-双亲委派"><a href="#3-3-双亲委派" class="headerlink" title="3.3 双亲委派"></a>3.3 双亲委派</h3><p><em>双亲委派是类加载器的一个加载过程 &#x3D;&#x3D;双亲委派本身是被写死的&#x3D;&#x3D;</em></p>
<p><strong>双亲委派是通过递归来实现的</strong></p>
<p>class文件加载到内存当中先通过Custom ClassLoader进行判断是否已加载。如果没有加载 则会进行向上检查这个类是否被加载了。当检查到这个类没有被Custom ClassLoader加载时 就会进行一个向上委托。从而使AppClassLoader来进行加载 然后重复操作，直至顶层加载器BootstrapClassLoader。顶层加载器BootstrapClassLoader在进行检查是否为自己负责可以加载的部分，若不是顶层负责的则又会向下委托。当自下而上 自上而下都跑完之后 如果当所有下级都没有加载 则会抛出异常 ClassNotFoundException</p>
<blockquote>
<p>如果一个类加载器收到了加载某个类的请求，则该类加载器并不会去加载该类，而是把这个请求委派给父类加载器，每一个层次的类加载器都是如此。因此所有类加载器请求最终都会传送到顶端的启动类加载器；只有当父类加载器在其搜索范围内无法找到所需的类，并将该结果反馈给子类加载器，子类加载器会尝试去自己加载</p>
</blockquote>
<p><em>双亲：指一个从子到父的过程 与一个从父到子的过程</em></p>
<p><em>委派：当前加载器进行加载 委托上级去完成</em></p>
<blockquote>
<p>向上委派时，父类加载器都是到Cache缓存中寻找。可以将这个Cache缓存理解成一个list或者一个数组</p>
</blockquote>
<p>&#x3D;&#x3D;为什么需要使用双亲委派？&#x3D;&#x3D;</p>
<p><em>双亲委派机制的优势：</em> <strong>沙箱安全机制保证核心class文件不被篡改</strong>和<strong>避免类class的重复加载</strong></p>
<p>沙箱安全机制：<em>如果有人想替换系统级别的类：String.java。篡改它的实现，在这种机制下这些系统的类已经被Bootstrap classLoader加载过了（当一个类需要加载的时候，最先去尝试加载的就是BootstrapClassLoader），<strong>而对于任意一个类，都需要由加载它的类加载器和这个类本身一同确立其在Java虚拟机中的唯一性</strong>，所以其他类加载器并没有机会再去加载，从一定程度上防止了危险代码的植入。</em></p>
<blockquote>
<p>保证核心class文件不被篡改，即使被篡改了也不会被加载，即便被加载了也不会是同一个class对象 确保了class的执行安全</p>
</blockquote>
<p>避免类的重复加载：当父ClassLoader已经加载了该类的时候，就不需要子ClassLoader再加载一次</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220801135651212.png" alt="image-20220801135651212"></p>
<p>全盘负责委托机制：当一个ClassLoader加载一个类的时候，除非显示使用另一个ClassLoader，否则该类所依赖和引用的类也是由这个ClassLoader载入</p>
<h3 id="3-4-父加载器"><a href="#3-4-父加载器" class="headerlink" title="3.4 父加载器"></a>3.4 父加载器</h3><p>&#x3D;&#x3D;父类加载器&#x3D;&#x3D;是如何理解的：注意父加载器不是继承关系 <em><strong>父加载器指代的是ClassLoader源码中有一个变量类型为ClassLoader类型 名称为parent</strong></em></p>
<p><em>父加载器不是类加载器的加载器，也不是加载器父类的加载器</em></p>
<h3 id="3-5-类加载器范围"><a href="#3-5-类加载器范围" class="headerlink" title="3.5 类加载器范围"></a>3.5 类加载器范围</h3><p>案例结果：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sun.misc.Launcher$AppClassLoader@18b4aac2</span><br><span class="line">null</span><br><span class="line">sun.misc.Launcher$ExtClassLoader@4554617c</span><br><span class="line">null</span><br></pre></td></tr></table></figure>

<p>从案例执行结果中 可以看出AppClassLoader与ExtClassLoader都是Launcher的内部类。Launcher是ClassLoader的包装类或者启动类</p>
<p>从翻看Launcher源码可以看到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">bootClassPath</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;sun.boot.class.path&quot;</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">var1</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;java.class.path&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">var0</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;java.ext.dirs&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>sun.boot.class.path 是BootstrapClassloader的加载路径</li>
<li>java.class.path 是AppClassloader的加载路径</li>
<li>java.ext.dirs 是ExtClassLoader的加载路径</li>
</ul>
<p>查看类加载器范围结果代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sun.misc.Launcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo07</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">pathBoot</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;sun.boot.class.path&quot;</span>);</span><br><span class="line">        System.out.println(pathBoot.replaceAll(<span class="string">&quot;;&quot;</span>,System.lineSeparator()));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;---------------------------------&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">pathExt</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;java.ext.dirs&quot;</span>);</span><br><span class="line">        System.out.println(pathExt.replaceAll(<span class="string">&quot;;&quot;</span>,System.lineSeparator()));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;---------------------------------&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">pathApp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;java.class.path&quot;</span>);</span><br><span class="line">        System.out.println(pathApp.replaceAll(<span class="string">&quot;;&quot;</span>,System.lineSeparator()));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220801212453081.png" alt="image-20220801212453081"></p>
<p>查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\resources.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\rt.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\sunrsasign.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\jsse.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\jce.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\charsets.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\jfr.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\classes</span><br><span class="line">---------------------------------上为Bootstrap ClassLoader</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext</span><br><span class="line">C:\WINDOWS\Sun\Java\lib\ext</span><br><span class="line">---------------------------------上为Extension ClassLoader</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\charsets.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\deploy.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext\access-bridge-64.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext\cldrdata.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext\dnsns.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext\jaccess.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext\jfxrt.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext\localedata.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext\nashorn.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext\sunec.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext\sunjce_provider.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext\sunmscapi.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext\sunpkcs11.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\ext\zipfs.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\javaws.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\jce.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\jfr.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\jfxswt.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\jsse.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\management-agent.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\plugin.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\resources.jar</span><br><span class="line">D:\JAVA\jdk1.8_0_211\jre\lib\rt.jar</span><br><span class="line">----------------------------------上为Application ClassLoader</span><br><span class="line"></span><br><span class="line">E:\aPersonalData\Temporary\Test01\out\production\Test01</span><br><span class="line">D:\IntelliJ IDEA\IntelliJ IDEA 2021.2.3\lib\idea_rt.jar</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>对于虚拟机，只有两种不同的类加载器：</p>
<p>1.启动类加载器(Bootstrap ClassLoader)，这个类加载器使用C++语言实现，是虚拟机自身的一部分；</p>
<p>2.其它所有的类加载器，这些类加载器都由Java语言实现，独立于虚拟机外部，并且全部继承自java.lang.ClassLoader。</p>
<p>具体划分，如下：</p>
<ol>
<li>启动类加载器(Bootstrap ClassLoader)：这个类加载器负责将放置在<JAVA_HOME>\lib目录中的，或者被-Xbootclasspath参数所指定路径中的，并且是虚拟机能识别的(仅按照文件名识别，如rt.jar，名字不符合的类库即使放置在lib目录中也不会被加载)类库加载到虚拟机内存中。启动类加载器无法被Java程序直接使用，因为是C++语言实现的。</li>
<li>扩展类加载器(Extension ClassLoader)：这个类加载器由sun.misc.Launcher$ExtClassLoader实现，它负责加载<JAVA_HOME>\lib\ext目录中的，或者被java.ext.dirs系统变量所指定的路径中的所有类库，开发者可以直接使用扩展类加载器。</li>
<li>应用程序类加载器(Application ClassLoader)：这个类加载器由sum.misc.Launcher.$AppClassLoader来实现。由于这个类加载器是ClassLoader中的getSystemClassLoader()方法的返回值，所以一般也被称为系统类加载器。它负责加载用户类路径上所指定的类库（classPath），开发者可以直接使用这个类加载器，如果应用程序中没有自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器。</li>
</ol>
</blockquote>
<h3 id="3-6-自定义加载器"><a href="#3-6-自定义加载器" class="headerlink" title="3.6 自定义加载器"></a>3.6 自定义加载器</h3><p>手动加载类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassLoaderTest04</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> ClassLoaderTest04.class.getClassLoader().loadClass(<span class="string">&quot;com.openlab.Person&quot;</span>);</span><br><span class="line">        System.out.println(clazz.getName());</span><br><span class="line"><span class="comment">//       类加载器也可以用来加载资源</span></span><br><span class="line"><span class="comment">//       ClassLoaderTest04.class.getClassLoader().getResourceAsStream();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这种加载方式 通常使用在 </p>
<ul>
<li>Tomcat 加载 Servlet</li>
<li>Spring 框架中加载ApplicationContext</li>
<li>在写一些类库或修改底层框架时 常会使用到</li>
</ul>
<p><em>用于在于 根据需求 调用相对应的方法加载某个类 、</em></p>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve)</span><br><span class="line">    <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 加锁</span></span><br><span class="line">    <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">        <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">t0</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//继续使用parent的classloader 递归调用loadClass方法</span></span><br><span class="line">                <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">                    c = parent.loadClass(name, <span class="literal">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    c = findBootstrapClassOrNull(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用findClass方法去找class</span></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                <span class="comment">// to find the class.</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">t1</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">                c = findClass(name);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">            resolveClass(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>实现自定义加载器步骤：</p>
<ol>
<li><p>继承ClassLoader</p>
</li>
<li><p>重写模板方法 findClass</p>
</li>
<li><p>调用defineClass方法</p>
</li>
</ol>
<blockquote>
<p>实现需求：从目录中读取class文件 将class文件通过自定义加载器进行加载 –利用IO流</p>
</blockquote>
<p>针对问题优化：–由于Java语言容易被反编译</p>
<ul>
<li>如何防止反编译</li>
<li>如何防止篡改</li>
</ul>
<p>解决方案 –在自定义加载器中对class文件进行加密 解密</p>
<p>自定义加载器代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MacluClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">                <span class="string">&quot;c:/test&quot;</span>,</span><br><span class="line">                name.replaceAll(<span class="string">&quot;.&quot;</span>,<span class="string">&quot;/&quot;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((b = fis.read())!=<span class="number">0</span>)&#123;</span><br><span class="line">                baos.write(b);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="type">byte</span>[] bytes = baos.toByteArray();</span><br><span class="line"></span><br><span class="line">            baos.close();</span><br><span class="line">            fis.close();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> defineClass(name,bytes,<span class="number">0</span>,bytes.length);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="built_in">super</span>.findClass(name);<span class="comment">// throw ClassNotFoundException</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, IllegalAccessException, InstantiationException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MacluClassLoader</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> cl.loadClass(<span class="string">&quot;com.openlab.Person&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) clazz.newInstance();</span><br><span class="line">        person.m();</span><br><span class="line"></span><br><span class="line">        System.out.println(cl.getClass().getClassLoader());</span><br><span class="line">        System.out.println(cl.getParent());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过定义自己格式的classloader（一般情况下class文件就是一个二进制文件流）可以采用一种比较简单的方式对class文件进行加密和解密</p>
<ul>
<li><p>加密： 通过^ 异或 可以定义 一个数字 在读取每一个字节后写入操作时，使用流里面获取到的数据和这个数字进行异或的算法， 从而进行加密的操作</p>
</li>
<li><p>解密: 字节数字 ^ 这个数字 ^ 这个数字 就完成了解密的操作</p>
</li>
</ul>
<p>自定义加载器 并实现 加密 - 解密  代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MacluClassLoaderWithEncription</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">seed</span> <span class="operator">=</span> <span class="number">0B10110110</span>; <span class="comment">// 进行参加加密算法的数字</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">                <span class="string">&quot;c:/test&quot;</span>,</span><br><span class="line">                name.replaceAll(<span class="string">&quot;.&quot;</span>,<span class="string">&quot;/&quot;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((b = fis.read())!=<span class="number">0</span>)&#123;</span><br><span class="line">                baos.write(b^seed);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">byte</span>[] bytes = baos.toByteArray();</span><br><span class="line"></span><br><span class="line">            baos.close();</span><br><span class="line">            fis.close();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> defineClass(name,bytes,<span class="number">0</span>,bytes.length);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.findClass(name);<span class="comment">// throw ClassNotFoundException</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, IllegalAccessException, InstantiationException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        encFile(<span class="string">&quot;com.openlab.Person&quot;</span>);</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MacluClassLoaderWithEncription</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> cl.loadClass(<span class="string">&quot;com.openlab.Person&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) clazz.newInstance();</span><br><span class="line">        person.m();</span><br><span class="line"></span><br><span class="line">        System.out.println(cl.getClass().getClassLoader());</span><br><span class="line">        System.out.println(cl.getParent());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">encFile</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">                <span class="string">&quot;c:/test/&quot;</span>,</span><br><span class="line">                name.replace(<span class="string">&quot;.&quot;</span>,<span class="string">&quot;/&quot;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;c:/test&quot;</span>,name.replaceAll(<span class="string">&quot;.&quot;</span>,<span class="string">&quot;/&quot;</span>).concat(<span class="string">&quot;.macluclass&quot;</span>)));</span><br><span class="line">        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((b = fis.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">            fos.write(b^seed);</span><br><span class="line">        &#125;</span><br><span class="line">        fis.close();</span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-7-编译器-JIT"><a href="#3-7-编译器-JIT" class="headerlink" title="3.7 编译器 JIT"></a>3.7 编译器 JIT</h3><p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220802145305626.png" alt="image-20220802145305626"></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220802145053434.png" alt="image-20220802145053434"></p>
<p>Java：</p>
<ul>
<li>解释器： bytecode-interpreter</li>
<li>即时编辑器：JIT Just In Time compiler</li>
</ul>
<p>java程序执行流程：</p>
<p>x.java –&gt;javac 通过编译 –&gt; x.class –&gt;classfile 通过 classloader 进行加载（期间需要类库的支持）–&gt; 加载后 通过两个方式 ：解释器 与JIT 即时编译器 执行</p>
<ul>
<li>解释器 通过解释class文件 进行执行</li>
<li>即使编译器 将class文件变成本地文件 –例如windows中 .exe 文件</li>
</ul>
<p>引出问题：Java是解释型语言还是编译型语言？</p>
<p>Java可以使用 编译器 进行编译执行 同样可以使用 解释器 进行解释执行 主要根据需求来对JVM进行参数设置</p>
<p><strong>&#x3D;&#x3D;Java程序执行默认是一种混合模式&#x3D;&#x3D;</strong></p>
<ul>
<li><p>混合模式：使用解释器+热点编辑器 hotspot</p>
<p>起始阶段采用解释来执行 同时伴有 热点代码的检测 默认值为10000</p>
<ul>
<li><p>多次被调用的方法(通过方法计数器检测 ：检测方法的执行频率)</p>
</li>
<li><p>多次被调用的循环(通过循环计数器检测 ：检测循环的执行频率)</p>
</li>
</ul>
</li>
</ul>
<p><strong>当这样的一个循环或者是一个方法，或者是一段代码，被多次调用，判定这段代码执行频率特别高的情况下，就将这段代码编译成本地的代码，在下次直接访问的时候，直接访问本地的代码。不需要解释器对其进行解释执行。从而达到效率的提升。这种执行代码的方式被称为混合模式。</strong></p>
<p>为什么不直接编译成本地代码，编译的执行速度更快？能够提高效率？</p>
<ol>
<li>现在的解释器的执行效率已经是非常高了，对于一些简单的代码执行，它的性能并不输于编译器。</li>
<li>当要执行的程序依赖类库特别多的情况下，在虚拟机中编译一遍，会导致启动过程会非常的缓慢。</li>
</ol>
<p>更改JVM执行代码参数：</p>
<ul>
<li><p>-Xmixed 为混合模式：</p>
<p> 开始解释执行，启动速度比较快，对热点代码进行检测和编译。</p>
</li>
<li><p>-Xint 解释模式</p>
<p> 启动速度很快，执行较慢</p>
</li>
<li><p>-Xcomp 纯编译模式</p>
<p>启动较慢，执行较快</p>
</li>
</ul>
<p>代码案例：测试这三个jvm参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WayToRunTest01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="comment">//这段代码被短时间执行很多次，请JVM虚拟机对其进行优化</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i&lt;<span class="number">10_0000</span>;i++)</span><br><span class="line">            m();</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i&lt;<span class="number">10_0000</span>;i++)&#123;</span><br><span class="line">            m();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(end-start);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 该方法本身没有意义，就是耗时间用的。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i&lt;<span class="number">10_0000L</span>;i++)&#123;</span><br><span class="line">             <span class="type">long</span> <span class="variable">j</span> <span class="operator">=</span> i%<span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>默认混合模式：2345</p>
<p>-Xint 解释模式：6522</p>
<p>-Xcomp纯编译模式：5973</p>
<h3 id="3-8-懒加载"><a href="#3-8-懒加载" class="headerlink" title="3.8 懒加载"></a>3.8 懒加载</h3><p>classfile加载到工程中 一共有三个部分</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220802150756088.png" alt="image-20220802150756088"></p>
<p>initializing 实际上为 lazyInitializing 懒加载 严格上讲 应该是懒初始化</p>
<p>扩展：JVM规范中并没有规定什么时候加载 但是严格规定了初始化的规则  以下情况需要执行初始化</p>
<ol>
<li><p>New对象  getstatic 访问静态变量  putstatic 访问静态实例 invokestatic指令</p>
<p>以上指令是必须要初始化这个类  访问final变量除外</p>
</li>
<li><p>反射调用的时候 必须要初始化这个类</p>
</li>
<li><p>初始化子类的时候 首先父类初始化</p>
</li>
<li><p>虚拟机启动时 被执行的主类必须要初始化</p>
</li>
<li><p>动态语言支持java.lang.invoke.MethodHandler解析结果为REF-getstatic REF-putstatic REF-invokestatic的方法句柄时 该类必须要初始化</p>
</li>
</ol>
<p>案例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyLoadingTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"><span class="comment">//        P p;</span></span><br><span class="line"><span class="comment">//        X x = new X();</span></span><br><span class="line"><span class="comment">//        System.out.println(P.i);</span></span><br><span class="line"><span class="comment">//        System.out.println(P.j);</span></span><br><span class="line">        Class.forName(<span class="string">&quot;com.openlab.LazyLoadingTest$P&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">P</span>&#123;</span><br><span class="line">        <span class="keyword">final</span>  <span class="keyword">static</span> <span class="type">int</span> i=<span class="number">8</span>;<span class="comment">// 打印final的值是不需要加载整个类的</span></span><br><span class="line">        <span class="keyword">static</span> <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">9</span>;</span><br><span class="line">        <span class="keyword">static</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;P&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">X</span> <span class="keyword">extends</span> <span class="title class_">P</span>&#123;</span><br><span class="line">        <span class="keyword">static</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;X&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>面试题：如何打破classloader的双亲委派机制？</p>
</blockquote>
<p>主要思想 策略：重写Classloader中的loadClass方法 而不是findClass方法</p>
<p>重写Classloader就能够打破双亲委派的机制</p>
<p>&#x3D;&#x3D;什么时候需要打破需要去打破双亲委派的机制？&#x3D;&#x3D;</p>
<ol>
<li>在JDK1.2版本之前 要自定义classloader 必须要重写loadClass方法</li>
<li>在一个线程中设定自己的线程上下文的加载器对象 ThreadContextClassLoader 可以实现基础调用实现类的代码， 通过thread.setContextClassLoader 来设定classloader。</li>
<li>模块化的 热部署 热启动 的情况下 也可以打破classloader的双亲委派机制<br>例如osgi和tomcat 都有自己的模块指定classloader，可以加载同一个类库的不同版本的对象，来可以打破classloader的双亲委派机制，目前这个方式用的比较多。</li>
</ol>
<p>Tomcat中 Webapplication 对象是可以存在多个的，有两个Webapplication 被加载，但是他们的版本不同，这种情况下可以打破双亲委派的。</p>
<p>注意：类的名字的是相同的 只是说版本不同 如果采用双亲委派的机制，那么这两个对象是不可能加载到同一个空间里面 因为加载的过程中，发现在同一空间有同名的类，那么他一定不会被加载。</p>
<p>所以tomcat的每一个Webapplication 都有一个classloader</p>
<p>双亲委派模式加载：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassReloadingTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">MacluClassLoader</span> <span class="variable">classloader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MacluClassLoader</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> classloader.loadClass(<span class="string">&quot;com.openlab.Person&quot;</span>);</span><br><span class="line">        classloader = <span class="literal">null</span>;</span><br><span class="line">        System.out.println(clazz.hashCode());</span><br><span class="line">        classloader = <span class="literal">null</span>;</span><br><span class="line">        classloader = <span class="keyword">new</span> <span class="title class_">MacluClassLoader</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> classloader.loadClass(<span class="string">&quot;com.openlab.Person&quot;</span>);</span><br><span class="line">        System.out.println(clazz1.hashCode());</span><br><span class="line">        System.out.println(clazz == clazz1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上案例中可以看出，双亲委派，即便重新创建了classloader对象，那么曾经被加载的对象，再次加载的时候，加载的还是这个对象。</p>
<p>热部署应该如何实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">T012_ClassReloading2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;C:/test/&quot;</span> + name.replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            <span class="keyword">if</span>(!f.exists()) <span class="keyword">return</span> <span class="built_in">super</span>.loadClass(name);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(f);</span><br><span class="line">                <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[is.available()];</span><br><span class="line">                is.read(b);</span><br><span class="line">                <span class="keyword">return</span> defineClass(name, b, <span class="number">0</span>, b.length);</span><br><span class="line">            &#125; <span class="keyword">catch</span> ( FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.loadClass(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MyLoader</span> <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyLoader</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> m.loadClass(<span class="string">&quot;com.openlab.Person&quot;</span>);</span><br><span class="line">        m = <span class="keyword">new</span> <span class="title class_">MyLoader</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazzNew</span> <span class="operator">=</span> m.loadClass(<span class="string">&quot;com.openlab.Person&quot;</span>);</span><br><span class="line">        System.out.println(clazz == clazzNew);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>复习 初始化</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(T.count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">T</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> count=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">T</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">T</span><span class="params">()</span>&#123;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分析执行过程：</p>
<p>当我们调用T.count的时候，需要把T.class load到内存，通过appclassloader到内存， 进行校验，然后在进行 preparation 对T中的静态变量进行赋默认值，这个时候count的默认值为0，然后进行resolution 解析，最后在进行initialzing 给这些值进行赋初始值。</p>
<p><strong>构造器先执行 – 后静态代码再执行赋值</strong></p>
<p>如果我们定义成员变量public int m &#x3D; 8; m什么时候被赋初始值，</p>
<p>当创建T对象的时候，才会赋默认值，当调用构造方法的时候才会赋值为8</p>
<p>New — 申请内存 — 默认值 — 初始值</p>
<blockquote>
<p>单例模式复习</p>
</blockquote>
<p>Double check loading</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="comment">//懒汉式</span></span><br><span class="line"><span class="comment">// 虽然达到了按需初始化的目的，但是带来线程不安全问题</span></span><br><span class="line"><span class="comment">// 可以通过synchronized 解决 但也带来效率下降</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton instance;<span class="comment">// JIT</span></span><br><span class="line">     <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span>&#123;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="type">ConcurrentHashMap</span> <span class="variable">chm</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span>&#123;</span><br><span class="line">         <span class="keyword">if</span>(instance == <span class="literal">null</span>)&#123;</span><br><span class="line">             <span class="keyword">synchronized</span> (Singleton.class)&#123;</span><br><span class="line">                 <span class="keyword">if</span>(instance == <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1</span>);</span><br><span class="line">                    &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                     instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> instance;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>双重锁</p>
<p>第一重检查，说明还没有任何一个线程给它赋值，那么就给它加锁，第二重检查的主要目的，就是为了防止多次被初始化， 因为在第一次检查的初始化的时候，其他线程有可能已经对其进行初始化， 第二次检查如果结果依然为null 说明，在上面的这段代码执行期间，没有其他线程对它进行初始化。</p>
<blockquote>
<p>面试题：上一段代码是否需要加入volatile关键字</p>
</blockquote>
<p>程序的可见性</p>
<p>有序性 –指令重排序</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808154345620.png" alt="image-20220808154345620"></p>
<p>用jclasslib</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808154357699.png" alt="image-20220808154357699"></p>
<p>当调用new的指令的时候，那么内存已经申请了 invokespecial是调用构造方法，如果把内存中额m的值原来是0 现在变成8 astore_1 指的是将结果赋值给小ta，但是因为指令重排序的问题，那么invokespecial 和astore_1 的执行顺序可能会产生变化的。如果发生了指令重排序的问题，astore_1指令先执行的话 就相当于把这个内存地址扔给了ta 然后在进行初始化。 类似双重检查时到一半的时候的初始化问题。</p>
<h2 id="Chapter4-JMM-Java内存架构"><a href="#Chapter4-JMM-Java内存架构" class="headerlink" title="Chapter4  JMM Java内存架构"></a>Chapter4  JMM Java内存架构</h2><p><strong>Java memory model</strong></p>
<h3 id="4-1-硬件层并发优化的基础知识"><a href="#4-1-硬件层并发优化的基础知识" class="headerlink" title="4.1 硬件层并发优化的基础知识"></a>4.1 硬件层并发优化的基础知识</h3><p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808155347587.png" alt="image-20220808155347587"></p>
<p>寄存器如何读取硬盘中的内容， 首先将硬盘的数据load到内存中，然后寄存器先到高速缓存中去找，如果找到就直接使用，速度是非常快的，如果没找到，就去下层的高速缓存中去寻找，依次类推。</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808155420699.png" alt="image-20220808155420699"></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808155556886.png" alt="image-20220808155556886"></p>
<p>假如 有一个数字在主存中，这个数字会被load到L3缓存中，L2和L1高速缓存是在CPU的内部的，主存中的数字会被load到不同的CPU中，第一个cpu把x赋值为1，第二个CPU把x赋值为2 那么就会产生一个问题 数据一致性问题。</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808161744716.png" alt="image-20220808161744716"></p>
<p>当多个CPU 访问主存的时候，会因为更改主存中的数据值，可以给总线加锁，也就是说当一个CPU访问主存中的数据的时候 其他的CPU不能对总线进行访问，老的CPU的做法，这个锁被称为总线锁， 但是这种方法效率是比较低的。</p>
<p>新的CPU 会使用各种各样的办法来解决一致性的问题。</p>
<p>MESI 数据一致性协议的一种。</p>
<p>MSI MESI MOSI Synapse FireFly Dragon 都是数据的一致性协议。</p>
<p>为什么会这么多数据的一致性的协议，CPU的厂商特别多</p>
<p>MESI intel的CPU 使用的MESI一致性协议。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xiaowenmu1/article/details/89705740">https://blog.csdn.net/xiaowenmu1/article/details/89705740</a></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808161806061.png" alt="image-20220808161806061"></p>
<p>MESI 这个协议是给每个缓存的内容做了一个标记，如果CPU读取了一个数字进来 X，这个x和主存中的内容相比，到底有没有改变这个值，如果更改了，就标记为m也就是modified如果x可以被独享，就标记为Excusive，如果这个x 被其他的别人也可以使用，就标记为shared，如果x在读的时候被其他CPU改过了，就标记为Invalid。</p>
<p>MESI协议让各个CPU的缓存保持一致性的，如果要使用的数字是Invalid，马上要对这个数字进行计算，那么这种情况 需要到主存中再把这个数字读一遍，它就变得有效了。</p>
<p>MESI 也叫缓存锁。</p>
<p>现在的CPU的底层解决数据的一致性： 通过MESI缓存锁+总线锁 组合来实现的。</p>
<h3 id="4-2-缓存行和伪共享"><a href="#4-2-缓存行和伪共享" class="headerlink" title="4.2 缓存行和伪共享"></a>4.2 缓存行和伪共享</h3><p>当我们要把内存中的数据放入到缓存里的时候，它不会只把这一个数据放入到缓存中，例如int i&#x3D; 12 它只有4个字节，不会只把这4个字节读取到缓存中，为了提高效率，而是会把这4个字节后面的一对内容都读进去 所读进去的这一行内容 就是一个基本的缓存单位，这个缓存的单位被称为缓存行。</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808163035465.png" alt="image-20220808163035465"></p>
<p>Cacheline 缓存行 —-基本单位。</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808163116027.png" alt="image-20220808163116027"></p>
<p>伪共享 面试题</p>
<p>X和Y 位于同一个缓存行 第一个cpu只使用x 读的时候会把x和y都读出来，第二个CPU只要y变量也会把x和y都读进来。这种情况下会出现伪共享问题。</p>
<p>第一个cpu在修改了x的值之后，会通知其他cpu，x已经被修改了，其他CPU会标记x为invalid 状态，在通知的时候 变更的是整个缓存行的内容，那么这个时候，第二个cpu要使用y这个变量，就会到主存中再次去读取整个缓存行的内容，那么y变量才有效，第二个cpu也会通知其他cpu y的变量又改了一遍，而第一个cpu跟y是没关系，他只要读x 结果他又要把整个缓存行重新读一遍。</p>
<p>两个不相干的cpu在读取内容的时候，会因为缓存行的关系 产生互相影响。这种情况叫做伪共享。</p>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheLineTest01</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">T</span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> T[] arr = <span class="keyword">new</span> <span class="title class_">T</span>[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        arr[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">T</span>();</span><br><span class="line">        arr[<span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">T</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i&lt;<span class="number">1000_0000L</span>;i++)&#123;</span><br><span class="line">                arr[<span class="number">0</span>].x = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i&lt;<span class="number">1000_0000L</span>;i++)&#123;</span><br><span class="line">                arr[<span class="number">1</span>].x = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        System.out.println((System.nanoTime() - start)/<span class="number">100_0000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808163205632.png" alt="image-20220808163205632"></p>
<p>执行时间</p>
<p>200多-300多</p>
<p>代码二 缓存行对其</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheLineTest02</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Padding</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="type">long</span> p1, p2, p3, p4, p5, p6, p7; <span class="comment">//缓存行对其</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">T</span> <span class="keyword">extends</span> <span class="title class_">Padding</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> T[] arr = <span class="keyword">new</span> <span class="title class_">T</span>[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        arr[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">T</span>();</span><br><span class="line">        arr[<span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">T</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000_0000L</span>; i++) &#123;</span><br><span class="line">                arr[<span class="number">0</span>].x = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000_0000L</span>; i++) &#123;</span><br><span class="line">                arr[<span class="number">1</span>].x = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        System.out.println((System.nanoTime() - start)/<span class="number">100_0000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>类T 继承了Padding 类 T 对象new 处理就占了64个字节 正好对应一个缓存行，arr [0].x</p>
<p>在写回主存的时候，不需要通知Cpu2 就不会频繁的再去重主存中更新数据。</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808163411544.png" alt="image-20220808163411544"></p>
<p>执行时间</p>
<p>120-130左右</p>
<p>解决伪共享的问题： 使用缓存行对其的方式 能够提高效率 它也会浪费一定的空间。</p>
<p>有volatile 去修饰变量 在进行写的操作 汇编代码 出现第二行汇编代码</p>
<p>Lock前缀的指令在多核的处理器下引发两件事情</p>
<ol>
<li><p>将当前处理器缓存行的数据写回到系统内存</p>
</li>
<li><p>这个写回内存的操作会使其他的cpu李的缓存的该内存地址的数据无效</p>
</li>
</ol>
<p>为了去提高处理的速度，CPU不直接和内存进行通信，而是先将系统内存的数据读到内部缓存(L1 和L2 或其他)后，再进行操作，但操作完不知道何时会写入到内存，如果声明volatile的变量的写的操作 JVM就会向CPU发送一条Lock前缀指令，将这个变量所在的缓存行的数据写回到系统内存，就算写回处理内存，其他CPU处理的缓存的值还是旧的，再执行计算操作就会有问题，所以在多个cpu 为了保证各个处理器的缓存是一致的，就会实现缓存的一致性协议。</p>
<blockquote>
<p>Volatile的两条实现原则：</p>
</blockquote>
<ol>
<li><p>Lock前缀指令会引起CPU缓存回写到内存中</p>
<p>Lock前缀指令导致在执行指令期间，声明的CPU处理器的Lock信号，该信号在多CPU环境中，cpu可以独占任何共享内存，但CPU的lock信号 一般不锁总线，而是锁缓存，因为总线锁的开销比较大。</p>
<p>对于Intel486和Pentium处理器 在锁的操作时，经常的在总线上声明lock信号，相反它会锁定这块内存区域的缓存，并写回的内存，使用缓存的一致性机制来确保修改的原子性，所以这个操作被称为“缓存锁定”缓存一致性的机制，会阻止同时修改由两个以上的CPU缓存的内存区域数据。</p>
</li>
<li><p>一个CPU的缓存回写到内存会导致其他CPU缓存无效。</p>
<p>Intel处理器 使用MESI协议去维护内部缓存和其他处理器缓存的一致性</p>
<p>缓存行对其、追加字节</p>
</li>
</ol>
<p>LinkedTransferQueue 使用的一个内部类类型来定义队列的头head和尾节点，这个内部类PaddedAtomicReferecne相对于父类AtimicReference 只做了一件事情。就是将共享变量追加到64个字节。</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808164615323.png" alt="image-20220808164615323"></p>
<h3 id="4-3-乱序问题"><a href="#4-3-乱序问题" class="headerlink" title="4.3 乱序问题"></a>4.3 乱序问题</h3><p> 现在的cpu 为了提高效率 会有各种各样的优化，这个优化被叫做CPU乱序执行。</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808164636661.png" alt="image-20220808164636661"></p>
<p>CPU为了提高效率会打乱指令的执行顺序。</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808164646778.png" alt="image-20220808164646778"></p>
<p>读的时候 乱序执行还是好理解一些，写的时候并发叫做合并写。</p>
<p>WCBuffer Write Combine Buffer 合并写。</p>
<p>当cpu需要给某一个数做计算，然后把这个数存储到主存中，在写回主存的时候有L1和L2两个高速缓存。Cpu先把这个数写入L1中 假如L1中没有个数，缓存就没有命中，那么会写入L2中，但是因为L2的速度比较慢，所以在写的过程中，后续的指令也改变了这个数值。那么它就会把这些指令合并到一起 扔到一个合并缓存中，做一个最终的计算结果扔到L2中 这个情况合并写。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/liushaodong/p/4777308.html">https://www.cnblogs.com/liushaodong/p/4777308.html</a></p>
<p> WCBuffer 这个缓存的级别是高于L1高速缓存 Intel的cpu里面 其实只有4个WC可以被我们同时使用。</p>
<p>一种方式： 写操作的时候 小于4个wc 那么可以同时写1-3个WC 将其写入到L2中</p>
<p>二种方式： 写操作的时候 如果一次写超过4个wc 需要分2次把合并的内容写入到L2中</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808165052847.png" alt="image-20220808165052847"></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808165057124.png" alt="image-20220808165057124"></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808165114702.png" alt="image-20220808165114702"></p>
<p>充分的利用合并写 能够看出来分开执行的效率是速度更快的 效率更高</p>
<p>正是由于CPU有一个特别告诉的缓存 只有4个字节 所以一次填写4个的执行效率更快一些 而4+2 模式 4个填充之后 还要等待另外两个其他的字节进行填充，而3+3的模式只要等待1个字节填充就可以执行，执行完了之后还要等待第二次的执行。</p>
<h3 id="4-4-乱序证明"><a href="#4-4-乱序证明" class="headerlink" title="4.4 乱序证明"></a>4.4 乱序证明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"><span class="comment">// 这个程序是美团的人写的</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Disorder</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>, y = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>, b =<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(;;) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                x = <span class="number">0</span>; y = <span class="number">0</span>;</span><br><span class="line">                a = <span class="number">0</span>; b = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 1 0  0 1  1 1  0 0</span></span><br><span class="line">                <span class="type">Thread</span> <span class="variable">one</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="comment">//由于线程one先启动，下面这句话让它等一等线程two. 读着可根据自己电脑的实际性能适当调整等待时间.</span></span><br><span class="line">                        shortWait(<span class="number">100000</span>);</span><br><span class="line">                        a = <span class="number">1</span>;</span><br><span class="line">                        x = b;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                <span class="type">Thread</span> <span class="variable">other</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        b = <span class="number">1</span>;</span><br><span class="line">                        y = a;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                one.start();other.start();</span><br><span class="line">                one.join();other.join();</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;第&quot;</span> + i + <span class="string">&quot;次 (&quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;）&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span>(x == <span class="number">0</span> &amp;&amp; y == <span class="number">0</span>) &#123;</span><br><span class="line">                    System.err.println(result);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shortWait</span><span class="params">(<span class="type">long</span> interval)</span>&#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            <span class="type">long</span> end;</span><br><span class="line">            <span class="keyword">do</span>&#123;</span><br><span class="line">                end = System.nanoTime();</span><br><span class="line">            &#125;<span class="keyword">while</span>(start + interval &gt;= end);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 1 0 0 1 1 1 如果一旦出现 a-0 b-0 乱序的问题就发生了。</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808165219357.png" alt="image-20220808165219357"></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220808165222723.png" alt="image-20220808165222723"></p>
<h3 id="4-5-如何保证特定情况下不乱序"><a href="#4-5-如何保证特定情况下不乱序" class="headerlink" title="4.5 如何保证特定情况下不乱序"></a>4.5 如何保证特定情况下不乱序</h3><p> Java的层面 应用volatile关键字去修饰变量 保证有序性</p>
<p>硬件层面：使用CPU的汇编指令</p>
<ol>
<li><p>加锁 加锁百分百能够完成了 提高效率 在CPU的指令级别中很多cpu都做了同一件事，内存屏障 也叫内存栅栏。</p>
</li>
<li><p>这里说的cpu的内存屏障 和java的内存屏障没有关系。</p>
</li>
</ol>
<p>拿Intel处理器的内存屏障来说：</p>
<p>不同的CPU 它的内存屏障指令是不一样的，而且有逻辑上也有区别。</p>
<p>Intel 的内存屏障的设计比较简单 只有三条指令。</p>
<p>指令1 ：sfence 写屏障 在sfence 指令前的写操作 必须在sfence 指令的写操作前完成。</p>
<p>指令2： lfence 读屏障 在lfence指令前的读操作 必须在lfence指令的读操作前完成。</p>
<p>指令3：mfence 读写屏障 在mfence 指令的读写操作 必须在mfence指令的读写操作前完成。</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/64240319ed60">https://www.jianshu.com/p/64240319ed60</a></p>
<p>有序性保障：</p>
<p>Intel lock 指令</p>
<p>原子指令 比如X86上的lock指令是一个FullBarrire 执行的时候会锁住内存子系统来确保执行顺序 甚至可以跨越多个CPU</p>
<p>Software locks 通常使用内存屏障或原子指令来实现变量的可见性和保持程序的执行顺序。  </p>
<p>作业： </p>
<p>博客1 关于内存屏障 java的内存屏障怎么搞。</p>
<p>博客2 如何实线并发的原子性 可见性 有序性。</p>
<h2 id="Chapter5-JVM内存结构"><a href="#Chapter5-JVM内存结构" class="headerlink" title="Chapter5  JVM内存结构"></a>Chapter5  JVM内存结构</h2><p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220823133047662.png" alt="image-20220823133047662"></p>
<p>知识结构：</p>
<ul>
<li>classfile</li>
<li>classloader</li>
<li>内存结构</li>
<li>执行引擎 – 解释器 JIT 即时编译器 GC</li>
</ul>
<blockquote>
<p>类的对象存储在方法区中，堆中存储对象和成员变量，而堆中的对象在方法的执行过程中，需要用到虚拟机栈，程序计数器，以及本地方法栈，方法在执行的时候，它的每行代码都是由执行引擎中的解释器逐行解释的，对于热点代码则通过JIT即时编译器进行编译，在执行引擎中还有一个比较重要的模块，垃圾回收GC，它会对堆中的不再引用对象进行垃圾回收，还会有一些java不太方便实现的功能， 调用底层操作系统的功能，通过本地方法接口来进行实现</p>
</blockquote>
<h3 id="5-1-JVM-系统线程"><a href="#5-1-JVM-系统线程" class="headerlink" title="5.1 JVM 系统线程"></a>5.1 JVM 系统线程</h3><p>有很多的线程其实是在后台运行的，这些后台线程与主函数的主线程以及主线程创建的一些其他线程在一起运行 HotSpotVM 后台运行的系统线程有以下几个</p>
<table>
<thead>
<tr>
<th>线程名称</th>
<th>线程作用</th>
</tr>
</thead>
<tbody><tr>
<td>虚拟机线程（VM thread）</td>
<td>这个线程等待JVM到达安全点操作出现。这些操作必须要再独立的线程里执行，因为当堆修改无法进行时，线程都需要JVM位于安全点，这些操作的类型的有 stop-the-world 垃圾回收，线程栈 dump 线程暂停，线程偏向锁（biased locking）接触</td>
</tr>
<tr>
<td>周期性任务线程</td>
<td>这个线程负责定时器事件（也就是中断） 用来调度周期性操作的执行</td>
</tr>
<tr>
<td>GC线程</td>
<td>这些线程支持JVM 中不同的垃圾回收活动</td>
</tr>
<tr>
<td>编译器线程</td>
<td>这些线程在运行时讲字节码动态编译成本地平台相关的机器码</td>
</tr>
<tr>
<td>信号分发线程</td>
<td>这个线程接受发送到JVM的信号并调用适当的JVM方法处理</td>
</tr>
</tbody></table>
<h3 id="5-2-程序计数器"><a href="#5-2-程序计数器" class="headerlink" title="5.2 程序计数器"></a>5.2 程序计数器</h3><p>程序计数器 Program Counter Register</p>
<p> 指的是当前指令（操作码）的地址 本地指令除外，如果当前的方法native方法 PC的值为undefined。 所有的CPU 都有一个PC 每执行一条指令PC都会自增 因此PC存储了指向下一条要被执行的指令。</p>
<p>程序计数器在这里记住的JVM下一条指令的执行地址，当第一条指令执行完，那么解释器就会到程序计数器中取寻找下一条指令。在物理上来讲的话 程序计数器是通过寄存器来实现的</p>
<p>程序计数器特点：</p>
<ul>
<li><p>线程私有</p>
<p>多个线程在执行代码的时候，CPU会用一个调度系数，给线程分配时间片，线程在现有的时间片，没有执行完，那么会让它执行一个暂存的指令，然后切换到其他线程，其他线程也是如此。那么线程在切换的过程中，如果想知道下一个指令执行到哪了，会使用程序计数器来进行记录。</p>
<p>每条线程里都有自己的程序计数器，来记录自己线程执行到的指令 当线程切换后 又切换到原有的线程那么它就从自己的程序计数器中取出要执行的下一条指令</p>
</li>
<li><p>程序计数器 不存在内存溢出 OOM</p>
</li>
<li><p>程序计数器是很小的空间 ，可以把它看成字节码行号的指示器</p>
</li>
</ul>
<h3 id="5-3-虚拟机栈"><a href="#5-3-虚拟机栈" class="headerlink" title="5.3 虚拟机栈"></a>5.3 虚拟机栈</h3><p>Java中每个线程在运行的时候都需要划分内存空间，虚拟机栈是指每个线程在运行时需要的内存空间，所以说每条线程中都会存在一个虚拟机栈，而虚拟机栈中的每一块空间都是一个栈帧，一个栈帧对应着一次方法的调用。</p>
<p>栈帧： 每个方法在执行的时候需要的内存</p>
<p>方法在调用的时候，需要参数 局部变量 返回地址 都是需要地址</p>
<p>一个虚拟机栈是由多个栈帧组成</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220823135537366.png" alt="image-20220823135537366"></p>
<p>栈帧存储 局部变量表 操作栈 动态链接 方法出口等信息 后进先出 <strong>LIFO</strong></p>
<p>Frames 表示栈帧</p>
<p>提出问题：</p>
<ol>
<li><p>垃圾回收是否涉及到虚拟机栈？</p>
<p>不需要 因为每一次方法的执行完之后都会被弹出栈空间 根本就不需要垃圾回收</p>
</li>
<li><p>栈内存分配越大越好吗？</p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/java.html#GUID-3B1CE181-CD30-4178-9602-230B800D4FAE">https://docs.oracle.com/en/java/javase/11/tools/java.html#GUID-3B1CE181-CD30-4178-9602-230B800D4FAE</a></p>
<p>可以通过-Xss来设置栈空间的大小，栈的空间越大 并不会提升程序的运行的速度，反而会让程序的线程数量变少， 因为物理内存是固定的。栈的内存越大 提升方法进行递归调用的次数</p>
</li>
<li><p>方法内的局部变量是否是线程安全的？</p>
<p>主要取决于局部变量被多个线程共享</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220823170311194.png" alt="image-20220823170311194"></p>
<p>如果两个线程中的局部变量互补干扰 那么局部变量是对线程私有的，不会存在线程的安全的问题</p>
<p>当这个变量一旦被static关键字修饰，它就会引发安全问题</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220823170356870.png" alt="image-20220823170356870"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo02</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        StringBuilder sb = new StringBuilder();</span></span><br><span class="line"><span class="comment">//        sb.append(4);</span></span><br><span class="line"><span class="comment">//        sb.append(5);</span></span><br><span class="line"><span class="comment">//        sb.append(6);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        new Thread(()-&gt;&#123;</span></span><br><span class="line"><span class="comment">//           m2(sb);</span></span><br><span class="line"><span class="comment">//        &#125;).start();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        sb.append(<span class="number">1</span>);</span><br><span class="line">        sb.append(<span class="number">2</span>);</span><br><span class="line">        sb.append(<span class="number">3</span>);</span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m2</span><span class="params">(StringBuilder sb)</span>&#123;</span><br><span class="line"></span><br><span class="line">        sb.append(<span class="number">1</span>);</span><br><span class="line">        sb.append(<span class="number">2</span>);</span><br><span class="line">        sb.append(<span class="number">3</span>);</span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StringBuilder <span class="title function_">m3</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        sb.append(<span class="number">1</span>);</span><br><span class="line">        sb.append(<span class="number">2</span>);</span><br><span class="line">        sb.append(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> sb;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>M1方法 线程安全的 StringBuffer 本身就是一个局部变量 </p>
<p>M2 方法 StringBuilder 变成了一个参数 所以它线程不安全， 有可能会有其他线程访问到它 sb对象 不是线程私有的了。</p>
<p>M3 方法 将StringBuilder 做成了返回值 那么它线程不安全， 其他线程是可以拿到这个方法的返回值的 并且去修改它。</p>
</li>
</ol>
<p>总结：</p>
<ul>
<li>每个线程运行时需要的内存 ——-虚拟机栈</li>
<li>每个栈都由多个栈帧组成 每一个栈帧又对应着方法调用的内存</li>
<li>每个线程只能有一个活动的栈帧 对应着当前正在执行的方法</li>
</ul>
<h4 id="5-3-1-局部变量表"><a href="#5-3-1-局部变量表" class="headerlink" title="5.3.1 局部变量表"></a>5.3.1 局部变量表</h4><p>局部变量表存放内容：</p>
<ol>
<li>编译期 基本数据类型</li>
<li>对象的引用 reference 类型 引用指针</li>
<li>ReturnAddress 类型 – 指向了一条字节码指令</li>
</ol>
<p>64位的long double 会占用两个局部变量的空间(slot) 其余的类型都只占用1个slot</p>
<p>在局部变量表中包含了方法在执行过程中的所有的变量 甚至包括this的引用，方法的参数，其他局部变量 静态方法</p>
<p>在虚拟机规范中，对这个区域规定两种异常情况：</p>
<ol>
<li><p>如果线程请求的栈的深度大于虚拟机所允许的深度</p>
<p>StackOverFlowError</p>
</li>
<li><p>虚拟机的栈是可以进行动态扩展的，当扩展时申请不到足够的内存时</p>
<p>OutOfMemoryError</p>
</li>
</ol>
<h4 id="5-3-2-JVM栈帧"><a href="#5-3-2-JVM栈帧" class="headerlink" title="5.3.2 JVM栈帧"></a>5.3.2 JVM栈帧</h4><p>方法调用的和方法执行的一个数据结构 一个方法从调用到执行完成</p>
<p>每一个栈帧都包括：</p>
<ul>
<li>局部变量表</li>
<li>操作数栈</li>
<li>动态链接</li>
<li>方法返回地址</li>
<li>额外信息</li>
</ul>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220823175433302.png" alt="image-20220823175433302"></p>
<h4 id="5-3-3-操作数栈"><a href="#5-3-3-操作数栈" class="headerlink" title="5.3.3 操作数栈"></a>5.3.3 操作数栈</h4><p>类似局部变量表， 操作栈 也是后进先出</p>
<p>操作数栈的最大深度 class文件中的Code属性max_stacks 数据项</p>
<p>操作数栈可以存储任意类型</p>
<p>32位的数据类型 栈容量为1</p>
<p>64位的数据类型 栈容量为2</p>
<p>栈容量的单位 —-字宽</p>
<p>对32位的虚拟机 一个字宽是 4个字节</p>
<p>对64位的虚拟机 一个字宽是8个字节</p>
<p>在进行算术运算上就是通过操作数栈来进行的</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220823175501748.png" alt="image-20220823175501748">、</p>
<h4 id="5-3-4-动态链接"><a href="#5-3-4-动态链接" class="headerlink" title="5.3.4 动态链接"></a>5.3.4 动态链接</h4><p>每个栈帧都包含 一个指向运行时常量池中这个栈帧属性和方法的引用，持有这个引用是为了支持方法调用过程的动态连接。</p>
<p>在class文件的常量池中有大量的符号引用的，方法在调用的时候调用指令的时候会以符号引用作为参数。</p>
<p>符号引用的一部分是在类的加载阶段或是在第一次使用的时候转化为直接引用 静态解析</p>
<p>另一部分在每次运行期间转化的直接引用动态链接。</p>
<h4 id="5-3-5-方法返回地址"><a href="#5-3-5-方法返回地址" class="headerlink" title="5.3.5 方法返回地址"></a>5.3.5 方法返回地址</h4><p>方法的退出方式有两种</p>
<ul>
<li><p>正常完成出口</p>
<p>执行引擎遇到return的指令返回的字节码指令 返回值和返回类型</p>
</li>
<li><p>异常完成出口</p>
<p>方法在执行时遇到了异常 异常没有在方法体内得到处理 一种是虚拟机内部异常，代码中athrow字节码的异常。当出现异常时是不会产生任何返回值的。</p>
</li>
</ul>
<p> 只要是方法的退出，都要回到方法的调用位置 这个位置是由程序计数器来记录的可以作为返回的地址 栈帧中会保存这个计数器的值，异常退出的话，返回的地址是通过异常处理器来确定的。异常信息是不会保存栈帧中</p>
<h4 id="5-3-6-附加信息"><a href="#5-3-6-附加信息" class="headerlink" title="5.3.6 附加信息"></a>5.3.6 附加信息</h4><p>栈帧的信息</p>
<h3 id="5-4-本地方法栈-Native栈"><a href="#5-4-本地方法栈-Native栈" class="headerlink" title="5.4 本地方法栈 Native栈"></a>5.4 本地方法栈 Native栈</h3><p>和虚拟机栈类似 发挥的作用基本相同。</p>
<p>虚拟机栈是为虚拟机执行字节码服务</p>
<p>本地方法栈是为虚拟机使用到native方法服务</p>
<p>提供支持的JVM一般都会为每个线程创建本地方法栈</p>
<p>C-linkage 模型实现 JNI java native Invocation 这个本地栈就被称为C栈 本地方法栈参数的顺序，返回值和C程序相同的。</p>
<p>Hotspot 直接将虚拟机栈和本地方法栈合二为一</p>
<h3 id="5-5-堆"><a href="#5-5-堆" class="headerlink" title="5.5 堆"></a>5.5 堆</h3><p>Java Heap java虚拟机中管理内存的最大一块 堆是被所有线程共享的内存区域。在虚拟机启动的时候创建。</p>
<p> 所有的对象实例以及数组都要在堆上分配。</p>
<p>栈帧只能存储指向堆中的对象和数组的引用。 对象只能由垃圾回收器移除。</p>
<p>Java堆是收集器管理的主要区域， GC堆 采用的分代收集的算法。</p>
<ul>
<li><p>新生代</p>
<p>经常被分为Eden空间和Survivor空间</p>
</li>
<li><p>老年代</p>
</li>
<li><p>永久带</p>
<p>1.8 的jdk之后，就不存在永久代了。</p>
</li>
</ul>
<p>再细致去分</p>
<ul>
<li>Eden空间</li>
<li>FromSurvivor空间</li>
<li>ToSurvivor 空间</li>
</ul>
<p>进一步划分的目的是为了更好的回收内存或者更快的分配内存</p>
<h4 id="5-5-1-分代策略"><a href="#5-5-1-分代策略" class="headerlink" title="5.5.1 分代策略"></a>5.5.1 分代策略</h4><p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824161934127.png" alt="image-20220824161934127"></p>
<p>1.8 的jdk之后，就不存在永久代了。被metaspace替代了，采用永久代的方式来实现方法区，永久代 用于放常量类的信息 静态变量等数据 这些数据和垃圾回收的关系不是很大，和垃圾回收关系比较大的两个区域分别是新生代和老年代</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824162011519.png" alt="image-20220824162011519"></p>
<h3 id="5-6-内存管理"><a href="#5-6-内存管理" class="headerlink" title="5.6 内存管理"></a>5.6 内存管理</h3><p>所有的对象和数组都会在堆内存中进行分配，并且永远不会显示回收，而是由垃圾回收器自动回收。通常新的对象和数组被创建并放入老年代。</p>
<p>Minor 垃圾回收器 回收将发生在新生代，依旧存活的对象将从eden区域移到Survivor区</p>
<p>Major 垃圾回收 一般会导致应用进程的暂停，它将在三个区内移动对象， 仍然存活的对象，被会从新生代移动到老年代。</p>
<p>每次老年代回收时也会进行永久代的回收，它们中任何一个变满了，都会进行回收。</p>
<h4 id="5-6-1-新生代"><a href="#5-6-1-新生代" class="headerlink" title="5.6.1 新生代"></a>5.6.1 新生代</h4><p>新生成的对象优先的放在新生代中，存活率很低</p>
<p>新生代中的常规应用进行一次垃圾回收， 可以回收到70%-95% 效率很高</p>
<p>HotSpot 将新生代划分为三个区</p>
<p>一块比较大的 Eden 伊甸</p>
<p>和两块较小的 Survivor 幸存者</p>
<p>默认比例为：8:1:1 </p>
<p>为什么用这个比例 原因是因为hotspot 采用的复制算法来回收新生代。</p>
<p>大的对象是不会进入新生代的 而是直接进入老年代</p>
<p>当Eden区没有足够的空间进行分配，虚拟机将发起一次MinorGC</p>
<p>GC开始的时候 对象会存在Eden区 。 这个时候FormSurvivor区和ToSurvivor 是空的，作为保留区域。</p>
<p>GC进行时 Eden区的所有存活的对象都会被复制到ToSurvivor 区中 而在FormSurvivor区，扔存活的对象，根据他们的年龄值决定去向。年龄值达到年龄的阀值（15 新生代中的对象每熬过一次GC 年龄就+1）的对象会被移动到老年代中，没有达到阀值的对象会被复制的ToSurvivor区，接着FormSurvivor和ToSurvivor 两者交换角色。都要保证ToSurvivor 区在一轮GC后是空的 GC时 当ToSurvivor没有足够的空间存放上一次新生代收集下来的存活对象，需要依赖老年代进行分配担保，将这些对象放入到老年代。</p>
<h4 id="5-6-2-老年代"><a href="#5-6-2-老年代" class="headerlink" title="5.6.2 老年代"></a>5.6.2 老年代</h4><p>在新生代经历了多次GC（具体要看虚拟机的配置的情况）后仍然存活了下来的对象就会进入老年代，对象的生命周期长，存活率高，在老年代进行GC的频率比较低，而且回收速度也比较慢</p>
<h4 id="5-6-3-永久代-PermanentGeneration-metaspace"><a href="#5-6-3-永久代-PermanentGeneration-metaspace" class="headerlink" title="5.6.3 永久代 PermanentGeneration -metaspace"></a>5.6.3 永久代 PermanentGeneration -metaspace</h4><p>类的信息 常量 静态变量 JIT即时编译器编译后的代码等数据。这个区域是不进行垃圾回收的</p>
<h3 id="5-7-非堆内存"><a href="#5-7-非堆内存" class="headerlink" title="5.7 非堆内存"></a>5.7 非堆内存</h3><p>在逻辑是是JVM的一部分对象，但实际是哪个不在堆上创建</p>
<p>非堆内存：</p>
<ul>
<li>永久代：<ul>
<li>方法区</li>
<li>驻留字符串</li>
</ul>
</li>
</ul>
<p>代码缓存 Code Cache 用于编译和存储哪些被JIT即时编译器编译的原生代码方法</p>
<h3 id="5-8-栈内存溢出"><a href="#5-8-栈内存溢出" class="headerlink" title="5.8 栈内存溢出"></a>5.8 栈内存溢出</h3><p>栈内存溢出情况：</p>
<ol>
<li>栈帧过多的时候容易造成溢出</li>
<li>栈帧过大的时候容易造成溢出</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StackOverflowTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span> <span class="type">int</span> count;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            method1();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(count);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span>&#123;</span><br><span class="line">        count++;</span><br><span class="line">        method1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171020711.png" alt="image-20220824171020711"></p>
<p>可以通过-Xss256k 去调整栈空间的大小</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171045409.png" alt="image-20220824171045409"></p>
<h3 id="5-9-堆内存溢出"><a href="#5-9-堆内存溢出" class="headerlink" title="5.9 堆内存溢出"></a>5.9 堆内存溢出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeapOverFlowTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">try</span>&#123;</span><br><span class="line">         List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">         <span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">         <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">             list.add(a);</span><br><span class="line">             a = a+a;<span class="comment">// hellohellohellohello</span></span><br><span class="line">             i++;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;<span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">         System.out.println(i);</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171114736.png" alt="image-20220824171114736"></p>
<p>通过虚拟机参数去指定堆空间的大小</p>
<p>-Xmx8m</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171122692.png" alt="image-20220824171122692"></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171129278.png" alt="image-20220824171129278"></p>
<h3 id="5-10-堆内存诊断"><a href="#5-10-堆内存诊断" class="headerlink" title="5.10 堆内存诊断"></a>5.10 堆内存诊断</h3><ol>
<li>命令行工具 jps<br>查看当前系统中有哪些java</li>
<li>命令行工具 jmap  jmap -heap 进程id<br>查看堆内存中的占用情况</li>
<li>图形界面的工具 多功能的检测工具 可以连续监控<br>jconsole</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo03</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1...&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">        <span class="type">byte</span>[] array = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span>];<span class="comment">// 10M</span></span><br><span class="line">        System.out.println(<span class="string">&quot;2...&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">        array = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        System.gc();</span><br><span class="line">        System.out.println(<span class="string">&quot;3...&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>命令行窗口的使用：<br>View -Tool Windows -Terminal</p>
<h4 id="5-10-1-jsp指令"><a href="#5-10-1-jsp指令" class="headerlink" title="5.10.1 jsp指令"></a>5.10.1 jsp指令</h4><p>输入jps指令 查看系统中的java进程</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171325350.png" alt="image-20220824171325350"></p>
<h4 id="5-10-2-jmap指令"><a href="#5-10-2-jmap指令" class="headerlink" title="5.10.2 jmap指令"></a>5.10.2 jmap指令</h4><p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171408005.png" alt="image-20220824171408005"></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171414254.png" alt="image-20220824171414254"></p>
<p>Heap Configuration 堆的配置</p>
<p>MaxHeapSize 最大的堆内存空间</p>
<p>NewSize 新生代内存</p>
<p>MaxNewSize 最大的新生代内存空间</p>
<p>OldSize 老年代内存</p>
<p>Metaspace 元空间的内存</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171427554.png" alt="image-20220824171427554"></p>
<p>Heap Usage 表示堆内存的占用</p>
<p>Edenspace 表示新生代的Eden区</p>
<p>Form Form Survivor</p>
<p>To   To Survivor</p>
<p>Old Generation 表示老年代</p>
<p>实验流程：</p>
<p>Jps 操作</p>
<ol>
<li>Jmap 查看 没有声明数组的内存占用情况</li>
<li>Jmap 查看 有声明数组的内存占用情况</li>
<li>Jmap 查看 数组被赋值为null 以及调用gc之后的内存使用情况</li>
</ol>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171524749.png" alt="image-20220824171524749"></p>
<blockquote>
<p> 容量 32M</p>
<p>使用的容量 4.48 M</p>
<p>空闲 27.51M</p>
</blockquote>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171545730.png" alt="image-20220824171545730"></p>
<blockquote>
<p>使用容量 14.48M</p>
<p>空闲容量 17.51M</p>
</blockquote>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171556147.png" alt="image-20220824171556147"></p>
<blockquote>
<p>使用容量 0.64M</p>
<p>空闲容量 31.35M</p>
</blockquote>
<h4 id="5-10-3-jconsole"><a href="#5-10-3-jconsole" class="headerlink" title="5.10.3 jconsole"></a>5.10.3 jconsole</h4><ol>
<li><p>运行程序</p>
</li>
<li><p>然后在命令行输入jconsole</p>
</li>
</ol>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171639542.png" alt="image-20220824171639542"></p>
<ol start="3">
<li>选择不安全连接</li>
</ol>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171717553.png" alt="image-20220824171717553"></p>
<ol start="4">
<li>展示监控平台的工具</li>
</ol>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824171726659.png" alt="image-20220824171726659"></p>
<ol start="5">
<li>里面可以检测出 内存的占用 线程 类的加载情况等等</li>
</ol>
<h4 id="5-10-4-面试题"><a href="#5-10-4-面试题" class="headerlink" title="5.10.4 面试题"></a>5.10.4 面试题</h4><blockquote>
<p> 垃圾回收之后 内存的占用率依旧很高 这种情况应该怎么检测 怎么排解这个问题</p>
</blockquote>
<ol>
<li><p>使用jps去查看进程</p>
</li>
<li><p>然后 jmap -heap +id 进程内存</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824172342717.png" alt="image-20220824172342717"></p>
<p>而是在老年代里面占用的空间相对比较大 182.88+19.45 —- 200多M</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824172401399.png" alt="image-20220824172401399"></p>
<p>执行GC 之后 已经进行垃圾回收 ，在执行结果中继续检测，那么能够发现执行的效率不是很高，内存使用率依旧是200多M</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824172410304.png" alt="image-20220824172410304"></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824172414187.png" alt="image-20220824172414187">、</p>
<p>可以看到新生代的内存被回收了一些， 但是老年代还是很多</p>
<p>这里面为什么垃圾回收没有把内存回收掉？ 要对问题进行检测</p>
</li>
<li><p>检测工具：jvisualvm</p>
<p>在命令行输入指令就可以 它也是一个可视化的工具 可视化的虚拟机</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824172436229.png" alt="image-20220824172436229"></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824172439177.png" alt="image-20220824172439177"></p>
<p>堆Dump 是堆空间的快照</p>
<p>把我们此刻的堆的内存信息截取出来， 并且也会把堆中的哪些类型的对象和对象的信息也收集起来</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824172445857.png" alt="image-20220824172445857"></p>
<p>检查 —-点击查找</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824172453234.png" alt="image-20220824172453234"></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824172458651.png" alt="image-20220824172458651"></p>
<p>在这里可以看到ArrayList这条占用的空间是比较大的 点击进去</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824172515062.png" alt="image-20220824172515062"></p>
<p>ArrayList这项 占用了200多MB 点开 elementData 能够查看的里面有一个byte[]</p>
<p>还能够发现 200个student对象的创建，就能够排查出来问题的原因，因为student对象没有被回收，student对象是被长期使用的。导致垃圾回收器没有回收它的内存</p>
</li>
</ol>
<p>我们在生产环境中，也是使用证的办法来进行排查 垃圾回收后，内存占用率依旧很大的问题</p>
<h3 id="5-11-方法区MethodArea"><a href="#5-11-方法区MethodArea" class="headerlink" title="5.11 方法区MethodArea"></a>5.11 方法区MethodArea</h3><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-2.html">https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-2.html</a></p>
<p>方法区 Methodarea 与java中堆一样的，方法区中的数据可以被每个线程共享，用于存储已经被加载的类的信息 ，常量 静态变量 ，以及JIT即时编译器的代码数据 等等。JVM虚拟机的规范中，把方法区描述为堆的一个逻辑部分，也有一个名字来对应 Non-heap 是为了与java中的堆进行分区。</p>
<p>很多人把方法区称为永久代， 本质上其实是不一样，按照HotSpot设计团队选择把GC分代收集扩展至方法区，永久代知识方法区的实现而已 目前永久代被废除 叫metaspace</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824172750119.png" alt="image-20220824172750119"></p>
<p>Java的虚拟机 对方法区的限制是比较宽松的，除了和java堆一样不需要连续的内存 也可以选择固定的大小或者可以扩展，还可以选择不实现垃圾回收。垃圾回收在方法区中出现的比较少。</p>
<p>方法区 内存回收目标是对常量池的回收和对类型的卸载</p>
<h4 id="5-11-1-方法区结构"><a href="#5-11-1-方法区结构" class="headerlink" title="5.11.1 方法区结构"></a>5.11.1 方法区结构</h4><p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824172821629.png" alt="image-20220824172821629"></p>
<h4 id="5-11-2-JDK1-6版本-JDK1-7版本-JDK1-8版本"><a href="#5-11-2-JDK1-6版本-JDK1-7版本-JDK1-8版本" class="headerlink" title="5.11.2 JDK1.6版本 JDK1.7版本 JDK1.8版本"></a>5.11.2 JDK1.6版本 JDK1.7版本 JDK1.8版本</h4><p>常量池主要分成以下几种：</p>
<ol>
<li>静态常量池<br>就是.class文件中的常量池， 包含字符串数字这些字面量，还包含 类的方法的信息， 占用了classfile的大部分空间，这个常量池主要用于放两大类的常量：字面量和符号引用，包含了三种类型的常量 类和接口的全限定名 字段名称和描述符，方法名称和描述符</li>
<li>运行时常量池<br>虚拟机会将各个的class文件中常量池载入到运行时常量池中 即编译期间 生成字面量 符号引用，装载class文件</li>
<li>字符串常量池 StringTable<br>可以把它理解为运行时常量池分出来的一部分内容，加载时 对于class的静态常量池 字符串会被装载到字符串常量池中</li>
<li>整型常量池 Integer<br>类似StringTable 可以把它理解为运行时常量池分出来的一部分内容 在加载时如果是整型的数据被装到整型的常量池中</li>
</ol>
<blockquote>
<p>在永久代移出之后，字符串的常量池也不再放在永久代了， 也没有放入到元空间里，而是继续留在了堆空间了Heap-？ 方便回收？</p>
<p>运行时常量池搬到了元空间里， 它是装静态变量 字节码的信息 有它的地方才被称为方法区</p>
</blockquote>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220824175607841.png" alt="image-20220824175607841"></p>
<p>所有的线程共享同一个方法区，因为访问方法区的数据和动态链接的进程必须是线程安全的，方法区存储了每个类的信息，比如：</p>
<ul>
<li><p>lassloader 引用</p>
<p>通过this.getClass().getClassLoader()进行获取</p>
<p>通过上图可以看出来，对象中含有字节码和加载器的地址引用</p>
</li>
<li><p>类型信息</p>
</li>
<li><p>修饰符(public final)</p>
</li>
<li><p>是类还是接口(class,interface)</p>
</li>
<li><p>类的全限定名(Test&#x2F;ClassStruct.class)</p>
</li>
<li><p>直接父类的全限定名(java&#x2F;lang&#x2F;Object.class)</p>
</li>
<li><p>直接父接口的权限定名数组(java&#x2F;io&#x2F;Serializable)</p>
<ul>
<li>运行时常量池</li>
<li>数值型常量</li>
<li>字段引用</li>
<li>方法引用</li>
<li>属性</li>
<li>字段数据</li>
<li>针对每个字段的信息</li>
<li>字段名</li>
<li>类型</li>
<li>修饰符</li>
<li>属性（Attribute）</li>
<li>方法数据</li>
<li>每个方法</li>
<li>方法名</li>
<li>返回值类型</li>
<li>参数类型（按顺序）</li>
<li>修饰符</li>
<li>属性</li>
<li>方法代码</li>
<li>每个方法</li>
<li>字节码</li>
<li>操作数栈大小</li>
<li>局部变量大小</li>
<li>局部变量表</li>
<li>异常表</li>
<li>每个异常处理器</li>
<li>开始点</li>
<li>结束点</li>
<li>异常处理代码的程序计数器（PC）偏移量</li>
<li>被捕获的异常类对应的常量池下标</li>
<li>常量池</li>
</ul>
</li>
</ul>
<p>直接常量：</p>
<ol>
<li>CONSTANT_INGETER_INFO整型直接常量池public final int CONST_INT&#x3D;0;</li>
<li>CONSTANT_String_info字符串直接常量池<br>public final String CONST_STR&#x3D;”CONST_STR”;</li>
<li>CONSTANT_DOUBLE_INFO浮点型直接常量池</li>
</ol>
<p>等等各种基本数据类型基础常量池、方法名、方法描述符、类名、字段名，字段描述符的符号引用</p>
<p>参考博客内容：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43684005/article/details/119615972">https://blog.csdn.net/qq_43684005/article/details/119615972</a></p>
<h4 id="5-11-3-方法区内存溢出"><a href="#5-11-3-方法区内存溢出" class="headerlink" title="5.11.3 方法区内存溢出"></a>5.11.3 方法区内存溢出</h4><p>1.8版本以前 导致永久代的内存溢出</p>
<p>1.8版本之后 导致元空间的内存溢出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> jdk.internal.org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 元空间内存溢出</span></span><br><span class="line"><span class="comment">//-XX:MaxMetaspaceSize=8m</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo05</span>  <span class="keyword">extends</span>  <span class="title class_">ClassLoader</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">try</span>&#123;</span><br><span class="line">          <span class="type">Demo05</span> <span class="variable">demo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Demo05</span>();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i&lt;<span class="number">10000</span>;i++,j++)&#123;</span><br><span class="line">             <span class="comment">// 用代码的方式生成字节码</span></span><br><span class="line">              <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(<span class="number">0</span>);</span><br><span class="line">              <span class="comment">// 版本号 public 类的名字  包名 类的父类 接口</span></span><br><span class="line">              cw.visit(Opcodes.V1_8,Opcodes.ACC_PUBLIC,<span class="string">&quot;Class&quot;</span>+i,<span class="literal">null</span>,<span class="string">&quot;java/lang/Object&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">              <span class="type">byte</span>[] code = cw.toByteArray();</span><br><span class="line">              <span class="comment">// 执行了类的加载</span></span><br><span class="line">              demo.defineClass(<span class="string">&quot;Class&quot;</span>+i,code,<span class="number">0</span>,code.length);</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">           System.out.println(j);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.8jdk 版本之后永久代被移出 由metaspace来替代，元空间是没有上限的，所以这段代码在不调整JVM的虚拟机参数的情况下是不会溢出的</p>
<p>-XX:MaxMetaspaceSize&#x3D;8m</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825164311304.png" alt="image-20220825164311304"></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825164318155.png" alt="image-20220825164318155"></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825164321497.png" alt="image-20220825164321497"></p>
<p>如果测试永久代溢出 把jdk版本修改成1.6的版本 并且需要修改一下虚拟机的参数</p>
<p>-XX:MaxPermSize&#x3D;8m;</p>
<p>这里应该出现的error OutofMemoryError 异常信息</p>
<p>场景：在生产环境中 这种动态生成class的方法 是非常常用的方式</p>
<ul>
<li><p>Spring Aop</p>
<p>动态代理 —-cglib Aop的核心</p>
</li>
<li><p>Mybatis</p>
<p>也应用cglib 比如mapper接口的生成</p>
</li>
</ul>
<h4 id="5-11-4-StringTable-串池"><a href="#5-11-4-StringTable-串池" class="headerlink" title="5.11.4 StringTable 串池"></a>5.11.4 StringTable 串池</h4><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/260939453">https://zhuanlan.zhihu.com/p/260939453</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26632895/article/details/105587461">https://blog.csdn.net/qq_26632895/article/details/105587461</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_25884515/article/details/104187125?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1.pc_relevant_paycolumn_v2&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1.pc_relevant_paycolumn_v2&utm_relevant_index=1">https://blog.csdn.net/qq_25884515/article/details/104187125?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.pc_relevant_paycolumn_v2&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.pc_relevant_paycolumn_v2&amp;utm_relevant_index=1</a></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825164538545.png" alt="image-20220825164538545"></p>
<p>String 字符串这个类 不可变的 底层是字符数组</p>
<p>当String 类 String s&#x3D;”hello” 是在StringTable当中的“hello”字符串引用给s这个变量</p>
<p>String拼接的底层使用的StringBuilder 通过append的方法进行底层的拼接，再把StringBuilder转换成String类型</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825164552844.png" alt="image-20220825164552844"></p>
<p>面试题：</p>
<ul>
<li><p>为什么要把StringTable放入到堆空间中</p>
<p>在1.6的JDK中永久代，很少去做垃圾回收的，降低了它的效率 FullGC垃圾回收时才会回收StringTable，但是FullGC的触发条件 老年代空间不足，在永久代空间也不足时才会触发FullGC。会导致StringTable的回收效率不高。 研发的时候 String变量是经常使用的，所以在1.8版本中 放在堆空间里，提升StringTable的回收效率。</p>
<blockquote>
<p>StringTbale的底层数据结构是<strong>HashTable</strong>，每个元素都是<strong>key-value</strong>结构，采用了数组+单向链表的实现方式</p>
<p>Sting中的intern() 这个方法 就是将字符串对象放入的StringTable</p>
<p>调优的代码跑一下</p>
</blockquote>
</li>
</ul>
<h4 id="5-11-5-直接内存"><a href="#5-11-5-直接内存" class="headerlink" title="5.11.5 直接内存"></a>5.11.5 直接内存</h4><p>直接内存 DirectMemory 并不是虚拟机运行时数据区的一部分，也不是规范中定义的内存区域，但它也会OOM。</p>
<p>JDK1.4 加入了NIO new Input&#x2F;Output 引入了一种基于通道 Channel 与缓冲区buffer的IO的方式。可以使用native函数库直接分配堆外的内存，然后通过Java的对象DirectBuffer对象作为这块内存的引用而进行操作。在某些场景中是可以提高性能的，因为它避免了在java堆和native堆中来回的复制数据。</p>
<p>直接内存分配是不受java的堆的大小控制 ，但他还是内存，只要是内存就有限制，</p>
<p>一般情况下我们使用-Xmx 等一些参数的收，会忽略直接内存。 从而导致动态扩展的时候内存总和大于物理内存限制，而出现OOM。</p>
<p>直接内存 是系统内存</p>
<ul>
<li>NIO操作用于数据缓冲区 比普通的IO性能要高</li>
<li>不受JVM内存的回收管理。</li>
<li>分配回收成本比较高，读写的性能比较强。</li>
</ul>
<p>作业：</p>
<ol>
<li>博客作业：整理JVM常用调优参数</li>
<li>博客作业：JVM 内存模型整理，</li>
</ol>
<blockquote>
<p> 美团 面试题 Object o &#x3D; new Object() 有多少个字节 底层如何实现的 内存区域划分</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.FileChannel;</span><br><span class="line"><span class="comment">// 使用IO和NIO哪个效率更高</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo06</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FROM</span> <span class="operator">=</span> <span class="string">&quot;D:\\教学资料\\秋招备战法则\\刷题\\javaWeb\\录屏\\0113Stringtable和直接内存.wmv&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TO</span> <span class="operator">=</span> <span class="string">&quot;D:\\a.wmv&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span>  <span class="type">int</span> <span class="variable">_1MB</span> <span class="operator">=</span> <span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      io();</span><br><span class="line">      directBuffer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用NIO的方式去读取文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title function_">directBuffer</span><span class="params">()</span>  &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>(<span class="type">FileChannel</span> <span class="variable">from</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(FROM).getChannel();</span><br><span class="line">            <span class="type">FileChannel</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(TO).getChannel();</span><br><span class="line">        )&#123;</span><br><span class="line">           <span class="type">ByteBuffer</span> <span class="variable">bb</span> <span class="operator">=</span> ByteBuffer.allocateDirect(_1MB);</span><br><span class="line">           <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">               <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> from.read(bb);</span><br><span class="line">               <span class="keyword">if</span>(len == -<span class="number">1</span>)&#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               bb.flip();</span><br><span class="line">               to.write(bb);</span><br><span class="line">               bb.clear();</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        System.out.println(<span class="string">&quot;directBuffer用时&quot;</span>+(end-start)/<span class="number">1000_000.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * IO的方式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">io</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">FileInputStream</span> <span class="variable">from</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(FROM);</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(TO);</span><br><span class="line">        )&#123;</span><br><span class="line">            <span class="type">byte</span>[] buf = <span class="keyword">new</span> <span class="title class_">byte</span>[_1MB];</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> from.read(buf);</span><br><span class="line">                <span class="keyword">if</span>(len == -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                to.write(buf,<span class="number">0</span>,len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        System.out.println(<span class="string">&quot;io用时&quot;</span>+(end-start)/<span class="number">1000_000.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825164837171.png" alt="image-20220825164837171"></p>
<blockquote>
<p>为什么byteBuffer 它的性能会这么高</p>
</blockquote>
<p>Java本身其实不具备磁盘读写的能力，如果要使用java语言对磁盘进行读写的情况，需要调用操作系统的函数，比如说本地的方法，这里涉及到状态上的切换</p>
<p>使用java语言的IO去读取文件的时候，java的用户态需要切换到系统内核态，先要把文件读取到系统缓存中，java代码没有办法直接去访问系统的缓存，，它就会在堆空间分配一个java缓冲区，然后在通过IO到java的堆的缓冲区内读取，读取后在将内核态转换为用户态，在内存中会存在两份要读取的文件流，所以浪费内存空间，效率降低</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825164907439.png" alt="image-20220825164907439"></p>
<p>使用NIO调用的过程，通过ByteBuffer bb &#x3D; ByteBuffer.<em>allocateDirect</em>(<em>_1MB</em>); 申请一个直接内存，是在系统内存你和java的堆内存之间的，系统可以使用，java代码也可以使用，成倍的速度的提升</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825164918297.png" alt="image-20220825164918297"></p>
<h4 id="5-11-6-直接内存溢出"><a href="#5-11-6-直接内存溢出" class="headerlink" title="5.11.6 直接内存溢出"></a>5.11.6 直接内存溢出</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">//直接内存溢出</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo07</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">_100MB</span> <span class="operator">=</span> <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;ByteBuffer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ByteBuffer&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(_100MB);</span><br><span class="line">                list.add(byteBuffer);</span><br><span class="line">                i++;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825164959450.png" alt="image-20220825164959450"></p>
<h4 id="5-11-7-直接内存释放原理"><a href="#5-11-7-直接内存释放原理" class="headerlink" title="5.11.7 直接内存释放原理"></a>5.11.7 直接内存释放原理</h4><p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825165020188.png" alt="image-20220825165020188"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo08</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">_1GB</span> <span class="operator">=</span> <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(_1GB);</span><br><span class="line">        System.out.println(<span class="string">&quot;分配完毕&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">        System.out.println(<span class="string">&quot;开始释放&quot;</span>);</span><br><span class="line">        byteBuffer = <span class="literal">null</span>;</span><br><span class="line">        System.gc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825165037466.png" alt="image-20220825165037466"></p>
<p>释放内存后</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825165048337.png" alt="image-20220825165048337"></p>
<blockquote>
<p>是不是因为调用垃圾回收器，所以这个直接内存是由垃圾回收器回收？</p>
</blockquote>
<h4 id="5-11-8-Unsafe"><a href="#5-11-8-Unsafe" class="headerlink" title="5.11.8 Unsafe"></a>5.11.8 Unsafe</h4><p>Java语言不像C语言或者是C++可以自己申请内存，java依靠Unsafe这个类提供了类似于C++手动管理内存的能力，所以这个类很危险</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170104464.png" alt="image-20220825170104464"></p>
<p>这个类本身是final 而且它的构造方法也是private 那么这个对象的创建需要通过反射来完成。Unsafe对象的创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title function_">getInstance</span><span class="params">()</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">    <span class="type">Field</span> <span class="variable">unsafeField</span> <span class="operator">=</span> Unsafe.class.getDeclaredFields()[<span class="number">0</span>];</span><br><span class="line">    unsafeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) unsafeField.get(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">return</span> unsafe;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170129198.png" alt="image-20220825170129198"></p>
<p>运行程序</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170139465.png" alt="image-20220825170139465"></p>
<p>点击回车 查看任务管理器， 进程是没有被关掉的，但是内存也被释放了</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170148128.png" alt="image-20220825170148128"></p>
<p>查看一下ByteBuffer的源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DirectByteBuffer(<span class="type">int</span> cap) &#123;                   <span class="comment">// package-private</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>(-<span class="number">1</span>, <span class="number">0</span>, cap, cap);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">pa</span> <span class="operator">=</span> VM.isDirectMemoryPageAligned();</span><br><span class="line">    <span class="type">int</span> <span class="variable">ps</span> <span class="operator">=</span> Bits.pageSize();</span><br><span class="line">    <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> Math.max(<span class="number">1L</span>, (<span class="type">long</span>)cap + (pa ? ps : <span class="number">0</span>));</span><br><span class="line">    Bits.reserveMemory(size, cap);</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">base</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//这里调用的是unsafe的内存申请</span></span><br><span class="line">        base = unsafe.allocateMemory(size);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (OutOfMemoryError x) &#123;</span><br><span class="line">        Bits.unreserveMemory(size, cap);</span><br><span class="line">        <span class="keyword">throw</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    unsafe.setMemory(base, size, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pa &amp;&amp; (base % ps != <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="comment">// Round up to page boundary</span></span><br><span class="line">        address = base + ps - (base &amp; (ps - <span class="number">1</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        address = base;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// Deallocator 这个对象里面调用了释放直接内存</span></span><br><span class="line">    cleaner = Cleaner.create(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">Deallocator</span>(base, size, cap));</span><br><span class="line">    att = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Deallocator</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Runnable</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> Unsafe.getUnsafe();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> address;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> size;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Deallocator</span><span class="params">(<span class="type">long</span> address, <span class="type">long</span> size, <span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> (address != <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">this</span>.address = address;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (address == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Paranoia</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        unsafe.freeMemory(address);</span><br><span class="line">        address = <span class="number">0</span>;</span><br><span class="line">        Bits.unreserveMemory(size, capacity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Cleaner 这个对象是个虚引用，特点是它所关联的对象被引用时，Cleaner就会触发它的clean方法，unsafe调用freeMemory 来进行释放内存，直接内存的实现是接住了java中的虚引用。</p>
<p>禁用显示的垃圾回收：</p>
<p>我们在代码中写的System.gc() 显示的垃圾回收 让System.gc()无效</p>
<p>-XX:+DisableExplicitGC</p>
<p>System.gc() 其实是FullGC </p>
<p>FullGC是一种比较影响性能的垃圾回收，它不光要回收新生代，也要回收老年代，会造成程序的暂停时间比较长，一般在JVM调优过程中会使用这个命令 禁用显示的垃圾回收</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.openlab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo08</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">_1GB</span> <span class="operator">=</span> <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(_1GB);</span><br><span class="line">        System.out.println(<span class="string">&quot;分配完毕&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">        System.out.println(<span class="string">&quot;开始释放&quot;</span>);</span><br><span class="line">        byteBuffer = <span class="literal">null</span>;</span><br><span class="line">        System.gc();</span><br><span class="line">        System.in.read();</span><br><span class="line">        System.out.print(<span class="string">&quot;程序结束&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170339346.png" alt="image-20220825170339346"></p>
<h2 id="Chapter6-JVM常用指令"><a href="#Chapter6-JVM常用指令" class="headerlink" title="Chapter6  JVM常用指令"></a>Chapter6  JVM常用指令</h2><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="Chapter7-垃圾回收算法-GC调优"><a href="#Chapter7-垃圾回收算法-GC调优" class="headerlink" title="Chapter7 垃圾回收算法 GC调优"></a>Chapter7 垃圾回收算法 GC调优</h2><h3 id="7-1-引用计数法"><a href="#7-1-引用计数法" class="headerlink" title="7.1 引用计数法"></a>7.1 引用计数法</h3><p>原理：只要是有引用的对象，就给这个对象增加一个计数，删除一个引用则减少一个计数，垃圾回收的时候，只回收计数为的0对象，这个算法的比较致命的问题，无法处理循环引用的问题</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170540153.png" alt="image-20220825170540153"></p>
<p>说早期python使用的是这种算法，java使用的不是这种算法，java中应用的叫可达性分析算法</p>
<h3 id="7-2-可达性分析算法"><a href="#7-2-可达性分析算法" class="headerlink" title="7.2 可达性分析算法"></a>7.2 可达性分析算法</h3><p>通过一系列的被称为GC Roots的根对象作为起始节点集，从这些节点开始，根据引用关系向下搜索，这个搜索的过程所走的路径被称为 引用链 Reference Chain。如果某个对象到GCRoots 间没有任何引用链相连，则证明此对象不可能再被使用。</p>
<p>什么是GC Roots 不能被垃圾回收的对象 首先先对堆内存进行扫描，堆中的对象如果被GCRoots引用的话，那么就不会被回收，反之没有被GCRoots引用，就需要被回收。</p>
<p>监听堆内存的工具。</p>
<p>Memory Analyzer MAT 是一个Eclipse的工具</p>
<p><a target="_blank" rel="noopener" href="https://www.eclipse.org/mat/">https://www.eclipse.org/mat/</a></p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170620289.png" alt="image-20220825170620289"></p>
<p>通过这段代码来检测</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.maclu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//主要是看list1在有值和没值的情况下做个对比。</span></span><br><span class="line">        List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line">        list.add(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">        System.out.println(<span class="number">1</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">        list = <span class="literal">null</span>;</span><br><span class="line">        System.out.println(<span class="number">2</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">        System.out.println(<span class="string">&quot;end...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要配合几个命令行工具 jps jmap</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170651668.png" alt="image-20220825170651668"></p>
<p>输入指令： jmap -dump:format&#x3D;b,live,file&#x3D;4.bin 12684</p>
<p>-dump  将内存中的运行的内容转储成一个文件</p>
<p>:format b 表示以二进制的文件来展示，live 展示当前进程中没有被回收的变量，live这个参数在执行之前会执行一次垃圾回收 file&#x3D;4.bin 表示文件存储的位置和名称 当前程序的目录下。</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170713685.png" alt="image-20220825170713685"></p>
<p>在程序console下点击回车，再次执行指令</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170723719.png" alt="image-20220825170723719"></p>
<p>用检测工具打开我们生成的文件</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170731638.png" alt="image-20220825170731638"></p>
<p>发送一个分析报告</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170743940.png" alt="image-20220825170743940"></p>
<p>在javabasic 选项中 点击GCRoots的对象</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170759683.png" alt="image-20220825170759683"></p>
<p>System Class 系统执行的时候需要加载的类，这些类都是对象，肯定不会被回收</p>
<p>Native Stack 本地方法栈中的对象，需要系统调用的方法 也不会被回收</p>
<p>Thread 表示活动的线程 正在活动的线程是不会被回收</p>
<p>Busy Monitor 里面的内容是加了lock的对象 也不会被回收</p>
<p>4.bin</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825170809528.png" alt="image-20220825170809528"></p>
<p>第一个4.bin的文件中可以看到main线程中存在ArrayList这个对象</p>
<p> Bin</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825172307718.png" alt="image-20220825172307718"></p>
<p>bin的快照中是没有ArrayList的对象的，那么这个ArrayList就被回收了</p>
<p>GC Roots 中包含了哪些对象：</p>
<ol>
<li>在虚拟机栈中引用的对象</li>
<li>在方法区中类静态属性引用的对象</li>
<li>方法区中常量引用对象</li>
<li>本地方法栈中的JNI引用对象</li>
<li>Java虚拟机的内部引用</li>
<li>所有被同步锁持有的对象</li>
<li>反映java虚拟机内部青苦瓜的JMXBean JVMTI 中注册的回调本地代码缓存的</li>
<li>还有一些是在垃圾收集器中 分代收集和局部回收当中的一些对象</li>
</ol>
<p>怎么去判断哪些变量是需要被回收的，其实就是看GCRoots 是否引用到堆中的对象？</p>
<h3 id="7-3-四种应用"><a href="#7-3-四种应用" class="headerlink" title="7.3 四种应用"></a>7.3 四种应用</h3><p>断对象是否存活和“引用”离不开关系 我们所定义的对象只能处于“被引用”和“未被引用”的状态，那么如果一些对象 当内存不足的时候，是继续保留在内存中，还是应该被回收，如果内存空间在进行垃圾回收后依旧很紧张，那么是应该抛弃这些对象，还是如何处理？</p>
<p>在JDK1.2的版本中java对引用的概念进行了统一的扩充</p>
<p>分为 强引用 软引用 弱引用 和虚引用 (终结器引用)</p>
<ul>
<li><p>强引用： Strongly Reference</p>
<p>最传统的引用的定义，在程序中做的引用赋值操作 比如说Object obj &#x3D; new Object(); 这种引用关系就是强引用，只要强引用存在，垃圾回收器就不会回收被引用的对象，当GCRoots 引用到堆中的对象时 该对象不会被回收，当GCRoots 的引用断开时，会被回收</p>
</li>
<li><p>软引用： Soft Reference</p>
<p>是用来描述一些 还有用，但是非必须的对象，被软引用关联的对象，在系统要发生内存溢出异常前，会把这些对象列进回收范围之中，进行二次回收，如果回收之后内存还不够，才会抛出内存溢出异常，提供了SoftReference类来实现软引用 内存不足的时候会回收，前提是软引用所引用的对象，没有强引用去引用它</p>
</li>
<li><p>弱引用： Weak Reference</p>
<p>非必须的对象，强度比软引用更弱一些， 被弱引用关联的对象，只能活到下一次垃圾回收之前，垃圾回收之后，无论是内存是否足够， 都会回收弱引用所关联的对象。提供WeakReference类来实现弱引用。前提是弱引用所引用的对象，没有强引用去引用它，不管这个弱引用的对象是否重要，都被回收</p>
<p>不管是软引用还是弱引用，他们也都占据了内存，如果要释放掉他们，需要将引用移动到引用队列，由引用队列来进一步处理</p>
</li>
<li><p>虚引用： Phantom Reference</p>
<p>最弱的的一种关系， 对象是否有虚引用的存在，完全不会对生存时间产生影响，使用虚引用目的，在对象被回收的时候，收到一个系统的通知 提供了PhantomReference类来实现 虚引用</p>
<p>举例 在ByteBuffer中有一个对象 Cleaner 继承PhantomReference 虚引用，当强引用和ByteBuffer断开 ByteBuffer 肯定是要被回收的，ByteBuffer还申请了直接内存，直接内存又不能通过java垃圾回收器来回收掉，这个时候会把Cleaner对象拉入引用队列中，队列中有个对象 ReferenceHandler 在引用队列中定时去寻找是否有新的引用传递过来，如果有Cleaner 就会调用自己的clean方法去释放直接内存</p>
</li>
<li><p>终结器引用</p>
<p>所有的对象都会继承Object object中有一个方法叫finalize() 该方法是终结方法。当我们去重写finalize()方法 对象没有强引用时，那么这个对下就可以被当做垃圾进行回收，会将终结器引用 加入到引用队列中，再由一个优先级很低的线程FinalizeHandler 去查看引用队列中是否有终结器的引用， 根据终结器的引用找到这个对象重写的finalize()方法 进行回收。finalize()方法的效率很低，基本上是二次回收，还要将终结器的引用移动到队列， 就会导致finalize() 方法迟迟不会调用，这个对象的内存也是迟迟不能释放。 不推荐大家去使用finalize()方法</p>
</li>
</ul>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825172929460.png" alt="image-20220825172929460"></p>
<h4 id="7-3-1-软引用的使用场景"><a href="#7-3-1-软引用的使用场景" class="headerlink" title="7.3.1 软引用的使用场景"></a>7.3.1 软引用的使用场景</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>  <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_4MB</span> <span class="operator">=</span> <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">4</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;<span class="type">byte</span>[]&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;<span class="type">byte</span>[]&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">byte</span>[_4MB]);</span><br><span class="line">    &#125;</span><br><span class="line">    System.in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>-Xmx20M 设置最大空间</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173206235.png" alt="image-20220825173206235"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">soft</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// list --&gt; SoftReference --&gt; byte[]</span></span><br><span class="line"></span><br><span class="line">    List&lt;SoftReference&lt;<span class="type">byte</span>[]&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        SoftReference&lt;<span class="type">byte</span>[]&gt; ref = <span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">byte</span>[_4MB]);</span><br><span class="line">        System.out.println(ref.get());</span><br><span class="line">        list.add(ref);</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;循环结束：&quot;</span> + list.size());</span><br><span class="line">    <span class="keyword">for</span> (SoftReference&lt;<span class="type">byte</span>[]&gt; ref : list) &#123;</span><br><span class="line">        System.out.println(ref.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173220101.png" alt="image-20220825173220101"></p>
<p>程序是正常执行的，没有溢出，后面的软引用对象被清空了，只保留了一个</p>
<p>加上GC的详细打印的参数：</p>
<p>-XX:+PrintGCDetails -verbose:gc</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173307573.png" alt="image-20220825173307573"></p>
<p>在第三个弱引用对象建立的时候，内存不太够了，内存 分配的失败，触发了垃圾回收，只是回收了新生代，创建第四个软引用，内存的分配又失败，垃圾回收之后 新生代的内存的分配效率还是很低，触发FullGC FullGC 不仅仅要回收新生代，也要回收老年代，一分配又失败，再次触发垃圾回收，新生代的内存全部为清空，老年代中的内存也被清空了一部分</p>
<p>总结： 软引用再内存空间的好处：不重要的对象使用软引用进行关联，在堆空间内存紧张时，就可将其回收</p>
<h4 id="7-3-2-软引用引用队列"><a href="#7-3-2-软引用引用队列" class="headerlink" title="7.3.2 软引用引用队列"></a>7.3.2 软引用引用队列</h4><p>通过上面的案例list的软引用对象已经为null，没必要保存在list集合中，配合引用队列把软引用对象本身清理掉</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.maclu;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.Reference;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.ReferenceQueue;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.SoftReference;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo2_1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 演示软引用, 配合引用队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_4MB</span> <span class="operator">=</span> <span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">            List&lt;SoftReference&lt;<span class="type">byte</span>[]&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 引用队列</span></span><br><span class="line">            ReferenceQueue&lt;<span class="type">byte</span>[]&gt; queue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                <span class="comment">// 关联了引用队列， 当软引用所关联的 byte[]被回收时，软引用自己会加入到 queue 中去</span></span><br><span class="line">                SoftReference&lt;<span class="type">byte</span>[]&gt; ref = <span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">byte</span>[_4MB], queue);</span><br><span class="line">                System.out.println(ref.get());</span><br><span class="line">                list.add(ref);</span><br><span class="line">                System.out.println(list.size());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从队列中获取无用的 软引用对象，并移除</span></span><br><span class="line">            Reference&lt;? <span class="keyword">extends</span> <span class="title class_">byte</span>[]&gt; poll = queue.poll();</span><br><span class="line">            <span class="keyword">while</span>( poll != <span class="literal">null</span>) &#123;</span><br><span class="line">                list.remove(poll);</span><br><span class="line">                poll = queue.poll();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;===========================&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (SoftReference&lt;<span class="type">byte</span>[]&gt; reference : list) &#123;</span><br><span class="line">                System.out.println(reference.get());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从执行结果来看几个null值的不见了，说明被引用队列清理掉了</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173402512.png" alt="image-20220825173402512"></p>
<h4 id="7-3-3-弱引用"><a href="#7-3-3-弱引用" class="headerlink" title="7.3.3 弱引用"></a>7.3.3 弱引用</h4><p>List 强引用 WeakReference </p>
<p>WeakReference 弱引用byte数组</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.maclu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo2_2</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 演示弱引用</span></span><br><span class="line"><span class="comment">     * -Xmx20m -XX:+PrintGCDetails -verbose:gc</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_4MB</span> <span class="operator">=</span> <span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">            <span class="comment">//  list --&gt; WeakReference --&gt; byte[]</span></span><br><span class="line">            List&lt;WeakReference&lt;<span class="type">byte</span>[]&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                WeakReference&lt;<span class="type">byte</span>[]&gt; ref = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">byte</span>[_4MB]);</span><br><span class="line">                list.add(ref);</span><br><span class="line">                <span class="keyword">for</span> (WeakReference&lt;<span class="type">byte</span>[]&gt; w : list) &#123;</span><br><span class="line">                    System.out.print(w.get()+<span class="string">&quot; &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;循环结束：&quot;</span> + list.size());</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173426024.png" alt="image-20220825173426024"></p>
<h3 id="7-4-垃圾回收算法"><a href="#7-4-垃圾回收算法" class="headerlink" title="7.4 垃圾回收算法"></a>7.4 垃圾回收算法</h3><h4 id="7-4-1-标记清除法"><a href="#7-4-1-标记清除法" class="headerlink" title="7.4.1 标记清除法"></a>7.4.1 标记清除法</h4><p>最早出现的也是最基础的垃圾回收算法，这个算法分为两个阶段，“标记”和“清除”两个阶段，首先标记出所有要回收的对象，在标记完成之后，统一回收掉所有被标记的对象（清除），也可以反 标记存活的对象，统一回收未被标记的对象，这个算法需要暂定应用，同时会产生内存碎片</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173519950.png" alt="image-20220825173519950"></p>
<p>扫描整个堆对象，通过GCRoots的链去判断哪些垃圾需要被清楚</p>
<p>定义：Mark Sweep</p>
<p>阶段一： 先去标记，看哪些对象可以被垃圾回收</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173533264.png" alt="image-20220825173533264"></p>
<p>阶段二： 清除 释放对象占用的空间，释放不是把占用的整个内存进行清零的做操做，而是记录对象的起始地址和结束地址，放入空闲地址链表里就可以了，下次分配新对象，就从空闲的链表中找，看看有没有一块足够的空间去容纳新的对象，如果有就进行内存的分配，不会占用的整个内存进行清零的做操做</p>
<ul>
<li><p>优点：速度较快</p>
</li>
<li><p>缺点：执行效率不稳定<br>Java堆中包含大量的对象时，而且大部分是需要被回收的，必须要经历大量的标记和清除动作，导致这两个过程随着对象的增长而性能降低</p>
<blockquote>
<p> 内存空间的碎片化问题</p>
</blockquote>
<p>会产生不连续的空间，如果有大的对象需要足够的连续空间时，会不得不触发另一次垃圾回收的操作</p>
</li>
</ul>
<h4 id="7-4-2-标记整理算法"><a href="#7-4-2-标记整理算法" class="headerlink" title="7.4.2 标记整理算法"></a>7.4.2 标记整理算法</h4><p>定义：Mark Compact</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173723036.png" alt="image-20220825173723036"></p>
<p>阶段一： 标记可回收的对象</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173730016.png" alt="image-20220825173730016"></p>
<p>阶段二： 内存被回收之后，多加了一个步骤，即合并空闲内存区域，减少内存碎片</p>
<ul>
<li><p>缺点：</p>
<p>速度慢，对象在整理的过程中需要被移动，一移动，如果有引用引用了这些对象，则需要改变引用的地址</p>
</li>
</ul>
<h4 id="7-4-3-标记复制算法"><a href="#7-4-3-标记复制算法" class="headerlink" title="7.4.3 标记复制算法"></a>7.4.3 标记复制算法</h4><p>首先把内存划分成了大小相同的两块区域</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173814511.png" alt="image-20220825173814511"></p>
<p>阶段一： 先标记</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173820513.png" alt="image-20220825173820513"></p>
<p>再把from区存活的对象复制到to区，然后就完成了区域碎片的整理，，复制完成之后，From区全是无用的对象，要被回收。回收之后From区就空了</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173834260.png" alt="image-20220825173834260"></p>
<p>两者交换位置</p>
<p>定义：copy</p>
<ul>
<li>优点：<ul>
<li>不会有内存碎片</li>
<li>不需要占用双倍的内存空间</li>
</ul>
</li>
</ul>
<h3 id="7-5-分代回收"><a href="#7-5-分代回收" class="headerlink" title="7.5 分代回收"></a>7.5 分代回收</h3><h4 id="7-5-1-分代思想"><a href="#7-5-1-分代思想" class="headerlink" title="7.5.1 分代思想"></a>7.5.1 分代思想</h4><p>实际上，虚拟机不会使用单独的垃圾回收算法，而是多个算法协同工作，具体的实现即是JVM里的分代的垃圾回收机制</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825173950991.png" alt="image-20220825173950991"></p>
<p>Java 8 堆被分成两份，新生代和老年代（1:2） 在java7还存在永久代</p>
<p>为什么要进行区域的划分？ </p>
<p>内存中的变量可能会需要很长的时间的使用，那么长时间要使用的对象放入到老年代中，新使用的对象放入到新生代中，就可以根据对象的生命周期的不同的特点，来进行垃圾回收。老年代回收很久才发生一次，而新生代垃圾回收会比较频繁</p>
<ul>
<li>新生代：复制算法</li>
<li>老年代：标记-清除 或者标记-整理算法</li>
</ul>
<h4 id="7-5-2-Minor-GC和Full-GC"><a href="#7-5-2-Minor-GC和Full-GC" class="headerlink" title="7.5.2 Minor GC和Full GC"></a>7.5.2 Minor GC和Full GC</h4><p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825174547324.png" alt="image-20220825174547324"></p>
<p>当新生代的存储空间满了之后，会执行Minor GC 会按照可达性分析算法进行标记，这里会使用复制的算法，把存活下来对象复制到幸存区To中</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825174555411.png" alt="image-20220825174555411"></p>
<p>会把Eden区域清空，然后把幸存区To的对象寿命+1</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825174603129.png" alt="image-20220825174603129"></p>
<p>然后会交换幸存区From和幸存区To </p>
<p>大小的默认比例：8:1:1</p>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825174609788.png" alt="image-20220825174609788"></p>
<p>Minor GC ：回收新生代，新生代的对象存活的时间很短，所以Minor GC会频繁的执行，执行的速度也是比较快的</p>
<p>Full GC： 回收老年代和新生代 那么老年代对象存活时间比较长，所以FullGC很少执行，执行的速度要比Minor GC 慢很多</p>
<h4 id="7-5-3-分代分配"><a href="#7-5-3-分代分配" class="headerlink" title="7.5.3 分代分配"></a>7.5.3 分代分配</h4><p>对象优先在Eden区分配：</p>
<p>当创建一个对象时，对象会被分配到新生代的Eden区，当Eden区满了的时候，触发Young GC。</p>
<p>当进行YoungGC之后，此时Eden区存活的对象被移动到To区，并且对象的年龄会+1，清空Eden区。</p>
<p>当再次触发Young GC的时候，会把Eden区中存活下来的对象和To中存活的对象，移动到From区，这些对象的年龄又会+1， 清空Eden区 和To区。</p>
<p>To区永远是空的 Survivor区 From区 有数据区，每次Minor GC后，两个区域互换</p>
<p>会引发stop the world，暂停其他用户的线程 等待垃圾回收结束，用户线程恢复执行。</p>
<p>From区和To区 也可以叫做 S0区 和S1区。</p>
<p>新生代的垃圾回收 一般叫Minor GC 或 YoungGC</p>
<p>晋升到老年代：</p>
<p>长期存活的对象，进入老年代，会为对象定义年龄计数器，对象在Eden出生，经过Minor GC依然存活，就会移动到幸存区，年龄+1，当增加到一定次数的时候，则移动到老年代。</p>
<p>-XX:MaxTenuringThreshold 定义年龄的阀值，对象头中用4个bit做存储，所以最大值是15 默认值也是15。</p>
<p>大对象直接进入到老年代， 需要连续的内存空间，例如很长的字符串或者是数组，避免对象Eden区和幸存区之间进行大量的复制，大对象的出现会提前触发GC 获取足够大的连续空间分配给大对象。</p>
<p>-XX:PretenureSizeThreshold 大于此值的对象会直接放在老年代分配</p>
<p>动态对象的年龄判定： 如果在幸存区中，相同年龄的对象的所有大小和超过了幸存区的空间的一半，年龄大于该年龄的对象就可以直接放入到老年代。</p>
<p>空间分配担保：</p>
<p> 在发生Minor GC之前，虚拟机会先检查老年代最大可用的连续空间是否大于新生代所有的对象总空间，如果这个条件的成立的话，那么Minor GC 可以确认是安全的。如果不成立的话 虚拟机会查看 HandlerPromotionFailure的值是否允许担保失败，如果允许那么就会基础检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小，如果大于将尝试着进行一次Minor GC，如果小于或者HandlerPromotionFailure的值不允许冒险，那么就进行Full GC</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>对象首先分配在Eden区域</p>
<p>新生代空间不足会触发MinorGC Eden和From存活对象会使用copy的算法复制到TO中，存活的对象年龄+1并且交换From和to</p>
<p>MinorGC 触发会引起stop the world 暂停其他用户线程，等待垃圾回收结束，用户线程才恢复运行</p>
<p>当对象的寿命超过阀值 会晋升到老年代，最大的寿命是15 -4个bit</p>
<p>当老年代空间不足时会触发MinorGC ，如果之后空间依旧不足会触发FullGC ，SWT的时间回更长</p>
<h3 id="7-6-JVM的常用参数"><a href="#7-6-JVM的常用参数" class="headerlink" title="7.6 JVM的常用参数"></a>7.6 JVM的常用参数</h3><p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825174811500.png" alt="image-20220825174811500"></p>
<h4 id="7-6-1-垃圾回收过程分析"><a href="#7-6-1-垃圾回收过程分析" class="headerlink" title="7.6.1 垃圾回收过程分析"></a>7.6.1 垃圾回收过程分析</h4><blockquote>
<p>实验1 在没有任何代码的情况下观察GC日志</p>
</blockquote>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825174836660.png" alt="image-20220825174836660"></p>
<p>问题1：新生代的总计部分是9M eden区占了8M form区占1M to区1M 为什么是9M</p>
<p>原因： 没有计算to空间 to区是用来存放依旧存活的对象</p>
<blockquote>
<p>实验2 list中放入7M的byte类型数组</p>
</blockquote>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825174857523.png" alt="image-20220825174857523"></p>
<p>2053 新生代回收前的占用 -&gt; 回收后的占用 回收花费的时间 整个堆在回收前占用的总大小。</p>
<p>注意：为什么了进行了一次GC</p>
<blockquote>
<p>实验3 list中在放入512k的byte数组</p>
</blockquote>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825174908972.png" alt="image-20220825174908972"></p>
<p>Eden区的使用量增长</p>
<blockquote>
<p>实验4 list中再放入512k的byte数组</p>
</blockquote>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825174927792.png" alt="image-20220825174927792"></p>
<p>新生代的内存空间发生不足，进行了2次GC，有些对象晋升到了老年代。</p>
<blockquote>
<p>实验5 list中放入8M的byte类型数组</p>
</blockquote>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825174943459.png" alt="image-20220825174943459"></p>
<p>没有经过GC的，说明这个8M的内容直接存入到了老年代，大的对象直接晋升到老年代，大的对象在老年代空间足够，但新生代内存不足情况下，会直接晋升到老年代。</p>
<blockquote>
<p>实验6 list中再放入8M的byte类型数组</p>
</blockquote>
<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825174953356.png" alt="image-20220825174953356"></p>
<p>由于新生代和老年代都放不下16MB的对昂，而且这两个对象都被ArrayList引用，无法被会回收，造成内存溢出</p>
<blockquote>
<p>实验7 当内存溢出发生在子线程中，它的内存溢出是否会导致整个主线程结束</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.maclu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_512KB</span> <span class="operator">=</span> <span class="number">512</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_1MB</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_6MB</span> <span class="operator">=</span> <span class="number">6</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_7MB</span> <span class="operator">=</span> <span class="number">7</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_8MB</span> <span class="operator">=</span> <span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc</span></span><br><span class="line"><span class="comment">//    public static void main(String[] args) &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        ArrayList&lt;byte[]&gt; list = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">//        list.add(new byte[_8MB]);</span></span><br><span class="line"><span class="comment">//        list.add(new byte[_8MB]);</span></span><br><span class="line"><span class="comment">////        list.add(new byte[_7MB]);</span></span><br><span class="line"><span class="comment">////        list.add(new byte[_512KB]);</span></span><br><span class="line"><span class="comment">////        list.add(new byte[_512KB]);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            ArrayList&lt;<span class="type">byte</span>[]&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            list.add(<span class="keyword">new</span> <span class="title class_">byte</span>[_8MB]);</span><br><span class="line">            list.add(<span class="keyword">new</span> <span class="title class_">byte</span>[_8MB]);</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;sleep....&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">5000L</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\黎明\AppData\Roaming\Typora\typora-user-images\image-20220825175022928.png" alt="image-20220825175022928"></p>
<p>结论： 不会，主线程并没有意外结束， 一个线程内的outOfMemory 不会导致整个线程的结束</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/01/21/Java8/" rel="prev" title="Java8">
      <i class="fa fa-chevron-left"></i> Java8
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/01/21/SpringMVC/" rel="next" title="SpringMVC">
      SpringMVC <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter1-JVM%E5%9F%BA%E7%A1%80"><span class="nav-number">1.</span> <span class="nav-text">Chapter1  JVM基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-JVM%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 JVM基础知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E4%BB%8E%E8%B7%A8%E5%B9%B3%E5%8F%B0%E8%AF%AD%E8%A8%80"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 从跨平台语言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%B8%B8%E8%A7%81JVM%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 常见JVM虚拟机</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter2-Class%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text">Chapter2  Class文件结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-class-file-format"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 class file format</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-class%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E7%9A%84%E8%A7%A3%E6%9E%90"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 class文件结构的解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-%E9%AD%94%E6%95%B0"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.2.1 魔数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-class%E6%96%87%E4%BB%B6%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2.2 class文件版本号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-%E5%B8%B8%E9%87%8F%E6%B1%A0"><span class="nav-number">2.2.3.</span> <span class="nav-text">2.2.3 常量池</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-4-access-flags"><span class="nav-number">2.2.4.</span> <span class="nav-text">2.2.4 access_flags</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-5-this-class"><span class="nav-number">2.2.5.</span> <span class="nav-text">2.2.5 this_class</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-6-super-class"><span class="nav-number">2.2.6.</span> <span class="nav-text">2.2.6 super_class</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-7-%E5%B8%B8%E9%87%8F%E6%B1%A0%E8%AF%A6%E7%BB%86%E8%A7%A3%E6%9E%90"><span class="nav-number">2.2.7.</span> <span class="nav-text">2.2.7 常量池详细解析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter3-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">3.</span> <span class="nav-text">Chapter3  类加载和初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Class-Cycle"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 Class Cycle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-ClassLoader"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 ClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 双亲委派</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E7%88%B6%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 父加载器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E8%8C%83%E5%9B%B4"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 类加载器范围</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 自定义加载器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-%E7%BC%96%E8%AF%91%E5%99%A8-JIT"><span class="nav-number">3.7.</span> <span class="nav-text">3.7 编译器 JIT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-%E6%87%92%E5%8A%A0%E8%BD%BD"><span class="nav-number">3.8.</span> <span class="nav-text">3.8 懒加载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter4-JMM-Java%E5%86%85%E5%AD%98%E6%9E%B6%E6%9E%84"><span class="nav-number">4.</span> <span class="nav-text">Chapter4  JMM Java内存架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E7%A1%AC%E4%BB%B6%E5%B1%82%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E7%9A%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 硬件层并发优化的基础知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E7%BC%93%E5%AD%98%E8%A1%8C%E5%92%8C%E4%BC%AA%E5%85%B1%E4%BA%AB"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 缓存行和伪共享</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E4%B9%B1%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 乱序问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%E4%B9%B1%E5%BA%8F%E8%AF%81%E6%98%8E"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 乱序证明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E7%89%B9%E5%AE%9A%E6%83%85%E5%86%B5%E4%B8%8B%E4%B8%8D%E4%B9%B1%E5%BA%8F"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 如何保证特定情况下不乱序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter5-JVM%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="nav-number">5.</span> <span class="nav-text">Chapter5  JVM内存结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-JVM-%E7%B3%BB%E7%BB%9F%E7%BA%BF%E7%A8%8B"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 JVM 系统线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 程序计数器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 虚拟机栈</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-1-%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E8%A1%A8"><span class="nav-number">5.3.1.</span> <span class="nav-text">5.3.1 局部变量表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-2-JVM%E6%A0%88%E5%B8%A7"><span class="nav-number">5.3.2.</span> <span class="nav-text">5.3.2 JVM栈帧</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-3-%E6%93%8D%E4%BD%9C%E6%95%B0%E6%A0%88"><span class="nav-number">5.3.3.</span> <span class="nav-text">5.3.3 操作数栈</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-4-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5"><span class="nav-number">5.3.4.</span> <span class="nav-text">5.3.4 动态链接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-5-%E6%96%B9%E6%B3%95%E8%BF%94%E5%9B%9E%E5%9C%B0%E5%9D%80"><span class="nav-number">5.3.5.</span> <span class="nav-text">5.3.5 方法返回地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-6-%E9%99%84%E5%8A%A0%E4%BF%A1%E6%81%AF"><span class="nav-number">5.3.6.</span> <span class="nav-text">5.3.6 附加信息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88-Native%E6%A0%88"><span class="nav-number">5.4.</span> <span class="nav-text">5.4 本地方法栈 Native栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-%E5%A0%86"><span class="nav-number">5.5.</span> <span class="nav-text">5.5 堆</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-5-1-%E5%88%86%E4%BB%A3%E7%AD%96%E7%95%A5"><span class="nav-number">5.5.1.</span> <span class="nav-text">5.5.1 分代策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-number">5.6.</span> <span class="nav-text">5.6 内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-6-1-%E6%96%B0%E7%94%9F%E4%BB%A3"><span class="nav-number">5.6.1.</span> <span class="nav-text">5.6.1 新生代</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-6-2-%E8%80%81%E5%B9%B4%E4%BB%A3"><span class="nav-number">5.6.2.</span> <span class="nav-text">5.6.2 老年代</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-6-3-%E6%B0%B8%E4%B9%85%E4%BB%A3-PermanentGeneration-metaspace"><span class="nav-number">5.6.3.</span> <span class="nav-text">5.6.3 永久代 PermanentGeneration -metaspace</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-7-%E9%9D%9E%E5%A0%86%E5%86%85%E5%AD%98"><span class="nav-number">5.7.</span> <span class="nav-text">5.7 非堆内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-8-%E6%A0%88%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-number">5.8.</span> <span class="nav-text">5.8 栈内存溢出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-9-%E5%A0%86%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-number">5.9.</span> <span class="nav-text">5.9 堆内存溢出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-10-%E5%A0%86%E5%86%85%E5%AD%98%E8%AF%8A%E6%96%AD"><span class="nav-number">5.10.</span> <span class="nav-text">5.10 堆内存诊断</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-10-1-jsp%E6%8C%87%E4%BB%A4"><span class="nav-number">5.10.1.</span> <span class="nav-text">5.10.1 jsp指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-10-2-jmap%E6%8C%87%E4%BB%A4"><span class="nav-number">5.10.2.</span> <span class="nav-text">5.10.2 jmap指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-10-3-jconsole"><span class="nav-number">5.10.3.</span> <span class="nav-text">5.10.3 jconsole</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-10-4-%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="nav-number">5.10.4.</span> <span class="nav-text">5.10.4 面试题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-11-%E6%96%B9%E6%B3%95%E5%8C%BAMethodArea"><span class="nav-number">5.11.</span> <span class="nav-text">5.11 方法区MethodArea</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-11-1-%E6%96%B9%E6%B3%95%E5%8C%BA%E7%BB%93%E6%9E%84"><span class="nav-number">5.11.1.</span> <span class="nav-text">5.11.1 方法区结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-11-2-JDK1-6%E7%89%88%E6%9C%AC-JDK1-7%E7%89%88%E6%9C%AC-JDK1-8%E7%89%88%E6%9C%AC"><span class="nav-number">5.11.2.</span> <span class="nav-text">5.11.2 JDK1.6版本 JDK1.7版本 JDK1.8版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-11-3-%E6%96%B9%E6%B3%95%E5%8C%BA%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-number">5.11.3.</span> <span class="nav-text">5.11.3 方法区内存溢出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-11-4-StringTable-%E4%B8%B2%E6%B1%A0"><span class="nav-number">5.11.4.</span> <span class="nav-text">5.11.4 StringTable 串池</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-11-5-%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98"><span class="nav-number">5.11.5.</span> <span class="nav-text">5.11.5 直接内存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-11-6-%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-number">5.11.6.</span> <span class="nav-text">5.11.6 直接内存溢出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-11-7-%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98%E9%87%8A%E6%94%BE%E5%8E%9F%E7%90%86"><span class="nav-number">5.11.7.</span> <span class="nav-text">5.11.7 直接内存释放原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-11-8-Unsafe"><span class="nav-number">5.11.8.</span> <span class="nav-text">5.11.8 Unsafe</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter6-JVM%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4"><span class="nav-number">6.</span> <span class="nav-text">Chapter6  JVM常用指令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link"><span class="nav-number">7.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter7-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95-GC%E8%B0%83%E4%BC%98"><span class="nav-number">8.</span> <span class="nav-text">Chapter7 垃圾回收算法 GC调优</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E6%B3%95"><span class="nav-number">8.1.</span> <span class="nav-text">7.1 引用计数法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E5%8F%AF%E8%BE%BE%E6%80%A7%E5%88%86%E6%9E%90%E7%AE%97%E6%B3%95"><span class="nav-number">8.2.</span> <span class="nav-text">7.2 可达性分析算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%E5%9B%9B%E7%A7%8D%E5%BA%94%E7%94%A8"><span class="nav-number">8.3.</span> <span class="nav-text">7.3 四种应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-1-%E8%BD%AF%E5%BC%95%E7%94%A8%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">8.3.1.</span> <span class="nav-text">7.3.1 软引用的使用场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-2-%E8%BD%AF%E5%BC%95%E7%94%A8%E5%BC%95%E7%94%A8%E9%98%9F%E5%88%97"><span class="nav-number">8.3.2.</span> <span class="nav-text">7.3.2 软引用引用队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-3-%E5%BC%B1%E5%BC%95%E7%94%A8"><span class="nav-number">8.3.3.</span> <span class="nav-text">7.3.3 弱引用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95"><span class="nav-number">8.4.</span> <span class="nav-text">7.4 垃圾回收算法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-1-%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4%E6%B3%95"><span class="nav-number">8.4.1.</span> <span class="nav-text">7.4.1 标记清除法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-2-%E6%A0%87%E8%AE%B0%E6%95%B4%E7%90%86%E7%AE%97%E6%B3%95"><span class="nav-number">8.4.2.</span> <span class="nav-text">7.4.2 标记整理算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-3-%E6%A0%87%E8%AE%B0%E5%A4%8D%E5%88%B6%E7%AE%97%E6%B3%95"><span class="nav-number">8.4.3.</span> <span class="nav-text">7.4.3 标记复制算法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-%E5%88%86%E4%BB%A3%E5%9B%9E%E6%94%B6"><span class="nav-number">8.5.</span> <span class="nav-text">7.5 分代回收</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-1-%E5%88%86%E4%BB%A3%E6%80%9D%E6%83%B3"><span class="nav-number">8.5.1.</span> <span class="nav-text">7.5.1 分代思想</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-Minor-GC%E5%92%8CFull-GC"><span class="nav-number">8.5.2.</span> <span class="nav-text">7.5.2 Minor GC和Full GC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-3-%E5%88%86%E4%BB%A3%E5%88%86%E9%85%8D"><span class="nav-number">8.5.3.</span> <span class="nav-text">7.5.3 分代分配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">8.5.4.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-JVM%E7%9A%84%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="nav-number">8.6.</span> <span class="nav-text">7.6 JVM的常用参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-1-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">8.6.1.</span> <span class="nav-text">7.6.1 垃圾回收过程分析</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Linyuxuan</p>
  <div class="site-description" itemprop="description">Hope Sometimes Love Brain</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Linyuxuan</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>

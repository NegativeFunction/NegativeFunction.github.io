<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/logo.png">
  <link rel="mask-icon" href="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/logo.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"negativefunction.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="JVM1. JVM学习路线预科知识JVM Java Virtual Machine - java 程序的运行环境（java 二进制字节码的运行环境） JVM运行优点  一次编写，到处运行  自动内存管理，垃圾回收功能  数组下标越界检查  多态  对比 jvm jre jdk       学习路线 JVM学习路线   JVM内存结构 GC 类文件 字节码 JMM      常见 JVM  我们讲的">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM2023">
<meta property="og:url" content="https://negativefunction.github.io/2023/01/31/JVM2023/index.html">
<meta property="og:site_name" content="Welcome To Lin&#39;s World">
<meta property="og:description" content="JVM1. JVM学习路线预科知识JVM Java Virtual Machine - java 程序的运行环境（java 二进制字节码的运行环境） JVM运行优点  一次编写，到处运行  自动内存管理，垃圾回收功能  数组下标越界检查  多态  对比 jvm jre jdk       学习路线 JVM学习路线   JVM内存结构 GC 类文件 字节码 JMM      常见 JVM  我们讲的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128150337660.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128150845220.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128150432239.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128152640256.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128152825298.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128153020836.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129012754941.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129013631960.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129015128973.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129015345868.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129090700284.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129101855859.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129112853529.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129121046158.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129121151640.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129131054638.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129131251850.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129131816652.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129133749036.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129210113990.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129211027300.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129213846780.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129213944215.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129214043107.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129215758960.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129224550527.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129224718852.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129224838168.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129225024054.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129225121508.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129225217701.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129231349686.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129232108951.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129232715976.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129232241335.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129233803355.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130000021564.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130000148827.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130000221800.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130000445008.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130000724967.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130001005885.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130002349990.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130002726856.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130003632501.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130004007273.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130013106452.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130020617028.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130023122098.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131015553127.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102433463.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102503672.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102533975.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102627560.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102655779.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102711519.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102747310.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102815074.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102833858.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102855048.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102915850.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102940090.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102951366.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103050009.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103104858.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103124540.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103137016.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103205056.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103219333.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103308678.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103334036.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103512529.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103536823.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103549930.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103614656.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103629149.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103639878.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103650675.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103701865.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103715500.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103726645.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103741012.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131024938366.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130153415487.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130153500801.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131033208864.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131033307710.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130153611470.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131033355876.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130153640850.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130153713226.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131034417149.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131034453798.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130161924281.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131112923075.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131113343984.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131113644275.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130163448952.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131132216900.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131135234604.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130165217833.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130225619474.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130225647369.png">
<meta property="og:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130225722127.png">
<meta property="article:published_time" content="2023-01-31T07:34:47.000Z">
<meta property="article:modified_time" content="2023-01-31T07:35:04.261Z">
<meta property="article:author" content="Linyuxuan">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128150337660.png">

<link rel="canonical" href="https://negativefunction.github.io/2023/01/31/JVM2023/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>JVM2023 | Welcome To Lin's World</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Welcome To Lin's World</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">The Future Will Come</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">18</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://negativefunction.github.io/2023/01/31/JVM2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/05.jpg">
      <meta itemprop="name" content="Linyuxuan">
      <meta itemprop="description" content="Hope Sometimes Love Brain">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome To Lin's World">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JVM2023
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-31 15:34:47 / Modified: 15:35:04" itemprop="dateCreated datePublished" datetime="2023-01-31T15:34:47+08:00">2023-01-31</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h1><h2 id="1-JVM学习路线"><a href="#1-JVM学习路线" class="headerlink" title="1. JVM学习路线"></a>1. JVM学习路线</h2><h3 id="预科知识"><a href="#预科知识" class="headerlink" title="预科知识"></a>预科知识</h3><p>JVM Java Virtual Machine - java 程序的运行环境（java 二进制字节码的运行环境）</p>
<p><strong>JVM运行优点</strong></p>
<ul>
<li>一次编写，到处运行 </li>
<li>自动内存管理，垃圾回收功能 </li>
<li>数组下标越界检查 </li>
<li>多态</li>
</ul>
<p><strong>对比 jvm jre jdk</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128150337660.png" alt="image-20230128150337660" style="zoom:67%;margin-left:0" />





<h3 id="学习路线"><a href="#学习路线" class="headerlink" title="学习路线"></a>学习路线</h3><blockquote>
<p><strong>JVM学习路线</strong></p>
</blockquote>
<ol>
<li>JVM内存结构</li>
<li>GC</li>
<li>类文件</li>
<li>字节码</li>
<li>JMM</li>
</ol>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128150845220.png" alt="image-20230128150845220" style="zoom:67%;margin-left:0" />



<h3 id="常见-JVM"><a href="#常见-JVM" class="headerlink" title="常见 JVM"></a>常见 JVM</h3><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128150432239.png" alt="image-20230128150432239" style="zoom:80%;margin-left:0" />

<p><strong>我们讲的以 HotSpot 为主</strong></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Comparison_of_Java_virtual_machines">维基参考</a></p>
<p><a target="_blank" rel="noopener" href="https://www.javainterviewpoint.com/java-virtual-machine-architecture-in-java/">JVM资料参考</a></p>
<h2 id="2-JVM内存结构"><a href="#2-JVM内存结构" class="headerlink" title="2. JVM内存结构"></a>2. JVM内存结构</h2><ol>
<li>程序计数器</li>
<li>虚拟机栈</li>
<li>本地方法栈</li>
<li>堆</li>
<li>方法区</li>
</ol>
<h3 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h3><p>Program Counter Register 程序计数器（<strong>通过寄存器实现 –寄存器是CPU读取最快的空间</strong>）</p>
<ul>
<li><strong>作用，是记住下一条jvm指令的执行地址</strong></li>
<li>&#x3D;&#x3D;特点&#x3D;&#x3D;<ul>
<li>&#x3D;&#x3D;是线程私有的&#x3D;&#x3D; </li>
<li>&#x3D;&#x3D;不会存在内存溢出&#x3D;&#x3D;</li>
</ul>
</li>
</ul>
<p><strong>作用</strong></p>
<figure class="highlight plaintext"><figcaption><span>basic</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0: getstatic #20 // PrintStream out = System.out;</span><br><span class="line">3: astore_1 // --</span><br><span class="line">4: aload_1 // out.println(1);</span><br><span class="line">5: iconst_1 // --</span><br><span class="line">6: invokevirtual #26 // --</span><br><span class="line">9: aload_1 // out.println(2);</span><br><span class="line">10: iconst_2 // --</span><br><span class="line">11: invokevirtual #26 // --</span><br><span class="line">14: aload_1 // out.println(3);</span><br><span class="line">15: iconst_3 // --</span><br><span class="line">16: invokevirtual #26 // --</span><br><span class="line">19: aload_1 // out.println(4);</span><br><span class="line">20: iconst_4 // --</span><br><span class="line">21: invokevirtual #26 // --</span><br><span class="line">24: aload_1 // out.println(5);</span><br><span class="line">25: iconst_5 // --</span><br><span class="line">26: invokevirtual #26 // --</span><br><span class="line">29: return</span><br></pre></td></tr></table></figure>



<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128152640256.png" alt="image-20230128152640256" style="zoom:67%;margin-left:0" />



<p><em>时间片概念</em>：时间片即CPU分配给各个程序的时间，每个进程被分配一个时间段，称作它的时间片，即该进程允许运行的时间，使各个程序从表面上看是同时进行的</p>
<p><strong>每个线程都有自己的程序计数器</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128152825298.png" alt="image-20230128152825298" style="zoom:67%;margin-left:0" />



<h3 id="虚拟机栈"><a href="#虚拟机栈" class="headerlink" title="虚拟机栈"></a>虚拟机栈</h3><h4 id="虚拟机栈概念"><a href="#虚拟机栈概念" class="headerlink" title="虚拟机栈概念"></a>虚拟机栈概念</h4><p><strong>Java Virtual Machine Stacks （Java 虚拟机栈）</strong></p>
<ul>
<li>每个线程运行时所需要的内存，称为虚拟机栈 </li>
<li>每个栈由多个栈帧（Frame）组成，对应着每次方法调用时所占用的内存 </li>
<li>每个线程只能有一个活动栈帧，对应着当前正在执行的那个方法</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230128153020836.png" alt="image-20230128153020836" style="zoom:67%;margin-left:0" />



<p><strong>思考</strong></p>
<ol>
<li>垃圾回收是否涉及栈内存？垃圾回收不管理栈内存 -&gt; 垃圾回收只回收堆内存，而栈内存在每次栈帧执行完弹栈时都会释放</li>
<li>栈内存分配越大越好吗？栈内存越大，只能使同一线程函数递归的次数越多，并不是越大越好 -&gt; Linux 1024KB; macOS 1024KB; Windows The default value depends on virtual memory (栈内存越大 -&gt; 线程数越少 因为物理内存是一定的 例如总物理 500M 一个线程 1M 理论上可以有 500个线程；如果每个栈内存 2M 理论上只能有 250个线程运行)</li>
<li>方法内的局部变量是否线程安全？<ul>
<li>如果方法内局部变量**没有逃离方法的作用访问(参数传入，或 return 传出)**，它是线程安全的  <code>int x = 0</code></li>
<li>如果是局部变量引用了对象，**并逃离方法的作用范围(参数传入，或 return 传出)**，需要考虑线程安全 <code>static int x = 0</code></li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_17</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        sb.append(<span class="number">4</span>);</span><br><span class="line">        sb.append(<span class="number">5</span>);</span><br><span class="line">        sb.append(<span class="number">6</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            m2(sb);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        sb.append(<span class="number">1</span>);</span><br><span class="line">        sb.append(<span class="number">2</span>);</span><br><span class="line">        sb.append(<span class="number">3</span>);</span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">m2</span><span class="params">(StringBuilder sb)</span> &#123;</span><br><span class="line">        sb.append(<span class="number">1</span>);</span><br><span class="line">        sb.append(<span class="number">2</span>);</span><br><span class="line">        sb.append(<span class="number">3</span>);</span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StringBuilder <span class="title function_">m3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        sb.append(<span class="number">1</span>);</span><br><span class="line">        sb.append(<span class="number">2</span>);</span><br><span class="line">        sb.append(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> sb;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>参考 Java 参数文档</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/">https://docs.oracle.com/javase/8/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/">https://docs.oracle.com/en/java/javase/11/</a> </p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/java.html">https://docs.oracle.com/en/java/javase/11/tools/java.html</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/">https://docs.oracle.com/en/java/javase/17/</a></p>
<h4 id="栈内存溢出"><a href="#栈内存溢出" class="headerlink" title="栈内存溢出"></a>栈内存溢出</h4><h5 id="栈帧过多导致栈内存溢出"><a href="#栈帧过多导致栈内存溢出" class="headerlink" title="栈帧过多导致栈内存溢出"></a>栈帧过多导致栈内存溢出</h5><ul>
<li>栈帧过多导致栈内存溢出</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        method1();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">        method2(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">method2</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span>  a + b;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            method1();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(count);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">        count++;</span><br><span class="line">        method1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>StackOverFlowError</strong></p>
<h5 id="栈帧过大导致栈内存溢出"><a href="#栈帧过大导致栈内存溢出" class="headerlink" title="栈帧过大导致栈内存溢出"></a>栈帧过大导致栈内存溢出</h5><ul>
<li>栈帧过大导致栈内存溢出</li>
</ul>
<p>设置栈size</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xss256k</span><br></pre></td></tr></table></figure>



<h5 id="第三方库导致-StackOverFlowError"><a href="#第三方库导致-StackOverFlowError" class="headerlink" title="第三方库导致 StackOverFlowError"></a>第三方库导致 <strong>StackOverFlowError</strong></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.jvm.t1.stack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonIgnore;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * json 数据转换</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_19</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">        <span class="type">Dept</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dept</span>();</span><br><span class="line">        d.setName(<span class="string">&quot;Market&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Emp</span> <span class="variable">e1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Emp</span>();</span><br><span class="line">        e1.setName(<span class="string">&quot;zhang&quot;</span>);</span><br><span class="line">        e1.setDept(d);</span><br><span class="line"></span><br><span class="line">        <span class="type">Emp</span> <span class="variable">e2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Emp</span>();</span><br><span class="line">        e2.setName(<span class="string">&quot;li&quot;</span>);</span><br><span class="line">        e2.setDept(d);</span><br><span class="line"></span><br><span class="line">        d.setEmps(Arrays.asList(e1, e2));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &#123; name: &#x27;Market&#x27;, emps: [&#123; name:&#x27;zhang&#x27;, dept:&#123; name:&#x27;&#x27;, emps: [ &#123;&#125;]&#125; &#125;,] &#125;</span></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        System.out.println(mapper.writeValueAsString(d));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Emp</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> Dept dept;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Dept <span class="title function_">getDept</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dept;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDept</span><span class="params">(Dept dept)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dept = dept;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dept</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Emp&gt; emps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Emp&gt; <span class="title function_">getEmps</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> emps;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEmps</span><span class="params">(List&lt;Emp&gt; emps)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.emps = emps;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="线程运行诊断"><a href="#线程运行诊断" class="headerlink" title="线程运行诊断"></a>线程运行诊断</h4><p><strong>问题1</strong></p>
<p>cpu 占用过多</p>
<p>定位 </p>
<ul>
<li>用top定位哪个进程对cpu的占用过高 </li>
<li>ps H -eo pid,tid,%cpu | grep 进程id （用ps命令进一步定位是哪个线程引起的cpu占用过高） </li>
<li>jstack 进程id <ul>
<li>可以根据线程id (nid) 找到有问题的线程，进一步定位到问题代码的源码行号</li>
</ul>
</li>
</ul>
<p><strong>Java占用内存过高</strong></p>
<p><code>top</code>查看</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129012754941.png" alt="image-20230129012754941" style="zoom:80%;margin-left:0" />

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前所有线程相对应指标</span></span><br><span class="line">ps H -eo pid,tid,%cpu</span><br><span class="line"></span><br><span class="line">ps H -eo pid,tid,%cpu | grep 32655</span><br><span class="line"></span><br><span class="line"><span class="comment"># jdk提供</span></span><br><span class="line">jstack 32655</span><br></pre></td></tr></table></figure>





<p><strong>问题2</strong></p>
<p>程序运行很长时间没有结果</p>
<p><em>有可能因为线程死锁</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> java cn.itcast.jvm.t1.Demo1_3&amp;</span><br><span class="line"><span class="built_in">nohup</span>: ignoring input and appending output to `nohup.out`</span><br></pre></td></tr></table></figure>

<p>排查线程死锁</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack 32655</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示线程死锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>&#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>&#123;&#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_3</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">B</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (a) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;我获得了 a 和 b&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (a) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;我获得了 a 和 b&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h3><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129013631960.png" alt="image-20230129013631960" style="zoom:80%;margin-left:0" />

<p><strong>本地方法接口指 -&gt; 不是由Java代码编写，由于Java代码有一定的限制，不能直接操作OS底层，所以就需要使用 c&#x2F;c++ 编写的本地方法来与操作OS底层的API对接 -&gt; Java代码可以间接通过本地方法来操作OS，而本地方法运行时使用的内存就是本地方法栈</strong></p>
<p><code>native修饰</code>的本地方法</p>
<h3 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h3><h4 id="堆概念"><a href="#堆概念" class="headerlink" title="堆概念"></a>堆概念</h4><p><em>Heap 堆</em></p>
<ul>
<li>通过 new 关键字，创建对象都会<strong>使用堆内存</strong></li>
</ul>
<p><em>特点</em></p>
<ul>
<li>它是<strong>线程共享</strong>的，堆中对象都<strong>需要考虑线程安全</strong>的问题 </li>
<li><strong>有垃圾回收机制</strong></li>
</ul>
<h4 id="堆内存溢出"><a href="#堆内存溢出" class="headerlink" title="堆内存溢出"></a>堆内存溢出</h4><h4 id="堆内存诊断"><a href="#堆内存诊断" class="headerlink" title="堆内存诊断"></a>堆内存诊断</h4><ol>
<li>jsp工具<ul>
<li>查看当前系统中有哪些 java 进程</li>
</ul>
</li>
<li>jmap<ul>
<li>查看堆内存占用情况 jmap - heap 进程id <em>–查看某一时刻，类似于快照</em></li>
</ul>
</li>
<li>jconsole<ul>
<li>图形界面的，多功能的监测工具，可以连续监测</li>
</ul>
</li>
<li>jvirsualvm</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示堆内存溢出 java.lang.OutOfMemoryError: Java heap space</span></span><br><span class="line"><span class="comment"> * -Xmx8m</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_5</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                list.add(a); <span class="comment">// hello, hellohello, hellohellohellohello ...</span></span><br><span class="line">                a = a + a;  <span class="comment">// hellohellohellohello</span></span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OutOfMemoryError</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示堆内存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_4</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1...&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">        <span class="type">byte</span>[] array = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">10</span>]; <span class="comment">// 10 Mb</span></span><br><span class="line">        System.out.println(<span class="string">&quot;2...&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">20000</span>);</span><br><span class="line">        array = <span class="literal">null</span>;</span><br><span class="line">        System.gc();</span><br><span class="line">        System.out.println(<span class="string">&quot;3...&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jmap -heap 18756</span><br><span class="line">jmap -heap &lt;进程<span class="built_in">id</span>&gt;</span><br></pre></td></tr></table></figure>



<p><strong>jconsole</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129015128973.png" alt="image-20230129015128973" style="zoom:80%;margin-left:0" />





<p><strong>垃圾回收后，内存占用仍然很高</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jdk提供</span></span><br><span class="line">jvisualvm</span><br></pre></td></tr></table></figure>

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129015345868.png" alt="image-20230129015345868" style="zoom:80%;margin-left:0" />





<h3 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h3><h4 id="方法区概念"><a href="#方法区概念" class="headerlink" title="方法区概念"></a>方法区概念</h4><p><strong>方法区概念</strong></p>
<p>方法区是所有Java虚拟机线程共享的区域（此特点类似堆），方法区中存储与类结构相关的信息（类 field, method data, methods, constructions 包含 special methods），同样包含 run-time constant pool，运行时常量池</p>
<p>&#x3D;&#x3D;<em>定义概念上，方法区是 heap 的一部分，但是具体的厂商在完成不同 JVM 的实现时，不一定会遵循定义概念</em>&#x3D;&#x3D;</p>
<p>规范并不强制方法区的实现位置 -&gt; jdk8 以前的 hotspot 方法区的实现叫做<strong>永久带</strong>（就是使用堆内存的一部分）-&gt; jdk1.8 之后的方法区实现换了一种方式叫做<strong>元空间</strong>（用的就不是堆内存，而是本地内存 -&gt; 直接操作系统内存）-&gt; 不同实现就导致方法区的位置不同</p>
<p>同样方法区也会导致 <code>OutOfMemoryError</code></p>
<blockquote>
<p>The Java Virtual Machine has a <em>method area</em> that is shared among all Java Virtual Machine threads. The method area is analogous to the storage area for compiled code of a conventional language or analogous to the “text” segment in an operating system process. It stores per-class structures such as the run-time constant pool, field and method data, and the code for methods and constructors, including the special methods (<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.9">§2.9</a>) used in class and instance initialization and interface initialization.</p>
<p>The method area is created <strong>on virtual machine start-up</strong>. Although the method area is <strong>logically part of the heap</strong>, simple implementations may choose not to either garbage collect or compact it. This specification does not mandate the location of the method area or the policies used to manage compiled code. The method area may be of a fixed size or may be expanded as required by the computation and may be contracted if a larger method area becomes unnecessary. The memory for the method area does not need to be contiguous.</p>
<p>A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of the method area, as well as, in the case of a varying-size method area, control over the maximum and minimum method area size.</p>
<p>The following exceptional condition is associated with the method area:</p>
<ul>
<li>If memory in the method area cannot be made available to satisfy an allocation request, the Java Virtual Machine throws an <code>OutOfMemoryError</code>.</li>
</ul>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html">官方定义</a></p>
<p><strong>组成图</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129090700284.png" alt="image-20230129090700284" style="zoom:80%;margin-left:0" />

<ul>
<li><strong>jdk1.6 常量池 -&gt; 运行时常量池 -&gt; 包含 StringTable</strong></li>
<li>&#x3D;&#x3D;<strong>jdk1.8 之后，方法区就被移到本地内存中 -&gt; 称为元空间 -&gt; 而 StringTable 则被移到 Heap 堆空间中</strong>&#x3D;&#x3D;</li>
</ul>
<h4 id="方法区内存溢出"><a href="#方法区内存溢出" class="headerlink" title="方法区内存溢出"></a>方法区内存溢出</h4><ul>
<li>1.8 以前会导致永久代内存溢出</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 演示永久代内存溢出 java.lang.OutOfMemoryError: PermGen space</span><br><span class="line">* -XX:MaxPermSize=8m</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示永久代内存溢出  java.lang.OutOfMemoryError: PermGen space</span></span><br><span class="line"><span class="comment"> * -XX:MaxPermSize=8m</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_8</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Demo1_8</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Demo1_8</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20000</span>; i++, j++) &#123;</span><br><span class="line">                <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(<span class="number">0</span>);</span><br><span class="line">                cw.visit(Opcodes.V1_6, Opcodes.ACC_PUBLIC, <span class="string">&quot;Class&quot;</span> + i, <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">                <span class="type">byte</span>[] code = cw.toByteArray();</span><br><span class="line">                test.defineClass(<span class="string">&quot;Class&quot;</span> + i, code, <span class="number">0</span>, code.length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示元空间内存溢出 java.lang.OutOfMemoryError: Metaspace</span></span><br><span class="line"><span class="comment"> * -XX:MaxMetaspaceSize=8m</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_8</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123; <span class="comment">// 可以用来加载类的二进制字节码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Demo1_8</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Demo1_8</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++, j++) &#123;</span><br><span class="line">                <span class="comment">// ClassWriter 作用是生成类的二进制字节码</span></span><br><span class="line">                <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 版本号， public， 类名, 包名, 父类， 接口</span></span><br><span class="line">                cw.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, <span class="string">&quot;Class&quot;</span> + i, <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">                <span class="comment">// 返回 byte[]</span></span><br><span class="line">                <span class="type">byte</span>[] code = cw.toByteArray();</span><br><span class="line">                <span class="comment">// 执行了类的加载</span></span><br><span class="line">                test.defineClass(<span class="string">&quot;Class&quot;</span> + i, code, <span class="number">0</span>, code.length); <span class="comment">// Class 对象</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>1.8 之后会导致元空间内存溢出</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 演示元空间内存溢出 java.lang.OutOfMemoryError: Metaspace</span><br><span class="line">* -XX:MaxMetaspaceSize=8m</span><br></pre></td></tr></table></figure>



<p><strong>案例</strong></p>
<ul>
<li>spring</li>
<li>mybatis</li>
</ul>
<h4 id="运行时常量池"><a href="#运行时常量池" class="headerlink" title="运行时常量池"></a>运行时常量池</h4><p><strong>常量池</strong></p>
<p>常量池，就是一张表，虚拟机指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量等信息</p>
<p><strong>运行时常量池</strong></p>
<p>运行时常量池，常量池是 *.class 文件中的，当该类被加载，它的常量池信息就会放入运行时常量池，并把里面的符号地址变为真实地址</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 二进制字节码（类基本信息，常量池，类方法定义，包含了虚拟机指令）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>借助jdk提供的反编译工具 <code>javap -v HelloWorld.class</code> -&gt; <code>-v</code> 显示反编译后的详细信息</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\Todo\note\Software\Java_Note\Code\JavaCode\out\production\JavaCode\Test02&gt; javap -v .\HelloWorld.class</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;<strong>得到反编译后的详细信息</strong>&#x3D;&#x3D;</p>
<p>主要部分包括类 -&gt; 基本信息，<em>常量池</em>，类方法定义，包含了虚拟机指令</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Classfile</span> /<span class="symbol">E:</span>/<span class="title class_">Todo</span>/note/<span class="title class_">Software</span>/<span class="title class_">Java</span>_Note/<span class="title class_">Code</span>/<span class="title class_">JavaCode</span>/out/production/<span class="title class_">JavaCode</span>/<span class="title class_">Test02</span>/<span class="title class_">HelloWorld</span>.<span class="keyword">class</span></span><br><span class="line">  <span class="title class_">Last</span> modified <span class="number">2023</span>-<span class="number">1</span>-<span class="number">29</span>; size <span class="number">547</span> bytes      </span><br><span class="line">  <span class="variable constant_">MD5</span> checksum c9ba0a6bb02e055dc5d4a83327a04608</span><br><span class="line">  <span class="title class_">Compiled</span> from <span class="string">&quot;HelloWorld.java&quot;</span>              </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test02</span>.<span class="title class_">HelloWorld</span>                 </span><br><span class="line">  minor <span class="symbol">version:</span> <span class="number">0</span>                             </span><br><span class="line">  major <span class="symbol">version:</span> <span class="number">52</span>                            </span><br><span class="line">  <span class="symbol">flags:</span> <span class="variable constant_">ACC_PUBLIC</span>, <span class="variable constant_">ACC_SUPER</span>                 </span><br><span class="line"><span class="title class_">Constant</span> <span class="symbol">pool:</span>                                 </span><br><span class="line">   <span class="comment">#1 = Methodref          #6.#20         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   <span class="comment">#2 = Fieldref           #21.#22        // java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">   <span class="comment">#3 = String             #23            // hello world</span></span><br><span class="line">   <span class="comment">#4 = Methodref          #24.#25        // java/io/PrintStream.println:(Ljava/lang/String;)V</span></span><br><span class="line">   <span class="comment">#5 = Class              #26            // Test02/HelloWorld</span></span><br><span class="line">   <span class="comment">#6 = Class              #27            // java/lang/Object</span></span><br><span class="line">   <span class="comment">#7 = Utf8               &lt;init&gt;</span></span><br><span class="line">   <span class="comment">#8 = Utf8               ()V</span></span><br><span class="line">   <span class="comment">#9 = Utf8               Code</span></span><br><span class="line">  <span class="comment">#10 = Utf8               LineNumberTable</span></span><br><span class="line">  <span class="comment">#11 = Utf8               LocalVariableTable</span></span><br><span class="line">  <span class="comment">#12 = Utf8               this</span></span><br><span class="line">  <span class="comment">#13 = Utf8               LTest02/HelloWorld;</span></span><br><span class="line">  <span class="comment">#14 = Utf8               main</span></span><br><span class="line">  <span class="comment">#15 = Utf8               ([Ljava/lang/String;)V</span></span><br><span class="line">  <span class="comment">#16 = Utf8               args</span></span><br><span class="line">  <span class="comment">#17 = Utf8               [Ljava/lang/String;</span></span><br><span class="line">  <span class="comment">#18 = Utf8               SourceFile</span></span><br><span class="line">  <span class="comment">#19 = Utf8               HelloWorld.java</span></span><br><span class="line">  <span class="comment">#20 = NameAndType        #7:#8          // &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  <span class="comment">#21 = Class              #28            // java/lang/System</span></span><br><span class="line">  <span class="comment">#22 = NameAndType        #29:#30        // out:Ljava/io/PrintStream;</span></span><br><span class="line">  <span class="comment">#23 = Utf8               hello world</span></span><br><span class="line">  <span class="comment">#24 = Class              #31            // java/io/PrintStream</span></span><br><span class="line">  <span class="comment">#25 = NameAndType        #32:#33        // println:(Ljava/lang/String;)V</span></span><br><span class="line">  <span class="comment">#26 = Utf8               Test02/HelloWorld</span></span><br><span class="line">  <span class="comment">#27 = Utf8               java/lang/Object</span></span><br><span class="line">  <span class="comment">#28 = Utf8               java/lang/System</span></span><br><span class="line">  <span class="comment">#29 = Utf8               out</span></span><br><span class="line">  <span class="comment">#30 = Utf8               Ljava/io/PrintStream;</span></span><br><span class="line">  <span class="comment">#31 = Utf8               java/io/PrintStream</span></span><br><span class="line">  <span class="comment">#32 = Utf8               println</span></span><br><span class="line">  <span class="comment">#33 = Utf8               (Ljava/lang/String;)V</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="title class_">Test02</span>.<span class="title class_">HelloWorld</span>();</span><br><span class="line">    <span class="symbol">descriptor:</span> ()V</span><br><span class="line">    <span class="symbol">flags:</span> <span class="variable constant_">ACC_PUBLIC</span></span><br><span class="line">    <span class="title class_">Code</span>:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: invokespecial <span class="comment">#1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      <span class="title class_">LineNumberTable</span>:</span><br><span class="line">        line <span class="number">3</span>: <span class="number">0</span></span><br><span class="line">      <span class="title class_">LocalVariableTable</span>:</span><br><span class="line">        <span class="title class_">Start</span>  <span class="title class_">Length</span>  <span class="title class_">Slot</span>  <span class="title class_">Name</span>   <span class="title class_">Signature</span></span><br><span class="line">            <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  this   <span class="title class_">LTest02</span>/<span class="title class_">HelloWorld</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> static void main(java.lang.<span class="title class_">String</span>[]);</span><br><span class="line">    <span class="symbol">descriptor:</span> ([<span class="title class_">Ljava</span>/lang/<span class="title class_">String</span>;)V</span><br><span class="line">    <span class="symbol">flags:</span> <span class="variable constant_">ACC_PUBLIC</span>, <span class="variable constant_">ACC_STATIC</span></span><br><span class="line">    <span class="title class_">Code</span>:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: getstatic     <span class="comment">#2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">         <span class="number">3</span>: ldc           <span class="comment">#3                  // String hello world</span></span><br><span class="line">         <span class="number">5</span>: invokevirtual <span class="comment">#4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span></span><br><span class="line">         <span class="number">8</span>: <span class="keyword">return</span></span><br><span class="line">      <span class="title class_">LineNumberTable</span>:</span><br><span class="line">        line <span class="number">5</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">6</span>: <span class="number">8</span></span><br><span class="line">      <span class="title class_">LocalVariableTable</span>:</span><br><span class="line">        <span class="title class_">Start</span>  <span class="title class_">Length</span>  <span class="title class_">Slot</span>  <span class="title class_">Name</span>   <span class="title class_">Signature</span></span><br><span class="line">            <span class="number">0</span>       <span class="number">9</span>     <span class="number">0</span>  args   [<span class="title class_">Ljava</span>/lang/<span class="title class_">String</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">SourceFile</span>: <span class="string">&quot;HelloWorld.java&quot;</span></span><br></pre></td></tr></table></figure>



<p><strong>运行时常量池</strong></p>
<p><em>运行时常量池，常量池是 *.class 文件中的，当该类被加载，它的常量池信息就会放入运行时常量池，并把里面的符号地址变为真实地址</em></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Constant</span> <span class="symbol">pool:</span>                                 </span><br><span class="line">   <span class="comment">#1 = Methodref          #6.#20         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   <span class="comment">#2 = Fieldref           #21.#22        // java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">   <span class="comment">#3 = String             #23            // hello world</span></span><br><span class="line">   <span class="comment">#4 = Methodref          #24.#25        // java/io/PrintStream.println:(Ljava/lang/String;)V</span></span><br><span class="line">   <span class="comment">#5 = Class              #26            // Test02/HelloWorld</span></span><br><span class="line">   <span class="comment">#6 = Class              #27            // java/lang/Object</span></span><br><span class="line">   <span class="comment">#7 = Utf8               &lt;init&gt;</span></span><br><span class="line">   <span class="comment">#8 = Utf8               ()V</span></span><br><span class="line">   <span class="comment">#9 = Utf8               Code</span></span><br><span class="line">  <span class="comment">#10 = Utf8               LineNumberTable</span></span><br><span class="line">  <span class="comment">#11 = Utf8               LocalVariableTable</span></span><br><span class="line">  <span class="comment">#12 = Utf8               this</span></span><br><span class="line">  <span class="comment">#13 = Utf8               LTest02/HelloWorld;</span></span><br><span class="line">  <span class="comment">#14 = Utf8               main</span></span><br><span class="line">  <span class="comment">#15 = Utf8               ([Ljava/lang/String;)V</span></span><br><span class="line">  <span class="comment">#16 = Utf8               args</span></span><br><span class="line">  <span class="comment">#17 = Utf8               [Ljava/lang/String;</span></span><br><span class="line">  <span class="comment">#18 = Utf8               SourceFile</span></span><br><span class="line">  <span class="comment">#19 = Utf8               HelloWorld.java</span></span><br><span class="line">  <span class="comment">#20 = NameAndType        #7:#8          // &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  <span class="comment">#21 = Class              #28            // java/lang/System</span></span><br><span class="line">  <span class="comment">#22 = NameAndType        #29:#30        // out:Ljava/io/PrintStream;</span></span><br><span class="line">  <span class="comment">#23 = Utf8               hello world</span></span><br><span class="line">  <span class="comment">#24 = Class              #31            // java/io/PrintStream</span></span><br><span class="line">  <span class="comment">#25 = NameAndType        #32:#33        // println:(Ljava/lang/String;)V</span></span><br><span class="line">  <span class="comment">#26 = Utf8               Test02/HelloWorld</span></span><br><span class="line">  <span class="comment">#27 = Utf8               java/lang/Object</span></span><br><span class="line">  <span class="comment">#28 = Utf8               java/lang/System</span></span><br><span class="line">  <span class="comment">#29 = Utf8               out</span></span><br><span class="line">  <span class="comment">#30 = Utf8               Ljava/io/PrintStream;</span></span><br><span class="line">  <span class="comment">#31 = Utf8               java/io/PrintStream</span></span><br><span class="line">  <span class="comment">#32 = Utf8               println</span></span><br><span class="line">  <span class="comment">#33 = Utf8               (Ljava/lang/String;)V</span></span><br></pre></td></tr></table></figure>

<ul>
<li>当该<strong>类被加载</strong>，它的<strong>常量池信息就会放入运行时常量池</strong>，并把里面的符号地址变为<strong>真实地址 -&gt; 内存地址 0xXXXX</strong></li>
</ul>
<h4 id="StringTable"><a href="#StringTable" class="headerlink" title="StringTable"></a>StringTable</h4><p><strong>StringTable –字符串常量池，又称串池</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StringTable [ &quot;a&quot;, &quot;b&quot; ,&quot;ab&quot; ]  hashtable 结构，不能扩容</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_22</span> &#123;</span><br><span class="line">    <span class="comment">// 常量池中的信息，都会被加载到运行时常量池中， 这时 a b ab 都是常量池中的符号，还没有变为 java 字符串对象</span></span><br><span class="line">    <span class="comment">// ldc #2 会把 a 符号变为 &quot;a&quot; 字符串对象</span></span><br><span class="line">    <span class="comment">// ldc #3 会把 b 符号变为 &quot;b&quot; 字符串对象</span></span><br><span class="line">    <span class="comment">// ldc #4 会把 ab 符号变为 &quot;ab&quot; 字符串对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="string">&quot;a&quot;</span>; <span class="comment">// 懒惰的</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;b&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s4</span> <span class="operator">=</span> s1 + s2; <span class="comment">// new StringBuilder()[init初始化].append(&quot;a&quot;).append(&quot;b&quot;).toString()  new String(&quot;ab&quot;)</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s5</span> <span class="operator">=</span> <span class="string">&quot;a&quot;</span> + <span class="string">&quot;b&quot;</span>;  <span class="comment">// javac 在编译期间的优化，结果已经在编译期确定为ab</span></span><br><span class="line">	s3 == s4;	<span class="comment">// false -&gt; s3 是串池中的，而s4是堆内存中new 的，所以是两个对象</span></span><br><span class="line">        s3 == s5;	<span class="comment">// true -&gt; 字符串常量池就是在编译期间，将所用到的，能直接识别的 String（即 &quot;&quot; 的String） 放入串池中。同时进行编译优化 &quot;a&quot; + &quot;b&quot; 的字符串，同样会在串池中保存 -&gt; &quot;ab&quot; -&gt; 如果串池中已经存在 &quot;ab&quot; 则会直接找到 &quot;ab&quot;，而不需要再次放入</span></span><br><span class="line">            </span><br><span class="line">        System.out.println(s3 == s5);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>&#x3D;&#x3D;<em>字符串常量池就是在编译期间，将所用到的，能直接识别的 String（即 “” 的String） 放入串池中。同时进行编译优化 “a” + “b” 的字符串，同样会在串池中保存 -&gt; “ab” -&gt; 如果串池中已经存在 “ab” 则会直接找到 “ab”，而不需要再次放入</em>&#x3D;&#x3D;</p>
<p><strong>字符串延迟加载</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示字符串字面量也是【延迟】成为对象的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestString</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> args.length;</span><br><span class="line">        System.out.println(); <span class="comment">// 字符串个数 2275 断点</span></span><br><span class="line"></span><br><span class="line">        System.out.print(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;6&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;7&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;8&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;9&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;1&quot;</span>); <span class="comment">// 字符串个数 2285 断点</span></span><br><span class="line">        System.out.print(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;6&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;7&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;8&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;9&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        System.out.print(x); <span class="comment">// 字符串个数 断点</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129101855859.png" alt="image-20230129101855859" style="zoom:80%;margin-left:0" />



<p><strong>面试案例题</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;b&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="string">&quot;a&quot;</span> + <span class="string">&quot;b&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">s4</span> <span class="operator">=</span> s1 + s2;</span><br><span class="line"><span class="type">String</span> <span class="variable">s5</span> <span class="operator">=</span> <span class="string">&quot;ab&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">s6</span> <span class="operator">=</span> s4.intern();</span><br><span class="line"><span class="comment">// 问</span></span><br><span class="line">System.out.println(s3 == s4);	<span class="comment">// false</span></span><br><span class="line">System.out.println(s3 == s5);	<span class="comment">// true</span></span><br><span class="line">System.out.println(s3 == s6);	<span class="comment">// true</span></span><br><span class="line"><span class="type">String</span> <span class="variable">x2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;c&quot;</span>) + <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;d&quot;</span>);	<span class="comment">// heap</span></span><br><span class="line"><span class="type">String</span> <span class="variable">x1</span> <span class="operator">=</span> <span class="string">&quot;cd&quot;</span>;	<span class="comment">// pool</span></span><br><span class="line">x2.intern();</span><br><span class="line"><span class="comment">// 问，如果调换了【最后两行代码】的位置呢（true），如果换位置后是 jdk1.6呢（false）</span></span><br><span class="line">System.out.println(x1 == x2);	<span class="comment">// false</span></span><br></pre></td></tr></table></figure>



<p><strong>Intern()方法</strong></p>
<p>&#x3D;&#x3D;将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回&#x3D;&#x3D;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_23</span> &#123;</span><br><span class="line">    <span class="comment">// jdk8</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//  [&quot;ab&quot;, &quot;a&quot;, &quot;b&quot;]</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">x</span> <span class="operator">=</span> <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;a&quot;</span>) + <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 堆  new String(&quot;a&quot;)   new String(&quot;b&quot;) new String(&quot;ab&quot;)</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> s.intern(); <span class="comment">// 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</span></span><br><span class="line">	<span class="comment">// 如果没有放入，则 s2 为 串池中的 字符串，而 s 为堆中的字符串 s2 != s</span></span><br><span class="line">        </span><br><span class="line">        System.out.println( s2 == x);</span><br><span class="line">        System.out.println( s == x );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_23</span> &#123;</span><br><span class="line">    <span class="comment">// jdk1.6</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [&quot;a&quot;, &quot;b&quot;, &quot;ab&quot;]</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;a&quot;</span>) + <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 堆  new String(&quot;a&quot;)   new String(&quot;b&quot;)  new String(&quot;ab&quot;)</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> s.intern(); <span class="comment">// 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</span></span><br><span class="line">        <span class="comment">// s 拷贝一份，放入串池</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">x</span> <span class="operator">=</span> <span class="string">&quot;ab&quot;</span>;	<span class="comment">// 串池中存在 ab 就直接使用</span></span><br><span class="line">        System.out.println( s2 == x);	<span class="comment">// true</span></span><br><span class="line">        System.out.println( s == x );	<span class="comment">// false -&gt; 1.8 true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>StringTable 特性</strong></p>
<ul>
<li>常量池中的字符串仅是符号，第一次用到时才变为对象</li>
<li>利用串池的机制，来避免重复创建字符串对象</li>
<li>字符串变量拼接的原理是 StringBuilder （1.8）</li>
<li>字符串常量拼接的原理是编译期优化</li>
<li>可以使用 intern 方法，主动将串池中还没有的字符串对象放入串池<ul>
<li>1.8 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</li>
<li>1.6 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有会把此对象复制一份，放入串池，会把串池中的对象返回 -&gt; <strong>即调用 intern 的对象 与 最终放入串池中的对象是两个不同的对象</strong></li>
</ul>
</li>
</ul>
<p><strong>StringTable 位置</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129112853529.png" alt="image-20230129112853529" style="zoom:80%;margin-left:0" />

<p>&#x3D;&#x3D;jdk1.8 之后 StringTable 转换位置的原因 -&gt; 在jdk1.6 时，StringTable 是 <strong>永久带实现</strong> -&gt; 必须等到老年代内存空间不足，才会执行 full gc 来回收，而 StringTable 本身是需要很频繁的使用和回收 -&gt; <strong>而堆 heap 中只需要 Minor GC 就可以回收空间</strong> -&gt; 从而减少StringTable内存的优化&#x3D;&#x3D;</p>
<p><strong>验证 StringTable 位置</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示 StringTable 位置</span></span><br><span class="line"><span class="comment"> * 在jdk8下设置 -Xmx10m -XX:-UseGCOverheadLimit</span></span><br><span class="line"><span class="comment"> * 在jdk6下设置 -XX:MaxPermSize=10m</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_6</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">260000</span>; j++) &#123;</span><br><span class="line">                list.add(String.valueOf(j).intern());</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">jdk1.6</span></span><br><span class="line"><span class="comment">java.lang.OutOfMemoryError: PermGen space</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">jdk1.8</span></span><br><span class="line"><span class="comment">java.lang.OutOfMemoryError: GC overhead limit exceeded</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html">官方文档</a></p>
<blockquote>
<p><strong>-XX:+UseGCOverheadLimit</strong></p>
<p>Enables the use of a policy that limits the proportion of time spent by the JVM on GC before an <code>OutOfMemoryError</code> exception is thrown. This option is enabled, by default and the parallel GC will throw an <code>OutOfMemoryError</code> if more than 98% of the total time is spent on garbage collection and less than 2% of the heap is recovered. When the heap is small, this feature can be used to prevent applications from running for long periods of time with little or no progress. To disable this option, specify <code>-XX:-UseGCOverheadLimit</code>.</p>
</blockquote>
<h4 id="StringTable-垃圾回收机制"><a href="#StringTable-垃圾回收机制" class="headerlink" title="StringTable 垃圾回收机制"></a>StringTable 垃圾回收机制</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示 StringTable 垃圾回收</span></span><br><span class="line"><span class="comment"> * -Xmx10m -XX:+PrintStringTableStatistics -XX:+PrintGCDetails -verbose:gc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">100000</span>; j++) &#123; <span class="comment">// j=100, j=10000</span></span><br><span class="line">                String.valueOf(j).intern();</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>StringTable 性能调优</strong></p>
<p>StringTable 底层是一个 hash 表</p>
<ul>
<li>调整 -XX:StringTableSize&#x3D;桶个数</li>
<li>考虑将字符串对象是否入池 -&gt; 字符串是否需要重复使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示串池大小对性能的影响</span></span><br><span class="line"><span class="comment"> * -Xms500m -Xmx500m -XX:+PrintStringTableStatistics -XX:StringTableSize=1009 --&gt; 48w的单词 分散在 1009 个桶里 -&gt; 平均每需要 12097ms </span></span><br><span class="line"><span class="comment"> * -Xms500m -Xmx500m -XX:+PrintStringTableStatistics -XX:StringTableSize=200000 --&gt; 48w的单词 分散在 20w 个桶里 -&gt; 平均每个桶里 2 个单词，所以只需要 401ms 速度相当快</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_24</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;linux.words&quot;</span>), <span class="string">&quot;utf-8&quot;</span>))) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                line = reader.readLine();</span><br><span class="line">                <span class="keyword">if</span> (line == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                line.intern();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;cost:&quot;</span> + (System.nanoTime() - start) / <span class="number">1000000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>空间换时间</strong></p>
<p>字符串是否需要重复使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示 intern 减少内存占用</span></span><br><span class="line"><span class="comment"> * -XX:StringTableSize=200000 -XX:+PrintStringTableStatistics</span></span><br><span class="line"><span class="comment"> * -Xsx500m -Xmx500m -XX:+PrintStringTableStatistics -XX:StringTableSize=200000</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_25</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        List&lt;String&gt; address = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        System.in.read();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;linux.words&quot;</span>), <span class="string">&quot;utf-8&quot;</span>))) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    line = reader.readLine();</span><br><span class="line">                    <span class="keyword">if</span>(line == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    address.add(line.intern());</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;cost:&quot;</span> +(System.nanoTime()-start)/<span class="number">1000000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129121046158.png" alt="image-20230129121046158" style="zoom:80%;margin-left:0" />

<p><strong>加上入池动作</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129121151640.png" alt="image-20230129121151640" style="zoom:80%;margin-left:0" />



<h3 id="直接内存"><a href="#直接内存" class="headerlink" title="直接内存"></a>直接内存</h3><h4 id="直接内存概念"><a href="#直接内存概念" class="headerlink" title="直接内存概念"></a>直接内存概念</h4><p>Direct Memory <code>--直接内存不属于 JVM 内存管理，而是属于OS系统内存，可被JVM调用</code></p>
<ul>
<li>常见于 NIO 操作时，用于<strong>数据缓冲区</strong> </li>
<li><strong>分配回收成本较高，但读写性能高</strong> </li>
<li>&#x3D;&#x3D;不受 JVM 内存回收管理&#x3D;&#x3D;</li>
</ul>
<p><strong>案例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示 ByteBuffer 作用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_9</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FROM</span> <span class="operator">=</span> <span class="string">&quot;E:\\编程资料\\第三方教学视频\\youtube\\Getting Started with Spring Boot-sbPSjI4tt10.mp4&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TO</span> <span class="operator">=</span> <span class="string">&quot;E:\\a.mp4&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_1Mb</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        io(); <span class="comment">// io 用时：1535.586957 1766.963399 1359.240226</span></span><br><span class="line">        directBuffer(); <span class="comment">// directBuffer 用时：479.295165 702.291454 562.56592</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">directBuffer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileChannel</span> <span class="variable">from</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(FROM).getChannel();</span><br><span class="line">             <span class="type">FileChannel</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(TO).getChannel();</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">bb</span> <span class="operator">=</span> ByteBuffer.allocateDirect(_1Mb);</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> from.read(bb);</span><br><span class="line">                <span class="keyword">if</span> (len == -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                bb.flip();</span><br><span class="line">                to.write(bb);</span><br><span class="line">                bb.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        System.out.println(<span class="string">&quot;directBuffer 用时：&quot;</span> + (end - start) / <span class="number">1000_000.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">io</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">from</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(FROM);</span><br><span class="line">             <span class="type">FileOutputStream</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(TO);</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="type">byte</span>[] buf = <span class="keyword">new</span> <span class="title class_">byte</span>[_1Mb];</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> from.read(buf);</span><br><span class="line">                <span class="keyword">if</span> (len == -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                to.write(buf, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        System.out.println(<span class="string">&quot;io 用时：&quot;</span> + (end - start) / <span class="number">1000_000.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="直接内存原理"><a href="#直接内存原理" class="headerlink" title="直接内存原理"></a>直接内存原理</h4><p><strong>直接内存原理</strong></p>
<p>常规IO</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129131054638.png" alt="image-20230129131054638" style="zoom:80%;margin-left:0" />

<ul>
<li>Java代码不能操作系统缓冲区</li>
<li>可以对应操作 Java缓冲区 –缓冲区copy -&gt; 性能开销</li>
</ul>
<p>直接内存NIO</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129131251850.png" alt="image-20230129131251850" style="zoom:80%;margin-left:0" />



<h4 id="内存溢出"><a href="#内存溢出" class="headerlink" title="内存溢出"></a>内存溢出</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示直接内存溢出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_10</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">_100Mb</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;ByteBuffer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(_100Mb);</span><br><span class="line">                list.add(byteBuffer);</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 方法区是jvm规范， jdk6 中对方法区的实现称为永久代</span></span><br><span class="line">        <span class="comment">//                  jdk8 对方法区的实现称为元空间</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>java.lang.OutOfMemoryError: Direct buffer memory</p>
</blockquote>
<h4 id="分配和回收原理"><a href="#分配和回收原理" class="headerlink" title="分配和回收原理"></a>分配和回收原理</h4><ul>
<li>使用了 Unsafe 对象完成直接内存的分配回收，并且回收需要主动调用 freeMemory 方法</li>
<li>ByteBuffer 的实现类内部，使用了 Cleaner （虚引用）来监测 ByteBuffer 对象，一旦 ByteBuffer 对象被垃圾回收，那么就会由 ReferenceHandler 线程 [守护线程] 通过 Cleaner 的 clean 方法调用 freeMemory 来释放直接内存</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 禁用显式回收对直接内存的影响</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_26</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">_1Gb</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * -XX:+DisableExplicitGC 显式的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(_1Gb);</span><br><span class="line">        System.out.println(<span class="string">&quot;分配完毕...&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">        System.out.println(<span class="string">&quot;开始释放...&quot;</span>);</span><br><span class="line">        byteBuffer = <span class="literal">null</span>;</span><br><span class="line">        System.gc(); <span class="comment">// 显式的垃圾回收，Full GC</span></span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129131816652.png" alt="image-20230129131816652" style="zoom:80%;margin-left:0" />

<ul>
<li>开辟<strong>1G直接内存</strong>，&#x3D;&#x3D;执行 GC 会并<strong>不会释放</strong>直接内存&#x3D;&#x3D;，而是需要通过<strong>调用 Unsafe 来释放直接内存</strong></li>
<li><em>而 DirectByteBuffer类会主动调用 cleanner</em><em>[虚引用对象]</em>* 自身会控制 Unsafe 来释放 直接内存*</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 直接内存分配的底层原理：Unsafe</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_27</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">_1Gb</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> getUnsafe();</span><br><span class="line">        <span class="comment">// 分配内存</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">base</span> <span class="operator">=</span> unsafe.allocateMemory(_1Gb);</span><br><span class="line">        unsafe.setMemory(base, _1Gb, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 释放内存</span></span><br><span class="line">        unsafe.freeMemory(base);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) f.get(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">return</span> unsafe;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>JVM调优时会经常使用 -&gt; <code>-XX: +DisableExplicitGC 显示的</code> -&gt; 使代码中显示的调用 <code>System.gc()</code> 失效</p>
<p>因为 <code>System.gc()</code> 触发的使 full GC -&gt; 从而导致性能的严重降低</p>
<p>但是使用 <code>-XX: +DisableExplicitGC 显示的</code> 禁用了代码层面的 gc，<strong>就有可能影响直接内存的回收</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 禁用显式回收对直接内存的影响</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1_26</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">_1Gb</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * -XX:+DisableExplicitGC 显式的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(_1Gb);</span><br><span class="line">        System.out.println(<span class="string">&quot;分配完毕...&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">        System.out.println(<span class="string">&quot;开始释放...&quot;</span>);</span><br><span class="line">        byteBuffer = <span class="literal">null</span>;</span><br><span class="line">        System.gc(); <span class="comment">// 显式的垃圾回收，Full GC</span></span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>由于 <code>ByteBuffer</code> 对象任然存活，没有被 GC，那么它所对应的直接内存就也没有被回收</strong></li>
<li>所以使用 <code>-XX: +DisableExplicitGC 显示的</code> 禁用了代码层面的 gc，<strong>对其他内存没有影响，但是会影响直接内存的回收</strong></li>
<li><strong>可以用 Unsafe 对象直接手动管理 直接内存</strong></li>
</ul>
<h2 id="3-垃圾回收-GC"><a href="#3-垃圾回收-GC" class="headerlink" title="3. 垃圾回收 GC"></a>3. 垃圾回收 GC</h2><ol>
<li>判断对象可以回收的机制</li>
<li>垃圾回收算法</li>
<li>分代垃圾回收</li>
<li>垃圾回收器</li>
<li>垃圾回收调优</li>
</ol>
<h4 id="对象垃圾回收条件"><a href="#对象垃圾回收条件" class="headerlink" title="对象垃圾回收条件"></a>对象垃圾回收条件</h4><p>两种判断方式</p>
<ol>
<li>引用计数法</li>
<li>可达性分析算法</li>
</ol>
<h5 id="引用计数法"><a href="#引用计数法" class="headerlink" title="引用计数法"></a>引用计数法</h5><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129133749036.png" alt="image-20230129133749036" style="zoom:80%;margin-left:0" />

<p><strong>无法处理循环引用问题，AB对象循环引用，导致无法被引用计数法回收内存 -&gt; 从而导致内存泄漏</strong></p>
<p>由于两个对象的引用数不能清零，所以导致 GC 始终无法回收这两个对象</p>
<p><em>&#x3D;&#x3D;早期的 python VM 使用了这个 引用计数法 来实现 GC，而 JVM 并没有使用这个方式 GC，而是使用 可达性分析算法实现 GC&#x3D;&#x3D;</em></p>
<h5 id="可达性分析算法"><a href="#可达性分析算法" class="headerlink" title="可达性分析算法"></a>可达性分析算法</h5><p>可达性分析算法，首先确定<strong>肯定不能回收的对象</strong>为<strong>根对象</strong>，在GC前，先扫描堆中的对象，看是否能够沿着 GC Root对象 为起点的引用链找到该对象，找不到，表示可以回收</p>
<ul>
<li>Java 虚拟机中的垃圾回收器采用可达性分析来探索所有存活的对象 </li>
<li>扫描堆中的对象，看是否能够沿着 GC Root对象 为起点的引用链找到该对象，找不到，表示可以回收 </li>
<li>哪些对象可以作为 <code>GC Root</code> ?</li>
</ul>
<p><strong>Memory Analyzer（MAT）</strong></p>
<blockquote>
<p>The Eclipse Memory Analyzer is a fast and feature-rich <strong>Java heap analyzer</strong> that helps you find memory leaks and reduce memory consumption.</p>
<p>Use the Memory Analyzer to analyze productive heap dumps with hundreds of millions of objects, quickly calculate the retained sizes of objects, see who is preventing the Garbage Collector from collecting objects, run a report to automatically extract leak suspects.</p>
</blockquote>
<p>–Java对象分析工具</p>
<p><em>演示</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示GC Roots</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo2_2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, IOException &#123;</span><br><span class="line">        List&lt;Object&gt; list1 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list1.add(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        list1.add(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">        System.out.println(<span class="number">1</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line">        list1 = <span class="literal">null</span>;</span><br><span class="line">        System.out.println(<span class="number">2</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">        System.out.println(<span class="string">&quot;end...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jps</span><br><span class="line"><span class="comment"># b-&gt;二进制 live-&gt;存活对象(live会在快照前主动进行 GC) file -&gt; 将快照存储在1.bin 文件中</span></span><br><span class="line">jamp -dump:format=b,live,file=1.bin 21384</span><br></pre></td></tr></table></figure>



<p><em>通过 MAT 查看 GC_ROOTS</em></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129210113990.png" alt="image-20230129210113990" style="zoom:80%;margin-left:0" />

<p>Total: 4 entries</p>
<ul>
<li>System Class</li>
<li>Native Stack</li>
<li>Thread</li>
<li>Busy Monitor</li>
</ul>
<h5 id="五种引用"><a href="#五种引用" class="headerlink" title="五种引用"></a>五种引用</h5><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129211027300.png" alt="image-20230129211027300" style="zoom:80%;margin-left:0" />





<ol>
<li>强引用<ul>
<li><strong>只有所有 GC Roots 对象都不通过【强引用】引用该对象，该对象才能被垃圾回收</strong></li>
</ul>
</li>
<li>软引用（SoftReference） <ul>
<li>仅有软引用引用该对象时，在垃圾回收后，<strong>内存仍不足时</strong>会再次出发垃圾回收，回收软引用对象 </li>
<li><em>可以配合引用队列来<strong>释放软引用自身</strong></em></li>
</ul>
</li>
<li>弱引用（WeakReference）<ul>
<li>仅有弱引用引用该对象时，在垃圾回收时，<strong>无论内存是否充足，都会回收</strong>弱引用对象 </li>
<li><em>可以配合引用队列来<strong>释放弱引用自身</strong></em></li>
</ul>
</li>
<li>虚引用（PhantomReference） –关联引用队列<ul>
<li><strong>必须配合引用队列使用</strong>，主要<strong>配合 ByteBuffer 使用</strong>，<strong>被引用对象回收时，会将<code>虚引用入队</code>（主要其引用对象被回收，而<u>直接内存并没有被回收</u>），由 <code>Reference Handler 线程</code>调用虚引用相关方法（调用<code>Unsafe.freeMemory</code>）<u>释放直接内存</u></strong></li>
</ul>
</li>
<li>终结器引用（FinalReference） –关联引用队列<ul>
<li>无需手动编码，但其<strong>内部配合引用队列使用</strong>，在垃圾回收时，终结器引用入队（被引用对象暂时没有被回收），再由 <code>Finalizer 线程</code>（<strong>一个优先级很低的线程</strong>）通过终结器引用找到被引用对象并调用它的 finalize 方法（ <strong><u>Object类中有一个 finalize()方法</u><strong>，</strong>当重写了 finalize()方法 <u>–希望在 当前对象被GC时调用</u> 并没有强引用引用其时，就可以被GC回收，回收时，进入终结器引用队列，通过 Finalizer线程扫描引用队列并执行其 finalize()方法后才会被回收</strong> ），第二次 GC 时才能回收被引用对象</li>
</ul>
</li>
</ol>
<p><em>不推荐使用 finalize() 释放内存</em></p>
<p><strong>软引用案例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示软引用</span></span><br><span class="line"><span class="comment"> * -Xmx20m -XX:+PrintGCDetails -verbose:gc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo2_3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_4MB</span> <span class="operator">=</span> <span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">/*List&lt;byte[]&gt; list = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">        for (int i = 0; i &lt; 5; i++) &#123;</span></span><br><span class="line"><span class="comment">            list.add(new byte[_4MB]);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        System.in.read();*/</span></span><br><span class="line">        soft();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">soft</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// list --&gt; SoftReference --&gt; byte[]</span></span><br><span class="line"></span><br><span class="line">        List&lt;SoftReference&lt;<span class="type">byte</span>[]&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            SoftReference&lt;<span class="type">byte</span>[]&gt; ref = <span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">byte</span>[_4MB]);</span><br><span class="line">            System.out.println(ref.get());</span><br><span class="line">            list.add(ref);</span><br><span class="line">            System.out.println(list.size());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;循环结束：&quot;</span> + list.size());</span><br><span class="line">        <span class="keyword">for</span> (SoftReference&lt;<span class="type">byte</span>[]&gt; ref : list) &#123;</span><br><span class="line">            System.out.println(ref.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>软引用配合引用队列</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示软引用, 配合引用队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo2_4</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_4MB</span> <span class="operator">=</span> <span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;SoftReference&lt;<span class="type">byte</span>[]&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 引用队列</span></span><br><span class="line">        ReferenceQueue&lt;<span class="type">byte</span>[]&gt; queue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// 关联了引用队列， 当软引用所关联的 byte[]被回收时，软引用自己会加入到 queue 中去</span></span><br><span class="line">            SoftReference&lt;<span class="type">byte</span>[]&gt; ref = <span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">byte</span>[_4MB], queue);</span><br><span class="line">            System.out.println(ref.get());</span><br><span class="line">            list.add(ref);</span><br><span class="line">            System.out.println(list.size());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从队列中获取无用的 软引用对象，并移除</span></span><br><span class="line">        Reference&lt;? <span class="keyword">extends</span> <span class="title class_">byte</span>[]&gt; poll = queue.poll();</span><br><span class="line">        <span class="keyword">while</span>( poll != <span class="literal">null</span>) &#123;</span><br><span class="line">            list.remove(poll);</span><br><span class="line">            poll = queue.poll();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;===========================&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SoftReference&lt;<span class="type">byte</span>[]&gt; reference : list) &#123;</span><br><span class="line">            System.out.println(reference.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>弱引用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示弱引用</span></span><br><span class="line"><span class="comment"> * -Xmx20m -XX:+PrintGCDetails -verbose:gc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo2_5</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">_4MB</span> <span class="operator">=</span> <span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//  list --&gt; WeakReference --&gt; byte[]</span></span><br><span class="line">        List&lt;WeakReference&lt;<span class="type">byte</span>[]&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            WeakReference&lt;<span class="type">byte</span>[]&gt; ref = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">byte</span>[_4MB]);</span><br><span class="line">            list.add(ref);</span><br><span class="line">            <span class="keyword">for</span> (WeakReference&lt;<span class="type">byte</span>[]&gt; w : list) &#123;</span><br><span class="line">                System.out.print(w.get()+<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;循环结束：&quot;</span> + list.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><em>软引用与弱引用都是避免强引用导致 OOM 问题</em></p>
<ul>
<li>软引用 -&gt; <strong>list –&gt; SoftReference –&gt; byte[]</strong></li>
<li>弱引用 -&gt; <strong>list –&gt; WeakReference –&gt; byte[]</strong></li>
</ul>
<h3 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h3><p>常见的三种回收算法</p>
<ol>
<li>标记清除法</li>
<li>标记整理法</li>
<li>复制回收法</li>
</ol>
<h4 id="标记清除法"><a href="#标记清除法" class="headerlink" title="标记清除法"></a>标记清除法</h4><p><strong>定义： Mark Sweep</strong></p>
<p><em>标记清除法主要分为两个阶段</em></p>
<p>沿着 GCROOT 寻找，&#x3D;&#x3D;一阶段 -&gt; 标记哪些<strong>没有引用的对象</strong>，将没有引用的对象<strong>标记为垃圾</strong>&#x3D;&#x3D;。&#x3D;&#x3D;二阶段 -&gt; 再对标记的垃圾对象进行回收，<strong>回收也并不是将内存直接释放</strong>，而是将<strong>所回收对象占用内存</strong>的<strong>起始地址</strong>与<strong>结束地址</strong>存储在<strong>空闲内存列表</strong>中&#x3D;&#x3D;.当再次分配此段内存时，进行覆盖</p>
<p>特点：</p>
<ul>
<li>速度较快</li>
<li>会造成内存碎片</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129213846780.png" alt="image-20230129213846780" style="zoom:80%;margin-left:0" />





<h4 id="标记整理法"><a href="#标记整理法" class="headerlink" title="标记整理法"></a>标记整理法</h4><p>定义：Mark Compact</p>
<p>特点：</p>
<ul>
<li>速度较慢</li>
<li>没有内存碎片</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129213944215.png" alt="image-20230129213944215" style="zoom:80%;margin-left:0" />





<h4 id="复制回收法"><a href="#复制回收法" class="headerlink" title="复制回收法"></a>复制回收法</h4><p>定义：Copy </p>
<p>特点：</p>
<ul>
<li>不会有内存碎片 </li>
<li>需要占用双倍内存空间</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129214043107.png" alt="image-20230129214043107" style="zoom:80%;margin-left:0" />



<h3 id="分代垃圾回收"><a href="#分代垃圾回收" class="headerlink" title="分代垃圾回收"></a>分代垃圾回收</h3><h4 id="分代垃圾回收概念"><a href="#分代垃圾回收概念" class="headerlink" title="分代垃圾回收概念"></a>分代垃圾回收概念</h4><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129215758960.png" alt="image-20230129215758960" style="zoom:80%;margin-left:0" />

<p><strong>新生代处理生命周期短的对象，老年代处理生命周期长的对象</strong> <em>–针对不同区域采用不同的垃圾回收方法</em>（垃圾分类）</p>
<p>&#x3D;&#x3D;<strong>工作原理：</strong>&#x3D;&#x3D; <em>–空间不足时才会触发 GC</em></p>
<ul>
<li>对象创建后首先分配在<strong>伊甸园区域</strong> -&gt; <em>伊甸园区域内存不足时，就会触发 minor gc</em> -&gt; <strong>copy（通过幸存区 From To 实现）</strong> 存活的对象到 <strong><u>幸存区</u></strong> ，并使其 <strong>年龄+1</strong></li>
<li>新生代空间不足时，触发 <strong>minor gc</strong>，伊甸园和 from 存活的对象使用 copy 复制到 to 中，存活的对象年龄加 1并且交换 from to </li>
<li><em>minor gc 会引发 stop the world<strong>（minor gc触发 STW 的时间很小）</strong>，暂停其它用户的线程，等垃圾回收结束，用户线程才恢复运行</em> </li>
<li><strong>当对象寿命超过阈值时</strong>，**<u>会晋升至老年代</u>**，最大寿命是15（4bit） </li>
<li>当老年代空间不足，会先尝试触发 minor gc，如果之后空间仍不足，那么触发 full gc，STW的时间更长</li>
</ul>
<p><strong>进入老年代的方式</strong></p>
<ol>
<li><p>占用内存较大的对象，直接进入老年代</p>
<ul>
<li>程序一般认为大对象有可能是需要存活比较长时间的对象，而且大对象在幸存区返回来回复制，影响young GC的效率，</li>
<li>通过-XX:PretenureSizeThreshold进行设置</li>
</ul>
</li>
<li><p>年龄达到阈值</p>
<ul>
<li>通过-XX:MaxTenuringThreshold进行设置，默认为15</li>
</ul>
</li>
<li><p>动态年龄判断</p>
<ul>
<li>当一个对象从Eden区到了Survivor区，当 Survivor 空间中相同年龄所有对象的大小总和大于 Survivor 空间的一半，年龄大于或等于该年龄的对象就可以直接进入老年代，而不需要达到默认的分代年龄</li>
</ul>
</li>
<li><p>幸存区的内存不足</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-XX:NewSize=10485760 -XX:MaxNewSize=10485760 -XX:InitialHeapSize=20971520 -XX:MaxHeapSize=20971520 -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=15 -XX:PretenureSizeThreshold=5242880 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:gc.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新生代 10M 、伊甸区 8M、幸存区1 1M、幸存区2 1M、堆 20M、老年代 10M、年龄阈值是15、大对象是 10M；使用ParNewGC+CMS；打印相关gc日志到gc.log文件</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在幸存区内存不足时，会将部分对象放置到幸存区，部分对象放入老年代</li>
</ul>
</li>
</ol>
<h4 id="相关-JVM-参数"><a href="#相关-JVM-参数" class="headerlink" title="相关 JVM 参数"></a>相关 JVM 参数</h4><table>
<thead>
<tr>
<th>含义</th>
<th>参数</th>
</tr>
</thead>
<tbody><tr>
<td>堆初始大小</td>
<td>-Xms</td>
</tr>
<tr>
<td>堆最大大小</td>
<td>-Xmx 或 -XX:MaxHeapSize&#x3D;size</td>
</tr>
<tr>
<td>新生代大小</td>
<td>-Xmn 或 (-XX:NewSize&#x3D;size + -XX:MaxNewSize&#x3D;size )</td>
</tr>
<tr>
<td>幸存区比例（动态）</td>
<td>-XX:InitialSurvivorRatio&#x3D;ratio 和 -XX:+UseAdaptiveSizePolicy</td>
</tr>
<tr>
<td>幸存区比例</td>
<td>-XX:SurvivorRatio&#x3D;ratio</td>
</tr>
<tr>
<td>晋升阈值</td>
<td>-XX:MaxTenuringThreshold&#x3D;threshold</td>
</tr>
<tr>
<td>晋升详情</td>
<td>-XX:+PrintTenuringDistribution</td>
</tr>
<tr>
<td>GC详情</td>
<td>-XX:+PrintGCDetails -verbose:gc</td>
</tr>
<tr>
<td>FullGC 前 MinorGC</td>
<td>-XX:+ScavengeBeforeFullGC</td>
</tr>
</tbody></table>
<p><strong>GC案例</strong></p>
<ul>
<li>触发一次 MinorGC</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129224550527.png" alt="image-20230129224550527" style="zoom:80%;margin-left:0" />

<ul>
<li>将 eden space 占用提升到 98%</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129224718852.png" alt="image-20230129224718852" style="zoom:80%;margin-left:0" />

<ul>
<li>触发两次 MinorGC</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129224838168.png" alt="image-20230129224838168" style="zoom:80%;margin-left:0" />

<ul>
<li>Big Object直接进入老年代</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129225024054.png" alt="image-20230129225024054" style="zoom:80%;margin-left:0" />

<ul>
<li>触发 OOM</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129225121508.png" alt="image-20230129225121508" style="zoom:80%;margin-left:0" />

<ul>
<li>虽然内存是线程共享，当前线程触发 OOM ，并不会影响已经在运行的线程(or 主线程)，除非其他线程再次需要开辟空间（or 引发OOM）</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129225217701.png" alt="image-20230129225217701" style="zoom:80%;margin-left:0" />



<h3 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h3><h4 id="串行"><a href="#串行" class="headerlink" title="串行"></a>串行</h4><p><strong>特点</strong></p>
<ul>
<li>单线程 </li>
<li>堆内存较小，适合个人电脑</li>
</ul>
<p><strong>参数</strong></p>
<ul>
<li><code>-XX:+UseSerialGC = Serial + SerialOld</code><ul>
<li>Serial 工作在新生代</li>
<li>SerialOld 工作在老年代</li>
</ul>
</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129231349686.png" alt="image-20230129231349686" style="zoom:80%;margin-left:0" />





<h4 id="吞吐量优先"><a href="#吞吐量优先" class="headerlink" title="吞吐量优先"></a>吞吐量优先</h4><p><strong>特点</strong></p>
<ul>
<li>多线程 –并行</li>
<li>堆内存较大，多核 cpu </li>
<li>让单位时间内，STW 的时间最短 0.2 0.2 &#x3D; 0.4，垃圾回收时间占比最低，这样就称吞吐量高</li>
</ul>
<p><strong>参数</strong></p>
<ul>
<li><code>-XX:+UseParallelGC ~ -XX:+UseParallelOldGC</code> –jdk1.8默认开启</li>
<li><code>-XX:+UseAdaptiveSizePolicy</code> –自适应，调整各区域大小</li>
<li><code>-XX:GCTimeRatio=ratio</code> –调整GC与总时间占比</li>
<li><code>-XX:MaxGCPauseMillis=ms</code> –默认200ms 最大 GC STW 暂停时间</li>
<li><code>-XX:ParallelGCThreads=n</code> –控制CPU线程数</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129232108951.png" alt="image-20230129232108951" style="zoom:80%;margin-left:0" />



<p><strong>CPU占用趋势</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129232715976.png" alt="image-20230129232715976" style="zoom:80%;margin-left:0" />



<h4 id="响应时间优先"><a href="#响应时间优先" class="headerlink" title="响应时间优先"></a>响应时间优先</h4><p><strong>特点</strong></p>
<ul>
<li>多线程 –并行</li>
<li>堆内存较大，多核 cpu </li>
<li>尽可能让单次 STW 的时间最短 0.1 0.1 0.1 0.1 0.1 &#x3D; 0.5</li>
</ul>
<p>&#x3D;&#x3D;<strong>CMSGC</strong>&#x3D;&#x3D;</p>
<p><strong>参数</strong></p>
<ul>
<li><code>-XX:+UseConcMarkSweepGC ~ -XX:+UseParNewGC ~ SerialOld</code>  –用户线程与GC线程同时执行，同时争抢CPU时间片，开启回收器</li>
<li><code>-XX:ParallelGCThreads=n ~ -XX:ConcGCThreads=threads</code> –4 -&gt; 1 n -&gt; n&#x2F;4</li>
<li><code>-XX:CMSInitiatingOccupancyFraction=percent</code> –执行CMS内存占比 -&gt; 预留空间给浮动垃圾</li>
<li><code>-XX:+CMSScavengeBeforeRemark</code> –重新标记前，是否执行回收</li>
</ul>
<p><em>CMS基于标记清除算法，有可能会造成大量 碎片内存 -&gt; 从而引发并发失败，此时CMSGC就不能正常工作，导致退化成 SerialOldGC（串行整理 -&gt; STW 时间特别长）</em></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129232241335.png" alt="image-20230129232241335" style="zoom:80%;margin-left:0" />



<p><strong>CPU占用趋势</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230129233803355.png" alt="image-20230129233803355" style="zoom:80%;margin-left:0" />

<h4 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h4><h5 id="G1概念及原理"><a href="#G1概念及原理" class="headerlink" title="G1概念及原理"></a>G1概念及原理</h5><p><strong>G1概念</strong></p>
<p>Garbage First –Garbage One(一款很有年代的**<u>垃圾回收器</u>**，直到17年左右技术才相对成熟)</p>
<ul>
<li>2004 论文发布 </li>
<li>2009 JDK 6u14 体验 </li>
<li>2012 JDK 7u4 官方支持 </li>
<li>2017 JDK 9 纳为默认GC回收器 -&gt; 从而取代CMS回收器</li>
</ul>
<p><strong>适用场景</strong></p>
<ul>
<li>同时注重吞吐量（Throughput）和低延迟（Low latency），默认的暂停目标是 200 ms </li>
<li>超大堆内存，会将堆划分为多个大小相等的 <strong><u>Region</u></strong> 每一个区都可以独立作为 Eden &#x2F; Survive &#x2F; Old (化整为零思想)</li>
<li>整体上 <strong>单个Region</strong> 是 <strong>标记+整理</strong> 算法，两个区域之间是 <strong>复制</strong> 算法</li>
</ul>
<p><strong>相关参数</strong></p>
<ul>
<li><code>-XX:+UseG1GC</code> –显示开启使用 G1 -&gt; jdk1.9 后默认开启</li>
<li><code>-XX:G1HeapRegionSize=size</code>  –设置 Region 大小 -&gt; 最好&#x2F;必须 设置成 2^n</li>
<li><code>-XX:MaxGCPauseMillis=time</code></li>
</ul>
<h5 id="G1-垃圾回收阶段"><a href="#G1-垃圾回收阶段" class="headerlink" title="G1 垃圾回收阶段"></a>G1 垃圾回收阶段</h5><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130000021564.png" alt="image-20230130000021564" style="zoom:80%;margin-left:0" />



<p><strong>阶段一</strong></p>
<ul>
<li>Young Collection –新生代收集<ul>
<li>会导致 STW –相对较短</li>
</ul>
</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130000148827.png" alt="image-20230130000148827" style="zoom:80%;margin-left:0" />

<p>复制回收 copy -&gt; survive</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130000221800.png" alt="image-20230130000221800" style="zoom:80%;margin-left:0" />

<p>survive age -&gt; threshold -&gt; Old &#x2F; surive</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130000445008.png" alt="image-20230130000445008" style="zoom:80%;margin-left:0" />



<p><strong>阶段二</strong></p>
<ul>
<li><p>Young Collection + CM</p>
<ul>
<li><p>在 Young GC 时会进行 GC Root 的初始标记 </p>
</li>
<li><p>老年代占用堆空间比例<strong>达到阈值</strong>时，<strong>进行并发标记（不会 STW）</strong>，由下面的 JVM 参数决定</p>
<p><code>-XX:InitiatingHeapOccupancyPercent=percent </code> –（默认45%）</p>
</li>
</ul>
</li>
</ul>
<p>mark</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130000724967.png" alt="image-20230130000724967" style="zoom:80%;margin-left:0" />



<p><strong>阶段三</strong></p>
<ul>
<li><p>Mixed Collection –会对 E、S、O 进行全面垃圾回收</p>
<ul>
<li><p>最终标记（<strong>Remark</strong>）会 STW </p>
</li>
<li><p>拷贝存活（Evacuation）会 STW</p>
<p><code>-XX:MaxGCPauseMillis=ms</code> –控制 MaxGC 的 STW 时间。<strong>G1 会挑出回收价值高的 Old 来进行回收，从而来达到 MaxGCPauseMillis 的限制</strong></p>
</li>
</ul>
</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130001005885.png" alt="image-20230130001005885" style="zoom:80%;margin-left:0" />



<h5 id="Full-GC-辨析"><a href="#Full-GC-辨析" class="headerlink" title="Full GC 辨析"></a>Full GC 辨析</h5><ul>
<li>SerialGC <ul>
<li>新生代内存不足发生的垃圾收集 - minor gc </li>
<li>老年代内存不足发生的垃圾收集 - full gc</li>
</ul>
</li>
<li>ParallelGC <ul>
<li>新生代内存不足发生的垃圾收集 - minor gc </li>
<li>老年代内存不足发生的垃圾收集 - full gc</li>
</ul>
</li>
<li>CMS <ul>
<li>新生代内存不足发生的垃圾收集 - minor gc </li>
<li>老年代内存不足 -分两种情况</li>
</ul>
</li>
<li>G1 <ul>
<li>新生代内存不足发生的垃圾收集 - minor gc </li>
<li>老年代内存不足 -分两种情况 -&gt; threshold &gt;&#x3D; 45% -&gt; 触发标记-清除-并发清理（不是 FullGC） -&gt; 在 remark 期间判断当 <strong>垃圾产生速度 &gt; GC 速度时</strong> -&gt; 触发 FullGC</li>
</ul>
</li>
</ul>
<h5 id="Young-Collection-跨代引用问题"><a href="#Young-Collection-跨代引用问题" class="headerlink" title="Young Collection 跨代引用问题"></a>Young Collection 跨代引用问题</h5><p><em>为防止 search old 的时候开销太大，所以老年代存储使用一种卡表技术，老年代 region 细分化为 cards -&gt; 每个card 大概 512k</em></p>
<ul>
<li>新生代回收的跨代引用（老年代引用新生代）问题</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130002349990.png" alt="image-20230130002349990" style="zoom:80%;margin-left:0" />

<p>&#x3D;&#x3D;如果老年代有 card 引用了新生代的对象，就将此 card 标记为 <strong><u>脏卡</u></strong>&#x3D;&#x3D; –从而减少 search old 开销</p>
<p>同时新生代也会使用 Remembered Set 来记录有哪些 old card 引用了这些新生代对象，达到减少 search 开销的目的</p>
<ul>
<li><em>卡表与 Remembered Set</em> </li>
<li><em>在引用变更（脏卡）时通过 post-write barrier（写屏障） + dirty card queue （脏卡队列）</em></li>
<li><em>concurrent refinement threads 更新 Remembered Set</em></li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130002726856.png" alt="image-20230130002726856" style="zoom:80%;margin-left:0" />





<h5 id="Remark-重标记"><a href="#Remark-重标记" class="headerlink" title="Remark 重标记"></a>Remark 重标记</h5><p>对 E、S、O 进行全面垃圾回收时，会有两个阶段情况，先进行 remark -&gt; 判断是否需要 FullGC </p>
<p><strong>原理</strong></p>
<ul>
<li>pre-write barrier + satb_mark_queue</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130003632501.png" alt="image-20230130003632501" style="zoom:80%;" />

<ul>
<li>黑色 -&gt; 已完成 remark 处理</li>
<li>灰色 -&gt; 正在进行 remark &#x2F; 未完成（待完成） remark</li>
<li>白色 -&gt; 未进行 remark</li>
</ul>
<p><strong>问题：由于并发执行，如果在 remark 期间，有用户改变了对象之间的引用关系，就会导致，需要回收的对象没有被回收，不能回收的对象，被意外回收</strong></p>
<p><em>–通过 pre-write barrier（写屏障） + satb_mark_queue（mark队列）来解决问题</em></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130004007273.png" alt="image-20230130004007273" style="zoom:80%;margin-left:0" />

<p><strong>在发生引用改变时，配合 <u>写屏障</u> 将引用改变的对象放入 <u>markqueue</u>，最后统一<u>再进行一次 remark</u> 处理 <u>markqueque</u> 中的对象</strong></p>
<h5 id="不同-jdk-G1-优化"><a href="#不同-jdk-G1-优化" class="headerlink" title="不同 jdk G1 优化"></a>不同 jdk G1 优化</h5><p>主要围绕 jdk 8 9 </p>
<ul>
<li><strong>JDK 8u20 字符串去重</strong><ul>
<li>优点：节省大量内存 </li>
<li>缺点：略微多占用了 cpu 时间，新生代回收时间略微增加</li>
</ul>
</li>
</ul>
<p><code>-XX:+UseStringDeduplication</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;hello&quot;</span>); <span class="comment">// char[]&#123;&#x27;h&#x27;,&#x27;e&#x27;,&#x27;l&#x27;,&#x27;l&#x27;,&#x27;o&#x27;&#125;</span></span><br><span class="line"><span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;hello&quot;</span>); <span class="comment">// char[]&#123;&#x27;h&#x27;,&#x27;e&#x27;,&#x27;l&#x27;,&#x27;l&#x27;,&#x27;o&#x27;&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>将所有新分配的字符串放入一个<strong>队列</strong> </p>
</li>
<li><p>当<strong>新生代回收时</strong>，G1并发检查是否有字符串<strong>重复</strong> </p>
</li>
<li><p>如果它们值一样，让它们引用同一个 char[] </p>
</li>
<li><p>注意，与 <code>String.intern()</code> 不一样</p>
<ul>
<li><code>String.intern()</code> 关注的是<strong>字符串对象</strong> </li>
<li>而字符串去重关注的是 <strong>char[]</strong> </li>
<li>在 JVM 内部，使用了不同的字符串表 –<em>与 串池 对比使用了不同的字符串表</em></li>
</ul>
</li>
<li><p><strong>JDK 8u40 并发标记类卸载</strong></p>
<p>所有对象都经过并发标记后，就能知道哪些<strong>类（包括实例）不再被使用</strong>，当一个<strong>类加载器的所有类都不再使用</strong>，则卸载它所加载的所有类</p>
<p><code>-XX:+ClassUnloadingWithConcurrentMark</code> 默认启用</p>
</li>
<li><p><strong>JDK 8u60 回收巨型对象</strong></p>
<ul>
<li>一个对象大于 region 的一半时，称之为巨型对象 <em>–G1会有巨型对象区</em> </li>
<li>G1 <strong>不会对巨型对象进行拷贝</strong> </li>
<li>回收时被<strong>优先考虑</strong> </li>
<li>G1 会<strong>跟踪老年代所有 incoming 引用</strong>，这样<strong>老年代 incoming 引用为0</strong> 的巨型对象就可以在<strong>新生代垃圾回收时</strong>处理掉(尽早回收)</li>
</ul>
</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130013106452.png" alt="image-20230130013106452" style="zoom:80%;margin-left:0" />





<ul>
<li><p><strong>JDK 9 并发标记起始时间的调整</strong></p>
<ul>
<li><strong>并发标记</strong>（<em>通过提前开始并发标记来优化 FullGC</em>）必须在堆空间占满<strong>前</strong>完成，否则退化为 FullGC （虽然 FullGC 被优化为多线程，还是需要尽量减少）</li>
<li>JDK 9 之前需要使用 <code>-XX:InitiatingHeapOccupancyPercent</code> </li>
<li>JDK 9 可以动态调整 <ul>
<li><code>-XX:InitiatingHeapOccupancyPercent</code> 用来设置初始值 例如 45%</li>
<li>进行数据采样并动态调整 </li>
<li>总会添加一个安全的空档空间</li>
</ul>
</li>
</ul>
</li>
<li><p>JDK 9 更高效的回收</p>
<ul>
<li>250+增强 </li>
<li>180+bug修复</li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/19/gctuning/">https://docs.oracle.com/en/java/javase/19/gctuning/</a></li>
</ul>
</li>
</ul>
<h3 id="垃圾回收调优"><a href="#垃圾回收调优" class="headerlink" title="垃圾回收调优"></a>垃圾回收调优</h3><p>预备知识</p>
<ul>
<li>GC 相关的 VM 参数，会基本的空间调整 </li>
<li>相关工具 </li>
<li>切记调优跟应用、环境有关，没有放之四海而皆准的法则 <strong>–根据实际情况</strong></li>
</ul>
<p><strong>主要是经验活</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">查看虚拟机运行参数</span></span><br><span class="line"><span class="comment">&quot;C:\Program Files\Java\jdk1.8.0_91\bin\java&quot; -XX:+PrintFlagsFinal -version | findstr &quot;GC&quot;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo2_8</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="调优领域"><a href="#调优领域" class="headerlink" title="调优领域"></a>调优领域</h4><ul>
<li>内存 </li>
<li>锁竞争 </li>
<li>cpu 占用 </li>
<li>io</li>
</ul>
<h4 id="调优目标"><a href="#调优目标" class="headerlink" title="调优目标"></a>调优目标</h4><ul>
<li>目的是 -&gt; 【<strong>低延迟 –互联网项目，追求用户体验</strong>】还是【<strong>高吞吐量 –科学运算，追求高吞吐量，计算能力</strong>】，选择合适的回收器 </li>
<li>CMS，G1，ZGC超低延迟 –响应时间优先</li>
<li>ParallelGC –高吞吐</li>
<li>Zing VM –零停顿</li>
</ul>
<h4 id="最快-GC"><a href="#最快-GC" class="headerlink" title="最快 GC"></a>最快 GC</h4><p><strong>最快 GC 是不发生 GC</strong></p>
<ul>
<li>查看 FullGC 前后的内存占用，考虑下面几个问题<ol>
<li>数据是不是太多？ <ul>
<li>resultSet &#x3D; statement.executeQuery(“select * from 大表 <strong>limit n</strong>“)</li>
</ul>
</li>
<li>数据表示是否太臃肿？ <ul>
<li>对象图，用到什么查什么</li>
<li>对象大小 最小Object 16byte Integer（包装头 16byte） 24byte int 4byte</li>
</ul>
</li>
<li>是否存在内存泄漏？ <ul>
<li>static Map map &#x3D;   –&gt; 不释放？</li>
<li>软引用 </li>
<li>弱引用</li>
<li>第三方缓存实现</li>
</ul>
</li>
</ol>
</li>
</ul>
<h4 id="新生代调优"><a href="#新生代调优" class="headerlink" title="新生代调优"></a>新生代调优</h4><p><strong>新生代优化空间更大</strong></p>
<ul>
<li>新生代的特点 <ul>
<li>所有的 <strong>new 操作的内存分配非常廉价</strong> 在 Eden 中<ul>
<li>TLAB thread-local allocation buffer –new新对象会先判断 TLAB 缓存中是否存在，而 TLAB 的作用除了最为缓存减少new对象开销，还减少了在多线程new对象时的冲突问题（<em>缓存解决冲突原理</em>）</li>
</ul>
</li>
<li><strong>死亡对象的回收代价是零</strong> –被copy的对象，直接覆盖</li>
<li>大部分对象用过即死 </li>
<li>Minor GC 的时间远远低于 Full GC</li>
</ul>
</li>
<li>越大越好吗？<ul>
<li><em>新生代中复制时间 &gt; 标记时间 -&gt; 而新生代通常最终只会有少量的对象存活下来，调大 size 并不会明显减少时间开销，所以并不是越大越好</em></li>
</ul>
</li>
</ul>
<blockquote>
<p>-Xmn </p>
<p>Sets the initial and maximum size (in bytes) of the heap for the young generation (nursery). GC is performed in this region more often than in other regions. If the size for the young generation is too small, then a lot of minor garbage collections are performed. If the size is too large, then only full garbage collections are performed, which can take a long time to complete. Oracle recommends that you keep the size for the <strong>young generation greater than 25% and less than 50% of the overall heap size</strong>.</p>
</blockquote>
<ul>
<li><strong>新生代能容纳所有【并发量 * (请求-响应的内存)】的数据 –合理值</strong> -&gt; 同一时刻 1000 qps 请求响应占用内存为 512k -&gt; 大约 512m</li>
<li>幸存区大到能保留【当前活跃对象+需要晋升对象】 </li>
<li><strong>晋升阈值配置得当</strong>，让存活时间短的对象保存在幸存区，让长时间存活对象尽快晋升</li>
</ul>
<p><code>-XX:MaxTenuringThreshold=threshold</code> </p>
<p><code>-XX:+PrintTenuringDistribution</code> –显示详细信息</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Desired</span> survivor size <span class="number">48286924</span> bytes, new threshold <span class="number">10</span> (max <span class="number">10</span>)</span><br><span class="line">- age <span class="number">1</span>: <span class="number">28992024</span> bytes, <span class="number">28992024</span> total</span><br><span class="line">- age <span class="number">2</span>: <span class="number">1366864</span> bytes, <span class="number">30358888</span> total</span><br><span class="line">- age <span class="number">3</span>: <span class="number">1425912</span> bytes, <span class="number">31784800</span> total</span><br><span class="line">...</span><br></pre></td></tr></table></figure>





<p><strong>新生代Size与吞吐量关系</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130020617028.png" alt="image-20230130020617028" style="zoom:80%;margin-left:0" />





<h4 id="老年代调优"><a href="#老年代调优" class="headerlink" title="老年代调优"></a>老年代调优</h4><p>以 CMS 为例 </p>
<ul>
<li>CMS 的老年代内存越大越好 –CMS并发GC，浮动垃圾，并发失败，SerialOld</li>
<li>先<strong>尝试不做调优</strong>，如果<strong>没有 Full GC</strong> 那么已经不是 Old 性能卡点…，否则 <strong>先尝试调优新生代</strong> </li>
<li>观察发生 Full GC 时，性能卡点在老年代内存占用，将原有老年代内存预设调大 1&#x2F;4 ~ 1&#x2F;3，从而减少 FullGC 次数来降低老年代的 GC 开销<ul>
<li><code>-XX:CMSInitiatingOccupancyFraction=percent</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>较为极端值 -&gt; 将 CMSInitiatingOccupancyFraction 设为 0，只要 Old 产生垃圾就进行回收，这样就不会导致浮动垃圾过多，引发并发失败。缺点是对于 CPU 要求较高，必须控制一定存在一个 CPU 线程，一直处理 OdlGC</p>
</blockquote>
<p>常规控制在 70% - 80% -&gt; 提供浮动垃圾的内存</p>
<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><ol>
<li><p>案例1 Full GC 和 Minor GC频繁 </p>
<ul>
<li><strong>新生代 -&gt; 增大内存减少 minor gc</strong></li>
<li><strong>增加晋升阈值 -&gt; 使生命周期较短的对象尽量留在 survive -&gt; 从而减少 Full GC</strong></li>
</ul>
</li>
<li><p>案例2 请求高峰期发生 Full GC，单次暂停时间特别长 （CMS） </p>
<ul>
<li>业务需求 -&gt; <strong>低延迟</strong></li>
<li>分析 CMS 哪个阶段耗时较长 -&gt; CMS通常 重新标记阶段开销较大 -&gt; 通过在重新标记之前，进行一次 minor gc 来减少重新标记的开销 -&gt; <code>-XX:+CMSScavengeBeforeRemark</code>  -&gt; 减少单次 Full GC开销</li>
</ul>
</li>
<li><p>案例3 老年代充裕情况下，发生 Full GC （CMS jdk1.7）</p>
<ul>
<li>永久带原因？ -&gt; jdk1.8之前，<strong>永久带的空间不足</strong>，同样会触发 Full GC -&gt; 增加元空间的初始值与最大值，来解决永久带空间不足问题</li>
</ul>
</li>
</ol>
<h2 id="4-字节码"><a href="#4-字节码" class="headerlink" title="4. 字节码"></a>4. 字节码</h2><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130023122098.png" alt="image-20230130023122098" style="zoom:80%;margin-left:0" />

<p>Java源代码，编译成 <strong>Java Class字节码类文件</strong>（学习class字节码类<strong>文件结构</strong> -&gt; 包含<strong>字节码指令</strong>，与<strong>Java source编译成 class 文件过程中的优化处理</strong>）。编译完成后，Java Class字节码类文件需要经过<strong>类加载器</strong>（<strong>ClassLoader</strong>，<strong>类加载的各个阶段</strong>，有<strong>哪些类加载器</strong>）进行类加载。类加载器将字节码加载到 VM 中，由 VM 执行其中的<strong>字节码指令</strong>，需要由<strong>执行引擎</strong>中的 <strong>Interpreter（解释器）</strong>来进行解释执行，在解释过程中，会对<strong>热点代码</strong>进行<strong>运行期的编译处理</strong>（JavaVM 是通过解释和编译来运行的 -&gt; 需要了解<strong>运行期间的优化</strong>有一定理解）</p>
<p><strong>Java Source -&gt; javac -&gt; 0x字节码与字节码指令 -&gt; 解释（-&gt; Interpreter解释器，部分查表，部分解释成机器码指令） -&gt; 运行时进行部分及时编译（JIT）</strong></p>
<h3 id="类文件结构"><a href="#类文件结构" class="headerlink" title="类文件结构"></a>类文件结构</h3><p><strong>分析类文件结构</strong></p>
<p> HelloWorld.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HelloWorld 示例</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>javac -parameters -d . HellowWorld.java</code> </p>
<p><em>-parameters -d 编译后保留方法中参数的名称信息</em></p>
<p><strong>编译为 HelloWorld.class 后：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># od -t xC HelloWorld.class</span></span><br><span class="line">0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 09</span><br><span class="line">0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07</span><br><span class="line">0000040 00 1c 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29</span><br><span class="line">0000060 56 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e</span><br><span class="line">0000100 75 6d 62 65 72 54 61 62 6c 65 01 00 12 4c 6f 63</span><br><span class="line">0000120 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65 01</span><br><span class="line">0000140 00 04 74 68 69 73 01 00 1d 4c 63 6e 2f 69 74 63</span><br><span class="line">0000160 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 6f</span><br><span class="line">0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e 01 00 16</span><br><span class="line">0000220 28 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72</span><br><span class="line">0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 01 00 13</span><br><span class="line">0000260 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69</span><br><span class="line">0000300 6e 67 3b 01 00 10 4d 65 74 68 6f 64 50 61 72 61</span><br><span class="line">0000320 6d 65 74 65 72 73 01 00 0a 53 6f 75 72 63 65 46</span><br><span class="line">0000340 69 6c 65 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64</span><br><span class="line">0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d 0c 00 1e</span><br><span class="line">0000400 00 1f 01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64</span><br><span class="line">0000420 07 00 20 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74</span><br><span class="line">0000440 63 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c</span><br><span class="line">0000460 6f 57 6f 72 6c 64 01 00 10 6a 61 76 61 2f 6c 61</span><br><span class="line">0000500 6e 67 2f 4f 62 6a 65 63 74 01 00 10 6a 61 76 61</span><br><span class="line">0000520 2f 6c 61 6e 67 2f 53 79 73 74 65 6d 01 00 03 6f</span><br><span class="line">0000540 75 74 01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72</span><br><span class="line">0000560 69 6e 74 53 74 72 65 61 6d 3b 01 00 13 6a 61 76</span><br><span class="line">0000600 61 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d</span><br><span class="line">0000620 01 00 07 70 72 69 6e 74 6c 6e 01 00 15 28 4c 6a</span><br><span class="line">0000640 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b</span><br><span class="line">0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 00 01</span><br><span class="line">0000700 00 07 00 08 00 01 00 09 00 00 00 2f 00 01 00 01</span><br><span class="line">0000720 00 00 00 05 2a b7 00 01 b1 00 00 00 02 00 0a 00</span><br><span class="line">0000740 00 00 06 00 01 00 00 00 04 00 0b 00 00 00 0c 00</span><br><span class="line">0000760 01 00 00 00 05 00 0c 00 0d 00 00 00 09 00 0e 00</span><br><span class="line">0001000 0f 00 02 00 09 00 00 00 37 00 02 00 01 00 00 00</span><br><span class="line">0001020 09 b2 00 02 12 03 b6 00 04 b1 00 00 00 02 00 0a</span><br><span class="line">0001040 00 00 00 0a 00 02 00 00 00 06 00 08 00 07 00 0b</span><br><span class="line">0001060 00 00 00 0c 00 01 00 00 00 09 00 10 00 11 00 00</span><br><span class="line">0001100 00 12 00 00 00 05 01 00 10 00 00 00 01 00 13 00</span><br><span class="line">0001120 00 00 02 00 14</span><br></pre></td></tr></table></figure>

<p><strong>根据 JVM 规范，类文件结构如下</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4              magic;	<span class="comment">// 前4字节</span></span><br><span class="line">    u2              minor_version;	<span class="comment">// 接下来2字节</span></span><br><span class="line">    u2              major_version;</span><br><span class="line">    u2              constant_pool_count;</span><br><span class="line">    cp_info         constant_pool[constant_pool_count-<span class="number">1</span>];</span><br><span class="line">    u2              access_flags;	<span class="comment">// 访问修饰</span></span><br><span class="line">    u2              this_class;	<span class="comment">//类名 包名</span></span><br><span class="line">    u2              super_class;	<span class="comment">// 父类</span></span><br><span class="line">    u2              interfaces_count;	<span class="comment">// 接口信息</span></span><br><span class="line">    u2              interfaces[interfaces_count];</span><br><span class="line">    u2              fields_count;</span><br><span class="line">    field_info      fields[fields_count];</span><br><span class="line">    u2              methods_count;</span><br><span class="line">    method_info     methods[methods_count];</span><br><span class="line">    u2              attributes_count;	<span class="comment">// 类附加的属性信息</span></span><br><span class="line">    attribute_info  attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h4 id="魔数"><a href="#魔数" class="headerlink" title="魔数"></a>魔数</h4><p><strong>Magic Number</strong> -&gt; A constant numerical or text value used to identify a file format。</p>
<p>魔数 -&gt; 标识文件的格式使用魔数，而不是扩展名。主要是基于安全方面的考虑，因为文件的扩展名是可以随意修改的，例如 PDF文件魔数使用的文本值”%PDF”（ASCII字符），底层编码十六进制形式（25 50 44 46）；GIF文件的魔数使用的文本值”GIF89a”（ASCII字符），底层编码十六进制形式 (47 49 46 38 39 61) 。Java的Class文件魔数使用数值“CAFEBABE”（十六进制），底层编码就是该数值，.java文件魔数使用数值”CAFEDEAD”<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/gao_zhennan/article/details/124226807">参考文档</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_37695902/article/details/118369299">参考文档</a></p>
<p>0~3 字节，表示它是否是【class】类型的文件 </p>
<p>0000000 <em>ca fe ba be</em> 00 00 00 34 00 23 0a 00 06 00 15 09</p>
<h4 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h4><p>4~7 字节，表示类的版本 <strong>00 34（52） 表示是 Java 8</strong> –指体现了 jdk8 大版本，没有体现小版本</p>
<p>0000000 ca fe ba be <em>00 00 00 34</em> 00 23 0a 00 06 00 15 09</p>
<blockquote>
<p>51 jdk7</p>
<p>52 jdk8</p>
<p>53 jdk9</p>
</blockquote>
<h4 id="常量池"><a href="#常量池" class="headerlink" title="常量池"></a>常量池</h4><p>常量池占用整个 class 文件中较大的比重</p>
<table>
<thead>
<tr>
<th>Constant Type</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>CONSTANT_Class</td>
<td>7</td>
</tr>
<tr>
<td>CONSTANT_Fieldref</td>
<td>9</td>
</tr>
<tr>
<td>CONSTANT_Methodref</td>
<td>10</td>
</tr>
<tr>
<td>CONSTANT_InterfaceMethodref</td>
<td>11</td>
</tr>
<tr>
<td>CONSTANT_String</td>
<td>8</td>
</tr>
<tr>
<td>CONSTANT_Integer</td>
<td>3</td>
</tr>
<tr>
<td>CONSTANT_Float</td>
<td>4</td>
</tr>
<tr>
<td>CONSTANT_Long</td>
<td>5</td>
</tr>
<tr>
<td>CONSTANT_Double</td>
<td>6</td>
</tr>
<tr>
<td>CONSTANT_NameAndType</td>
<td>12</td>
</tr>
<tr>
<td>CONSTANT_Utf8</td>
<td>1</td>
</tr>
<tr>
<td>CONSTANT_MethodHandle</td>
<td>15</td>
</tr>
<tr>
<td>CONSTANT_MethodType</td>
<td>16</td>
</tr>
<tr>
<td>CONSTANT_InvokeDynamic</td>
<td>18</td>
</tr>
</tbody></table>
<ul>
<li><p>&#x3D;&#x3D;8<del>9 字节，表示常量池长度（整个常量池中有多少项），00 23 （35） 表示常量池有 #1</del>#34项，注意 #0 项不计入，也没有值&#x3D;&#x3D; </p>
<p>0000000 ca fe ba be 00 00 00 34 <em>00 23</em> 0a 00 06 00 15 09</p>
</li>
</ul>
<ol>
<li>第#1项 0a 表示一个 Method（查常量池表 -&gt; 表示一个方法引用信息） 信息（常量的<strong>类型信息</strong>），00 06 和 00 15（21） 表示它引用了常量池中 #6 和 #21 项来获得这个方法的【所属类】和【方法名】</li>
</ol>
<p>  0000000 ca fe ba be 00 00 00 34 00 23 <em>0a 00 06 00 15</em> 09</p>
<ol start="2">
<li>第#2项 09 表示一个 Field 信息，00 16（22）和 00 17（23） 表示它引用了常量池中 #22 和 # 23 项来获得这个成员变量的【所属类】和【成员变量名】</li>
</ol>
<p>  0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 <em>09</em> </p>
<p>  0000020 <em>00 16 00 17</em> 08 00 18 0a 00 19 00 1a 07 00 1b 07</p>
<ol start="3">
<li>第#3项 08 表示一个字符串常量名称，00 18（24）表示它引用了常量池中 #24 项</li>
</ol>
<p>  0000020 00 16 00 17 <em>08 00 18</em> 0a 00 19 00 1a 07 00 1b 07</p>
<ol start="4">
<li>第#4项 0a 表示一个 Method 信息，00 19（25） 和 00 1a（26） 表示它引用了常量池中 #25 和 #26 项来获得这个方法的【所属类】和【方法名】</li>
</ol>
<p>  0000020 00 16 00 17 08 00 18 <em>0a 00 19 00 1a</em> 07 00 1b 07</p>
<ol start="5">
<li>第#5项 07 表示一个 Class 信息，00 1b（27） 表示它引用了常量池中 #27 项</li>
</ol>
<p>  0000020 00 16 00 17 08 00 18 0a 00 19 00 1a <em>07 00 1b</em> 07</p>
<ol start="6">
<li>第#6项 07 表示一个 Class 信息，00 1c（28） 表示它引用了常量池中 #28 项</li>
</ol>
<p>  0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b <em>07</em></p>
<p>  0000040 <em>00 1c</em> 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29</p>
<ol start="7">
<li>第#7项 01 表示一个 utf8 串，00 06 表示长度，3c 69 6e 69 74 3e 是【 <code>&lt;init&gt;</code> -&gt; <strong>表示类的构造方法</strong>】</li>
</ol>
<p>  0000040 00 1c <em>01 00 06 3c 69 6e 69 74 3e</em> 01 00 03 28 29</p>
<ol start="8">
<li>第#8项 01 表示一个 utf8 串，00 03 表示长度，28 29 56 是【()V】其实就是表示无参、无返回值</li>
</ol>
<p>  0000040 00 1c 01 00 06 3c 69 6e 69 74 3e <em>01 00 03 28 29</em></p>
<p>  0000060 <em>56</em> 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e</p>
<ol start="9">
<li>第#9项 01 表示一个 utf8 串，00 04 表示长度，43 6f 64 65 是【Code】</li>
</ol>
<p>  0000060 56 <em>01 00 04 43 6f 64 65</em> 01 00 0f 4c 69 6e 65 4e</p>
<ol start="10">
<li>第#10项 01 表示一个 utf8 串，00 0f（15） 表示长度，4c 69 6e 65 4e 75 6d 62 65 72 54 61 62 6c 65 是【LineNumberTable】</li>
</ol>
<p>  0000060 56 01 00 04 43 6f 64 65 <em>01 00 0f 4c 69 6e 65 4e</em></p>
<p>  0000100 <em>75 6d 62 65 72 54 61 62 6c 65</em> 01 00 12 4c 6f 63</p>
<ol start="11">
<li>第#11项 01 表示一个 utf8 串，00 12（18） 表示长度，4c 6f 63 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65是【LocalVariableTable】</li>
</ol>
<p>   0000100 75 6d 62 65 72 54 61 62 6c 65 <em>01 00 12 4c 6f 63</em></p>
<p>   0000120 <em>61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65</em> 01</p>
<ol start="12">
<li>第#12项 01 表示一个 utf8 串，00 04 表示长度，74 68 69 73 是【this】</li>
</ol>
<p>   0000120 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65 <em>01</em></p>
<p>   0000140 <em>00 04 74 68 69 73</em> 01 00 1d 4c 63 6e 2f 69 74 63</p>
<ol start="13">
<li>第#13项 01 表示一个 utf8 串，00 1d（29） 表示长度，是<strong>【Lcn&#x2F;itcast&#x2F;jvm&#x2F;t5&#x2F;HelloWorld;】-&gt; 引用类型</strong></li>
</ol>
<p>   0000140 00 04 74 68 69 73 <em>01 00 1d 4c 63 6e 2f 69 74 63</em></p>
<p>   0000160 <em>61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 6f</em></p>
<p>   0000200 <em>57 6f 72 6c 64 3b</em> 01 00 04 6d 61 69 6e 01 00 16</p>
<ol start="14">
<li>第#14项 01 表示一个 utf8 串，00 04 表示长度，74 68 69 73 是【<strong>main</strong>】</li>
</ol>
<p>   0000200 57 6f 72 6c 64 3b <em>01 00 04 6d 61 69 6e</em> 01 00 16</p>
<ol start="15">
<li>第#15项 01 表示一个 utf8 串，00 16（22） 表示长度，是<strong>【([Ljava&#x2F;lang&#x2F;String;)V】-&gt; 参数类型和返回类型，其实就是参数为字符串数组，无返回值</strong></li>
</ol>
<p>   0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e <em>01 00 16</em></p>
<p>   0000220 <em>28 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72</em></p>
<p>   0000240 <em>69 6e 67 3b 29 56</em> 01 00 04 61 72 67 73 01 00 13</p>
<ol start="16">
<li>第#16项 01 表示一个 utf8 串，00 04 表示长度，是<strong>【args】-&gt; 参数名称</strong></li>
</ol>
<p>   0000240 69 6e 67 3b 29 56 <em>01 00 04 61 72 67 73</em> 01 00 13</p>
<ol start="17">
<li>第#17项 01 表示一个 utf8 串，00 13（19） 表示长度，是<strong>【[Ljava&#x2F;lang&#x2F;String;】-&gt; 参数类型</strong></li>
</ol>
<p>   0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 <em>01 00 13</em></p>
<p>   0000260 <em>5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69</em></p>
<p>   0000300 <em>6e 67 3b</em> 01 00 10 4d 65 74 68 6f 64 50 61 72 61</p>
<ol start="18">
<li>第#18项 01 表示一个 utf8 串，00 10（16） 表示长度，是<strong>【MethodParameters】-&gt; 方法参数信息</strong></li>
</ol>
<p>   0000300 6e 67 3b <em>01 00 10 4d 65 74 68 6f 64 50 61 72 61</em></p>
<p>   0000320 <em>6d 65 74 65 72 73</em> 01 00 0a 53 6f 75 72 63 65 46</p>
<ol start="19">
<li>第#19项 01 表示一个 utf8 串，00 0a（10） 表示长度，是<strong>【SourceFile】-&gt; 类属性信息，源文件</strong></li>
</ol>
<p>   0000320 6d 65 74 65 72 73 <em>01 00 0a 53 6f 75 72 63 65 46</em></p>
<p>   0000340 <em>69 6c 65</em> 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64</p>
<ol start="20">
<li>第#20项 01 表示一个 utf8 串，00 0f（15） 表示长度，是<strong>【HelloWorld.java】</strong></li>
</ol>
<p>   0000340 69 6c 65 <em>01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64</em></p>
<p>   0000360 <em>2e 6a 61 76 61</em> 0c 00 07 00 08 07 00 1d 0c 00 1e</p>
<ol start="21">
<li>第#21项 0c 表示一个 【名+类型】，00 07 00 08 引用了常量池中 #7 #8 两项</li>
</ol>
<p>   0000360 2e 6a 61 76 61 <em>0c 00 07 00 08</em> 07 00 1d 0c 00 1e</p>
<ol start="22">
<li>第#22项 07 表示一个 Class 信息，00 1d（29） 引用了常量池中 #29 项</li>
</ol>
<p>   0000360 2e 6a 61 76 61 0c 00 07 00 08 <em>07 00 1d</em> 0c 00 1e</p>
<ol start="23">
<li>第#23项 0c 表示一个 【名+类型】，00 1e（30） 00 1f （31）引用了常量池中 #30 #31 两项</li>
</ol>
<p>   0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d <em>0c 00 1e</em></p>
<p>   0000400 <em>00 1f</em> 01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64</p>
<ol start="24">
<li>第#24项 01 表示一个 utf8 串，00 0f（15） 表示长度，是【hello world】</li>
</ol>
<p>   0000400 00 1f <em>01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64</em></p>
<ol start="25">
<li>第#25项 07 表示一个 Class 信息，00 20（32） 引用了常量池中 #32 项</li>
</ol>
<p>   0000420 <em>07 00 20</em> 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74</p>
<ol start="26">
<li>第#26项 0c 表示一个 【名+类型】，00 21（33） 00 22（34）引用了常量池中 #33 #34 两项</li>
</ol>
<p>   0000420 07 00 20 <em>0c 00 21 00 22</em> 01 00 1b 63 6e 2f 69 74</p>
<ol start="27">
<li>第#27项 01 表示一个 utf8 串，00 1b（27） 表示长度，是【cn&#x2F;itcast&#x2F;jvm&#x2F;t5&#x2F;HelloWorld】</li>
</ol>
<p>   0000420 07 00 20 0c 00 21 00 22 <em>01 00 1b 63 6e 2f 69 74</em></p>
<p>   0000440 <em>63 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c</em></p>
<p>   0000460 <em>6f 57 6f 72 6c 64</em> 01 00 10 6a 61 76 61 2f 6c 61</p>
<ol start="28">
<li>第#28项 01 表示一个 utf8 串，00 10（16） 表示长度，是【java&#x2F;lang&#x2F;Object】</li>
</ol>
<p>   0000460 6f 57 6f 72 6c 64 <em>01 00 10 6a 61 76 61 2f 6c 61</em></p>
<p>   0000500 <em>6e 67 2f 4f 62 6a 65 63 74</em> 01 00 10 6a 61 76 61</p>
<ol start="29">
<li>第#29项 01 表示一个 utf8 串，00 10（16） 表示长度，是【java&#x2F;lang&#x2F;System】</li>
</ol>
<p>   0000500 6e 67 2f 4f 62 6a 65 63 74 <em>01 00 10 6a 61 76 61</em></p>
<p>   0000520 <em>2f 6c 61 6e 67 2f 53 79 73 74 65 6d</em> 01 00 03 6f</p>
<ol start="30">
<li>第#30项 01 表示一个 utf8 串，00 03 表示长度，是【out】</li>
</ol>
<p>   0000520 2f 6c 61 6e 67 2f 53 79 73 74 65 6d <em>01 00 03 6f</em></p>
<p>   0000540 <em>75 74</em> 01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72</p>
<ol start="31">
<li>第#31项 01 表示一个 utf8 串，00 15（21） 表示长度，是【Ljava&#x2F;io&#x2F;PrintStream;】</li>
</ol>
<p>   0000540 75 74 <em>01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72</em></p>
<p>   0000560 <em>69 6e 74 53 74 72 65 61 6d 3b</em> 01 00 13 6a 61 76</p>
<ol start="32">
<li>第#32项 01 表示一个 utf8 串，00 13（19） 表示长度，是【java&#x2F;io&#x2F;PrintStream】</li>
</ol>
<p>   0000560 69 6e 74 53 74 72 65 61 6d 3b <em>01 00 13 6a 61 76</em></p>
<p>   0000600 <em>61 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d</em></p>
<ol start="33">
<li>第#33项 01 表示一个 utf8 串，00 07 表示长度，是【println】</li>
</ol>
<p>   0000620 <em>01 00 07 70 72 69 6e 74 6c 6e</em> 01 00 15 28 4c 6a</p>
<ol start="34">
<li>第#34项 01 表示一个 utf8 串，00 15（21） 表示长度，是【(Ljava&#x2F;lang&#x2F;String;)V】</li>
</ol>
<p>   0000620 01 00 07 70 72 69 6e 74 6c 6e <em>01 00 15 28 4c 6a</em></p>
<p>   0000640 <em>61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b</em></p>
<p>   0000660 <em>29 56</em> 00 21 00 05 00 06 00 00 00 00 00 02 00 01</p>
<h4 id="访问标识与继承信息"><a href="#访问标识与继承信息" class="headerlink" title="访问标识与继承信息"></a>访问标识与继承信息</h4><p>21 表示该 class 是一个类，公共的 <strong>20 + 1 -&gt; 公共类</strong></p>
<ul>
<li>0000660 29 56 <em>00 21</em> 00 05 00 06 00 00 00 00 00 02 00 01</li>
</ul>
<p>05 表示根据常量池中 #5 找到本类全限定名 </p>
<ul>
<li>0000660 29 56 00 21 <em>00 05</em> 00 06 00 00 00 00 00 02 00 01</li>
</ul>
<p>06 表示根据常量池中 #6 找到父类全限定名 </p>
<ul>
<li>0000660 29 56 00 21 00 05 <em>00 06</em> 00 00 00 00 00 02 00 01</li>
</ul>
<p>表示接口的数量，本类为 0 </p>
<ul>
<li>0000660 29 56 00 21 00 05 00 06 <em>00 00</em> 00 00 00 02 00 01</li>
</ul>
<table>
<thead>
<tr>
<th>Flag Name</th>
<th>Value</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ACC_PUBLIC</strong></td>
<td>0x0001</td>
<td>Declared <code>public</code> ; may be accessed from outside its package.</td>
</tr>
<tr>
<td><strong>ACC_FINAL</strong></td>
<td>0x0010</td>
<td>Declared final ; no subclasses allowed.</td>
</tr>
<tr>
<td><strong>ACC_SUPER</strong></td>
<td>0x0020</td>
<td>Treat superclass methods specially when invoked by the <i>invokespecial</i> instruction. –表示类或者超类特殊方法</td>
</tr>
<tr>
<td><strong>ACC_INTERFACE</strong></td>
<td>0x0200</td>
<td>Is an interface, not a class.</td>
</tr>
<tr>
<td><strong>ACC_ABSTRACT</strong></td>
<td>0x0400</td>
<td>Declared <code>abstract</code> ; must not be instantiated.</td>
</tr>
<tr>
<td><strong>ACC_SYNTHETIC</strong></td>
<td>0x1000</td>
<td>Declared synthetic; not present in the source code. –人工合成的，不是源代码的</td>
</tr>
<tr>
<td><strong>ACC_ANNOTATION</strong></td>
<td>0x2000</td>
<td>Declared as an annotation type.</td>
</tr>
<tr>
<td><strong>ACC_ENUM</strong></td>
<td>0x4000</td>
<td>Declared as an <code>enum</code> type.</td>
</tr>
</tbody></table>
<h4 id="Field-信息"><a href="#Field-信息" class="headerlink" title="Field 信息"></a>Field 信息</h4><p>表示成员变量数量，本类为 0</p>
<ul>
<li>0000660 29 56 00 21 00 05 00 06 00 <em>00 00</em> 00 00 02 00 01</li>
</ul>
<table>
<thead>
<tr>
<th>FieldType</th>
<th>Type</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody><tr>
<td><code>B</code></td>
<td><code>byte</code></td>
<td>signed byte</td>
</tr>
<tr>
<td><code>C</code></td>
<td><code>char</code></td>
<td>Unicode character code point in the Basic Multilingual Plane, encoded with UTF-16</td>
</tr>
<tr>
<td><code>D</code></td>
<td><code>double</code></td>
<td>double-precision floating-point value</td>
</tr>
<tr>
<td><code>F</code></td>
<td><code>float</code></td>
<td>single-precision floating-point value</td>
</tr>
<tr>
<td><code>I</code></td>
<td><code>int</code></td>
<td>integer</td>
</tr>
<tr>
<td><code>J</code></td>
<td><code>long</code></td>
<td>long integer</td>
</tr>
<tr>
<td><code>L</code><br/>ClassName<br/><code>;</code></td>
<td><code>reference</code></td>
<td>an instance of class ClassName</td>
</tr>
<tr>
<td><code>S</code></td>
<td><code>short</code></td>
<td>signed short</td>
</tr>
<tr>
<td><code>Z</code></td>
<td><code>boolean</code></td>
<td><code>true</code> or <code>false</code></td>
</tr>
<tr>
<td><code>[</code></td>
<td><code>reference</code></td>
<td>one array dimension</td>
</tr>
</tbody></table>
<h4 id="Method-信息"><a href="#Method-信息" class="headerlink" title="Method 信息"></a>Method 信息</h4><p>表示方法数量，本类为 2</p>
<p>0000660 29 56 00 21 00 05 00 06 00 00 00 00 <em>00 02</em> 00 01</p>
<p>一个方法由 访问修饰符，名称，参数描述，<strong>方法属性</strong>数量，方法属性组成</p>
<ul>
<li>红色代表访问修饰符（本类中是 public）</li>
<li>蓝色代表引用了常量池 <strong>#07 项作为方法名称</strong></li>
<li>绿色代表引用了常量池 #08 项作为方法参数描述</li>
<li>黄色代表方法属性数量，本方法是 1</li>
<li>红色代表方法属性<ul>
<li>00 09 表示引用了常量池 #09 项，发现是【Code】属性</li>
<li>00 00 00 2f 表示此属性的长度是 47</li>
<li>00 01 表示【操作数栈】最大深度 </li>
<li>00 01 表示【局部变量表】最大槽（slot）数</li>
<li>00 00 00 05 表示字节码长度，本例是 5 </li>
<li><strong>2a b7 00 01 b1 是字节码指令</strong> </li>
<li>00 00 00 02 表示方法细节属性数量，本例是 2 </li>
<li>00 0a 表示引用了常量池 #10 项，发现是【LineNumberTable】属性<ul>
<li>00 00 00 06 表示此属性的总长度，本例是 6 </li>
<li>00 01 表示【LineNumberTable】长度 </li>
<li>00 00 表示【字节码】行号 00 04 表示【java 源码】行号</li>
</ul>
</li>
<li>00 0b 表示引用了常量池 #11 项，发现是【LocalVariableTable】属性<ul>
<li>00 00 00 0c 表示此属性的总长度，本例是 12 </li>
<li>00 01 表示【LocalVariableTable】长度 </li>
<li>00 00 表示局部变量生命周期开始，相对于字节码的偏移量 </li>
<li>00 05 表示局部变量覆盖的范围长度 </li>
<li>00 0c 表示局部变量名称，本例引用了常量池 #12 项，是【this】 </li>
<li>00 0d 表示局部变量的类型，本例引用了常量池 #13 项，是 【Lcn&#x2F;itcast&#x2F;jvm&#x2F;t5&#x2F;<strong>HelloWorld</strong>;】</li>
<li>00 00 表示局部变量占有的槽位（slot）编号，本例是 0</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 <em>00 01</em> </p>
<p>0000700 <span style="color:blue">00 07</span> <span style="color:green">00 08</span> <span style="color:yellow">00 01</span> <em>00 09 00 00 00 2f 00 01 00 01</em> </p>
<p>0000720 <em>00 00 00 05 2a b7 00 01 b1 00 00 00 02 00 0a 00</em> </p>
<p>0000740 <em>00 00 06 00 01 00 00 00 04 00 0b 00 00 00 0c 00</em> </p>
<p>0000760 <em>01 00 00 00 05 00 0c 00 0d 00 00</em> 00 09 00 0e 00</p>
<ul>
<li>红色代表访问修饰符（本类中是 public 01 static 08） </li>
<li>蓝色代表引用了常量池 #14 项作为方法名称 </li>
<li>绿色代表引用了常量池 #15 项作为方法参数描述 </li>
<li>黄色代表方法属性数量，本方法是 2 </li>
<li>红色代表方法属性（属性1）<ul>
<li>00 09 表示引用了常量池 #09 项，发现是【Code】属性 </li>
<li>00 00 00 37 表示此属性的长度是 55 </li>
<li>00 02 表示【操作数栈】最大深度 </li>
<li>00 01 表示【局部变量表】最大槽（slot）数 </li>
<li>00 00 00 05 表示字节码长度，本例是 9 </li>
<li><strong>b2 00 02 12 03 b6 00 04 b1 是字节码指令</strong> </li>
<li>00 00 00 02 表示方法细节属性数量，本例是 2 </li>
<li>00 0a 表示引用了常量池 #10 项，发现是【LineNumberTable】属性<ul>
<li>00 00 00 0a 表示此属性的总长度，本例是 10 </li>
<li>00 02 表示【LineNumberTable】长度 </li>
<li>00 00 表示【字节码】行号 00 06 表示【java 源码】行号 </li>
<li>00 08 表示【字节码】行号 00 07 表示【java 源码】行号</li>
</ul>
</li>
<li>00 0b 表示引用了常量池 #11 项，发现是【LocalVariableTable】属性<ul>
<li>00 00 00 0c 表示此属性的总长度，本例是 12 </li>
<li>00 01 表示【LocalVariableTable】长度</li>
<li>00 00 表示局部变量生命周期开始，相对于<strong>字节码的偏移量</strong> </li>
<li>00 09 表示局部变量覆盖的范围长度 </li>
<li>00 10 表示局部变量名称，本例引用了常量池 #16 项，是【args】 </li>
<li>00 11 表示局部变量的类型，本例引用了常量池 #17 项，是【[Ljava&#x2F;lang&#x2F;String;】 </li>
<li>00 00 表示局部变量占有的槽位（slot）编号，本例是 0</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>0000760 01 00 00 00 05 00 0c 00 0d 00 00 <em>00 09</em> <span style="color:blue">00 0e</span> <span style="color:green">00</span> </p>
<p>0001000 <span style="color:green">0f</span> <span style="color:yellow">00 02</span> <em>00 09 00 00 00 37 00 02 00 01 00 00 00</em> </p>
<p>0001020 <em>09 b2 00 02 12 03 b6 00 04 b1 00 00 00 02 00 0a</em> </p>
<p>0001040 <em>00 00 00 0a 00 02 00 00 00 06 00 08 00 07 00 0b</em> </p>
<p>0001060 <em>00 00 00 0c 00 01 00 00 00 09 00 10 00 11 00 00</em></p>
<p>红色代表方法属性（属性2）</p>
<ul>
<li>00 12 表示引用了常量池 #18 项，发现是【MethodParameters】属性<ul>
<li>00 00 00 05 表示此属性的总长度，本例是 5 </li>
<li>01 参数数量 </li>
<li>00 10 表示引用了常量池 #16 项，是【args】 </li>
<li>00 00 访问修饰符</li>
</ul>
</li>
</ul>
<p>0001100 <em>00 12 00 00 00 05 01 00 10 00 00</em> 00 01 00 13 00 </p>
<p>0001120 00 00 02 00 14</p>
<h4 id="附加属性"><a href="#附加属性" class="headerlink" title="附加属性"></a>附加属性</h4><ul>
<li>00 01 表示附加属性数量 </li>
<li>00 13 表示引用了常量池 #19 项，即【SourceFile】 </li>
<li>00 00 00 02 表示此属性的长度 </li>
<li>00 14 表示引用了常量池 #20 项，即【HelloWorld.java】</li>
</ul>
<p>0001100 00 12 00 00 00 05 01 00 10 00 00 <em>00 01 00 13 00</em> </p>
<p>0001120 <em>00 00 02 00 14</em></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html">参考文献 -Java虚拟机规范</a></p>
<h3 id="字节码指令"><a href="#字节码指令" class="headerlink" title="字节码指令"></a>字节码指令</h3><h4 id="字节码指令理论"><a href="#字节码指令理论" class="headerlink" title="字节码指令理论"></a>字节码指令理论</h4><p>接着上一节，研究一下两组字节码指令，一个是</p>
<p><code>public cn.itcast.jvm.t5.HelloWorld();</code> 构造方法的字节码指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2a b7 00 01 b1</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;<strong>jvm</strong>通过 <strong>解释器（Interpreter）</strong>来识别以上<strong>VM平台无关</strong>的<strong>字节码指令</strong>，将其<strong>解释成机器码</strong>，然后直接执行机器码&#x3D;&#x3D; -&gt; &#x3D;&#x3D;<strong>字节码指令</strong>可以通过<strong>查看官方文档</strong>，解释成 **操作码(助记符)**，使其便于阅读&#x3D;&#x3D;</p>
<ol>
<li>2a &#x3D;&gt; aload_0（<em>注记符-&gt;便于我们查看</em>） 加载 slot 0 的局部变量（**-&gt; 到操作数栈上<strong>，JVM解释器执行时需要</strong>到操作数栈上读取数据**），即 this，做为下面的 invokespecial 构造方法调用的参数</li>
<li>b7 &#x3D;&gt; invokespecial 预备<strong>调用构造方法</strong>，哪个方法呢？</li>
<li>00 01 引用常量池中 #1 项，即【 <code>Method java/lang/Object.&quot;&quot;:()V</code> 】</li>
<li>b1 表示返回 return</li>
</ol>
<p>另一个是 <code>public static void main(java.lang.String[]);</code> 主方法的字节码指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b2 00 02 12 03 b6 00 04 b1</span><br></pre></td></tr></table></figure>

<ol>
<li>b2 &#x3D;&gt; getstatic 用来加载静态变量（<strong>加载到操作数栈上</strong>），哪个静态变量呢？</li>
<li>00 02 引用常量池中 #2 项，即【Field java&#x2F;lang&#x2F;System.out:Ljava&#x2F;io&#x2F;PrintStream;】</li>
<li>12 &#x3D;&gt; ldc 加载参数，哪个参数呢？</li>
<li>03 引用常量池中 #3 项，即 【String hello world】</li>
<li>b6 &#x3D;&gt; invokevirtual 预备<strong>调用成员方法</strong>，哪个方法呢？</li>
<li>00 04 引用常量池中 #4 项，即【Method java&#x2F;io&#x2F;PrintStream.println:(Ljava&#x2F;lang&#x2F;String;)V】</li>
<li>b1 表示返回 return</li>
</ol>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131015553127.png" alt="image-20230131015553127" style="zoom:80%;margin-left:0" />



<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5">参考文档</a></p>
<h4 id="javap-工具"><a href="#javap-工具" class="headerlink" title="javap 工具"></a>javap 工具</h4><p>由于分析类文件结构过于麻烦，Oracle 提供了 javap 工具来反编译 class 文件</p>
<p> <code>javap -v HelloWorld.class</code> -&gt; -v 表示输出详细信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># javap -v HelloWorld.class</span></span><br><span class="line">Classfile /root/HelloWorld.class</span><br><span class="line">    Last modified Jul 7, 2019; size 597 bytes</span><br><span class="line">    MD5 checksum 361dca1c3f4ae38644a9cd5060ac6dbc</span><br><span class="line">    Compiled from <span class="string">&quot;HelloWorld.java&quot;</span></span><br><span class="line">public class cn.itcast.jvm.t5.HelloWorld</span><br><span class="line">    minor version: 0</span><br><span class="line">    major version: 52</span><br><span class="line">    flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">    <span class="comment">#1 = Methodref      #6.#21 // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">    <span class="comment">#2 = Fieldref       #22.#23 //</span></span><br><span class="line">    java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">    <span class="comment">#3 = String         #24 // hello world</span></span><br><span class="line">    <span class="comment">#4 = Methodref      #25.#26 // java/io/PrintStream.println:</span></span><br><span class="line">    (Ljava/lang/String;)V</span><br><span class="line">    <span class="comment">#5 = Class          #27 // cn/itcast/jvm/t5/HelloWorld</span></span><br><span class="line">    <span class="comment">#6 = Class          #28 // java/lang/Object</span></span><br><span class="line">    <span class="comment">#7 = Utf8           &lt;init&gt;</span></span><br><span class="line">    <span class="comment">#8 = Utf8           ()V</span></span><br><span class="line">    <span class="comment">#9 = Utf8           Code</span></span><br><span class="line">    <span class="comment">#10 = Utf8          LineNumberTable</span></span><br><span class="line">    <span class="comment">#11 = Utf8          LocalVariableTable</span></span><br><span class="line">    <span class="comment">#12 = Utf8          this</span></span><br><span class="line">    <span class="comment">#13 = Utf8          Lcn/itcast/jvm/t5/HelloWorld;</span></span><br><span class="line">    <span class="comment">#14 = Utf8          main</span></span><br><span class="line">    <span class="comment">#15 = Utf8          ([Ljava/lang/String;)V</span></span><br><span class="line">    <span class="comment">#16 = Utf8          args</span></span><br><span class="line">    <span class="comment">#17 = Utf8          [Ljava/lang/String;</span></span><br><span class="line">    <span class="comment">#18 = Utf8          MethodParameters</span></span><br><span class="line">    <span class="comment">#19 = Utf8          SourceFile</span></span><br><span class="line">    <span class="comment">#20 = Utf8          HelloWorld.java</span></span><br><span class="line">    <span class="comment">#21 = NameAndType   #7:#8 // &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">    <span class="comment">#22 = Class         #29 // java/lang/System</span></span><br><span class="line">    <span class="comment">#23 = NameAndType   #30:#31 // out:Ljava/io/PrintStream;</span></span><br><span class="line">    <span class="comment">#24 = Utf8          hello world</span></span><br><span class="line">    <span class="comment">#25 = Class         #32 // java/io/PrintStream</span></span><br><span class="line">    <span class="comment">#26 = NameAndType   #33:#34 // println:(Ljava/lang/String;)V</span></span><br><span class="line">    <span class="comment">#27 = Utf8          cn/itcast/jvm/t5/HelloWorld</span></span><br><span class="line">    <span class="comment">#28 = Utf8          java/lang/Object</span></span><br><span class="line">    <span class="comment">#29 = Utf8          java/lang/System</span></span><br><span class="line">    <span class="comment">#30 = Utf8          out</span></span><br><span class="line">    <span class="comment">#31 = Utf8          Ljava/io/PrintStream;</span></span><br><span class="line">    <span class="comment">#32 = Utf8          java/io/PrintStream</span></span><br><span class="line">    <span class="comment">#33 = Utf8          println</span></span><br><span class="line">    <span class="comment">#34 = Utf8          (Ljava/lang/String;)V</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    public cn.itcast.jvm.t5.HelloWorld();</span><br><span class="line">        descriptor: ()V</span><br><span class="line">        flags: ACC_PUBLIC</span><br><span class="line">        Code:</span><br><span class="line">            stack=1, locals=1, args_size=1</span><br><span class="line">                0: aload_0</span><br><span class="line">                1: invokespecial <span class="comment">#1 // Method java/lang/Object.&quot; &lt;init&gt;&quot;:()V</span></span><br><span class="line">                4: <span class="built_in">return</span></span><br><span class="line">            LineNumberTable:</span><br><span class="line">                line 4: 0</span><br><span class="line">            LocalVariableTable:</span><br><span class="line">                Start Length Slot Name Signature</span><br><span class="line">                    0      5    0 this Lcn/itcast/jvm/t5/HelloWorld;</span><br><span class="line">    public static void main(java.lang.String[]);</span><br><span class="line">        descriptor: ([Ljava/lang/String;)V</span><br><span class="line">        flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">        Code:</span><br><span class="line">            stack=2, locals=1, args_size=1</span><br><span class="line">            0: getstatic <span class="comment">#2 // Field</span></span><br><span class="line">    java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">            3: ldc <span class="comment">#3 // String hello world</span></span><br><span class="line">            5: invokevirtual <span class="comment">#4 // Method</span></span><br><span class="line">    java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">            8: <span class="built_in">return</span></span><br><span class="line">        LineNumberTable:</span><br><span class="line">            line 6: 0</span><br><span class="line">            line 7: 8</span><br><span class="line">        LocalVariableTable:</span><br><span class="line">            Start Length Slot Name Signature</span><br><span class="line">                0      9    0 args [Ljava/lang/String;</span><br><span class="line">        MethodParameters:</span><br><span class="line">            Name    Flags</span><br><span class="line">            args</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>javap 反编译工具来帮助我们简化阅读 class 字节码文件 -&gt; 更清晰阅读字节码文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">E:\Todo\note\Software\Java_Note\JVM_Note&gt;javap -v HelloWorld.class</span><br><span class="line">Classfile /E:/Todo/note/Software/Java_Note/JVM_Note/HelloWorld.class</span><br><span class="line">  Last modified 2023-1-30; size 432 bytes</span><br><span class="line">  MD5 checksum d3dace27df9ccf67c8b58b911541fa63</span><br><span class="line">  Compiled from <span class="string">&quot;HelloWorld.java&quot;</span></span><br><span class="line">public class Test02.HelloWorld</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   <span class="comment">#1 = Methodref          #6.#15         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   <span class="comment">#2 = Fieldref           #16.#17        // java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">   <span class="comment">#3 = String             #18            // hello world</span></span><br><span class="line">   <span class="comment">#4 = Methodref          #19.#20        // java/io/PrintStream.println:(Ljava/lang/String;)V</span></span><br><span class="line">   <span class="comment">#5 = Class              #21            // Test02/HelloWorld</span></span><br><span class="line">   <span class="comment">#6 = Class              #22            // java/lang/Object</span></span><br><span class="line">   <span class="comment">#7 = Utf8               &lt;init&gt;</span></span><br><span class="line">   <span class="comment">#8 = Utf8               ()V</span></span><br><span class="line">   <span class="comment">#9 = Utf8               Code</span></span><br><span class="line">  <span class="comment">#10 = Utf8               LineNumberTable</span></span><br><span class="line">  <span class="comment">#11 = Utf8               main</span></span><br><span class="line">  <span class="comment">#12 = Utf8               ([Ljava/lang/String;)V</span></span><br><span class="line">  <span class="comment">#13 = Utf8               SourceFile</span></span><br><span class="line">  <span class="comment">#14 = Utf8               HelloWorld.java</span></span><br><span class="line">  <span class="comment">#15 = NameAndType        #7:#8          // &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  <span class="comment">#16 = Class              #23            // java/lang/System</span></span><br><span class="line">  <span class="comment">#17 = NameAndType        #24:#25        // out:Ljava/io/PrintStream;</span></span><br><span class="line">  <span class="comment">#18 = Utf8               hello world</span></span><br><span class="line">  <span class="comment">#19 = Class              #26            // java/io/PrintStream</span></span><br><span class="line">  <span class="comment">#20 = NameAndType        #27:#28        // println:(Ljava/lang/String;)V</span></span><br><span class="line">  <span class="comment">#21 = Utf8               Test02/HelloWorld</span></span><br><span class="line">  <span class="comment">#22 = Utf8               java/lang/Object</span></span><br><span class="line">  <span class="comment">#23 = Utf8               java/lang/System</span></span><br><span class="line">  <span class="comment">#24 = Utf8               out</span></span><br><span class="line">  <span class="comment">#25 = Utf8               Ljava/io/PrintStream;</span></span><br><span class="line">  <span class="comment">#26 = Utf8               java/io/PrintStream</span></span><br><span class="line">  <span class="comment">#27 = Utf8               println</span></span><br><span class="line">  <span class="comment">#28 = Utf8               (Ljava/lang/String;)V</span></span><br><span class="line">&#123;</span><br><span class="line">  public Test02.HelloWorld();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial <span class="comment">#1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         4: <span class="built_in">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 3: 0</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     <span class="comment">#2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">         3: ldc           <span class="comment">#3                  // String hello world</span></span><br><span class="line">         5: invokevirtual <span class="comment">#4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span></span><br><span class="line">         8: <span class="built_in">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 5: 0</span><br><span class="line">        line 6: 8</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: <span class="string">&quot;HelloWorld.java&quot;</span></span><br></pre></td></tr></table></figure>





<h4 id="图解方法执行流程"><a href="#图解方法执行流程" class="headerlink" title="图解方法执行流程"></a>图解方法执行流程</h4><p><strong>java 代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 演示 字节码指令 和 操作数栈、常量池的关系</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> Short.MAX_VALUE + <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> a + b;</span><br><span class="line">        System.out.println(c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>编译后字节码文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># javap -v Demo3_1.class</span></span><br><span class="line">Classfile /root/Demo3_1.class</span><br><span class="line">Last modified Jul 7, 2019; size 665 bytes</span><br><span class="line">MD5 checksum a2c29a22421e218d4924d31e6990cfc5</span><br><span class="line">Compiled from <span class="string">&quot;Demo3_1.java&quot;</span></span><br><span class="line">public class cn.itcast.jvm.t3.bytecode.Demo3_1</span><br><span class="line">minor version: 0</span><br><span class="line">major version: 52</span><br><span class="line">flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line"><span class="comment">#1 = Methodref #7.#26 // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="comment">#2 = Class #27 // java/lang/Short</span></span><br><span class="line"><span class="comment">#3 = Integer 32768</span></span><br><span class="line"><span class="comment">#4 = Fieldref #28.#29 //</span></span><br><span class="line">java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line"><span class="comment">#5 = Methodref #30.#31 // java/io/PrintStream.println:(I)V</span></span><br><span class="line"><span class="comment">#6 = Class #32 // cn/itcast/jvm/t3/bytecode/Demo3_1</span></span><br><span class="line"><span class="comment">#7 = Class #33 // java/lang/Object</span></span><br><span class="line"><span class="comment">#8 = Utf8 &lt;init&gt;</span></span><br><span class="line"><span class="comment">#9 = Utf8 ()V</span></span><br><span class="line"><span class="comment">#10 = Utf8 Code</span></span><br><span class="line"><span class="comment">#11 = Utf8 LineNumberTable</span></span><br><span class="line"><span class="comment">#12 = Utf8 LocalVariableTable</span></span><br><span class="line"><span class="comment">#13 = Utf8 this</span></span><br><span class="line"><span class="comment">#14 = Utf8 Lcn/itcast/jvm/t3/bytecode/Demo3_1;</span></span><br><span class="line"><span class="comment">#15 = Utf8 main</span></span><br><span class="line"><span class="comment">#16 = Utf8 ([Ljava/lang/String;)V</span></span><br><span class="line"><span class="comment">#17 = Utf8 args</span></span><br><span class="line"><span class="comment">#18 = Utf8 [Ljava/lang/String;</span></span><br><span class="line"><span class="comment">#19 = Utf8 a</span></span><br><span class="line"><span class="comment">#20 = Utf8 I</span></span><br><span class="line"><span class="comment">#21 = Utf8 b</span></span><br><span class="line"><span class="comment">#22 = Utf8 c</span></span><br><span class="line"><span class="comment">#23 = Utf8 MethodParameters</span></span><br><span class="line"><span class="comment">#24 = Utf8 SourceFile</span></span><br><span class="line"><span class="comment">#25 = Utf8 Demo3_1.java</span></span><br><span class="line"><span class="comment">#26 = NameAndType #8:#9 // &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="comment">#27 = Utf8 java/lang/Short</span></span><br><span class="line"><span class="comment">#28 = Class #34 // java/lang/System</span></span><br><span class="line"><span class="comment">#29 = NameAndType #35:#36 // out:Ljava/io/PrintStream;</span></span><br><span class="line"><span class="comment">#30 = Class #37 // java/io/PrintStream</span></span><br><span class="line"><span class="comment">#31 = NameAndType #38:#39 // println:(I)V</span></span><br><span class="line"><span class="comment">#32 = Utf8 cn/itcast/jvm/t3/bytecode/Demo3_1</span></span><br><span class="line"><span class="comment">#33 = Utf8 java/lang/Object</span></span><br><span class="line"><span class="comment">#34 = Utf8 java/lang/System</span></span><br><span class="line"><span class="comment">#35 = Utf8 out</span></span><br><span class="line"><span class="comment">#36 = Utf8 Ljava/io/PrintStream;</span></span><br><span class="line"><span class="comment">#37 = Utf8 java/io/PrintStream</span></span><br><span class="line"><span class="comment">#38 = Utf8 println</span></span><br><span class="line"><span class="comment">#39 = Utf8 (I)V</span></span><br><span class="line">&#123;</span><br><span class="line">public cn.itcast.jvm.t3.bytecode.Demo3_1();</span><br><span class="line">descriptor: ()V</span><br><span class="line">flags: ACC_PUBLIC</span><br><span class="line">Code:</span><br><span class="line">stack=1, locals=1, args_size=1</span><br><span class="line">0: aload_0</span><br><span class="line">1: invokespecial <span class="comment">#1 // Method java/lang/Object.&quot;</span></span><br><span class="line">&lt;init&gt;<span class="string">&quot;:()V</span></span><br><span class="line"><span class="string">4: return</span></span><br><span class="line"><span class="string">LineNumberTable:</span></span><br><span class="line"><span class="string">line 6: 0</span></span><br><span class="line"><span class="string">LocalVariableTable:</span></span><br><span class="line"><span class="string">Start Length Slot Name Signature</span></span><br><span class="line"><span class="string">0 5 0 this Lcn/itcast/jvm/t3/bytecode/Demo3_1;</span></span><br><span class="line"><span class="string">public static void main(java.lang.String[]);</span></span><br><span class="line"><span class="string">descriptor: ([Ljava/lang/String;)V</span></span><br><span class="line"><span class="string">flags: ACC_PUBLIC, ACC_STATIC</span></span><br><span class="line"><span class="string">Code:</span></span><br><span class="line"><span class="string">stack=2, locals=4, args_size=1</span></span><br><span class="line"><span class="string">0: bipush 10</span></span><br><span class="line"><span class="string">2: istore_1</span></span><br><span class="line"><span class="string">3: ldc #3 // int 32768</span></span><br><span class="line"><span class="string">5: istore_2</span></span><br><span class="line"><span class="string">6: iload_1</span></span><br><span class="line"><span class="string">7: iload_2</span></span><br><span class="line"><span class="string">8: iadd</span></span><br><span class="line"><span class="string">9: istore_3</span></span><br><span class="line"><span class="string">10: getstatic #4 // Field</span></span><br><span class="line"><span class="string">java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line"><span class="string">13: iload_3</span></span><br><span class="line"><span class="string">14: invokevirtual #5 // Method</span></span><br><span class="line"><span class="string">java/io/PrintStream.println:(I)V</span></span><br><span class="line"><span class="string">17: return</span></span><br><span class="line"><span class="string">LineNumberTable:</span></span><br><span class="line"><span class="string">line 8: 0</span></span><br><span class="line"><span class="string">line 9: 3</span></span><br><span class="line"><span class="string">line 10: 6</span></span><br><span class="line"><span class="string">line 11: 10</span></span><br><span class="line"><span class="string">line 12: 17</span></span><br><span class="line"><span class="string">LocalVariableTable:</span></span><br><span class="line"><span class="string">Start Length Slot Name Signature</span></span><br><span class="line"><span class="string">0 18 0 args [Ljava/lang/String;</span></span><br><span class="line"><span class="string">3 15 1 a I</span></span><br><span class="line"><span class="string">6 12 2 b I</span></span><br><span class="line"><span class="string">10 8 3 c I</span></span><br><span class="line"><span class="string">MethodParameters:</span></span><br><span class="line"><span class="string">Name Flags</span></span><br><span class="line"><span class="string">args</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>



<ol>
<li><strong>常量池载入运行时常量池</strong></li>
</ol>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102433463.png" alt="image-20230130102433463" style="zoom:80%;margin-left:0" />

<p><strong>注意 小数字并不是存储在常量池中而是与字节码指令存储在一起 -&gt; 如 10 -&gt; 而一旦数字超过了short整数的最大值 Short.MAX_VALUE+1，就会被存储在常量池中</strong></p>
<ol start="2">
<li><strong>方法字节码载入方法区</strong></li>
</ol>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102503672.png" alt="image-20230130102503672" style="zoom:80%;margin-left:0" />



<ol start="3">
<li><strong>main 线程开始运行，分配栈帧内存</strong></li>
</ol>
<p>（stack&#x3D;2，locals&#x3D;4）</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102533975.png" alt="image-20230130102533975" style="zoom:80%;margin-left:0" />

<p>栈帧又分为，局部变量表（locals&#x3D;4）与操作数栈（stack&#x3D;2 存储数据与字节码指令）</p>
<ol start="4">
<li><strong>执行引擎开始执行字节码</strong></li>
</ol>
<p><em>bipush 10</em></p>
<ul>
<li>将一个 byte 压入操作数栈（操作数栈的宽度单位使，4字节，故而将其长度会补齐 4 个字节），类似的指令还有 </li>
<li>sipush 将一个 short 压入操作数栈（其长度会补齐 4 个字节） </li>
<li>ldc 将一个 int（常量池中数据） 压入操作数栈 </li>
<li>ldc2_w 将一个 long 压入操作数栈（分两次压入，因为 long 是 8 个字节） </li>
<li>这里小的数字都是和字节码指令存在一起，超过 short 范围的数字存入了常量池</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102627560.png" alt="image-20230130102627560" style="zoom:80%;margin-left:0" />



<p><em>istore_1</em></p>
<ul>
<li>将操作数栈顶数据弹出，存入局部变量表的 slot 1 -&gt; 槽位</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102655779.png" alt="image-20230130102655779" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102711519.png" alt="image-20230130102711519" style="zoom:80%;margin-left:0" />



<p><em>ldc #3</em></p>
<ul>
<li>从常量池加载 #3 数据到操作数栈</li>
<li><strong>注意</strong> Short.MAX_VALUE 是 32767，所以 32768 &#x3D; Short.MAX_VALUE + 1 实际是在编译期间计算好的</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102747310.png" alt="image-20230130102747310" style="zoom:80%;margin-left:0" />



<p><em>istore_2</em></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102815074.png" alt="image-20230130102815074" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102833858.png" alt="image-20230130102833858" style="zoom:80%;margin-left:0" />



<p><em>iload_1</em></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102855048.png" alt="image-20230130102855048" style="zoom:80%;margin-left:0" />



<p><em>iload_2</em></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102915850.png" alt="image-20230130102915850" style="zoom:80%;margin-left:0" />



<p><em>iadd</em></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102940090.png" alt="image-20230130102940090" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130102951366.png" alt="image-20230130102951366" style="zoom:80%;margin-left:0" />



<p><em>istore_3</em></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103050009.png" alt="image-20230130103050009" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103104858.png" alt="image-20230130103104858" style="zoom:80%;margin-left:0" />



<p><em>getstatic #4</em></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103124540.png" alt="image-20230130103124540" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103137016.png" alt="image-20230130103137016" style="zoom:80%;margin-left:0" />



<p><em>iload_3</em></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103205056.png" alt="image-20230130103205056" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103219333.png" alt="image-20230130103219333" style="zoom:80%;margin-left:0" />



<p><em>invokevirtual #5</em></p>
<ul>
<li>找到常量池 #5 项 </li>
<li>定位到方法区 <code>java/io/PrintStream.println:(I)V</code> 方法 </li>
<li>生成新的栈帧（分配 locals、stack等） </li>
<li>传递参数，执行新栈帧中的字节码</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103308678.png" alt="image-20230130103308678" style="zoom:80%;margin-left:0" />



<ul>
<li>执行完毕，弹出栈帧 </li>
<li>清除 main 操作数栈内容</li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103334036.png" alt="image-20230130103334036" style="zoom:80%;margin-left:0" />



<p><em>return</em></p>
<ul>
<li>完成 main 方法调用，弹出 main 栈帧 </li>
<li>程序结束</li>
</ul>
<h4 id="练习-分析-i"><a href="#练习-分析-i" class="headerlink" title="练习 - 分析 i++"></a>练习 - 分析 i++</h4><p><em>暂时可以有几个局部变量就几个槽位</em></p>
<p>目的：从字节码角度分析 a++ 相关题目</p>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 从字节码角度分析 a++ 相关题目</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> a++ + ++a + a--;</span><br><span class="line">        System.out.println(a);</span><br><span class="line">        System.out.println(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>字节码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public static void main(java.lang.String[]);</span><br><span class="line">descriptor: ([Ljava/lang/String;)V</span><br><span class="line">flags: (0x0009) ACC_PUBLIC, ACC_STATIC</span><br><span class="line">Code:</span><br><span class="line">stack=2, locals=3, args_size=1</span><br><span class="line">0: bipush 10</span><br><span class="line">2: istore_1</span><br><span class="line">3: iload_1</span><br><span class="line">4: iinc 1, 1</span><br><span class="line">7: iinc 1, 1</span><br><span class="line">10: iload_1</span><br><span class="line">11: iadd</span><br><span class="line">12: iload_1</span><br><span class="line">13: iinc 1, -1</span><br><span class="line">16: iadd</span><br><span class="line">17: istore_2</span><br><span class="line">18: getstatic #2 // Field</span><br><span class="line">java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">21: iload_1</span><br><span class="line">22: invokevirtual #3 // Method</span><br><span class="line">java/io/PrintStream.println:(I)V</span><br><span class="line">25: getstatic #2 // Field</span><br><span class="line">java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">28: iload_2</span><br><span class="line">29: invokevirtual #3 // Method</span><br><span class="line">java/io/PrintStream.println:(I)V</span><br><span class="line">32: return</span><br><span class="line">LineNumberTable:</span><br><span class="line">line 8: 0</span><br><span class="line">line 9: 3</span><br><span class="line">line 10: 18</span><br><span class="line">line 11: 25</span><br><span class="line">line 12: 32</span><br><span class="line">LocalVariableTable:</span><br><span class="line">Start Length Slot Name Signature</span><br><span class="line">0 33 0 args [Ljava/lang/String;</span><br><span class="line">3 30 1 a I</span><br><span class="line">18 15 2 b I</span><br></pre></td></tr></table></figure>

<p>分析：</p>
<ul>
<li>&#x3D;&#x3D;注意 iinc 指令是直接在<strong>局部变量 slot</strong> 上进行运算&#x3D;&#x3D; </li>
<li>a++ 和 ++a 的区别是<strong>先执行 iload 还是 先执行 iinc</strong></li>
</ul>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103512529.png" alt="image-20230130103512529" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103536823.png" alt="image-20230130103536823" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103549930.png" alt="image-20230130103549930" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103614656.png" alt="image-20230130103614656" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103629149.png" alt="image-20230130103629149" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103639878.png" alt="image-20230130103639878" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103650675.png" alt="image-20230130103650675" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103701865.png" alt="image-20230130103701865" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103715500.png" alt="image-20230130103715500" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103726645.png" alt="image-20230130103726645" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130103741012.png" alt="image-20230130103741012" style="zoom:80%;margin-left:0" />





<h4 id="条件判断指令"><a href="#条件判断指令" class="headerlink" title="条件判断指令"></a>条件判断指令</h4><table>
<thead>
<tr>
<th>指令</th>
<th>助记符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>0x99</td>
<td>ifeq</td>
<td>判断是否 &#x3D;&#x3D; 0</td>
</tr>
<tr>
<td>0x9a</td>
<td>ifne</td>
<td>判断是否 !&#x3D; 0</td>
</tr>
<tr>
<td>0x9b</td>
<td>iflt</td>
<td>判断是否 &lt; 0</td>
</tr>
<tr>
<td>0x9c</td>
<td>ifge</td>
<td>判断是否 &gt;&#x3D; 0</td>
</tr>
<tr>
<td>0x9d</td>
<td>ifgt</td>
<td>判断是否 &gt; 0</td>
</tr>
<tr>
<td>0x9e</td>
<td>ifle</td>
<td>判断是否 &lt;&#x3D; 0</td>
</tr>
<tr>
<td>0x9f</td>
<td>if_icmpeq</td>
<td>两个int是否 &#x3D;&#x3D;</td>
</tr>
<tr>
<td>0xa0</td>
<td>if_icmpne</td>
<td>两个int是否 !&#x3D;</td>
</tr>
<tr>
<td>0xa1</td>
<td>if_icmplt</td>
<td>两个int是否 &lt;</td>
</tr>
<tr>
<td>0xa2</td>
<td>if_icmpge</td>
<td>两个int是否 &gt;&#x3D;</td>
</tr>
<tr>
<td>0xa3</td>
<td>if_icmpgt</td>
<td>两个int是否 &gt;</td>
</tr>
<tr>
<td>0xa4</td>
<td>if_icmple</td>
<td>两个int是否 &lt;&#x3D;</td>
</tr>
<tr>
<td>0xa5</td>
<td>if_acmpeq</td>
<td>两个引用是否 &#x3D;&#x3D;</td>
</tr>
<tr>
<td>0xa6</td>
<td>if_acmpne</td>
<td>两个引用是否 !&#x3D;</td>
</tr>
<tr>
<td>0xc6</td>
<td>ifnull</td>
<td>判断是否 &#x3D;&#x3D; null</td>
</tr>
<tr>
<td>0xc7</td>
<td>ifnonnull</td>
<td>判断是否 !&#x3D; null</td>
</tr>
</tbody></table>
<p>说明：</p>
<ul>
<li>byte，short，char 都会按 int 比较，因为操作数栈都是 4 字节 </li>
<li>goto 用来进行跳转到指定行号的字节码</li>
</ul>
<p><em>long，double，float怎么比较见 Java虚拟机指令表</em></p>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(a == <span class="number">0</span>) &#123;</span><br><span class="line">            a = <span class="number">10</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a = <span class="number">20</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>字节码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0: iconst_0</span><br><span class="line">1: istore_1</span><br><span class="line">2: iload_1</span><br><span class="line">3: ifne 	12</span><br><span class="line">6: bipush 	10</span><br><span class="line">8: istore_1</span><br><span class="line">9: goto		15</span><br><span class="line">12: bipush 	20</span><br><span class="line">14: istore_1</span><br><span class="line">15: return</span><br></pre></td></tr></table></figure>



<blockquote>
<p><strong>思考</strong></p>
<p>以上比较指令中没有 long，float，double 的比较，那么它们要比较怎处理</p>
<p>参考 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html#jvms-6.5.lcmp">https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html#jvms-6.5.lcmp</a></p>
</blockquote>
<h4 id="循环控制指令"><a href="#循环控制指令" class="headerlink" title="循环控制指令"></a>循环控制指令</h4><p>循环控制同样是前面介绍的那些指令</p>
<p><strong>例如 while 循环：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (a &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            a++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>字节码是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0: iconst_0</span><br><span class="line">1: istore_1</span><br><span class="line">2: iload_1</span><br><span class="line">3: bipush   	10</span><br><span class="line">5: if_icmpge    14</span><br><span class="line">8: iinc 	    1, 1</span><br><span class="line">11: goto 	    2</span><br><span class="line">14: return</span><br></pre></td></tr></table></figure>

<p><strong>比如 do while 循环：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            a++;</span><br><span class="line">        &#125; <span class="keyword">while</span> (a &lt; <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>字节码是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0: iconst_0</span><br><span class="line"> 1: istore_1</span><br><span class="line"> 2: iinc 1, 1</span><br><span class="line"> 5: iload_1</span><br><span class="line"> 6: bipush 10</span><br><span class="line"> 8: if_icmplt 2</span><br><span class="line">11: return</span><br></pre></td></tr></table></figure>

<p><strong>最后再看 for 循环：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>字节码是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0: iconst_0</span><br><span class="line">1: istore_1</span><br><span class="line">2: iload_1</span><br><span class="line">3: bipush 10</span><br><span class="line">5: if_icmpge 14</span><br><span class="line">8: iinc 1, 1</span><br><span class="line">11: goto 2</span><br><span class="line">14: return</span><br></pre></td></tr></table></figure>



<blockquote>
<p><strong>注意</strong> </p>
<p>比较 <strong>while 和 for 的字节码</strong>，你发现它们是一模一样的，<strong>殊途同归</strong></p>
</blockquote>
<h4 id="练习-判断结果"><a href="#练习-判断结果" class="headerlink" title="练习 - 判断结果"></a>练习 - 判断结果</h4><p>请从字节码角度分析，下列代码运行的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_6_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            x = x++;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(x); <span class="comment">// 结果是 0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131024938366.png" alt="image-20230131024938366" style="zoom:80%;margin-left:0" />



<h4 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h4><h5 id="lt-cinit-gt-V"><a href="#lt-cinit-gt-V" class="headerlink" title="&lt;cinit&gt;()V"></a><code>&lt;cinit&gt;()V</code></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_8_1</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        i = <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        i = <span class="number">30</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译器会按<strong>从上至下</strong>的顺序，<strong>收集所有 static 静态代码块</strong>和<strong>静态成员赋值的代码</strong>，合并为一个特殊的方法 <code>&lt;cinit&gt;()V</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0: bipush 10</span><br><span class="line">2: putstatic #2 // Field i:I</span><br><span class="line">5: bipush 20</span><br><span class="line">7: putstatic #2 // Field i:I</span><br><span class="line">10: bipush 30</span><br><span class="line">12: putstatic #2 // Field i:I</span><br><span class="line">15: return</span><br></pre></td></tr></table></figure>

<p><code>&lt;cinit&gt;()V</code> 方法会在类加载的初始化阶段被调用</p>
<blockquote>
<p><strong>练习</strong></p>
<p>自己调整一下 static 变量和静态代码块的位置，观察字节码的改动</p>
</blockquote>
<h5 id="lt-init-gt-V"><a href="#lt-init-gt-V" class="headerlink" title="&lt;init&gt;()V"></a><code>&lt;init&gt;()V</code></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_8_2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> <span class="string">&quot;s1&quot;</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        b = <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        a = <span class="string">&quot;s2&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Demo3_8_2</span><span class="params">(String a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.a = a;</span><br><span class="line">        <span class="built_in">this</span>.b = b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Demo3_8_2</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Demo3_8_2</span>(<span class="string">&quot;s3&quot;</span>, <span class="number">30</span>);</span><br><span class="line">        System.out.println(d.a);</span><br><span class="line">        System.out.println(d.b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译器会按<strong>从上至下</strong>的顺序，<strong>收集所有 {} 代码块</strong>和<strong>成员变量赋值的代码</strong>，<strong>形成新的构造方法</strong>，但<strong>原始构造方法内的代码</strong>总是在<strong>最后</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> cn.itcast.jvm.t3.bytecode.Demo3_8_2(java.lang.String, <span class="type">int</span>);</span><br><span class="line">    descriptor: (Ljava/lang/String;I)V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">        stack=<span class="number">2</span>, locals=<span class="number">3</span>, args_size=<span class="number">3</span></span><br><span class="line">            <span class="number">0</span>: aload_0			<span class="comment">// 加载 this</span></span><br><span class="line">            <span class="number">1</span>: invokespecial        #<span class="number">1</span> <span class="comment">// super.&lt;init&gt;()V</span></span><br><span class="line">            <span class="number">4</span>: aload_0</span><br><span class="line">            <span class="number">5</span>: ldc                  #<span class="number">2</span> <span class="comment">// &lt;- &quot;s1&quot;</span></span><br><span class="line">            <span class="number">7</span>: putfield             #<span class="number">3</span> <span class="comment">// -&gt; this.a</span></span><br><span class="line">            <span class="number">10</span>: aload_0</span><br><span class="line">            <span class="number">11</span>: bipush              <span class="number">20</span> <span class="comment">// &lt;- 20</span></span><br><span class="line">            <span class="number">13</span>: putfield            #<span class="number">4</span> <span class="comment">// -&gt; this.b</span></span><br><span class="line">            <span class="number">16</span>: aload_0</span><br><span class="line">            <span class="number">17</span>: bipush              <span class="number">10</span> <span class="comment">// &lt;- 10</span></span><br><span class="line">            <span class="number">19</span>: putfield            #<span class="number">4</span> <span class="comment">// -&gt; this.b</span></span><br><span class="line">            <span class="number">22</span>: aload_0</span><br><span class="line">            <span class="number">23</span>: ldc                 #<span class="number">5</span> <span class="comment">// &lt;- &quot;s2&quot;</span></span><br><span class="line">            <span class="number">25</span>: putfield            #<span class="number">3</span> <span class="comment">// -&gt; this.a</span></span><br><span class="line">            <span class="number">28</span>: aload_0                <span class="comment">// ------------------------------</span></span><br><span class="line">            <span class="number">29</span>: aload_1                <span class="comment">// &lt;- slot 1(a) &quot;s3&quot;             |</span></span><br><span class="line">            <span class="number">30</span>: putfield            #<span class="number">3</span> <span class="comment">// -&gt; this.a                     |</span></span><br><span class="line">            <span class="number">33</span>: aload_0                                                 |</span><br><span class="line">            <span class="number">34</span>: iload_2                <span class="comment">// &lt;- slot 2(b) 30               |</span></span><br><span class="line">            <span class="number">35</span>: putfield            #<span class="number">4</span> <span class="comment">// -&gt; this.b --------------------</span></span><br><span class="line">            <span class="number">38</span>: <span class="keyword">return</span></span><br><span class="line">        LineNumberTable: ...</span><br><span class="line">        LocalVariableTable:</span><br><span class="line">            Start Length Slot Name Signature</span><br><span class="line">            <span class="number">0</span> <span class="number">39</span> <span class="number">0</span> <span class="built_in">this</span> Lcn/itcast/jvm/t3/bytecode/Demo3_8_2;</span><br><span class="line">            <span class="number">0</span> <span class="number">39</span> <span class="number">1</span> a Ljava/lang/String;</span><br><span class="line">            <span class="number">0</span> <span class="number">39</span> <span class="number">2</span> b I</span><br><span class="line">    MethodParameters: ...</span><br></pre></td></tr></table></figure>





<h4 id="方法调用"><a href="#方法调用" class="headerlink" title="方法调用"></a>方法调用</h4><p>不同的方法调用对应的字节码指令</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_9</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Demo3_9</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Demo3_9</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Demo3_9</span>();</span><br><span class="line">        d.test1();</span><br><span class="line">        d.test2();</span><br><span class="line">        d.test3();</span><br><span class="line">        d.test4();</span><br><span class="line">        Demo3_9.test4();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>字节码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: <span class="keyword">new</span> #<span class="number">2</span> <span class="comment">// class cn/itcast/jvm/t3/bytecode/Demo3_9 --分配堆空间内存</span></span><br><span class="line"><span class="number">3</span>: dup	<span class="comment">// 将分配成功的对象引用放入操作数栈，dup复制操作数栈，配合 init 使用</span></span><br><span class="line"><span class="number">4</span>: invokespecial #<span class="number">3</span> <span class="comment">// Method &quot;&lt;init&gt;&quot;:()V --构造</span></span><br><span class="line"><span class="number">7</span>: astore_1</span><br><span class="line"><span class="number">8</span>: aload_1</span><br><span class="line"><span class="number">9</span>: invokespecial #<span class="number">4</span> <span class="comment">// Method test1:()V --private</span></span><br><span class="line"><span class="number">12</span>: aload_1</span><br><span class="line"><span class="number">13</span>: invokespecial #<span class="number">5</span> <span class="comment">// Method test2:()V --final</span></span><br><span class="line"><span class="number">16</span>: aload_1</span><br><span class="line"><span class="number">17</span>: invokevirtual #<span class="number">6</span> <span class="comment">// Method test3:()V --public（可能被重写，所以invokevirtual动态绑定，需要在运行时确定）</span></span><br><span class="line"><span class="number">20</span>: aload_1</span><br><span class="line"><span class="number">21</span>: pop</span><br><span class="line"><span class="number">22</span>: invokestatic #<span class="number">7</span> <span class="comment">// Method test4:()V --static</span></span><br><span class="line"><span class="number">25</span>: invokestatic #<span class="number">7</span> <span class="comment">// Method test4:()V --static</span></span><br><span class="line"><span class="number">28</span>: <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<ul>
<li>new 是创建【对象】，给对象分配堆内存，执行成功会将【对象引用】压入操作数栈 </li>
<li>dup 是赋值操作数栈栈顶的内容，本例即为【对象引用】，为什么需要两份引用呢，一个是要配合 invokespecial 调用该对象的构造方法 “”:()V （会消耗掉栈顶一个引用），另一个要配合 astore_1 赋值给局部变量</li>
<li>最终方法（final），私有方法（private），构造方法都是由 invokespecial 指令来调用，属于静态绑定</li>
<li>普通成员方法是由 invokevirtual 调用，属于动态绑定，即支持多态</li>
<li>成员方法与静态方法调用的另一个区别是，执行方法前是否需要【对象引用】</li>
<li>比较有意思的是 d.test4(); 是通过【对象引用】调用一个静态方法，可以看到在调用 invokestatic 之前执行了 pop 指令，把【对象引用】从操作数栈弹掉了</li>
<li>还有一个执行 invokespecial 的情况是通过 super 调用父类方法</li>
<li><em>invokespecial 与 invokestatic 性能相对于 invokevirtual 要高出一截</em></li>
</ul>
<h4 id="多态原理"><a href="#多态原理" class="headerlink" title="多态原理"></a>多态原理</h4><p><strong>多态的原理从字节码指令角度看就是 <code>invokevirtual</code></strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 演示多态原理，注意加上下面的 JVM 参数，禁用指针压缩</span></span><br><span class="line"><span class="comment">* -XX:-UseCompressedOops -XX:-UseCompressedClassPointers</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_10</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(Animal animal)</span> &#123;</span><br><span class="line">        animal.eat();</span><br><span class="line">        System.out.println(animal.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        test(<span class="keyword">new</span> <span class="title class_">Cat</span>());</span><br><span class="line">        test(<span class="keyword">new</span> <span class="title class_">Dog</span>());</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我是&quot;</span> + <span class="built_in">this</span>.getClass().getSimpleName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;啃骨头&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cat</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;吃鱼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ol>
<li>运行代码</li>
</ol>
<p>停在 System.in.read() 方法上，这时运行 jps 获取进程 id</p>
<ol start="2">
<li>运行 HSDB 工具</li>
</ol>
<p><strong>借助 HSDB 工具才能看到 VM 底层的内存状态与内存地址</strong></p>
<p>进入 JDK 安装目录，执行</p>
<p><code>java -cp ./lib/sa-jdi.jar sun.jvm.hotspot.HSDB</code></p>
<p>进入图形界面 attach <strong>输入 进程 id</strong></p>
<p><strong>注意执行代码的时候需要加上参数，禁止指针压缩</strong></p>
<ol start="3">
<li>查找某个对象</li>
</ol>
<p>打开 Tools -&gt; Find Object By Query</p>
<p>输入 <code>select d from cn.itcast.jvm.t3.bytecode.Dog d</code> 点击 Execute 执行</p>
<p><code>select + 类型别名 + from 对象类型 别名</code></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130153415487.png" alt="image-20230130153415487" style="zoom:80%;margin-left:0" />



<ol start="4">
<li>查看对象内存结构</li>
</ol>
<p>点击超链接可以看到对象的内存结构，此对象没有任何属性，因此只有对象头的 16 字节，前 8 字节是 MarkWord，后 8 字节就是对象的 Class 指针</p>
<p>但目前看不到它的实际地址</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130153500801.png" alt="image-20230130153500801" style="zoom:80%;margin-left:0" />

<p><strong>对象在内存中的实际表示如上，类加载以后创建出来的对象底层的class结构 -&gt; 实际就是 C++ Expression 结构 -&gt; 结构里包含 对象头  16byte（锁标记 + 对象的类型指针，根据类型指针找到对象的class类） 和 对象里的成员变量</strong></p>
<p>&#x3D;&#x3D;<strong>实际Class类在内存中的表示</strong>&#x3D;&#x3D;</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131033208864.png" alt="image-20230131033208864" style="zoom:80%;margin-left:0" />



<ol start="5">
<li>查看对象 Class 的内存地址</li>
</ol>
<p>可以通过 Windows -&gt; Console 进入命令行模式，执行</p>
<p><code>mem 0x00000001299b4978 2</code></p>
<p>mem 有两个参数，参数 1 是对象地址，参数 2 是查看 2 行（即 16 字节）</p>
<p>结果中第二行 0x000000001b7d4028 即为 Class 的内存地址</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131033307710.png" alt="image-20230131033307710" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130153611470.png" alt="image-20230130153611470" style="zoom:80%;margin-left:0" />

<p><strong>类class 的完成显示</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131033355876.png" alt="image-20230131033355876" style="zoom:80%;margin-left:0" />



<ol start="6">
<li><strong>查看类的 vtable (类中的多态方法，都存储在一张 vtable 虚方法表中，而static final private 方法，都不会存储在虚方法表中)</strong></li>
</ol>
<p><strong>虚方法表在具体类结构的最后 <code>_default_vtable_indices</code> vtable 与 class 的偏移地址为 <code>1B8</code></strong></p>
<p><strong>方法1</strong>：Alt+R 进入 Inspector 工具，输入刚才的 Class 内存地址，看到如下界面</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130153640850.png" alt="image-20230130153640850" style="zoom:80%;margin-left:0" />

<p><strong>方法2</strong>：或者 Tools -&gt; Class Browser 输入 Dog 查找，可以得到相同的结果</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130153713226.png" alt="image-20230130153713226" style="zoom:80%;margin-left:0" />

<p>无论通过哪种方法，都可以找到 Dog Class 的 <strong>vtable 长度为 6（_vtable_len: 6）</strong>，意思就是 Dog 类有 6 个虚方法（多态相关的，final，static 不会列入）</p>
<p>那么这 6 个方法都是谁呢？从 Class 的起始地址开始算，<strong>偏移 0x1b8 就是 vtable 的起始地址，进行计算得到：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x000000001b7d4028</span><br><span class="line">			     1b8 +</span><br><span class="line">---------------------</span><br><span class="line">0x000000001b7d41e0</span><br></pre></td></tr></table></figure>

<p>通过 Windows -&gt; Console 进入命令行模式，执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mem 0x000000001b7d41e0 6</span><br><span class="line"></span><br><span class="line">0x000000001b7d41e0: 0x000000001b3d1b10</span><br><span class="line">0x000000001b7d41e8: 0x000000001b3d15e8</span><br><span class="line">0x000000001b7d41f0: 0x000000001b7d35e8</span><br><span class="line">0x000000001b7d41f8: 0x000000001b3d1540</span><br><span class="line">0x000000001b7d4200: 0x000000001b3d1678</span><br><span class="line">0x000000001b7d4208: 0x000000001b7d3fa8</span><br></pre></td></tr></table></figure>

<p>就得到了 **6 个虚方法(virtual method)**的入口地址</p>
<ol start="7">
<li>验证方法地址</li>
</ol>
<p>查看 Object animal Dog 直接按 虚方法（）的关系</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131034417149.png" alt="image-20230131034417149" style="zoom:80%;margin-left:0" />

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131034453798.png" alt="image-20230131034453798" style="zoom:80%;margin-left:0" />

<p>通过 Tools -&gt; Class Browser 查看每个类的方法定义，比较可知</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Dog - public void eat() @0x000000001b7d3fa8</span><br><span class="line">Animal - public java.lang.String toString() @0x000000001b7d35e8;</span><br><span class="line">Object - protected void finalize() @0x000000001b3d1b10;</span><br><span class="line">Object - public boolean equals(java.lang.Object) @0x000000001b3d15e8;</span><br><span class="line">Object - public native int hashCode() @0x000000001b3d1540;</span><br><span class="line">Object - protected native java.lang.Object clone() @0x000000001b3d1678;</span><br></pre></td></tr></table></figure>

<p>对号入座，发现 </p>
<ul>
<li><em>eat() 方法是 Dog 类自己的</em> </li>
<li><em>toString() 方法是继承 String 类的</em> </li>
<li><em>finalize() ，equals()，hashCode()，clone() 都是继承 Object 类的</em></li>
</ul>
<ol start="8">
<li><p>小结</p>
<p>当执行 invokevirtual 指令时，</p>
<ol>
<li>先通过栈帧中的对象引用找到对象</li>
<li>分析对象头，找到对象的实际 Class</li>
<li>Class 结构中有 vtable，它在类加载的链接阶段就已经根据方法的重写规则生成好了</li>
<li>查表得到方法的具体地址 </li>
<li>执行方法的字节码</li>
</ol>
</li>
</ol>
<p><strong>-&gt; 多态的 invokevirtual 执行，涉及到运行时动态的查找，JVM也会对这种动态的JVM进行优化，缓存（反复调用同一个方法，就直接从缓存中调取方法），如果发现运行期间，多态并没有发挥作用，只调用了一个类型，就会做一个单态的优化</strong></p>
<h4 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h4><h5 id="try-catch"><a href="#try-catch" class="headerlink" title="try-catch"></a>try-catch</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_11_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            i = <span class="number">10</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            i = <span class="number">20</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong> </p>
<p>为了抓住重点，下面的字节码省略了不重要的部分</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span>;</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">        stack=<span class="number">1</span>, locals=<span class="number">3</span>, args_size=<span class="number">1</span></span><br><span class="line">            <span class="number">0</span>: iconst_0</span><br><span class="line">            <span class="number">1</span>: istore_1</span><br><span class="line">            <span class="number">2</span>: bipush <span class="number">10</span></span><br><span class="line">            <span class="number">4</span>: istore_1</span><br><span class="line">            <span class="number">5</span>: goto <span class="number">12</span></span><br><span class="line">            <span class="number">8</span>: astore_2</span><br><span class="line">            <span class="number">9</span>: bipush <span class="number">20</span></span><br><span class="line">            <span class="number">11</span>: istore_1</span><br><span class="line">            <span class="number">12</span>: <span class="keyword">return</span></span><br><span class="line">        Exception table:</span><br><span class="line">            from to target type</span><br><span class="line">            <span class="number">2</span> <span class="number">5</span> <span class="number">8</span> Class java/lang/Exception</span><br><span class="line">    LineNumberTable: ...</span><br><span class="line">    LocalVariableTable:</span><br><span class="line">            Start Length Slot Name Signature</span><br><span class="line">            <span class="number">9</span> <span class="number">3</span> <span class="number">2</span> e Ljava/lang/Exception;</span><br><span class="line">            <span class="number">0</span> <span class="number">13</span> <span class="number">0</span> args [Ljava/lang/String;</span><br><span class="line">            <span class="number">2</span> <span class="number">11</span> <span class="number">1</span> i I</span><br><span class="line">    StackMapTable: ...</span><br><span class="line">    MethodParameters: ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到多出来一个 <strong>Exception table 的结构，[from, to) 是前闭后开的检测范围</strong>，一旦这个范围内的字节码<strong>执行出现异常</strong>，则<strong>通过 type 匹配异常类型</strong>，如果一致，进入 <strong>target</strong> 所指示行号 </li>
<li>8 行的字节码指令 astore_2 是将异常对象引用存入局部变量表的 slot 2 位置</li>
</ul>
<h5 id="多个-single-catch-块"><a href="#多个-single-catch-块" class="headerlink" title="多个 single-catch 块"></a>多个 single-catch 块</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_11_2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            i = <span class="number">10</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArithmeticException e) &#123;</span><br><span class="line">            i = <span class="number">30</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException e) &#123;</span><br><span class="line">            i = <span class="number">40</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            i = <span class="number">50</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span>;</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">        stack=<span class="number">1</span>, locals=<span class="number">3</span>, args_size=<span class="number">1</span></span><br><span class="line">            <span class="number">0</span>: iconst_0</span><br><span class="line">            <span class="number">1</span>: istore_1</span><br><span class="line">            <span class="number">2</span>: bipush <span class="number">10</span></span><br><span class="line">            <span class="number">4</span>: istore_1</span><br><span class="line">            <span class="number">5</span>: goto <span class="number">26</span></span><br><span class="line">            <span class="number">8</span>: astore_2</span><br><span class="line">            <span class="number">9</span>: bipush <span class="number">30</span></span><br><span class="line">            <span class="number">11</span>: istore_1</span><br><span class="line">            <span class="number">12</span>: goto <span class="number">26</span></span><br><span class="line">            <span class="number">15</span>: astore_2</span><br><span class="line">            <span class="number">16</span>: bipush <span class="number">40</span></span><br><span class="line">            <span class="number">18</span>: istore_1</span><br><span class="line">            <span class="number">19</span>: goto <span class="number">26</span></span><br><span class="line">            <span class="number">22</span>: astore_2</span><br><span class="line">            <span class="number">23</span>: bipush <span class="number">50</span></span><br><span class="line">            <span class="number">25</span>: istore_1</span><br><span class="line">            <span class="number">26</span>: <span class="keyword">return</span></span><br><span class="line">        Exception table:</span><br><span class="line">            from to target type</span><br><span class="line">            <span class="number">2</span> <span class="number">5</span> <span class="number">8</span> Class java/lang/ArithmeticException</span><br><span class="line">            <span class="number">2</span> <span class="number">5</span> <span class="number">15</span> Class java/lang/NullPointerException</span><br><span class="line">            <span class="number">2</span> <span class="number">5</span> <span class="number">22</span> Class java/lang/Exception</span><br><span class="line">        LineNumberTable: ...</span><br><span class="line">        LocalVariableTable:</span><br><span class="line">                Start Length Slot Name Signature</span><br><span class="line">                <span class="number">9</span> <span class="number">3</span> <span class="number">2</span> e Ljava/lang/ArithmeticException;</span><br><span class="line">                <span class="number">16</span> <span class="number">3</span> <span class="number">2</span> e Ljava/lang/NullPointerException;</span><br><span class="line">                <span class="number">23</span> <span class="number">3</span> <span class="number">2</span> e Ljava/lang/Exception;</span><br><span class="line">                <span class="number">0</span> <span class="number">27</span> <span class="number">0</span> args [Ljava/lang/String;</span><br><span class="line">                <span class="number">2</span> <span class="number">25</span> <span class="number">1</span> i I</span><br><span class="line">        StackMapTable: ...</span><br><span class="line">    MethodParameters: ...</span><br></pre></td></tr></table></figure>

<ul>
<li>因为异常出现时，只能进入 <strong>Exception table 中一个分支，所以局部变量表 slot 2 位置被共用</strong>（<em>没必要用三个 solt 槽位来存储异常对象引用，所以直接使用槽位复用</em>）</li>
</ul>
<h5 id="multi-catch"><a href="#multi-catch" class="headerlink" title="multi-catch"></a>multi-catch</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_11_3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">test</span> <span class="operator">=</span> Demo3_11_3.class.getMethod(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">            test.invoke(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException | IllegalAccessException |</span><br><span class="line">                 InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span>;</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">        stack=<span class="number">3</span>, locals=<span class="number">2</span>, args_size=<span class="number">1</span></span><br><span class="line">            <span class="number">0</span>: ldc #<span class="number">2</span></span><br><span class="line">            <span class="number">2</span>: ldc #<span class="number">3</span></span><br><span class="line">            <span class="number">4</span>: iconst_0</span><br><span class="line">            <span class="number">5</span>: anewarray #<span class="number">4</span></span><br><span class="line">            <span class="number">8</span>: invokevirtual #<span class="number">5</span></span><br><span class="line">            <span class="number">11</span>: astore_1</span><br><span class="line">            <span class="number">12</span>: aload_1</span><br><span class="line">            <span class="number">13</span>: aconst_null</span><br><span class="line">            <span class="number">14</span>: iconst_0</span><br><span class="line">            <span class="number">15</span>: anewarray #<span class="number">6</span></span><br><span class="line">            <span class="number">18</span>: invokevirtual #<span class="number">7</span></span><br><span class="line">            <span class="number">21</span>: pop</span><br><span class="line">            <span class="number">22</span>: goto <span class="number">30</span></span><br><span class="line">            <span class="number">25</span>: astore_1</span><br><span class="line">            <span class="number">26</span>: aload_1</span><br><span class="line">            <span class="number">27</span>: invokevirtual #<span class="number">11</span> <span class="comment">// e.printStackTrace:()V</span></span><br><span class="line">            <span class="number">30</span>: <span class="keyword">return</span></span><br><span class="line">    Exception table:</span><br><span class="line">            from to target type</span><br><span class="line">            <span class="number">0</span> <span class="number">22</span> <span class="number">25</span> Class java/lang/NoSuchMethodException</span><br><span class="line">            <span class="number">0</span> <span class="number">22</span> <span class="number">25</span> Class java/lang/IllegalAccessException</span><br><span class="line">            <span class="number">0</span> <span class="number">22</span> <span class="number">25</span> Class java/lang/reflect/InvocationTargetException</span><br><span class="line">    LineNumberTable: ...</span><br><span class="line">    LocalVariableTable:</span><br><span class="line">            Start Length Slot Name Signature</span><br><span class="line">            <span class="number">12</span> <span class="number">10</span> <span class="number">1</span> test Ljava/lang/reflect/Method;</span><br><span class="line">            <span class="number">26</span> <span class="number">4</span> <span class="number">1</span> e Ljava/lang/ReflectiveOperationException;</span><br><span class="line">            <span class="number">0</span> <span class="number">31</span> <span class="number">0</span> args [Ljava/lang/String;</span><br><span class="line">    StackMapTable: ...</span><br><span class="line">    MethodParameters: ...</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>区分异常类型分配槽位，三个不同的异常都存储在Exception table异常表中，相比于上述的异常，新语法并没有使字节码指令有什么变化</strong></li>
</ul>
<h5 id="finally"><a href="#finally" class="headerlink" title="finally"></a>finally</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_11_4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            i = <span class="number">10</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            i = <span class="number">20</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            i = <span class="number">30</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span>;</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">        stack=<span class="number">1</span>, locals=<span class="number">4</span>, args_size=<span class="number">1</span></span><br><span class="line">            <span class="number">0</span>: iconst_0</span><br><span class="line">            <span class="number">1</span>: istore_1 <span class="comment">// 0 -&gt; i</span></span><br><span class="line">            <span class="number">2</span>: bipush <span class="number">10</span> <span class="comment">// try --------------------------------------</span></span><br><span class="line">            <span class="number">4</span>: istore_1 <span class="comment">// 10 -&gt; i 				|</span></span><br><span class="line">            <span class="number">5</span>: bipush <span class="number">30</span> <span class="comment">// finally 				|</span></span><br><span class="line">            <span class="number">7</span>: istore_1 <span class="comment">// 30 -&gt; i 				|</span></span><br><span class="line">            <span class="number">8</span>: goto <span class="number">27</span> <span class="comment">// return -----------------------------------</span></span><br><span class="line">            <span class="number">11</span>: astore_2 <span class="comment">// catch Exceptin -&gt; e ----------------------</span></span><br><span class="line">            <span class="number">12</span>: bipush <span class="number">20</span> <span class="comment">//				 |</span></span><br><span class="line">            <span class="number">14</span>: istore_1 <span class="comment">// 20 -&gt; i				 |</span></span><br><span class="line">            <span class="number">15</span>: bipush <span class="number">30</span> <span class="comment">// finally 				|</span></span><br><span class="line">            <span class="number">17</span>: istore_1 <span class="comment">// 30 -&gt; i				 |</span></span><br><span class="line">            <span class="number">18</span>: goto <span class="number">27</span> <span class="comment">// return -----------------------------------</span></span><br><span class="line">            <span class="number">21</span>: astore_3 <span class="comment">// catch any -&gt; slot 3 ----------------------</span></span><br><span class="line">            <span class="number">22</span>: bipush <span class="number">30</span> <span class="comment">// finally				 |</span></span><br><span class="line">            <span class="number">24</span>: istore_1 <span class="comment">// 30 -&gt; i 				|</span></span><br><span class="line">            <span class="number">25</span>: aload_3 <span class="comment">// &lt;- slot 3				 |</span></span><br><span class="line">            <span class="number">26</span>: athrow <span class="comment">// throw ------------------------------------</span></span><br><span class="line">            <span class="number">27</span>: <span class="keyword">return</span></span><br><span class="line">    Exception table:</span><br><span class="line">            from to target type</span><br><span class="line">            <span class="number">2</span> <span class="number">5</span> <span class="number">11</span> Class java/lang/Exception</span><br><span class="line">            <span class="number">2</span> <span class="number">5</span> <span class="number">21</span> any <span class="comment">// 剩余的异常类型，比如 Error</span></span><br><span class="line">            <span class="number">11</span> <span class="number">15</span> <span class="number">21</span> any <span class="comment">// 剩余的异常类型，比如 Error</span></span><br><span class="line">    LineNumberTable: ...</span><br><span class="line">    LocalVariableTable:</span><br><span class="line">            Start Length Slot Name Signature</span><br><span class="line">            <span class="number">12</span> <span class="number">3</span> <span class="number">2</span> e Ljava/lang/Exception;</span><br><span class="line">            <span class="number">0</span> <span class="number">28</span> <span class="number">0</span> args [Ljava/lang/String;</span><br><span class="line">            <span class="number">2</span> <span class="number">26</span> <span class="number">1</span> i I</span><br><span class="line">    StackMapTable: ...</span><br><span class="line">    MethodParameters: ...</span><br></pre></td></tr></table></figure>

<p><strong>可以看到 finally 中的代码被复制了 3 份，分别放入 try 流程，catch 流程以及 catch 剩余的异常类型流程，从而保证，finally块中的内容一定会被执行</strong></p>
<p><strong><code>catch Exception</code> 并不能捕获所有异常，有可能出现，<code>Exception以外的（如 Exception 平级或父级的异常）</code>，这时又要<code>保证 finally块中的代码一定被执行</code>，就需要 <code>any</code> 来弥补剩余所有情况<code>（即第三个分支）</code></strong></p>
<h4 id="练习-finally-面试题"><a href="#练习-finally-面试题" class="headerlink" title="练习 - finally 面试题"></a>练习 - finally 面试题</h4><h5 id="finally-中出现-return"><a href="#finally-中出现-return" class="headerlink" title="finally 中出现 return"></a>finally 中出现 return</h5><p>下面的题目输出什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_12_2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> test();</span><br><span class="line">        System.out.println(result); <span class="comment">// 20</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">test</span><span class="params">()</span>;</span><br><span class="line">    descriptor: ()I</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">        stack=<span class="number">1</span>, locals=<span class="number">2</span>, args_size=<span class="number">0</span></span><br><span class="line">            <span class="number">0</span>: bipush <span class="number">10</span> <span class="comment">// &lt;- 10 放入栈顶</span></span><br><span class="line">            <span class="number">2</span>: istore_0 <span class="comment">// 10 -&gt; slot 0 (从栈顶移除了)</span></span><br><span class="line">            <span class="number">3</span>: bipush <span class="number">20</span> <span class="comment">// &lt;- 20 放入栈顶</span></span><br><span class="line">            <span class="number">5</span>: ireturn <span class="comment">// 返回栈顶 int(20)</span></span><br><span class="line">            <span class="number">6</span>: astore_1 <span class="comment">// catch any -&gt; slot 1</span></span><br><span class="line">            <span class="number">7</span>: bipush <span class="number">20</span> <span class="comment">// &lt;- 20 放入栈顶</span></span><br><span class="line">            <span class="number">9</span>: ireturn <span class="comment">// 返回栈顶 int(20)</span></span><br><span class="line">    Exception table:</span><br><span class="line">            from to target type</span><br><span class="line">            <span class="number">0</span> <span class="number">3</span> <span class="number">6</span> any</span><br><span class="line">    LineNumberTable: ...</span><br><span class="line">    StackMapTable: ...</span><br></pre></td></tr></table></figure>

<ul>
<li>由于 <strong>finally</strong> 中的 <strong>ireturn</strong> 被插入了所有可能的流程，因此返回结果肯定以 <strong>finally</strong> 的为准 </li>
<li>至于字节码中第 2 行，似乎没啥用，且留个伏笔，看下个例子</li>
<li>跟上例中的 finally 相比，发现没有 <strong>athrow</strong> 了，这告诉我们：<strong>如果在 finally 中出现了 return，会<code>吞掉异常</code>，可以试一下下面的代码</strong> -&gt; <strong>即使用 finally 直接执行了 return 结束了函数</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_12_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> test();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="finally-对返回值影响"><a href="#finally-对返回值影响" class="headerlink" title="finally 对返回值影响"></a>finally 对返回值影响</h5><p>下面的题目输出什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_12_2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> test();</span><br><span class="line">        System.out.println(result);	<span class="comment">// 10</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            i = <span class="number">20</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">test</span><span class="params">()</span>;</span><br><span class="line">    descriptor: ()I</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">        stack=<span class="number">1</span>, locals=<span class="number">3</span>, args_size=<span class="number">0</span></span><br><span class="line">            <span class="number">0</span>: bipush <span class="number">10</span> <span class="comment">// &lt;- 10 放入栈顶</span></span><br><span class="line">            <span class="number">2</span>: istore_0 <span class="comment">// 10 -&gt; i</span></span><br><span class="line">            <span class="number">3</span>: iload_0 <span class="comment">// &lt;- i(10)</span></span><br><span class="line">            <span class="number">4</span>: istore_1 <span class="comment">// 10 -&gt; slot 1，暂存至 slot 1，目的是为了固定返回值</span></span><br><span class="line">            <span class="number">5</span>: bipush <span class="number">20</span> <span class="comment">// &lt;- 20 放入栈顶</span></span><br><span class="line">            <span class="number">7</span>: istore_0 <span class="comment">// 20 -&gt; i</span></span><br><span class="line">            <span class="number">8</span>: iload_1 <span class="comment">// &lt;- slot 1(10) 载入 slot 1 暂存的值</span></span><br><span class="line">            <span class="number">9</span>: ireturn <span class="comment">// 返回栈顶的 int(10)</span></span><br><span class="line">            <span class="number">10</span>: astore_2</span><br><span class="line">            <span class="number">11</span>: bipush <span class="number">20</span></span><br><span class="line">            <span class="number">13</span>: istore_0</span><br><span class="line">            <span class="number">14</span>: aload_2</span><br><span class="line">            <span class="number">15</span>: athrow</span><br><span class="line">    Exception table:</span><br><span class="line">            from to target type</span><br><span class="line">            <span class="number">3</span> <span class="number">5</span> <span class="number">10</span> any</span><br><span class="line">    LineNumberTable: ...</span><br><span class="line">    LocalVariableTable:</span><br><span class="line">            Start Length Slot Name Signature</span><br><span class="line">            <span class="number">3</span> <span class="number">13</span> <span class="number">0</span> i I</span><br><span class="line">    StackMapTable: ...</span><br></pre></td></tr></table></figure>

<p><code>2: istore_0 // 10 -&gt; i</code> <strong>固定了返回值，最后会再次载入 10 后再 return</strong> –故而不会导致结果变化</p>
<h4 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_13</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span>;</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">        stack=<span class="number">2</span>, locals=<span class="number">4</span>, args_size=<span class="number">1</span></span><br><span class="line">            <span class="number">0</span>: <span class="keyword">new</span> #<span class="number">2</span> <span class="comment">// new Object</span></span><br><span class="line">            <span class="number">3</span>: dup</span><br><span class="line">            <span class="number">4</span>: invokespecial #<span class="number">1</span> <span class="comment">// invokespecial &lt;init&gt;:()V</span></span><br><span class="line">            <span class="number">7</span>: astore_1 <span class="comment">// lock引用 -&gt; lock</span></span><br><span class="line">            <span class="number">8</span>: aload_1 <span class="comment">// &lt;- lock （synchronized开始）</span></span><br><span class="line">            <span class="number">9</span>: dup	<span class="comment">// 提供给加锁和解锁使用</span></span><br><span class="line">            <span class="number">10</span>: astore_2 <span class="comment">// lock引用 -&gt; slot 2</span></span><br><span class="line">            <span class="number">11</span>: monitorenter <span class="comment">// monitorenter(lock引用)</span></span><br><span class="line">            <span class="number">12</span>: getstatic #<span class="number">3</span> <span class="comment">// &lt;- System.out</span></span><br><span class="line">            <span class="number">15</span>: ldc #<span class="number">4</span> <span class="comment">// &lt;- &quot;ok&quot;</span></span><br><span class="line">            <span class="number">17</span>: invokevirtual #<span class="number">5</span> <span class="comment">// invokevirtual println:</span></span><br><span class="line">            (Ljava/lang/String;)V</span><br><span class="line">            <span class="number">20</span>: aload_2 <span class="comment">// &lt;- slot 2(lock引用)</span></span><br><span class="line">            <span class="number">21</span>: monitorexit <span class="comment">// monitorexit(lock引用)</span></span><br><span class="line">            <span class="number">22</span>: goto <span class="number">30</span></span><br><span class="line">            <span class="number">25</span>: astore_3 <span class="comment">// any -&gt; slot 3</span></span><br><span class="line">            <span class="number">26</span>: aload_2 <span class="comment">// &lt;- slot 2(lock引用)</span></span><br><span class="line">            <span class="number">27</span>: monitorexit <span class="comment">// monitorexit(lock引用)</span></span><br><span class="line">            <span class="number">28</span>: aload_3</span><br><span class="line">            <span class="number">29</span>: athrow</span><br><span class="line">            <span class="number">30</span>: <span class="keyword">return</span></span><br><span class="line">    Exception table:</span><br><span class="line">            from to target type</span><br><span class="line">            <span class="number">12</span> <span class="number">22</span> <span class="number">25</span> any</span><br><span class="line">            <span class="number">25</span> <span class="number">28</span> <span class="number">25</span> any</span><br><span class="line">    LineNumberTable: ...</span><br><span class="line">    LocalVariableTable:</span><br><span class="line">            Start Length Slot Name Signature</span><br><span class="line">            <span class="number">0</span> <span class="number">31</span> <span class="number">0</span> args [Ljava/lang/String;</span><br><span class="line">            <span class="number">8</span> <span class="number">23</span> <span class="number">1</span> lock Ljava/lang/Object;</span><br><span class="line">    StackMapTable: ...</span><br><span class="line">    MethodParameters: ...</span><br></pre></td></tr></table></figure>

<p><strong>确保解锁动作还是使用 <code>Exception table</code> 来验证同一个对象，再解锁。即使运行过程中出现了异常，也会通过 <code>Exception table</code> 来确保队同一个对象进行解锁操作</strong></p>
<blockquote>
<p><strong>注意</strong></p>
<p>方法级别的 synchronized 不会在字节码指令中有所体现</p>
</blockquote>
<h3 id="编译期处理"><a href="#编译期处理" class="headerlink" title="编译期处理"></a>编译期处理</h3><p>所谓的 <strong>语法糖</strong> ，其实就是指 java 编译器把 <code>*.java</code> 源码编译为 <code>*.class</code> 字节码的过程中，自动生成和转换的一些代码，主要是为了减轻程序员的负担，算是 java 编译器给我们的一个额外福利（给糖吃嘛）</p>
<p><em>注意，以下代码的分析，借助了 javap 工具，idea 的反编译功能，idea 插件 jclasslib 等工具。另外，编译器转换的结果直接就是 class 字节码，只是为了便于阅读，给出了 <strong>几乎等价</strong> 的 java 源码方式，并不是编译器还会转换出中间的 java 源码，切记</em></p>
<h4 id="默认构造器"><a href="#默认构造器" class="headerlink" title="默认构造器"></a>默认构造器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy1</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译成class后的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy1</span> &#123;</span><br><span class="line">    <span class="comment">// 这个无参构造是编译器帮助我们加上的</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Candy1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(); <span class="comment">// 即调用父类 Object 的无参构造方法，即调用 java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="自动拆装箱"><a href="#自动拆装箱" class="headerlink" title="自动拆装箱"></a>自动拆装箱</h4><p>这个特性是 <strong>JDK 5</strong> 开始加入的， <strong>代码片段1</strong> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码在 <strong>JDK 5</strong> 之前是无法编译通过的，必须改写为 <strong>代码片段2</strong> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">x</span> <span class="operator">=</span> Integer.valueOf(<span class="number">1</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> x.intValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显然之前版本的代码太麻烦了，需要在<strong>基本类型和包装类型之间来回转换</strong>（尤其是集合类中操作的都是包装类型），因此这些转换的事情在 <strong>JDK 5</strong> 以后都<em>由编译器在编译阶段完成</em>。即 <strong>代码片段1</strong> 都会在编译阶段被转换为 <strong>代码片段2</strong> -128 ~ 127 之间的 int -&gt; 通过 <code>.valueOf()</code> &#x2F; <code>.intValue()</code> -&gt; <strong>优化成编译期间自动</strong></p>
<h4 id="泛型集合取值"><a href="#泛型集合取值" class="headerlink" title="泛型集合取值"></a>泛型集合取值</h4><p>泛型也是在 <strong>JDK 5</strong> 开始加入的特性，但 java 在编译泛型代码后会执行 <strong>泛型擦除</strong> 的动作（<em>有些是不会被擦除的</em>），即泛型信息在编译为字节码之后就丢失了，实际的类型都当做了 Object 类型来处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="number">10</span>); <span class="comment">// 实际调用的是 List.add(Object e)</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">x</span> <span class="operator">=</span> list.get(<span class="number">0</span>); <span class="comment">// 实际调用的是 Object obj = List.get(int index);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以在取值时，编译器真正生成的字节码中，还要额外做一个类型转换的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要将 Object 转为 Integer</span></span><br><span class="line"><span class="type">Integer</span> <span class="variable">x</span> <span class="operator">=</span> (Integer)list.get(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>如果前面的 x 变量类型修改为 int 基本类型那么最终生成的字节码是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要将 Object 转为 Integer, 并执行拆箱操作</span></span><br><span class="line"><span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> ((Integer)list.get(<span class="number">0</span>)).intValue();</span><br></pre></td></tr></table></figure>

<p><em>还好这些麻烦事都不用自己做。</em></p>
<p><strong>擦除的是字节码上的泛型信息，可以看到 <code>LocalVariableTypeTable</code> 仍然保留了方法参数泛型的信息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> cn.itcast.jvm.t3.candy.Candy3();</span><br><span class="line">descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">        Code:</span><br><span class="line">stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">    <span class="number">0</span>: aload_0</span><br><span class="line">        <span class="number">1</span>: invokespecial #<span class="number">1</span> <span class="comment">// Method java/lang/Object.&quot;</span></span><br><span class="line">            &lt;init&gt;<span class="string">&quot;:()V</span></span><br><span class="line"><span class="string">            4: return</span></span><br><span class="line"><span class="string">                LineNumberTable:</span></span><br><span class="line"><span class="string">line 6: 0</span></span><br><span class="line"><span class="string">    LocalVariableTable:</span></span><br><span class="line"><span class="string">Start Length Slot Name Signature</span></span><br><span class="line"><span class="string">    0 5 0 this Lcn/itcast/jvm/t3/candy/Candy3;</span></span><br><span class="line"><span class="string">public static void main(java.lang.String[]);</span></span><br><span class="line"><span class="string">descriptor: ([Ljava/lang/String;)V</span></span><br><span class="line"><span class="string">              flags: ACC_PUBLIC, ACC_STATIC</span></span><br><span class="line"><span class="string">              Code:</span></span><br><span class="line"><span class="string">              stack=2, locals=3, args_size=1</span></span><br><span class="line"><span class="string">              0: new #2 // class java/util/ArrayList</span></span><br><span class="line"><span class="string">              3: dup</span></span><br><span class="line"><span class="string">              4: invokespecial #3 // Method java/util/ArrayList.&quot;</span> &lt;init&gt;<span class="string">&quot;:()V</span></span><br><span class="line"><span class="string">              7: astore_1</span></span><br><span class="line"><span class="string">              8: aload_1</span></span><br><span class="line"><span class="string">              9: bipush 10</span></span><br><span class="line"><span class="string">              11: invokestatic #4 // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span></span><br><span class="line"><span class="string">              14: invokeinterface #5, 2 // InterfaceMethodjava/util/List.add:(Ljava/lang/Object;)Z --&gt; 不管你是 String Integer 泛型擦除统一视为 Object</span></span><br><span class="line"><span class="string">              19: pop</span></span><br><span class="line"><span class="string">              20: aload_1</span></span><br><span class="line"><span class="string">              21: iconst_0</span></span><br><span class="line"><span class="string">              22: invokeinterface #6, 2 // InterfaceMethodjava/util/List.get:(I)Ljava/lang/Object;</span></span><br><span class="line"><span class="string">              27: checkcast #7 // class java/lang/Integer --&gt; 将 Object 强制类型转换 检查构建类型</span></span><br><span class="line"><span class="string">              30: astore_2</span></span><br><span class="line"><span class="string">              31: return</span></span><br><span class="line"><span class="string">              LineNumberTable:</span></span><br><span class="line"><span class="string">              line 8: 0</span></span><br><span class="line"><span class="string">              line 9: 8</span></span><br><span class="line"><span class="string">              line 10: 20</span></span><br><span class="line"><span class="string">              line 11: 31</span></span><br><span class="line"><span class="string">              LocalVariableTable: // 局部变量类型表</span></span><br><span class="line"><span class="string">              Start Length Slot Name Signature</span></span><br><span class="line"><span class="string">              0 32 0 args [Ljava/lang/String;</span></span><br><span class="line"><span class="string">                           8 24 1 list Ljava/util/List;</span></span><br><span class="line"><span class="string">                           LocalVariableTypeTable:</span></span><br><span class="line"><span class="string">                           Start Length Slot Name Signature</span></span><br><span class="line"><span class="string">                           8 24 1 list Ljava/util/List&lt;Ljava/lang/Integer;&gt;;	// 在局部变量类型表中，泛型信息任然被保留，不能通过反射直接获取，只能通过方法的参数和返回值上通过反射 get 泛型信息才能获取</span></span><br></pre></td></tr></table></figure>

<p>使用反射，仍然能够获得这些信息：（<strong>泛型反射</strong>）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Set&lt;Integer&gt; <span class="title function_">test</span><span class="params">(List&lt;String&gt; list, Map&lt;Integer, Object&gt; map)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">test</span> <span class="operator">=</span> Candy3.class.getMethod(<span class="string">&quot;test&quot;</span>, List.class, Map.class);</span><br><span class="line">Type[] types = test.getGenericParameterTypes();	<span class="comment">// 得到泛型参数的类型信息</span></span><br><span class="line"><span class="keyword">for</span> (Type type : types) &#123;</span><br><span class="line">    <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;	<span class="comment">// 检查是否是泛型类型，判断不是原始类型 -&gt; 转换成参数化类型</span></span><br><span class="line">        <span class="type">ParameterizedType</span> <span class="variable">parameterizedType</span> <span class="operator">=</span> (ParameterizedType) type;</span><br><span class="line">        System.out.println(<span class="string">&quot;原始类型 - &quot;</span> + parameterizedType.getRawType());	<span class="comment">// 原始类型</span></span><br><span class="line">        Type[] arguments = parameterizedType.getActualTypeArguments();	<span class="comment">// 遍历转换</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arguments.length; i++) &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;泛型参数[%d] - %s\n&quot;</span>, i, arguments[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">原始类型 - interface java.util.List</span><br><span class="line">泛型参数[0] - class java.lang.String</span><br><span class="line">原始类型 - interface java.util.Map</span><br><span class="line">泛型参数[0] - class java.lang.Integer</span><br><span class="line">泛型参数[1] - class java.lang.Object</span><br></pre></td></tr></table></figure>



<h4 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h4><p>可变参数也是 <strong>JDK 5</strong> 开始加入的新特性：</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">(String... args)</span> &#123;</span><br><span class="line">        String[] array = args; <span class="comment">// 直接赋值</span></span><br><span class="line">        System.out.println(array);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        foo(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可变参数 <code>String... args</code> 其实是一个 <code>String[] args</code> ，从代码中的赋值语句中就可以看出来。 </p>
<p><strong>同样 java 编译器会在编译期间将上述代码变换为：</strong>&#x3D;&#x3D;<strong>（Java编译器根据<code>实参的数量</code>，将可变参数转换成数组）</strong>&#x3D;&#x3D;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String[] array = args; <span class="comment">// 直接赋值</span></span><br><span class="line">        System.out.println(array);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        foo(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意 </p>
<p>如果调用了 <code>foo()</code> 则等价代码为 <code>foo(new String[]&#123;&#125;)</code> ，创建了一个空的数组，而不会传递 <code>null</code> 进去</p>
</blockquote>
<h4 id="foreach-循环"><a href="#foreach-循环" class="headerlink" title="foreach 循环"></a>foreach 循环</h4><p>仍是 <strong>JDK 5</strong> 开始引入的语法糖，数组的循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy5_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] array = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;; <span class="comment">// 数组赋初值的简化写法也是语法糖哦</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> e : array) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会被编译器转换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy5_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Candy5_1</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] array = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; array.length; ++i) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">e</span> <span class="operator">=</span> array[i];</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而集合的循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy5_2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">for</span> (Integer i : list) &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际被编译器转换为对<strong>迭代器</strong>的调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy5_2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Candy5_2</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">iter</span> <span class="operator">=</span> list.iterator();</span><br><span class="line">        <span class="keyword">while</span>(iter.hasNext()) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">e</span> <span class="operator">=</span> (Integer)iter.next();</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意 </p>
<p>foreach 循环写法，能够配合数组，以及所有实现了 <strong>Iterable</strong> 接口的集合类一起使用，其中 <strong>Iterable</strong> 用来获取集合的迭代器（ <strong>Iterator</strong> ）</p>
</blockquote>
<h4 id="switch-字符串"><a href="#switch-字符串" class="headerlink" title="switch 字符串"></a>switch 字符串</h4><p>从 <strong>JDK 7</strong> 开始，switch 可以作用于字符串和枚举类，这个功能其实也是语法糖，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy6_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">choose</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (str) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;hello&quot;</span>: &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;h&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;world&quot;</span>: &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;w&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong></p>
<p>switch 配合 String 和枚举使用时，<strong>变量不能为null</strong>，原因分析完语法糖转换后的代码应当自然清楚</p>
</blockquote>
<p>会被编译器转换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy6_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Candy6_1</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">choose</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">x</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">switch</span>(str.hashCode()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">99162322</span>: <span class="comment">// hello 的 hashCode</span></span><br><span class="line">                <span class="keyword">if</span> (str.equals(<span class="string">&quot;hello&quot;</span>)) &#123;</span><br><span class="line">                    x = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">113318802</span>: <span class="comment">// world 的 hashCode</span></span><br><span class="line">                <span class="keyword">if</span> (str.equals(<span class="string">&quot;world&quot;</span>)) &#123;</span><br><span class="line">                    x = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span>(x) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                System.out.println(<span class="string">&quot;h&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                System.out.println(<span class="string">&quot;w&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可以看到，执行了两遍 switch，第一遍是根据字符串的 hashCode 和 equals 将字符串的转换为相应 byte 类型，第二遍才是利用 byte 执行进行比较。</strong></p>
<p>为什么第一遍时必须既比较 hashCode，又利用 equals 比较呢？<strong>hashCode 是为了提高效率</strong>，减少可能的比较；而 <strong>equals 是为了防止 hashCode 冲突</strong>，例如 <em>BM</em> 和 <em>C.</em> 这两个字符串的hashCode值都是 <em>2123</em> ，如果有如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy6_2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">choose</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (str) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;BM&quot;</span>: &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;h&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;C.&quot;</span>: &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;w&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会被编译器转换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy6_2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Candy6_2</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">choose</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">x</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">switch</span>(str.hashCode()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2123</span>: <span class="comment">// hashCode 值可能相同，需要进一步用 equals 比较</span></span><br><span class="line">                <span class="keyword">if</span> (str.equals(<span class="string">&quot;C.&quot;</span>)) &#123;</span><br><span class="line">                    x = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (str.equals(<span class="string">&quot;BM&quot;</span>)) &#123;</span><br><span class="line">                    x = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">switch</span>(x) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                        System.out.println(<span class="string">&quot;h&quot;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                        System.out.println(<span class="string">&quot;w&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="switch-枚举"><a href="#switch-枚举" class="headerlink" title="switch 枚举"></a>switch 枚举</h4><p>switch 枚举的例子，原始代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Sex</span> &#123;</span><br><span class="line">    MALE, FEMALE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">(Sex sex)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (sex) &#123;</span><br><span class="line">            <span class="keyword">case</span> MALE:</span><br><span class="line">                System.out.println(<span class="string">&quot;男&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FEMALE:</span><br><span class="line">                System.out.println(<span class="string">&quot;女&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>转换后代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy7</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 定义一个合成类（仅 jvm 使用，对我们不可见，静态内部类）</span></span><br><span class="line"><span class="comment">    * 用来映射枚举的 ordinal 与数组元素的关系</span></span><br><span class="line"><span class="comment">    * 枚举的 ordinal 表示枚举对象的序号，从 0 开始</span></span><br><span class="line"><span class="comment">    * 即 MALE 的 ordinal()=0，FEMALE 的 ordinal()=1</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">$MAP</span> &#123;</span><br><span class="line">        <span class="comment">// 数组大小即为枚举元素个数，里面存储case用来对比的数字</span></span><br><span class="line">        <span class="keyword">static</span> <span class="type">int</span>[] map = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            map[Sex.MALE.ordinal()] = <span class="number">1</span>;</span><br><span class="line">            map[Sex.FEMALE.ordinal()] = <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">(Sex sex)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> $MAP.map[sex.ordinal()];</span><br><span class="line">        <span class="keyword">switch</span> (x) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                System.out.println(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                System.out.println(<span class="string">&quot;女&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="枚举类"><a href="#枚举类" class="headerlink" title="枚举类"></a>枚举类</h4><p><strong>JDK 7</strong> 新增了枚举类，以前面的性别枚举为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Sex</span> &#123;</span><br><span class="line">    MALE, FEMALE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>转换后代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Sex</span> <span class="keyword">extends</span> <span class="title class_">Enum</span>&lt;Sex&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex MALE;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex FEMALE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex[] $VALUES;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        MALE = <span class="keyword">new</span> <span class="title class_">Sex</span>(<span class="string">&quot;MALE&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        FEMALE = <span class="keyword">new</span> <span class="title class_">Sex</span>(<span class="string">&quot;FEMALE&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        $VALUES = <span class="keyword">new</span> <span class="title class_">Sex</span>[]&#123;MALE, FEMALE&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Sole constructor. Programmers cannot invoke this constructor.</span></span><br><span class="line"><span class="comment">    * It is for use by code emitted by the compiler in response to</span></span><br><span class="line"><span class="comment">    * enum type declarations.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> name - The name of this enum constant, which is the identifier</span></span><br><span class="line"><span class="comment">    * used to declare it.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ordinal - The ordinal of this enumeration constant (its position</span></span><br><span class="line"><span class="comment">    * in the enum declaration, where the initial constant is</span></span><br><span class="line"><span class="comment">    assigned</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Sex</span><span class="params">(String name, <span class="type">int</span> ordinal)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name, ordinal);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Sex[] values() &#123;</span><br><span class="line">        <span class="keyword">return</span> $VALUES.clone();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Sex <span class="title function_">valueOf</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Enum.valueOf(Sex.class, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="try-with-resources"><a href="#try-with-resources" class="headerlink" title="try-with-resources"></a>try-with-resources</h4><p><strong>JDK 7</strong> 开始新增了对需要关闭的资源处理的特殊语法 <code>try-with-resources</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>(资源变量 = 创建资源对象)&#123;</span><br><span class="line">    </span><br><span class="line">&#125; <span class="keyword">catch</span>( ) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中资源对象需要实现 <strong>AutoCloseable</strong> 接口，例如 <strong>InputStream</strong> 、 <strong>OutputStream</strong> 、 <strong>Connection</strong> 、 <strong>Statement</strong> 、 <strong>ResultSet</strong> 等接口都实现了 <strong>AutoCloseable</strong> ，使用 <strong>try-withresources</strong> 可以不用写 <strong>finally</strong> 语句块，编译器会帮助生成关闭资源代码，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy9</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;d:\\1.txt&quot;</span>)) &#123;</span><br><span class="line">            System.out.println(is);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会被转换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy9</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Candy9</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;d:\\1.txt&quot;</span>);</span><br><span class="line">            <span class="type">Throwable</span> <span class="variable">t</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(is);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e1) &#123;</span><br><span class="line">                <span class="comment">// t 是我们代码出现的异常</span></span><br><span class="line">                t = e1;</span><br><span class="line">                <span class="keyword">throw</span> e1;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 判断了资源不为空</span></span><br><span class="line">                <span class="keyword">if</span> (is != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果我们代码有异常</span></span><br><span class="line">                    <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            is.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable e2) &#123;</span><br><span class="line">                            <span class="comment">// 如果 close 出现异常，作为被压制异常添加</span></span><br><span class="line">                            t.addSuppressed(e2);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 如果我们代码没有异常，close 出现的异常就是最后 catch 块中的 e</span></span><br><span class="line">                        is.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为什么要设计一个 <code>addSuppressed(Throwable e)</code> （添加被<strong>压制异常</strong>）的方法呢？是为了防止<strong>异常信息的丢失</strong>（想想 <strong>try-with-resources</strong> 生成的 <strong>fianlly</strong> 中如果抛出了异常）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">MyResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyResource</span>()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyResource</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;close 异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ArithmeticException: / by zero</span><br><span class="line">    at test.Test6.main(Test6.java:7)</span><br><span class="line">    Suppressed: java.lang.Exception: close 异常</span><br><span class="line">        at test.MyResource.close(Test6.java:18)</span><br><span class="line">        at test.Test6.main(Test6.java:6)</span><br></pre></td></tr></table></figure>

<p>如以上代码所示，两个异常信息都不会丢。<strong>异常丢失见上文</strong></p>
<h4 id="方法重写时的桥接方法"><a href="#方法重写时的桥接方法" class="headerlink" title="方法重写时的桥接方法"></a>方法重写时的桥接方法</h4><p>方法重写时对返回值分两种情况：</p>
<ul>
<li>父子类的<strong>返回值完全一致</strong> </li>
<li><strong>子类返回值可以是父类返回值的子类</strong>（比较绕口，见下面的例子）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Number <span class="title function_">m</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// 子类 m 方法的返回值是 Integer 是父类 m 方法返回值 Number 的子类</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">m</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于子类，java 编译器会做如下处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">m</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 此方法才是真正重写了父类 public Number m() 方法</span></span><br><span class="line">    <span class="keyword">public</span> synthetic bridge Number <span class="title function_">m</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 调用 public Integer m()</span></span><br><span class="line">        <span class="keyword">return</span> m();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>其中<strong>桥接方法比较特殊</strong>，仅对 java 虚拟机可见，并且与原来的 public Integer m() 没有命名冲突，可以用下面<strong>反射代码来验证</strong></em>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Method m : B.class.getDeclaredMethods()) &#123;</span><br><span class="line">    System.out.println(m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> java.lang.Integer test.candy.B.m()</span><br><span class="line"><span class="keyword">public</span> java.lang.Number test.candy.B.m()</span><br></pre></td></tr></table></figure>



<h4 id="匿名内部类"><a href="#匿名内部类" class="headerlink" title="匿名内部类"></a>匿名内部类</h4><p>源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy11</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>转换后代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 额外生成的类</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Candy11$1</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    Candy11$<span class="number">1</span>() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy11</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Candy11$1</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>匿名内部类会生成一个额外的类</strong></p>
<p>引用局部变量的匿名内部类，源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy11</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;ok:&quot;</span> + x);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>转换后代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 额外生成的类</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Candy11$1</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="type">int</span> val$x;	<span class="comment">// 多一个属性存储，不用再调外面的局部变量</span></span><br><span class="line">    Candy11$<span class="number">1</span>(<span class="type">int</span> x) &#123;</span><br><span class="line">        <span class="built_in">this</span>.val$x = x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok:&quot;</span> + <span class="built_in">this</span>.val$x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Candy11</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Candy11$1</span>(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong></p>
<p>这同时解释了为什么匿名内部类引用局部变量时，局部变量必须是 <strong>final</strong> 的：因为在创建 <strong>Candy11$1</strong> 对象时，将 x 的值赋值给了 <strong>Candy11$1</strong> 对象的 <strong>val$x</strong> 属性，所以 x 不应该再发生变化了，如果变化，那么 <strong>val$x</strong> 属性没有机会再跟着一起变化 -&gt; &#x3D;&#x3D;保证 <strong>匿名内部类中的属性</strong> 与 <strong>外部传递的局部变量</strong> 必须<strong>保证数据一致性</strong>&#x3D;&#x3D;</p>
</blockquote>
<h2 id="5-类加载"><a href="#5-类加载" class="headerlink" title="5. 类加载"></a>5. 类加载</h2><h3 id="类加载阶段"><a href="#类加载阶段" class="headerlink" title="类加载阶段"></a>类加载阶段</h3><p><strong>从大方面将可以将类加载分为三个阶段</strong></p>
<ol>
<li>加载</li>
<li>链接</li>
<li>初始化</li>
</ol>
<h4 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h4><ul>
<li><strong>将类的字节码载入方法区中</strong>，内部采用 <strong>C++</strong> 的数据结构 -&gt;  <strong>instanceKlass</strong> 描述 java 类( java 不能直接访问 instanceKlass 需要经过转换的过程 )，它的重要 field 有：<ul>
<li><strong>_java_mirror</strong> 即 java 的类镜像，（<em>C++对象 <u>-类对象</u>与Java对象之间的桥梁</em>）例如对 String 来说，就是 String.class，作用是把 klass 暴露给 java 使用</li>
<li><strong>_super</strong> 即父类 </li>
<li><strong>_fields</strong> 即成员变量 </li>
<li><strong>_methods</strong> 即方法 </li>
<li><strong>_constants</strong> 即常量池 </li>
<li><strong>_class_loader</strong> 即类加载器 </li>
<li><strong>_vtable</strong> 虚方法表 </li>
<li><strong>_itable</strong> 接口方法表</li>
</ul>
</li>
<li>如果这个类还有父类没有加载，<strong>先加载父类</strong></li>
<li><strong>加载和链接可能是交替运行</strong>的</li>
</ul>
<blockquote>
<p><strong>注意</strong></p>
<ul>
<li><strong>instanceKlass</strong> 这样的<strong>【元数据】是存储在方法区（1.8 后的元空间内）</strong>，但 <strong>_java_mirror</strong> 是存储在<strong>堆</strong>中</li>
<li>可以通过前面介绍的 <u>HSDB</u> 工具查看</li>
</ul>
</blockquote>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130161924281.png" alt="image-20230130161924281" style="zoom:80%;margin-left:0" />



<h4 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h4><h5 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h5><p><strong>验证类是否符合 JVM规范</strong>，&#x3D;&#x3D;安全性检查&#x3D;&#x3D; </p>
<p>用 UE 等支持二进制的编辑器修改 HelloWorld.class 的魔数，在控制台运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">E:\git\jvm\out\production\jvm&gt;java cn.itcast.jvm.t5.HelloWorld</span><br><span class="line">Error: A JNI error has occurred, please check your installation and try again</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.ClassFormatError: Incompatible magic value</span><br><span class="line">3405691578 in class file cn/itcast/jvm/t5/HelloWorld</span><br><span class="line">        at java.lang.ClassLoader.defineClass1(Native Method)</span><br><span class="line">        at java.lang.ClassLoader.defineClass(ClassLoader.java:763)</span><br><span class="line">        at</span><br><span class="line">java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142)</span><br><span class="line">        at java.net.URLClassLoader.defineClass(URLClassLoader.java:467)</span><br><span class="line">        at java.net.URLClassLoader.access$100(URLClassLoader.java:73)</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:368)</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:362)</span><br><span class="line">        at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:361)</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:424)</span><br><span class="line">        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331)</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:357)</span><br><span class="line">        at sun.launcher.LauncherHelper.checkAndLoadMain(LauncherHelper.java:495)</span><br></pre></td></tr></table></figure>



<h5 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h5><p>为 static 变量<strong>分配空间</strong>，<strong>设置默认值</strong></p>
<ul>
<li>static 变量在 JDK 7 之前<strong>存储于 instanceKlass 末尾</strong>，从 JDK 7 开始，<strong>存储于 _java_mirror 末尾</strong> </li>
<li>static 变量分配空间和赋值是两个步骤，分配空间在准备阶段完成，赋值在初始化阶段完成 </li>
<li>如果 <strong>static 变量是 final 的基本类型</strong>，以及<strong>字符串常量</strong>，那么<strong>编译阶段值就确定</strong>了，<strong>赋值在准备阶段完成</strong></li>
<li>如果 <strong>static 变量是 final</strong> 的，但**<u>属于引用类型</u><strong>，那么</strong><u>赋值就必须在初始化阶段</u>**完成</li>
</ul>
<p>&#x3D;&#x3D;<u>以上信息通过反编译字节码文件查看 助记码 就能很清晰的看到</u>&#x3D;&#x3D;</p>
<p><strong>所以分配空间与赋值是两个不同的动作</strong></p>
<h5 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h5><p>将常量池中的<strong>符号引用</strong>解析为<strong>直接引用</strong></p>
<p><em>类加载都是懒惰式的，没有用到就不会加载</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 解析的含义</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Load2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException,</span><br><span class="line">    IOException &#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classloader</span> <span class="operator">=</span> Load2.class.getClassLoader();</span><br><span class="line">        <span class="comment">// loadClass 方法不会导致类的解析和初始化</span></span><br><span class="line">        Class&lt;?&gt; c = classloader.loadClass(<span class="string">&quot;cn.itcast.jvm.t3.load.C&quot;</span>);</span><br><span class="line">        <span class="comment">// new C();</span></span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> &#123;</span><br><span class="line">    <span class="type">D</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">D</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">D</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过查看进程 id -&gt; 查看对象，如果不调用 <code>new C();</code> 只能看到，只加载了 <strong>类C</strong>（*<u>并没有触发解析</u>*），没有加载 <strong>类D</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131112923075.png" alt="image-20230131112923075" style="zoom:80%;margin-left:0" />

<p><strong>类D 是一个未经解析的类，仅仅是常量池中的一个符号，并没有被解析引用内存中哪个位置</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131113343984.png" alt="image-20230131113343984" style="zoom:80%;margin-left:0" />



<p><strong>触发解析，类D 被加载的情况</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 解析的含义</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Load2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException,</span><br><span class="line">    IOException &#123;</span><br><span class="line">        <span class="comment">// ClassLoader classloader = Load2.class.getClassLoader();</span></span><br><span class="line">        <span class="comment">// loadClass 方法不会导致类的解析和初始化</span></span><br><span class="line">        <span class="comment">// Class&lt;?&gt; c = classloader.loadClass(&quot;cn.itcast.jvm.t3.load.C&quot;);</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">C</span>();</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> &#123;</span><br><span class="line">    <span class="type">D</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">D</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">D</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可以发现类C常量池中的类D，已经被解析到内存中的地址</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131113644275.png" alt="image-20230131113644275" style="zoom:80%;margin-left:0" />





<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><h5 id="lt-cinit-gt-V-方法"><a href="#lt-cinit-gt-V-方法" class="headerlink" title="&lt;cinit&gt;()V 方法"></a><code>&lt;cinit&gt;()V</code> 方法</h5><p>初始化即调用 <code>&lt;cinit&gt;()V</code> ，虚拟机会保证这个类的『构造方法』的线程安全</p>
<h5 id="发生的时机"><a href="#发生的时机" class="headerlink" title="发生的时机"></a>发生的时机</h5><p>概括得说，类初始化是【<strong>懒惰的</strong>】</p>
<ul>
<li>main 方法所在的类，总会被<strong>首先初始化</strong> </li>
<li><strong>首次访问</strong>这个类的<strong>静态变量或静态方法</strong>时 </li>
<li><strong>子类初始化</strong>，如果父类还没初始化，会<strong>引发</strong> </li>
<li><strong>子类访问父类</strong>的<strong>静态变量</strong>，<strong>只会触发父类的初始化</strong> </li>
<li>Class.forName -&gt; 反射触发</li>
<li>new 会导致<strong>初始化</strong></li>
</ul>
<p>不会导致类初始化的情况</p>
<ul>
<li><strong>访问类的 static final 静态常量（基本类型和字符串）不会触发初始化</strong> -&gt; 类链接准备阶段完成</li>
<li>类对象.class 不会触发初始化 -&gt; 类加载阶段</li>
<li>创建该类的数组不会触发初始化 </li>
<li>类加载器的 loadClass 方法 </li>
<li>Class.forName 的参数 2 为 false 时</li>
</ul>
<p><strong>实验证明</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;a init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">double</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">5.0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">c</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;b init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>验证（实验时请先全部注释，每次只执行其中一个）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Load3</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;main init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;</span><br><span class="line"><span class="comment">//        // 1. 静态常量不会触发初始化</span></span><br><span class="line"><span class="comment">//        System.out.println(B.b);</span></span><br><span class="line"><span class="comment">//        // 2. 类对象.class 不会触发初始化</span></span><br><span class="line"><span class="comment">//        System.out.println(B.class);</span></span><br><span class="line"><span class="comment">//        // 3. 创建该类的数组不会触发初始化</span></span><br><span class="line"><span class="comment">//        System.out.println(new B[0]);</span></span><br><span class="line">        <span class="comment">// 4. 不会初始化类 B，但会加载 B、A</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">        cl.loadClass(<span class="string">&quot;cn.itcast.jvm.t3.load.B&quot;</span>);</span><br><span class="line"><span class="comment">//        // 5. 不会初始化类 B，但会加载 B、A</span></span><br><span class="line"><span class="comment">//        ClassLoader c2 = Thread.currentThread().getContextClassLoader();</span></span><br><span class="line"><span class="comment">//        Class.forName(&quot;cn.itcast.jvm.t3.load.B&quot;, false, c2);</span></span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        // 1. 首次访问这个类的静态变量或静态方法时</span></span><br><span class="line"><span class="comment">//        System.out.println(A.a);</span></span><br><span class="line"><span class="comment">//        // 2. 子类初始化，如果父类还没初始化，会引发</span></span><br><span class="line"><span class="comment">//        System.out.println(B.c);</span></span><br><span class="line"><span class="comment">//        // 3. 子类访问父类静态变量，只触发父类初始化</span></span><br><span class="line"><span class="comment">//        System.out.println(B.a);</span></span><br><span class="line"><span class="comment">//        // 4. 会初始化类 B，并先初始化类 A</span></span><br><span class="line"><span class="comment">//        Class.forName(&quot;cn.itcast.jvm.t3.load.B&quot;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;a init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">double</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">5.0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">c</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;b init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="练习-字节码分析"><a href="#练习-字节码分析" class="headerlink" title="练习 - 字节码分析"></a>练习 - 字节码分析</h4><p>从字节码分析，使用 a，b，c 这三个常量是否会导致 E 初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Load4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(E.a);	<span class="comment">// 不会</span></span><br><span class="line">        System.out.println(E.b);	<span class="comment">// 不会</span></span><br><span class="line">        System.out.println(E.c);	<span class="comment">// 会 -&gt; 包装类型（引用类型）</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">E</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">b</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init E&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>典型应用 - 完成懒惰初始化单例模式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="comment">// 内部类中保存单例 --同样保证了线程安全</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LazyHolder</span> &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Singleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 第一次调用 getInstance 方法，才会导致内部类加载和初始化其静态成员</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LazyHolder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上的实现特点是：</p>
<ul>
<li><strong>懒惰实例化</strong></li>
<li><strong>初始化时的线程安全是有保障的</strong></li>
</ul>
<h3 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h3><p>以 JDK 8 为例：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>加载哪的类</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Bootstrap ClassLoader</strong></td>
<td>JAVA_HOME&#x2F;jre&#x2F;lib</td>
<td>无法直接访问</td>
</tr>
<tr>
<td><strong>Extension ClassLoader</strong></td>
<td>JAVA_HOME&#x2F;jre&#x2F;lib&#x2F;ext</td>
<td>上级为 Bootstrap，显示为 null</td>
</tr>
<tr>
<td><strong>Application ClassLoader</strong></td>
<td>classpath</td>
<td>上级为 Extension</td>
</tr>
<tr>
<td><strong>自定义类加载器</strong></td>
<td>自定义</td>
<td>上级为 Application</td>
</tr>
</tbody></table>
<p><strong><u>类加载器层级关系，在加载类之前，会&#x3D;&#x3D;向上级询问是否已经加载过该类&#x3D;&#x3D;，如果没有，还会依次再向上询问，直到都没有加载，才会去加载这个类</u></strong></p>
<p><em>–双亲委派类加载模式</em></p>
<p><strong>Extension ClassLoader</strong> 在 <code>getParents()</code> 的时候显示 null，因为 <strong>Bootstrap ClassLoader</strong> <u><em>不是由 Java 实现的，而是由 C++ 实现的</em></u></p>
<h4 id="启动类加载器"><a href="#启动类加载器" class="headerlink" title="启动类加载器"></a>启动类加载器</h4><p><strong>Bootstrap ClassLoader</strong> 通常都是加载 <u><em>JAVA_HOME&#x2F;jre&#x2F;lib</em></u> 目录下的类，但是也可以通过<strong>改变 JVM 参数来特殊加载我们自定义的类</strong></p>
<p>用 Bootstrap 类加载器加载类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">F</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;bootstrap F init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Load5_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;cn.itcast.jvm.t3.load.F&quot;</span>);</span><br><span class="line">        System.out.println(aClass.getClassLoader()); <span class="comment">// AppClassLoader  ExtClassLoader</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">E:\git\jvm\out\production\jvm&gt;java -Xbootclasspath/a:. cn.itcast.jvm.t3.load.Load5_1</span><br><span class="line"><span class="comment"># -Xbootclasspath/a:. 追加当前目录启动类加载器加载路径</span></span><br><span class="line">bootstrap F init</span><br><span class="line">null</span><br></pre></td></tr></table></figure>

<ul>
<li>-Xbootclasspath 表示设置 bootclasspath </li>
<li>其中 &#x2F;a:. 表示将当前目录追加至 bootclasspath 之后 </li>
<li>可以用这个办法替换核心类<ul>
<li><code>java -Xbootclasspath:&lt;new bootclasspath&gt;</code> 新路径</li>
<li><code>java -Xbootclasspath/a:&lt;追加路径&gt;</code> 后追加</li>
<li><code>java -Xbootclasspath/p:&lt;追加路径&gt;</code> 前追加，前追加可以替换调核心类的加载。<strong>例如通过前追加替换 String Class 类</strong></li>
</ul>
</li>
</ul>
<h4 id="扩展类加载器"><a href="#扩展类加载器" class="headerlink" title="扩展类加载器"></a>扩展类加载器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">G</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;classpath G init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示 扩展类加载器</span></span><br><span class="line"><span class="comment"> * 在 C:\Program Files\Java\jdk1.8.0_91 下有一个 my.jar</span></span><br><span class="line"><span class="comment"> * 里面也有一个 G 的类，观察到底是哪个类被加载了</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Load5_2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;cn.itcast.jvm.t3.load.G&quot;</span>);</span><br><span class="line">        System.out.println(aClass.getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">classpath G init</span><br><span class="line">sun.misc.Launcher<span class="variable">$AppClassLoader</span>@18b4aac2	<span class="comment"># 默认在 classpath 路径下</span></span><br></pre></td></tr></table></figure>

<p>写一个同名的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">G</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ext G init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打个 jar 包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">E:\git\jvm\out\production\jvm&gt;jar -cvf my.jar cn/itcast/jvm/t3/load/G.class</span><br><span class="line">已添加清单</span><br><span class="line">正在添加: cn/itcast/jvm/t3/load/G.class(输入 = 481) (输出 = 322)(压缩了 33%)</span><br></pre></td></tr></table></figure>

<p>将 jar 包拷贝到 JAVA_HOME&#x2F;jre&#x2F;lib&#x2F;ext <u><em>classpath中也存放一个 G</em></u></p>
<p>重新执行 Load5_2 </p>
<p>输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ext G init</span><br><span class="line">sun.misc.Launcher<span class="variable">$ExtClassLoader</span>@29453f44	<span class="comment"># 验证了扩展类加载器，同样验证了 双亲委派</span></span><br></pre></td></tr></table></figure>



<h4 id="双亲委派模式"><a href="#双亲委派模式" class="headerlink" title="双亲委派模式"></a>双亲委派模式</h4><p>所谓的双亲委派，就是指调用<strong>类加载器的 loadClass 方法时，查找类的规则</strong></p>
<blockquote>
<p><strong>注意</strong></p>
<p>这里的双亲，<strong>翻译为上级似乎更为合适</strong>，因为它们并没有继承关系</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve)</span><br><span class="line">    <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">        <span class="comment">// 1. 检查该类是否已经加载</span></span><br><span class="line">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">t0</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 2. 有上级的话，委派上级 loadClass</span></span><br><span class="line">                    c = parent.loadClass(name, <span class="literal">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 3. 如果没有上级了（ExtClassLoader），则委派</span></span><br><span class="line">                    <span class="type">BootstrapClassLoader</span></span><br><span class="line">                        <span class="variable">c</span> <span class="operator">=</span> findBootstrapClassOrNull(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">t1</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">                <span class="comment">// 4. 每一层找不到，调用 findClass 方法（每个类加载器自己扩展）来加载</span></span><br><span class="line">                c = findClass(name);</span><br><span class="line">                <span class="comment">// 5. 记录耗时</span></span><br><span class="line">                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">            resolveClass(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Load5_3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        Class&lt;?&gt; aClass = Load5_3.class.getClassLoader()</span><br><span class="line">            .loadClass(<span class="string">&quot;cn.itcast.jvm.t3.load.H&quot;</span>);</span><br><span class="line">        System.out.println(aClass.getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行流程为：</p>
<ol>
<li><p><code>sun.misc.Launcher$AppClassLoader</code> &#x2F;&#x2F;1 处， 开始查看已加载的类，结果没有</p>
</li>
<li><p><code>sun.misc.Launcher$AppClassLoader</code> &#x2F;&#x2F; 2 处，委派上级</p>
<p><code>sun.misc.Launcher$ExtClassLoader.loadClass()</code></p>
</li>
<li><p><code>sun.misc.Launcher$ExtClassLoader</code> &#x2F;&#x2F; 1 处，查看已加载的类，结果没有</p>
</li>
<li><p><code>sun.misc.Launcher$ExtClassLoader</code> &#x2F;&#x2F; 3 处，没有上级了，则委派 <code>BootstrapClassLoader</code> 查找</p>
</li>
<li><p><code>BootstrapClassLoader</code> 是在 <strong>JAVA_HOME&#x2F;jre&#x2F;lib</strong> 下找 H 这个类，显然没有</p>
</li>
<li><p><code>sun.misc.Launcher$ExtClassLoader</code> &#x2F;&#x2F; 4 处，调用自己的 findClass 方法，是在</p>
<p><strong>JAVA_HOME&#x2F;jre&#x2F;lib&#x2F;ext</strong> 下找 H 这个类，显然没有，回到 <code>sun.misc.Launcher$AppClassLoader</code> 的 &#x2F;&#x2F; 2 处</p>
</li>
<li><p>继续执行到 <code>sun.misc.Launcher$AppClassLoader</code> &#x2F;&#x2F; 4 处，调用它自己的 <strong>findClass</strong> 方法，在 <strong>classpath</strong> 下查找，找到了</p>
</li>
</ol>
<h4 id="线程上下文类加载器"><a href="#线程上下文类加载器" class="headerlink" title="线程上下文类加载器"></a>线程上下文类加载器</h4><p>在使用 <strong>JDBC</strong> 时，都需要加载 <strong>Driver</strong> 驱动，不知道你注意到没有，不写 <code>Class.forName(&quot;com.mysql.jdbc.Driver&quot;)</code> 也是可以让 <code>com.mysql.jdbc.Driver</code> 正确加载，你知道是怎么做的吗？</p>
<p>追踪一下源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DriverManager</span> &#123;</span><br><span class="line">    <span class="comment">// 注册驱动的集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> CopyOnWriteArrayList&lt;DriverInfo&gt; registeredDrivers</span><br><span class="line">        = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 初始化驱动</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        loadInitialDrivers();</span><br><span class="line">        println(<span class="string">&quot;JDBC DriverManager initialized&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>先不看别的，看看 DriverManager 的类加载器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(DriverManager.class.getClassLoader());</span><br></pre></td></tr></table></figure>

<p>打印 null，表示<strong>它的类加载器是 Bootstrap ClassLoader</strong>，会到 <u>JAVA_HOME&#x2F;jre&#x2F;lib</u> 下搜索类，但 <u>JAVA_HOME&#x2F;jre&#x2F;lib</u> 下显然没有 mysql-connector-java-5.1.47.jar 包，这样问题来了，<em>在 DriverManager 的静态代码块中，怎么能正确加载 com.mysql.jdbc.Driver 呢？</em></p>
<p>jdk在某些情况下<strong>需要打破双亲委派机制</strong>，通过调用 <strong><code>ClassLoader.getSystemClassLoader()</code> 方法 -&gt; 来调用 应用程序类加载器</strong></p>
<p>继续看 <code>loadInitialDrivers()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loadInitialDrivers</span><span class="params">()</span> &#123;</span><br><span class="line">    String drivers;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        drivers = AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;String&gt;</span><br><span class="line">                                                () &#123;</span><br><span class="line">                                                    <span class="keyword">public</span> String <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                                                        <span class="keyword">return</span> System.getProperty(<span class="string">&quot;jdbc.drivers&quot;</span>);</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        drivers = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1）使用 ServiceLoader 机制加载驱动，即 SPI</span></span><br><span class="line">    AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Void&gt;() &#123;</span><br><span class="line">        <span class="keyword">public</span> Void <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            ServiceLoader&lt;Driver&gt; loadedDrivers =</span><br><span class="line">                ServiceLoader.load(Driver.class);</span><br><span class="line">            Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(driversIterator.hasNext()) &#123;</span><br><span class="line">                    driversIterator.next();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Throwable t) &#123;</span><br><span class="line">                <span class="comment">// Do nothing</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    println(<span class="string">&quot;DriverManager.initialize: jdbc.drivers = &quot;</span> + drivers);</span><br><span class="line">    <span class="comment">// 2）使用 jdbc.drivers 定义的驱动名加载驱动</span></span><br><span class="line">    <span class="keyword">if</span> (drivers == <span class="literal">null</span> || drivers.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    String[] driversList = drivers.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">    println(<span class="string">&quot;number of Drivers:&quot;</span> + driversList.length);</span><br><span class="line">    <span class="keyword">for</span> (String aDriver : driversList) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            println(<span class="string">&quot;DriverManager.Initialize: loading &quot;</span> + aDriver);</span><br><span class="line">            <span class="comment">// 这里的 ClassLoader.getSystemClassLoader() 就是应用程序类加载器</span></span><br><span class="line">            Class.forName(aDriver, <span class="literal">true</span>,</span><br><span class="line">                          ClassLoader.getSystemClassLoader());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            println(<span class="string">&quot;DriverManager.Initialize: load failed: &quot;</span> + ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看 2）发现它<em>最后是使用 Class.forName</em> 完成类的加载和初始化，**关联的是<u>应用程序类加载器</u>**，因此可以顺利完成类加载 </p>
<p>再看 1）它就是大名鼎鼎的 <strong>Service Provider Interface （SPI）</strong> </p>
<p>约定如下，<em>在 jar 包的 META-INF&#x2F;services 包下，以接口全限定名名为文件，文件内容是实现类名称</em></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130163448952.png" alt="image-20230130163448952" style="zoom:80%;margin-left:0" />

<p>这样就可以使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ServiceLoader&lt;接口类型&gt; allImpls = ServiceLoader.load(接口类型.class);</span><br><span class="line">Iterator&lt;接口类型&gt; iter = allImpls.iterator();</span><br><span class="line"><span class="keyword">while</span>(iter.hasNext()) &#123;</span><br><span class="line">    iter.next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来得到实现类，体现的是【<strong>面向接口编程+解耦</strong>】的思想，<em>在下面一些框架中都运用了此思想：</em> </p>
<ul>
<li>JDBC </li>
<li>Servlet 初始化器 </li>
<li>Spring 容器 </li>
<li>Dubbo（对 SPI 进行了扩展）</li>
</ul>
<p>接着看 ServiceLoader.load 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; ServiceLoader&lt;S&gt; <span class="title function_">load</span><span class="params">(Class&lt;S&gt; service)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取线程上下文类加载器</span></span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="keyword">return</span> ServiceLoader.load(service, cl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>线程上下文类加载器</strong>是<em>当前线程使用的类加载器</em>，默认就是<em>应用程序类加载器</em>，它内部又是<em>由 Class.forName 调用了线程上下文类加载器完成类加载，具体代码在 ServiceLoader 的内部类 LazyIterator 中</em>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> S <span class="title function_">nextService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasNextService())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">cn</span> <span class="operator">=</span> nextName;</span><br><span class="line">    nextName = <span class="literal">null</span>;</span><br><span class="line">    Class&lt;?&gt; c = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        c = Class.forName(cn, <span class="literal">false</span>, loader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException x) &#123;</span><br><span class="line">        fail(service,</span><br><span class="line">             <span class="string">&quot;Provider &quot;</span> + cn + <span class="string">&quot; not found&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!service.isAssignableFrom(c)) &#123;</span><br><span class="line">        fail(service,</span><br><span class="line">             <span class="string">&quot;Provider &quot;</span> + cn + <span class="string">&quot; not a subtype&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">S</span> <span class="variable">p</span> <span class="operator">=</span> service.cast(c.newInstance());</span><br><span class="line">        providers.put(cn, p);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">        fail(service,</span><br><span class="line">             <span class="string">&quot;Provider &quot;</span> + cn + <span class="string">&quot; could not be instantiated&quot;</span>,</span><br><span class="line">             x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(); <span class="comment">// This cannot happen</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<strong>线程上下文类加载器</strong>，同样破坏双亲委派机制</p>
<h4 id="自定义类加载器"><a href="#自定义类加载器" class="headerlink" title="自定义类加载器"></a>自定义类加载器</h4><p>什么时候需要自定义类加载器</p>
<ol>
<li>想加载非 classpath 随意路径中的类文件 -&gt; <em>想加载任意路径下的类</em></li>
<li>都是通过接口来使用实现，希望<strong>解耦</strong>时，常用在框架设计 </li>
<li>这些类希望予以隔离（不同版本），<strong>不同应用的同名类都可以加载</strong>，不冲突，常见于 tomcat 容器</li>
</ol>
<p>实现自定义类加载器步骤：</p>
<ol>
<li><em>继承 ClassLoader 父类</em> </li>
<li><em>要遵从双亲委派机制，重写 findClass 方法</em> <ul>
<li><em>注意不是重写 loadClass 方法，否则不会走双亲委派机制</em></li>
</ul>
</li>
<li><em>读取类文件的字节码</em> </li>
<li><em>调用父类的 defineClass 方法来加载类</em> </li>
<li><em>使用者调用该类加载器的 loadClass 方法</em></li>
</ol>
<p>示例：</p>
<p>准备好两个类文件放入 E:\myclasspath，它实现了 java.util.Map 接口，可以先反编译看一下：</p>
<p><strong>两个示例</strong></p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131132216900.png" alt="image-20230131132216900" style="zoom:80%;margin-left:0" />



<p><strong>自定义类加载器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Load7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MyClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClassLoader</span>();</span><br><span class="line">        Class&lt;?&gt; c1 = classLoader.loadClass(<span class="string">&quot;MapImpl1&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; c2 = classLoader.loadClass(<span class="string">&quot;MapImpl1&quot;</span>);</span><br><span class="line">        System.out.println(c1 == c2);</span><br><span class="line"></span><br><span class="line">        <span class="type">MyClassLoader</span> <span class="variable">classLoader2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClassLoader</span>();</span><br><span class="line">        Class&lt;?&gt; c3 = classLoader2.loadClass(<span class="string">&quot;MapImpl1&quot;</span>);</span><br><span class="line">        System.out.println(c1 == c3);	<span class="comment">// 不同类加载器加载的类不同</span></span><br><span class="line"></span><br><span class="line">        c1.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// name 就是类名称</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;e:\\myclasspath\\&quot;</span> + name + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            Files.copy(Paths.get(path), os);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 得到字节数组</span></span><br><span class="line">            <span class="type">byte</span>[] bytes = os.toByteArray();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// byte[] -&gt; *.class</span></span><br><span class="line">            <span class="keyword">return</span> defineClass(name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;类文件未找到&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="运行期优化"><a href="#运行期优化" class="headerlink" title="运行期优化"></a>运行期优化</h3><h4 id="即时编译"><a href="#即时编译" class="headerlink" title="即时编译"></a>即时编译</h4><p>JIT</p>
<h5 id="分层编译"><a href="#分层编译" class="headerlink" title="分层编译"></a>分层编译</h5><p>（TieredCompilation）</p>
<p>举例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JIT1</span> &#123;</span><br><span class="line">    <span class="comment">// -XX:+PrintCompilation -XX:-DoEscapeAnalysis</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">1000</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            System.out.printf(<span class="string">&quot;%d\t%d\n&quot;</span>,i,(end - start));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">0 96426</span><br><span class="line">1 52907</span><br><span class="line">2 44800</span><br><span class="line">3 119040</span><br><span class="line">4 65280</span><br><span class="line">5 47360</span><br><span class="line">6 45226</span><br><span class="line">7 47786</span><br><span class="line">8 48640</span><br><span class="line">9 60586</span><br><span class="line">10 42667</span><br><span class="line">11 48640</span><br><span class="line">12 70400</span><br><span class="line">13 49920</span><br><span class="line">14 49493</span><br><span class="line">15 45227</span><br><span class="line">16 45653</span><br><span class="line">17 60160</span><br><span class="line">18 58880</span><br><span class="line">19 46080</span><br><span class="line">20 47787</span><br><span class="line">21 49920</span><br><span class="line">22 54187</span><br><span class="line">23 57173</span><br><span class="line">24 50346</span><br><span class="line">25 52906</span><br><span class="line">26 50346</span><br><span class="line">27 47786</span><br><span class="line">28 49920</span><br><span class="line">29 64000</span><br><span class="line">30 49067</span><br><span class="line">31 63574</span><br><span class="line">32 63147</span><br><span class="line">33 56746</span><br><span class="line">34 49494</span><br><span class="line">35 64853</span><br><span class="line">36 107520</span><br><span class="line">37 46933</span><br><span class="line">38 51627</span><br><span class="line">39 45653</span><br><span class="line">40 103680</span><br><span class="line">41 51626</span><br><span class="line">42 60160</span><br><span class="line">43 49067</span><br><span class="line">44 45653</span><br><span class="line">45 49493</span><br><span class="line">46 51626</span><br><span class="line">47 49066</span><br><span class="line">48 47360</span><br><span class="line">49 50774</span><br><span class="line">50 70827</span><br><span class="line">51 64000</span><br><span class="line">52 72107</span><br><span class="line">53 49066</span><br><span class="line">54 46080</span><br><span class="line">55 44800</span><br><span class="line">56 46507</span><br><span class="line">57 73813</span><br><span class="line">58 61013</span><br><span class="line">59 57600</span><br><span class="line">60 83200</span><br><span class="line">61 7024204</span><br><span class="line">62 49493</span><br><span class="line">63 20907</span><br><span class="line">64 20907</span><br><span class="line">65 20053</span><br><span class="line">66 20906</span><br><span class="line">67 20907</span><br><span class="line">68 21333</span><br><span class="line">69 22187</span><br><span class="line">70 20480</span><br><span class="line">71 21760</span><br><span class="line">72 19200</span><br><span class="line">73 15360</span><br><span class="line">74 18347</span><br><span class="line">75 19627</span><br><span class="line">76 17067</span><br><span class="line">77 34134</span><br><span class="line">78 19200</span><br><span class="line">79 18347</span><br><span class="line">80 17493</span><br><span class="line">81 15360</span><br><span class="line">82 18774</span><br><span class="line">83 17067</span><br><span class="line">84 21760</span><br><span class="line">85 23467</span><br><span class="line">86 17920</span><br><span class="line">87 17920</span><br><span class="line">88 18774</span><br><span class="line">89 18773</span><br><span class="line">90 19200</span><br><span class="line">91 20053</span><br><span class="line">92 18347</span><br><span class="line">93 22187</span><br><span class="line">94 17920</span><br><span class="line">95 18774</span><br><span class="line">96 19626</span><br><span class="line">97 33280</span><br><span class="line">98 20480</span><br><span class="line">99 20480</span><br><span class="line">100 18773</span><br><span class="line">101 47786</span><br><span class="line">102 17493</span><br><span class="line">103 22614</span><br><span class="line">104 64427</span><br><span class="line">105 18347</span><br><span class="line">106 19200</span><br><span class="line">107 26027</span><br><span class="line">108 21333</span><br><span class="line">109 20480</span><br><span class="line">110 24747</span><br><span class="line">111 32426</span><br><span class="line">112 21333</span><br><span class="line">113 17920</span><br><span class="line">114 17920</span><br><span class="line">115 19200</span><br><span class="line">116 18346</span><br><span class="line">117 15360</span><br><span class="line">118 24320</span><br><span class="line">119 19200</span><br><span class="line">120 20053</span><br><span class="line">121 17920</span><br><span class="line">122 18773</span><br><span class="line">123 20053</span><br><span class="line">124 18347</span><br><span class="line">125 18347</span><br><span class="line">126 22613</span><br><span class="line">127 18773</span><br><span class="line">128 19627</span><br><span class="line">129 20053</span><br><span class="line">130 20480</span><br><span class="line">131 19627</span><br><span class="line">132 20053</span><br><span class="line">133 15360</span><br><span class="line">134 136533</span><br><span class="line">135 43093</span><br><span class="line">136 853</span><br><span class="line">137 853</span><br><span class="line">138 853</span><br><span class="line">139 853</span><br><span class="line">140 854</span><br><span class="line">141 853</span><br><span class="line">142 853</span><br><span class="line">143 853</span><br><span class="line">144 853</span><br><span class="line">145 853</span><br><span class="line">146 853</span><br><span class="line">147 854</span><br><span class="line">148 853</span><br><span class="line">149 853</span><br><span class="line">150 854</span><br><span class="line">151 853</span><br><span class="line">152 853</span><br><span class="line">153 853</span><br><span class="line">154 1280</span><br><span class="line">155 853</span><br><span class="line">156 853</span><br><span class="line">157 854</span><br><span class="line">158 853</span><br><span class="line">159 853</span><br><span class="line">160 854</span><br><span class="line">161 854</span><br><span class="line">162 853</span><br><span class="line">163 854</span><br><span class="line">164 854</span><br><span class="line">165 854</span><br><span class="line">166 854</span><br><span class="line">167 853</span><br><span class="line">168 853</span><br><span class="line">169 854</span><br><span class="line">170 853</span><br><span class="line">171 853</span><br><span class="line">172 853</span><br><span class="line">173 1280</span><br><span class="line">174 853</span><br><span class="line">175 1280</span><br><span class="line">176 853</span><br><span class="line">177 854</span><br><span class="line">178 854</span><br><span class="line">179 427</span><br><span class="line">180 853</span><br><span class="line">181 854</span><br><span class="line">182 854</span><br><span class="line">183 854</span><br><span class="line">184 853</span><br><span class="line">185 853</span><br><span class="line">186 854</span><br><span class="line">187 853</span><br><span class="line">188 853</span><br><span class="line">189 854</span><br><span class="line">190 1280</span><br><span class="line">191 853</span><br><span class="line">192 853</span><br><span class="line">193 853</span><br><span class="line">194 853</span><br><span class="line">195 854</span><br><span class="line">196 853</span><br><span class="line">197 853</span><br><span class="line">198 853</span><br><span class="line">199 854</span><br></pre></td></tr></table></figure>



<p><strong>探究原因 -&gt;</strong> </p>
<p><em>JVM 将执行状态分成了 5 个层次：</em></p>
<ol>
<li>0 层，解释执行（Interpreter）-&gt; 到达一定阈值执行 编译</li>
<li>1 层，使用 C1 即时编译器编译执行（不带 profiling） </li>
<li>2 层，使用 C1 即时编译器编译执行（带基本的 profiling） </li>
<li>3 层，使用 C1 即时编译器编译执行（带完全的 profiling） </li>
<li>4 层，使用 C2 即时编译器编译执</li>
</ol>
<blockquote>
<p><strong>profiling</strong> 是指在运行过程中收集一些程序执行状态的数据，例如【<strong>方法的调用次数</strong>】，【<strong>循环的回边次数</strong>】等</p>
</blockquote>
<p>即时编译器（JIT）与解释器的区别</p>
<ul>
<li>解释器是将<strong>字节码</strong>解释为<strong>机器码</strong>，下次即使遇到相同的字节码，仍会执行重复的解释 </li>
<li><strong>JIT 是将一些字节码编译为机器码，并存入 Code Cache</strong>，下次遇到相同的代码，直接执行，无需再编译 </li>
<li>解释器是将字节码解释为针对所有平台都通用的机器码 </li>
<li><strong>JIT 会根据平台类型，生成平台特定的机器码</strong></li>
</ul>
<p>对于占据大部分的不常用的代码，我们无需耗费时间将其编译成机器码，而是采取解释执行的方式运行；另一方面，对于仅占据小部分的热点代码，我们则可以将其编译成机器码，以达到理想的运行速度。 执行效率上简单比较一下 <strong>Interpreter &lt; C1 &lt; C2</strong>，总的目标是发现<strong>热点代码</strong>（hotspot名称的由来），将其优化</p>
<p>C1 -&gt; 提升 5倍</p>
<p>C2 -&gt; 提升 10倍</p>
<p>刚才的一种优化手段称之为【逃逸分析】，发现新建的对象是否逃逸。可以使用 <code>-XX:-DoEscapeAnalysis</code> 关闭逃逸分析，再运行刚才的示例观察结果</p>
<p>简述：在C2中进行逃逸分析，发现 <code>new Object();</code> 并不会被外部引用，判断其可以逃逸，就将 <code>new Object();</code> 部分代码干脆直接替换掉</p>
<p><strong>参考资料</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/12/vm/java-hotspot-virtual-machine-performance-enhancements.html#GUID-D2E3DC58-D18B-4A6C-8167-4A1DFB4888E4">https://docs.oracle.com/en/java/javase/12/vm/java-hotspot-virtual-machine-performance-enhancements.html#GUID-D2E3DC58-D18B-4A6C-8167-4A1DFB4888E4</a></p>
<h5 id="方法内联"><a href="#方法内联" class="headerlink" title="方法内联"></a>方法内联</h5><p>（Inlining）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">square</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> i * i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(square(<span class="number">9</span>));</span><br></pre></td></tr></table></figure>

<p>如果发现 square 是<strong>热点方法，并且长度不太长</strong>时，会进行<strong>内联</strong>，所谓的内联就是把<strong>方法内代码拷贝、粘贴到调用者的位置</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="number">9</span> * <span class="number">9</span>);</span><br></pre></td></tr></table></figure>

<p>还能够进行<strong>常量折叠</strong>（constant folding）的优化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="number">81</span>);</span><br></pre></td></tr></table></figure>

<p>实验：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JIT2</span> &#123;</span><br><span class="line">        <span class="comment">// -XX:+UnlockDiagnosticVMOptions -XX:+PrintInlining （解锁隐藏参数）打印inlining 信息</span></span><br><span class="line">        <span class="comment">// -XX:CompileCommand=dontinline,*JIT2.square 禁止某个方法 inlining</span></span><br><span class="line">        <span class="comment">// -XX:+PrintCompilation 打印编译信息</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">500</span>; i++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">1000</span>; j++) &#123;</span><br><span class="line">                x = square(<span class="number">9</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            System.out.printf(<span class="string">&quot;%d\t%d\t%d\n&quot;</span>,i,x,(end - start));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">square</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> i * i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="字段优化"><a href="#字段优化" class="headerlink" title="字段优化"></a>字段优化</h5><p>JMH 基准测试请参考：<a target="_blank" rel="noopener" href="http://openjdk.java.net/projects/code-tools/jmh/">http://openjdk.java.net/projects/code-tools/jmh/</a></p>
<p>创建 maven 工程，添加依赖如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jmh.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-generator-annprocess<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jmh.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写基准测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.annotations.*;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.Runner;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.RunnerException;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.Options;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.OptionsBuilder;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadLocalRandom;</span><br><span class="line"><span class="meta">@Warmup(iterations = 2, time = 1)</span>	<span class="comment">// 热身</span></span><br><span class="line"><span class="meta">@Measurement(iterations = 5, time = 1)</span>	<span class="comment">// 热身几轮</span></span><br><span class="line"><span class="meta">@State(Scope.Benchmark)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Benchmark1</span> &#123;</span><br><span class="line">    <span class="type">int</span>[] elements = randomInts(<span class="number">1_000</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] randomInts(<span class="type">int</span> size) &#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> ThreadLocalRandom.current();</span><br><span class="line">        <span class="type">int</span>[] values = <span class="keyword">new</span> <span class="title class_">int</span>[size];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            values[i] = random.nextInt();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> values;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; elements.length; i++) &#123;</span><br><span class="line">            doSum(elements[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] local = <span class="built_in">this</span>.elements;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; local.length; i++) &#123;</span><br><span class="line">            doSum(local[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> element : elements) &#123;</span><br><span class="line">            doSum(element);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@CompilerControl(CompilerControl.Mode.INLINE)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doSum</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">        sum += x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RunnerException &#123;</span><br><span class="line">        <span class="type">Options</span> <span class="variable">opt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OptionsBuilder</span>()</span><br><span class="line">            .include(Benchmark1.class.getSimpleName())</span><br><span class="line">            .forks(<span class="number">1</span>)</span><br><span class="line">            .build();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Runner</span>(opt).run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先启用 doSum 的方法内联，测试结果如下（每秒吞吐量，分数越高的更好）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Benchmark Mode Samples Score Score error Units</span><br><span class="line">t.Benchmark1.test1 thrpt 5 2420286.539 390747.467 ops/s</span><br><span class="line">t.Benchmark1.test2 thrpt 5 2544313.594 91304.136 ops/s</span><br><span class="line">t.Benchmark1.test3 thrpt 5 2469176.697 450570.647 ops/s</span><br></pre></td></tr></table></figure>

<p>接下来禁用 doSum 方法内联</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CompilerControl(CompilerControl.Mode.DONT_INLINE)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doSum</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">    sum += x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Benchmark Mode Samples Score Score error Units</span><br><span class="line">t.Benchmark1.test1 thrpt 5 296141.478 63649.220 ops/s</span><br><span class="line">t.Benchmark1.test2 thrpt 5 371262.351 83890.984 ops/s</span><br><span class="line">t.Benchmark1.test3 thrpt 5 368960.847 60163.391 ops/s</span><br></pre></td></tr></table></figure>

<p>分析： </p>
<p>在刚才的示例中，doSum 方法是否内联会影响 elements 成员变量读取的优化： </p>
<p>如果 doSum 方法内联了，刚才的 test1 方法会被优化成下面的样子（伪代码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Benchmark</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// elements.length 首次读取会缓存起来 -&gt; int[] local</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; elements.length; i++) &#123; <span class="comment">// 后续 999 次 求长度 &lt;- local</span></span><br><span class="line">        sum += elements[i]; <span class="comment">// 1000 次取下标 i 的元素 &lt;- local</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以节省 1999 次 <code>Field</code> 读取操作 </p>
<p>但如果 <code>doSum</code> 方法没有内联，则不会进行上面的优化 </p>
<p>练习：在内联情况下将 <code>elements</code> 添加 <code>volatile</code> 修饰符，观察测试结果</p>
<h4 id="反射优化"><a href="#反射优化" class="headerlink" title="反射优化"></a>反射优化</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Reflect1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;foo...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">foo</span> <span class="operator">=</span> Reflect1.class.getMethod(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= <span class="number">16</span>; i++) &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;%d\t&quot;</span>, i);</span><br><span class="line">            foo.invoke(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>foo.invoke 前面 0 ~ 15 次调用使用的是 <strong>MethodAccessor（方法访问器）</strong> 的 <strong>NativeMethodAccessorImpl（本地）</strong> 实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.misc.ReflectUtil;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NativeMethodAccessorImpl</span> <span class="keyword">extends</span> <span class="title class_">MethodAccessorImpl</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Method method;</span><br><span class="line">    <span class="keyword">private</span> DelegatingMethodAccessorImpl parent;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> numInvocations;</span><br><span class="line">    NativeMethodAccessorImpl(Method method) &#123;</span><br><span class="line">        <span class="built_in">this</span>.method = method;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object target, Object[] args)</span></span><br><span class="line">        <span class="keyword">throws</span> IllegalArgumentException, InvocationTargetException &#123;</span><br><span class="line">        <span class="comment">// inflationThreshold 膨胀阈值，默认 15</span></span><br><span class="line">        <span class="keyword">if</span> (++<span class="built_in">this</span>.numInvocations &gt; ReflectionFactory.inflationThreshold()</span><br><span class="line">            &amp;&amp; !ReflectUtil.isVMAnonymousClass(<span class="built_in">this</span>.method.getDeclaringClass()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 使用 ASM 动态生成的新实现代替本地实现，速度较本地实现快 20 倍左右</span></span><br><span class="line">            <span class="type">MethodAccessorImpl</span> <span class="variable">generatedMethodAccessor</span> <span class="operator">=</span></span><br><span class="line">                (MethodAccessorImpl)</span><br><span class="line">                (<span class="keyword">new</span> <span class="title class_">MethodAccessorGenerator</span>())</span><br><span class="line">                .generateMethod(</span><br><span class="line">                <span class="built_in">this</span>.method.getDeclaringClass(),</span><br><span class="line">                <span class="built_in">this</span>.method.getName(),</span><br><span class="line">                <span class="built_in">this</span>.method.getParameterTypes(),</span><br><span class="line">                <span class="built_in">this</span>.method.getReturnType(),</span><br><span class="line">                <span class="built_in">this</span>.method.getExceptionTypes(),</span><br><span class="line">                <span class="built_in">this</span>.method.getModifiers()</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">this</span>.parent.setDelegate(generatedMethodAccessor);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用本地实现</span></span><br><span class="line">        <span class="keyword">return</span> invoke0(<span class="built_in">this</span>.method, target, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setParent</span><span class="params">(DelegatingMethodAccessorImpl parent)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.parent = parent;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> Object <span class="title function_">invoke0</span><span class="params">(Method method, Object target, Object[]</span></span><br><span class="line"><span class="params">                                         args)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当调用到第 16 次（<strong>从0开始算，达到阈值</strong>）时，会采用<strong>运行时生成的类代替掉最初的实现</strong>，可以通过 debug 得到类名为 <code>sun.reflect.GeneratedMethodAccessor1</code> 可以使用阿里的 <strong>arthas</strong> 工具：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar</span><br><span class="line">[INFO] arthas-boot version: 3.1.1</span><br><span class="line">[INFO] Found existing java process, please choose one and hit RETURN.</span><br><span class="line">* [1]: 13065 cn.itcast.jvm.t3.reflect.Reflect1</span><br></pre></td></tr></table></figure>

<p>选择 1 回车表示分析该进程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">[INFO] arthas home: /root/.arthas/lib/3.1.1/arthas</span><br><span class="line">[INFO] Try to attach process 13065</span><br><span class="line">[INFO] Attach process 13065 success.</span><br><span class="line">[INFO] arthas-client connect 127.0.0.1 3658</span><br><span class="line">,---. ,------. ,--------.,--. ,--. ,---. ,---.</span><br><span class="line">/ O \ | .--. &#x27;&#x27;--. .--&#x27;| &#x27;--&#x27; | / O \ &#x27; .-&#x27;</span><br><span class="line">| .-. || &#x27;--&#x27;.&#x27; | | | .--. || .-. |`. `-.</span><br><span class="line">| | | || |\ \ | | | | | || | | |.-&#x27; |</span><br><span class="line">`--&#x27; `--&#x27;`--&#x27; &#x27;--&#x27; `--&#x27; `--&#x27; `--&#x27;`--&#x27; `--&#x27;`-----&#x27;</span><br><span class="line">wiki https://alibaba.github.io/arthas</span><br><span class="line">tutorials https://alibaba.github.io/arthas/arthas-tutorials</span><br><span class="line">version 3.1.1</span><br><span class="line">pid 13065</span><br><span class="line">time 2019-06-10 12:23:54</span><br></pre></td></tr></table></figure>

<p>再输入【jad + 类名】来进行反编译</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ jad sun.reflect.GeneratedMethodAccessor1</span><br><span class="line">    ClassLoader:</span><br><span class="line">+-sun.reflect.DelegatingClassLoader@15db9742</span><br><span class="line">    +-sun.misc.Launcher$AppClassLoader@4e0e2f2a</span><br><span class="line">    +-sun.misc.Launcher$ExtClassLoader@2fdb006e</span><br><span class="line">    Location:</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Decompiled with CFR 0_132.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Could not load the following classes:</span></span><br><span class="line"><span class="comment">* cn.itcast.jvm.t3.reflect.Reflect1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">package</span> sun.reflect;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.jvm.t3.reflect.Reflect1;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.MethodAccessorImpl;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GeneratedMethodAccessor1</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">MethodAccessorImpl</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Loose catch block</span></span><br><span class="line"><span class="comment">    * Enabled aggressive block sorting</span></span><br><span class="line"><span class="comment">    * Enabled unnecessary exception pruning</span></span><br><span class="line"><span class="comment">    * Enabled aggressive exception aggregation</span></span><br><span class="line"><span class="comment">    * Lifted jumps to return sites</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object object, Object[] arrobject)</span> <span class="keyword">throws</span></span><br><span class="line">        InvocationTargetException &#123;</span><br><span class="line">        <span class="comment">// 比较奇葩的做法，如果有参数，那么抛非法参数异常</span></span><br><span class="line">        block4 : &#123;</span><br><span class="line">            <span class="keyword">if</span> (arrobject == <span class="literal">null</span> || arrobject.length == <span class="number">0</span>) <span class="keyword">break</span> block4;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 可以看到，已经是直接调用了，不是反射调用</span></span><br><span class="line">            Reflect1.foo();</span><br><span class="line">            <span class="comment">// 因为没有返回值</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvocationTargetException</span>(throwable);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassCastException | NullPointerException runtimeException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(Object.<span class="built_in">super</span>.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Affect(row-cnt:<span class="number">1</span>) cost in <span class="number">1540</span> ms.</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong></p>
<p>通过查看 ReflectionFactory 源码可知 </p>
<ul>
<li>sun.reflect.noInflation 可以用来禁用膨胀（直接生成 GeneratedMethodAccessor1，但首次生成比较耗时，如果仅反射调用一次，不划算） </li>
<li><em>sun.reflect.inflationThreshold 可以修改膨胀阈值（环境变量设置）</em></li>
</ul>
</blockquote>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230131135234604.png" alt="image-20230131135234604" style="zoom:80%;margin-left:0" />





<h2 id="6-JMM"><a href="#6-JMM" class="headerlink" title="6. JMM"></a>6. JMM</h2><p><em>Java Memory Model(Java内存模型)， 围绕着在并发过程中如何处理<strong>可见性、原子性、有序性</strong>这三个特性而建立的模型。</em></p>
<p><strong>JMM结构规范</strong></p>
<blockquote>
<p>JMM规定了所有的变量都存储在主内存（Main Memory）中。每个线程还有自己的工作内存（Working Memory）,线程的工作内存中保存了该线程使用到的变量的主内存的副本拷贝，线程对变量的所有操作（读取、赋值等）都必须在工作内存中进行，而不能直接读写主内存中的变量（volatile变量仍然有工作内存的拷贝，但是由于它特殊的操作顺序性规定，所以看起来如同直接在主内存中读写访问一般）。不同的线程之间也无法直接访问对方工作内存中的变量，线程之间值的传递都需要通过主内存来完成。</p>
</blockquote>
<p>很多人将【java 内存结构】与【java 内存模型】傻傻分不清，【java 内存模型】是 Java Memory Model（JMM）的意思。 </p>
<p>关于它的权威解释，请参考 <a target="_blank" rel="noopener" href="https://download.oracle.com/otn-pub/jcp/memory_model-1.0-pfdspec-oth-JSpec/memory_model-1_0-pfd-spec.pdf?AuthParam=1562811549_4d4994cbd5b59d964cd2907ea22ca08b">https://download.oracle.com/otn-pub/jcp/memory_model-1.0-pfdspec-oth-JSpec/memory_model-1_0-pfd-spec.pdf?AuthParam=1562811549_4d4994cbd5b59d964cd2907ea22ca08b</a> </p>
<p>简单的说，JMM 定义了一套<strong>在多线程读写共享数据时（成员变量、数组）时</strong>，对<strong>数据的可见性、有序性、和原子性的规则和保障</strong></p>
<h3 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h3><p>原子性在学习线程时讲过，下面来个例子简单回顾一下：问题提出，<em>两个线程对初始值为 0 的静态变量一个做自增，一个做自减，各做 5000 次，结果是 0 吗？</em></p>
<p>以上的结果可能是正数、负数、零。为什么呢？因为 <strong>Java 中对静态变量的自增，自减并不是原子操作</strong>。</p>
<p>例如对于 <strong>i++</strong> 而言（i 为静态变量），实际会产生如下的 JVM 字节码指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getstatic i // 获取静态变量i的值</span><br><span class="line">iconst_1 // 准备常量1</span><br><span class="line">iadd // 加法</span><br><span class="line">putstatic i // 将修改后的值存入静态变量</span><br></pre></td></tr></table></figure>

<p>而对应 <strong>i–</strong> 也是类似：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getstatic i // 获取静态变量i的值</span><br><span class="line">iconst_1 // 准备常量1</span><br><span class="line">isub // 减法</span><br><span class="line">putstatic i // 将修改后的值存入静态变量i</span><br></pre></td></tr></table></figure>

<p>而 Java 的内存模型如下，完成静态变量的自增，自减需要在主存和线程内存中进行数据交换：</p>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130165217833.png" alt="image-20230130165217833" style="zoom:80%;margin-left:0" />

<p>如果是单线程以上 8 行代码是顺序执行（不会交错）没有问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 假设i的初始值为0</span><br><span class="line">getstatic i // 线程1-获取静态变量i的值 线程内i=0</span><br><span class="line">iconst_1 // 线程1-准备常量1</span><br><span class="line">iadd // 线程1-自增 线程内i=1</span><br><span class="line">putstatic i // 线程1-将修改后的值存入静态变量i 静态变量i=1</span><br><span class="line">getstatic i // 线程1-获取静态变量i的值 线程内i=1</span><br><span class="line">iconst_1 // 线程1-准备常量1</span><br><span class="line">isub // 线程1-自减 线程内i=0</span><br><span class="line">putstatic i // 线程1-将修改后的值存入静态变量i 静态变量i=0</span><br></pre></td></tr></table></figure>

<p>但多线程下这 8 行代码可能交错运行（为什么会交错？思考一下）：</p>
<p>出现负数的情况：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 假设i的初始值为0</span><br><span class="line">getstatic i // 线程1-获取静态变量i的值 线程内i=0</span><br><span class="line">getstatic i // 线程2-获取静态变量i的值 线程内i=0</span><br><span class="line">iconst_1 // 线程1-准备常量1</span><br><span class="line">iadd // 线程1-自增 线程内i=1</span><br><span class="line">putstatic i // 线程1-将修改后的值存入静态变量i 静态变量i=1</span><br><span class="line">iconst_1 // 线程2-准备常量1</span><br><span class="line">isub // 线程2-自减 线程内i=-1</span><br><span class="line">putstatic i // 线程2-将修改后的值存入静态变量i 静态变量i=-1</span><br></pre></td></tr></table></figure>

<p>出现正数的情况：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 假设i的初始值为0</span><br><span class="line">getstatic i // 线程1-获取静态变量i的值 线程内i=0</span><br><span class="line">getstatic i // 线程2-获取静态变量i的值 线程内i=0</span><br><span class="line">iconst_1 // 线程1-准备常量1</span><br><span class="line">iadd // 线程1-自增 线程内i=1</span><br><span class="line">iconst_1 // 线程2-准备常量1</span><br><span class="line">isub // 线程2-自减 线程内i=-1</span><br><span class="line">putstatic i // 线程2-将修改后的值存入静态变量i 静态变量i=-1</span><br><span class="line">putstatic i // 线程1-将修改后的值存入静态变量i 静态变量i=1</span><br></pre></td></tr></table></figure>



<p><strong>解决方案</strong></p>
<p><code>synchronized</code> （同步关键字）</p>
<p>语法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>( 对象 ) &#123;</span><br><span class="line">    要作为原子操作代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用 <code>synchronized</code> 解决并发问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">5000</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">5000</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                i--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>如何理解：你可以把 obj 想象成一个房间，线程 t1，t2 想象成两个人。</em></p>
<p><em>当线程 t1 执行到 synchronized(obj) 时就好比 t1 进入了这个房间，并反手锁住了门，在门内执行 count++ 代码</em></p>
<p><em>这时候如果 t2 也运行到了 synchronized(obj) 时，它发现门被锁住了，只能在门外等待</em></p>
<p><em>当 t1 执行完 synchronized{} 块内的代码，这时候才会解开门上的锁，从 obj 房间出来。t2 线程这时才可以进入 obj 房间，反锁住门，执行它的 count– 代码</em></p>
<blockquote>
<p>注意：</p>
<ul>
<li>上例中 t1 和 t2 线程必须用 synchronized 锁住同一个 obj 对象，如果 t1 锁住的是 m1 对象，t2 锁住的是 m2 对象，就好比两个人分别进入了两个不同的房间，没法起到同步的效果</li>
<li>针对 i++ 只有四条虚拟机指令加锁，频繁的加锁与解锁造成极大的性能开销，通过思考锁粒度，来优化加锁解锁的结构</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">5000</span>; j++) &#123;</span><br><span class="line">        i--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h3><h4 id="退不出循环问题"><a href="#退不出循环问题" class="headerlink" title="退不出循环问题"></a>退不出循环问题</h4><p>先来看一个现象，main 线程对 run 变量的修改对于 t 线程不可见，导致了 t 线程无法停止：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">run</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">while</span>(run)&#123;</span><br><span class="line">            <span class="comment">// ....</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t.start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    run = <span class="literal">false</span>; <span class="comment">// 线程t不会如预想的停下来</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>为什么呢？分析一下：</p>
<ol>
<li>初始状态， t 线程刚开始从主内存读取了 run 的值到工作内存。</li>
</ol>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130225619474.png" alt="image-20230130225619474" style="zoom:80%;margin-left:0" />

<ol start="2">
<li>因为 t 线程要频繁从主内存中读取 run 的值，JIT 编译器会将 run 的值缓存至自己工作内存中的高速缓存中，减少对主存中 run 的访问，提高效率</li>
</ol>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130225647369.png" alt="image-20230130225647369" style="zoom:80%;margin-left:0" />

<ol start="3">
<li>1 秒之后，main 线程修改了 run 的值，并同步至主存，而 t 是从自己工作内存中的高速缓存中读取这个变量的值，结果永远是旧值</li>
</ol>
<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/image-20230130225722127.png" alt="image-20230130225722127" style="zoom:80%;margin-left:0" />





<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p><strong>volatile（易变关键字）</strong></p>
<p>它可以用来修饰成员变量和静态成员变量，他可以避免线程从自己的工作缓存中查找变量的值，必须到主存中获取它的值，线程操作 volatile 变量都是直接操作主存</p>
<h4 id="可见性-1"><a href="#可见性-1" class="headerlink" title="可见性"></a>可见性</h4><p>前面例子体现的实际就是可见性，它保证的是在多个线程之间，一个线程对 volatile 变量的修改对另一个线程可见，不能保证原子性，仅用在一个写线程，多个读线程的情况： </p>
<p>上例从字节码理解是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getstatic run // 线程 t 获取 run true</span><br><span class="line">getstatic run // 线程 t 获取 run true</span><br><span class="line">getstatic run // 线程 t 获取 run true</span><br><span class="line">getstatic run // 线程 t 获取 run true</span><br><span class="line">putstatic run // 线程 main 修改 run 为 false， 仅此一次</span><br><span class="line">getstatic run // 线程 t 获取 run false</span><br></pre></td></tr></table></figure>

<p>比较一下之前我们将线程安全时举的例子：两个线程一个 i++ 一个 i– ，只能保证看到最新值，不能解决指令交错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 假设i的初始值为0</span><br><span class="line">getstatic i // 线程1-获取静态变量i的值 线程内i=0</span><br><span class="line">getstatic i // 线程2-获取静态变量i的值 线程内i=0</span><br><span class="line">iconst_1 // 线程1-准备常量1</span><br><span class="line">iadd // 线程1-自增 线程内i=1</span><br><span class="line">putstatic i // 线程1-将修改后的值存入静态变量i 静态变量i=1</span><br><span class="line">iconst_1 // 线程2-准备常量1</span><br><span class="line">isub // 线程2-自减 线程内i=-1</span><br><span class="line">putstatic i // 线程2-将修改后的值存入静态变量i 静态变量i=-1</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong></p>
<ul>
<li><p><strong>synchronized 语句块既可以保证代码块的原子性</strong>，也同时保证代码块内变量的可见性。但缺点是 synchronized 是属于<strong>重量级操作，性能相对更低</strong></p>
</li>
<li><p>如果在前面示例的死循环中加入 System.out.println() 会发现即使不加 volatile 修饰符，线程 t 也能正确看到对 run 变量的修改了，想一想为什么？println()底层有 synchronized{}关键字锁</p>
</li>
</ul>
</blockquote>
<h3 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h3><h4 id="诡异结果"><a href="#诡异结果" class="headerlink" title="诡异结果"></a>诡异结果</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="variable">ready</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// 线程1 执行此方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">        r.r1 = num + num;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r.r1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 线程2 执行此方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    num = <span class="number">2</span>;</span><br><span class="line">    ready = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I_Result 是一个对象，有一个属性 r1 用来保存结果，问，可能的结果有几种？</p>
<p><strong>分析</strong></p>
<ol>
<li>情况1：线程1 先执行，这时 ready &#x3D; false，所以进入 else 分支结果为 1</li>
<li>情况2：线程2 先执行 num &#x3D; 2，但没来得及执行 ready &#x3D; true，线程1 执行，还是进入 else 分支，结果为1</li>
<li>情况3：线程2 执行到 ready &#x3D; true，线程1 执行，这回进入 if 分支，结果为 4（因为 num 已经执行过了）</li>
</ol>
<p><strong>但实际上结果还有可能是 <u>0</u></strong></p>
<p>&#x3D;&#x3D;<em>这种情况下是：线程2 执行 ready &#x3D; true，切换到线程1，进入 if 分支，相加为 0，再切回线程2 执行num &#x3D; 2</em>&#x3D;&#x3D;</p>
<p>这种现象叫做指令重排，是 JIT 编译器在运行时的一些优化，这个现象需要通过大量测试才能复现：</p>
<p>借助 java 并发压测工具 jcstress <a target="_blank" rel="noopener" href="https://wiki.openjdk.java.net/display/CodeTools/jcstress">https://wiki.openjdk.java.net/display/CodeTools/jcstress</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:generate -DinteractiveMode=<span class="literal">false</span> -</span><br><span class="line">DarchetypeGroupId=org.openjdk.jcstress -DarchetypeArtifactId=jcstress-java-testarchetype -DgroupId=org.sample -DartifactId=<span class="built_in">test</span> -Dversion=1.0</span><br></pre></td></tr></table></figure>

<p>创建 maven 项目，提供如下测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JCStressTest</span></span><br><span class="line"><span class="meta">@Outcome(id = &#123;&quot;1&quot;, &quot;4&quot;&#125;, expect = Expect.ACCEPTABLE, desc = &quot;ok&quot;)</span></span><br><span class="line"><span class="meta">@Outcome(id = &quot;0&quot;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;!!!!&quot;)</span></span><br><span class="line"><span class="meta">@State</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrencyTest</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">ready</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="meta">@Actor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">            r.r1 = num + num;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            r.r1 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Actor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">        num = <span class="number">2</span>;</span><br><span class="line">        ready = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>必须打包执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install</span><br><span class="line">java -jar target/jcstress.jar</span><br></pre></td></tr></table></figure>

<p>会输出我们感兴趣的结果，摘录其中一次结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">*** INTERESTING tests</span><br><span class="line">Some interesting behaviors observed. This is for the plain curiosity.</span><br><span class="line">2 matching test results.</span><br><span class="line">[OK] test.ConcurrencyTest</span><br><span class="line">(JVM args: [-XX:-TieredCompilation])</span><br><span class="line">Observed state Occurrences Expectation Interpretation</span><br><span class="line">0 1,729 ACCEPTABLE_INTERESTING !!!!</span><br><span class="line">1 42,617,915 ACCEPTABLE ok</span><br><span class="line">4 5,146,627 ACCEPTABLE ok</span><br><span class="line">[OK] test.ConcurrencyTest</span><br><span class="line">(JVM args: [])</span><br><span class="line">Observed state Occurrences Expectation Interpretation</span><br><span class="line">0 1,652 ACCEPTABLE_INTERESTING !!!!</span><br><span class="line">1 46,460,657 ACCEPTABLE ok</span><br><span class="line">4 4,571,072 ACCEPTABLE ok</span><br></pre></td></tr></table></figure>

<p>可以看到，出现结果为 0 的情况有 638 次，虽然次数相对很少，但毕竟是出现了</p>
<h4 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h4><p><strong>volatile 修饰的变量，可以禁用指令重排</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JCStressTest</span></span><br><span class="line"><span class="meta">@Outcome(id = &#123;&quot;1&quot;, &quot;4&quot;&#125;, expect = Expect.ACCEPTABLE, desc = &quot;ok&quot;)</span></span><br><span class="line"><span class="meta">@Outcome(id = &quot;0&quot;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;!!!!&quot;)</span></span><br><span class="line"><span class="meta">@State</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrencyTest</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">ready</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="meta">@Actor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">            r.r1 = num + num;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            r.r1 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Actor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">        num = <span class="number">2</span>;</span><br><span class="line">        ready = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*** INTERESTING tests</span><br><span class="line">Some interesting behaviors observed. This is for the plain curiosity.</span><br><span class="line">0 matching test results.</span><br></pre></td></tr></table></figure>



<h4 id="有序性理解"><a href="#有序性理解" class="headerlink" title="有序性理解"></a>有序性理解</h4><p>JVM 会在不影响正确性的前提下，可以调整语句的执行顺序，思考下面一段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> i;</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> j;</span><br><span class="line"><span class="comment">// 在某个线程内执行如下赋值操作</span></span><br><span class="line">i = ...; <span class="comment">// 较为耗时的操作</span></span><br><span class="line">j = ...;</span><br></pre></td></tr></table></figure>

<p>可以看到，至于是先执行 i 还是 先执行 j ，对最终的结果不会产生影响。所以，上面代码真正执行时，既可以是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">i = ...; <span class="comment">// 较为耗时的操作</span></span><br><span class="line">j = ...;</span><br></pre></td></tr></table></figure>

<p>这种特性称之为『指令重排』，多线程下『指令重排』会影响正确性，例如著名的 double-checked locking 模式实现单例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Singleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 实例没创建，才会进入内部的 synchronized代码块</span></span><br><span class="line">        <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">                <span class="comment">// 也许有其它线程已经创建实例，所以再判断一次</span></span><br><span class="line">                <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">                    INSTANCE = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上的实现特点是：</p>
<ul>
<li>懒惰实例化 </li>
<li>首次使用 getInstance() 才使用 synchronized 加锁，后续使用时无需加锁</li>
</ul>
<p>但在多线程环境下，上面的代码是有问题的， <code>INSTANCE = new Singleton()</code> 对应的字节码为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0: new #2 // class cn/itcast/jvm/t4/Singleton</span><br><span class="line">3: dup</span><br><span class="line">4: invokespecial #3 // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">7: putstatic #4 // Field</span><br><span class="line">INSTANCE:Lcn/itcast/jvm/t4/Singleton;</span><br></pre></td></tr></table></figure>

<p>其中 4 7 两步的顺序不是固定的，也许 jvm 会优化为：先将引用地址赋值给 INSTANCE 变量后，再执行构造方法，如果两个线程 t1，t2 按如下时间序列执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">时间1 t1 线程执行到 INSTANCE = new Singleton();</span><br><span class="line">时间2 t1 线程分配空间，为Singleton对象生成了引用地址（0 处）</span><br><span class="line">时间3 t1 线程将引用地址赋值给 INSTANCE，这时 INSTANCE != null（7 处）</span><br><span class="line">时间4 t2 线程进入getInstance() 方法，发现 INSTANCE != null（synchronized块外），直接</span><br><span class="line">返回 INSTANCE</span><br><span class="line">时间5 t1 线程执行Singleton的构造方法（4 处）</span><br></pre></td></tr></table></figure>

<p>这时 t1 还未完全将构造方法执行完毕，如果在构造方法中要执行很多初始化操作，那么 t2 拿到的是将是一个未初始化完毕的单例 </p>
<p>对 INSTANCE 使用 volatile 修饰即可，可以禁用指令重排，但要注意在 JDK 5 以上的版本的 volatile 才会真正有效</p>
<h4 id="happens-before"><a href="#happens-before" class="headerlink" title="happens-before"></a>happens-before</h4><p><strong>happens-before 规定了哪些写操作对其它线程的读操作可见，它是可见性与有序性的一套规则总结</strong>，抛开以下 happens-before 规则，JMM 并不能保证一个线程对共享变量的写，对于其它线程对该共享变量的读可见</p>
<ul>
<li>线程解锁 m 之前对变量的写，对于接下来对 m 加锁的其它线程对该变量的读可见</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line"><span class="keyword">static</span> <span class="type">Object</span> <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(m) &#123;</span><br><span class="line">        x = <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(m) &#123;</span><br><span class="line">        System.out.println(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure>

<ul>
<li>线程对 volatile 变量的写，对接下来其它线程对该变量的读可见</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    x = <span class="number">10</span>;</span><br><span class="line">&#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    System.out.println(x);</span><br><span class="line">&#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure>

<ul>
<li>线程 start 前对变量的写，对该线程开始后对该变量的读可见</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line">x = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    System.out.println(x);</span><br><span class="line">&#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br></pre></td></tr></table></figure>

<ul>
<li>线程结束前对变量的写，对其它线程得知它结束后的读可见（比如其它线程调用 t1.isAlive() 或 t1.join()等待它结束）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    x = <span class="number">10</span>;</span><br><span class="line">&#125;,<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">t1.start();</span><br><span class="line">t1.join();</span><br><span class="line">System.out.println(x);</span><br></pre></td></tr></table></figure>

<ul>
<li>线程 t1 打断 t2（interrupt）前对变量的写，对于其他线程得知 t2 被打断后对变量的读可见（通过t2.interrupted 或 t2.isInterrupted）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> x;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">                System.out.println(x);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        x = <span class="number">10</span>;</span><br><span class="line">        t2.interrupt();</span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    <span class="keyword">while</span>(!t2.isInterrupted()) &#123;</span><br><span class="line">        Thread.<span class="keyword">yield</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对变量默认值（0，false，null）的写，对其它线程对该变量的读可见</li>
<li>具有传递性，如果 x hb-&gt; y 并且 y hb-&gt; z 那么有 x hb-&gt; z</li>
</ul>
<blockquote>
<p>变量都是指成员变量或静态成员变量</p>
<p>参考：<a target="_blank" rel="noopener" href="https://download.oracle.com/otn-pub/jcp/memory_model-1.0-pfdspec-oth-JSpec/memory_model-1_0-pfd-spec.pdf?AuthParam=1562811549_4d4994cbd5b59d964cd2907ea22ca08b">上文</a></p>
</blockquote>
<h3 id="CAS-与-原子类"><a href="#CAS-与-原子类" class="headerlink" title="CAS 与 原子类"></a>CAS 与 原子类</h3><h4 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h4><p>CAS 即 <strong>Compare and Swap</strong> ，它体现的一种乐观锁的思想，比如多个线程要对一个共享的整型变量执行 +1 操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要不断尝试</span></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="type">int</span> 旧值 = 共享变量 ; <span class="comment">// 比如拿到了当前值 0</span></span><br><span class="line">    <span class="type">int</span> 结果 = 旧值 + <span class="number">1</span>; <span class="comment">// 在旧值 0 的基础上增加 1 ，正确结果是 1</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    这时候如果别的线程把共享变量改成了 5，本线程的正确结果 1 就作废了，这时候</span></span><br><span class="line"><span class="comment">    compareAndSwap 返回 false，重新尝试，直到：</span></span><br><span class="line"><span class="comment">    compareAndSwap 返回 true，表示我本线程做修改的同时，别的线程没有干扰</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span>( compareAndSwap ( 旧值, 结果 )) &#123;</span><br><span class="line">        <span class="comment">// 成功，退出循环</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取共享变量时，为了保证该变量的可见性，需要使用 volatile 修饰。结合 CAS 和 volatile 可以实现无锁并发，适用于竞争不激烈、多核 CPU 的场景下</p>
<ul>
<li>因为没有使用 synchronized，所以线程不会陷入阻塞，这是效率提升的因素之一</li>
<li>但如果竞争激烈，可以想到重试必然频繁发生，反而效率会受影响</li>
</ul>
<p><strong>CAS 底层依赖于一个 Unsafe 类来直接调用操作系统底层的 CAS 指令</strong>，下面是直接使用 Unsafe 对象进行线程安全保护的一个例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCAS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">DataContainer</span> <span class="variable">dc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainer</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                dc.increase();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        System.out.println(dc.getData());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataContainer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> data;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> DATA_OFFSET;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Unsafe 对象不能直接调用，只能通过反射获得</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">theUnsafe</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            theUnsafe.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            unsafe = (Unsafe) theUnsafe.get(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// data 属性在 DataContainer 对象中的偏移量，用于 Unsafe 直接访问该属性</span></span><br><span class="line">            DATA_OFFSET =</span><br><span class="line">                unsafe.objectFieldOffset(DataContainer.class.getDeclaredField(<span class="string">&quot;data&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increase</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> oldValue;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取共享变量旧值，可以在这一行加入断点，修改 data 调试来加深理解</span></span><br><span class="line">            oldValue = data;</span><br><span class="line">            <span class="comment">// cas 尝试修改 data 为 旧值 + 1，如果期间旧值被别的线程改了，返回 false</span></span><br><span class="line">            <span class="keyword">if</span> (unsafe.compareAndSwapInt(<span class="built_in">this</span>, DATA_OFFSET, oldValue, oldValue +</span><br><span class="line">                                         <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrease</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> oldValue;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            oldValue = data;</span><br><span class="line">            <span class="keyword">if</span> (unsafe.compareAndSwapInt(<span class="built_in">this</span>, DATA_OFFSET, oldValue, oldValue -</span><br><span class="line">                                         <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="乐观锁与悲观锁"><a href="#乐观锁与悲观锁" class="headerlink" title="乐观锁与悲观锁"></a>乐观锁与悲观锁</h4><ul>
<li>CAS 是基于乐观锁的思想：最乐观的估计，不怕别的线程来修改共享变量，就算改了也没关系，我吃亏点再重试</li>
<li>synchronized 是基于悲观锁的思想：最悲观的估计，得防着其它线程来修改共享变量，我上了锁你们都别想改，我改完了解开锁，你们才有机会</li>
</ul>
<h4 id="原子操作类"><a href="#原子操作类" class="headerlink" title="原子操作类"></a>原子操作类</h4><p>juc（java.util.concurrent）中提供了原子操作类，可以提供线程安全的操作，例如：AtomicInteger、AtomicBoolean等，它们底层就是采用 CAS 技术 + volatile 来实现的</p>
<p>可以使用 AtomicInteger 改写之前的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建原子整数对象</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">5000</span>; j++) &#123;</span><br><span class="line">            i.getAndIncrement(); <span class="comment">// 获取并且自增 i++</span></span><br><span class="line">            <span class="comment">// i.incrementAndGet(); // 自增并且获取 ++i</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">5000</span>; j++) &#123;</span><br><span class="line">            i.getAndDecrement(); <span class="comment">// 获取并且自减 i--</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="synchronized-优化"><a href="#synchronized-优化" class="headerlink" title="synchronized 优化"></a>synchronized 优化</h3><p>Java HotSpot 虚拟机中，每个对象都有对象头（包括 class 指针和 Mark Word）。Mark Word 平时存储这个对象的 <strong>哈希码</strong> 、 <strong>分代年龄</strong> ，当加锁时，这些信息就根据情况被替换为 <strong>标记位</strong> 、 <strong>线程锁记录指针</strong> 、 <strong>重量级锁指针</strong> 、 <strong>线程ID</strong> 等内容</p>
<h4 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h4><p>如果一个对象虽然有多线程访问，但多线程访问的时间是错开的（也就是没有竞争），那么可以使用轻量级锁来优化。</p>
<p>这就好比：</p>
<p>学生（线程 A）用课本占座，上了半节课，出门了（CPU时间到），回来一看，发现课本没变，说明没有竞争，继续上他的课。如果这期间有其它学生（线程 B）来了，会告知（线程A）有并发访问，线程 A 随即升级为重量级锁，进入重量级锁的流程。而重量级锁就不是那么用课本占座那么简单了，可以想象线程 A 走之前，把座位用一个铁栅栏围起来</p>
<p>假设有两个方法同步块，利用同一个对象加锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// 同步块 A</span></span><br><span class="line">        method2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// 同步块 B</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个线程都的栈帧都会包含一个锁记录的结构，内部可以存储锁定对象的 Mark Word</p>
<table>
<thead>
<tr>
<th>线程 1</th>
<th>对象 Mark Word</th>
<th>线程 2</th>
</tr>
</thead>
<tbody><tr>
<td>访问同步块 A，把 Mark 复制到线程 1 的锁记录</td>
<td>01（无锁）</td>
<td>-</td>
</tr>
<tr>
<td>CAS 修改 Mark 为线程 1 锁记录地址</td>
<td>01（无锁）</td>
<td>-</td>
</tr>
<tr>
<td>成功（加锁）</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>-</td>
</tr>
<tr>
<td>执行同步块 A</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>-</td>
</tr>
<tr>
<td>访问同步块 B，把 Mark 复制到线程 1 的锁记录</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>-</td>
</tr>
<tr>
<td>CAS 修改 Mark 为线程 1 锁记录地址</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>-</td>
</tr>
<tr>
<td>失败（发现是自己的锁）</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>-</td>
</tr>
<tr>
<td>锁重入</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>-</td>
</tr>
<tr>
<td>执行同步块 B</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>-</td>
</tr>
<tr>
<td>同步块 B 执行完毕</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>-</td>
</tr>
<tr>
<td>同步块 A 执行完毕</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>-</td>
</tr>
<tr>
<td>成功（解锁）</td>
<td>01（无锁）</td>
<td>-</td>
</tr>
<tr>
<td>-</td>
<td>01（无锁）</td>
<td>访问同步块 A，把 Mark 复制到线程 2 的锁记录</td>
</tr>
<tr>
<td>-</td>
<td>01（无锁）</td>
<td>CAS 修改 Mark 为线程 2 锁记录地址</td>
</tr>
<tr>
<td>-</td>
<td>00（轻量锁）线程 2 锁记录地址</td>
<td>成功（加锁）</td>
</tr>
<tr>
<td>-</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<h4 id="锁膨胀"><a href="#锁膨胀" class="headerlink" title="锁膨胀"></a>锁膨胀</h4><p>如果在尝试加轻量级锁的过程中，CAS 操作无法成功，这时一种情况就是有其它线程为此对象加上了轻量级锁（有竞争），这时需要进行锁膨胀，将轻量级锁变为重量级锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// 同步块</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>线程 1</th>
<th>对象 Mark</th>
<th>线程 2</th>
</tr>
</thead>
<tbody><tr>
<td>访问同步块，把 Mark 复制到线程 1 的锁记录</td>
<td>01（无锁）</td>
<td>-</td>
</tr>
<tr>
<td>CAS 修改 Mark 为线程 1 锁记录地址</td>
<td>01（无锁）</td>
<td>-</td>
</tr>
<tr>
<td>成功（加锁）</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>-</td>
</tr>
<tr>
<td>执行同步块</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>-</td>
</tr>
<tr>
<td>执行同步块</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>访问同步块，把 Mark 复制到线程 2</td>
</tr>
<tr>
<td>执行同步块</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>CAS 修改 Mark 为线程 2 锁记录地址</td>
</tr>
<tr>
<td>执行同步块</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>失败（发现别人已经占了锁）</td>
</tr>
<tr>
<td>执行同步块</td>
<td>00（轻量锁）线程 1 锁记录地址</td>
<td>CAS 修改 Mark 为重量锁</td>
</tr>
<tr>
<td>执行同步块</td>
<td>10（重量锁）重量锁指针</td>
<td>阻塞中</td>
</tr>
<tr>
<td>执行完毕</td>
<td>10（重量锁）重量锁指针</td>
<td>阻塞中</td>
</tr>
<tr>
<td>失败（解锁）</td>
<td>10（重量锁）重量锁指针</td>
<td>阻塞中</td>
</tr>
<tr>
<td>释放重量锁，唤起阻塞线程竞争</td>
<td>01（无锁）</td>
<td>阻塞中</td>
</tr>
<tr>
<td>-</td>
<td>10（重量锁）</td>
<td>竞争重量锁</td>
</tr>
<tr>
<td>-</td>
<td>10（重量锁）</td>
<td>成功（加锁）</td>
</tr>
<tr>
<td>-</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<h4 id="重量锁"><a href="#重量锁" class="headerlink" title="重量锁"></a>重量锁</h4><p>重量级锁竞争的时候，还可以使用<strong>自旋来进行优化</strong>，如果当前线程自旋成功（即这时候持锁线程已经退出了同步块，释放了锁），这时当前线程就可以避免阻塞</p>
<p>在 Java 6 之后<strong>自旋锁是自适应的</strong>，比如对象<strong>刚刚的一次自旋操作成功过，那么认为这次自旋成功的可能性会高，就多自旋几次</strong>；<strong>反之，就少自旋甚至不自旋，总之，比较智能</strong></p>
<ul>
<li><strong><u>自旋会占用 CPU 时间，单核 CPU 自旋就是浪费，多核 CPU 自旋才能发挥优势</u></strong></li>
<li>好比等红灯时汽车是不是熄火，不熄火相当于自旋（等待时间短了划算），熄火了相当于阻塞（等待时间长了划算）</li>
<li>Java 7 之后不能控制是否开启自旋功能，jvm内部控制自旋</li>
</ul>
<p><strong>自旋重试成功的情况</strong></p>
<table>
<thead>
<tr>
<th>线程 1 （cpu 1 上）</th>
<th>对象 Mark</th>
<th>线程 2 （cpu 2 上）</th>
</tr>
</thead>
<tbody><tr>
<td>-</td>
<td>10（重量锁）</td>
<td>-</td>
</tr>
<tr>
<td>访问同步块，获取 monitor</td>
<td>10（重量锁）重量锁指针</td>
<td>-</td>
</tr>
<tr>
<td>成功（加锁）</td>
<td>10（重量锁）重量锁指针</td>
<td>-</td>
</tr>
<tr>
<td>执行同步块</td>
<td>10（重量锁）重量锁指针</td>
<td>-</td>
</tr>
<tr>
<td>执行同步块</td>
<td>10（重量锁）重量锁指针</td>
<td>访问同步块，获取 monitor</td>
</tr>
<tr>
<td>执行同步块</td>
<td>10（重量锁）重量锁指针</td>
<td>自旋重试</td>
</tr>
<tr>
<td>执行完毕</td>
<td>10（重量锁）重量锁指针</td>
<td>自旋重试</td>
</tr>
<tr>
<td>成功（解锁）</td>
<td>01（无锁）</td>
<td>自旋重试</td>
</tr>
<tr>
<td>-</td>
<td>10（重量锁）重量锁指针</td>
<td>成功（加锁）</td>
</tr>
<tr>
<td>-</td>
<td>10（重量锁）重量锁指针</td>
<td>执行同步块</td>
</tr>
<tr>
<td>-</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p><strong>自旋重试失败的情况</strong></p>
<table>
<thead>
<tr>
<th>线程 1（cpu 1 上）</th>
<th>对象 Mark</th>
<th>线程 2（cpu 2 上）</th>
</tr>
</thead>
<tbody><tr>
<td>-</td>
<td>10（重量锁）</td>
<td>-</td>
</tr>
<tr>
<td>访问同步块，获取 monitor</td>
<td>10（重量锁）重量锁指针</td>
<td>-</td>
</tr>
<tr>
<td>成功（加锁）</td>
<td>10（重量锁）重量锁指针</td>
<td>-</td>
</tr>
<tr>
<td>执行同步块</td>
<td>10（重量锁）重量锁指针</td>
<td>-</td>
</tr>
<tr>
<td>执行同步块</td>
<td>10（重量锁）重量锁指针</td>
<td>访问同步块，获取 monitor</td>
</tr>
<tr>
<td>执行同步块</td>
<td>10（重量锁）重量锁指针</td>
<td>自旋重试</td>
</tr>
<tr>
<td>执行同步块</td>
<td>10（重量锁）重量锁指针</td>
<td>自旋重试</td>
</tr>
<tr>
<td>执行同步块</td>
<td>10（重量锁）重量锁指针</td>
<td>自旋重试</td>
</tr>
<tr>
<td>执行同步块</td>
<td>10（重量锁）重量锁指针</td>
<td>阻塞</td>
</tr>
<tr>
<td>-</td>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<h4 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h4><p>轻量级锁在没有竞争时（就自己这个线程），每次重入仍然需要执行 CAS 操作。Java 6 中引入了偏向锁来做进一步优化：只有第一次使用 CAS 将线程 ID 设置到对象的 Mark Word 头，之后发现这个线程 ID 是自己的就表示没有竞争，不用重新 CAS</p>
<ul>
<li>撤销偏向需要将持锁线程升级为轻量级锁，这个过程中所有线程需要暂停（STW）</li>
<li>访问对象的 hashCode 也会撤销偏向锁</li>
<li>如果对象虽然被多个线程访问，但没有竞争，这时偏向了线程 T1 的对象仍有机会重新偏向 T2，重偏向会重置对象的 Thread ID</li>
<li>撤销偏向和重偏向都是批量进行的，以类为单位</li>
<li>如果撤销偏向到达某个阈值，整个类的所有对象都会变为不可偏向的</li>
<li>可以主动使用 -XX:-UseBiasedLocking 禁用偏向锁</li>
</ul>
<p>参考文章</p>
<p><a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp-149958.pdf">https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp-149958.pdf</a></p>
<p>假设有两个方法同步块，利用同一个对象加锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// 同步块 A</span></span><br><span class="line">        method2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// 同步块 B</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>线程 1</th>
<th>对象 Mark</th>
</tr>
</thead>
<tbody><tr>
<td>访问同步块 A，检查 Mark 中是否有线程 ID</td>
<td>101（无锁可偏向）</td>
</tr>
<tr>
<td>尝试加偏向锁</td>
<td>101（无锁可偏向）对象 hashCode</td>
</tr>
<tr>
<td>成功</td>
<td>101（无锁可偏向）线程ID</td>
</tr>
<tr>
<td>执行同步块 A</td>
<td>101（无锁可偏向）线程ID</td>
</tr>
<tr>
<td>访问同步块 B，检查 Mark 中是否有线程 ID</td>
<td>101（无锁可偏向）线程ID</td>
</tr>
<tr>
<td>是自己的线程 ID，锁是自己的，无需做更多操作</td>
<td>101（无锁可偏向）线程ID</td>
</tr>
<tr>
<td>执行同步块 B</td>
<td>101（无锁可偏向）线程ID</td>
</tr>
<tr>
<td>执行完毕</td>
<td>101（无锁可偏向）对象 hashCode</td>
</tr>
</tbody></table>
<h4 id="其它优化"><a href="#其它优化" class="headerlink" title="其它优化"></a>其它优化</h4><h5 id="减少上锁时间"><a href="#减少上锁时间" class="headerlink" title="减少上锁时间"></a>减少上锁时间</h5><p>同步代码块中<strong>尽量短</strong></p>
<h5 id="减少锁的粒度"><a href="#减少锁的粒度" class="headerlink" title="减少锁的粒度"></a>减少锁的粒度</h5><p>将<strong>一个锁拆分为多个锁</strong>提高并发度，例如：</p>
<ul>
<li>ConcurrentHashMap</li>
<li>LongAdder 分为 base 和 cells 两部分。没有并发争用的时候或者是 cells 数组正在初始化的时候，会使用 CAS 来累加值到 base，有并发争用，会初始化 cells 数组，数组有多少个 cell，就允许有多少线程并行修改，最后将数组中每个 cell 累加，再加上 base 就是最终的值</li>
<li>LinkedBlockingQueue 入队和出队使用不同的锁，相对于LinkedBlockingArray只有一个锁效率要高</li>
</ul>
<h5 id="锁粗化"><a href="#锁粗化" class="headerlink" title="锁粗化"></a>锁粗化</h5><p><strong>多次循环进入同步块不如同步块内多次循环</strong></p>
<p>另外 JVM 可能会做如下优化，把<strong>多次 append 的加锁操作粗化为一次（因为都是对同一个对象加锁，没必要重入多次）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">StringBuffer</span>().append(<span class="string">&quot;a&quot;</span>).append(<span class="string">&quot;b&quot;</span>).append(<span class="string">&quot;c&quot;</span>);</span><br></pre></td></tr></table></figure>



<h5 id="锁消除"><a href="#锁消除" class="headerlink" title="锁消除"></a>锁消除</h5><p>JVM 会进行代码的逃逸分析，例如某个加锁对象是方法内局部变量，不会被其它线程所访问到，这时候就会被即时编译器忽略掉所有同步操作</p>
<h5 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h5><p>CopyOnWriteArrayList</p>
<p>ConyOnWriteSet</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://wiki.openjdk.java.net/display/HotSpot/Synchronization">HotSpot-Synchronization</a></p>
<p><a target="_blank" rel="noopener" href="http://luojinping.com/2015/07/09/java%E9%94%81%E4%BC%98%E5%8C%96/">锁优化</a></p>
<p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/java-se-16-synchronized">javase-synchronized</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9932047a89be">锁优化-JVM锁降级</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sheeva/p/6366782.html">JVM多线程</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/46312817/does-java-ever-rebias-an-individual-lock">java-lock</a></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Linyuxuan
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://negativefunction.github.io/2023/01/31/JVM2023/" title="JVM2023">https://negativefunction.github.io/2023/01/31/JVM2023/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/01/28/ProjectDeployDocument/" rel="prev" title="项目部署文档">
      <i class="fa fa-chevron-left"></i> 项目部署文档
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#JVM"><span class="nav-number">1.</span> <span class="nav-text">JVM</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-JVM%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF"><span class="nav-number">1.1.</span> <span class="nav-text">1. JVM学习路线</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E7%A7%91%E7%9F%A5%E8%AF%86"><span class="nav-number">1.1.1.</span> <span class="nav-text">预科知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF"><span class="nav-number">1.1.2.</span> <span class="nav-text">学习路线</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81-JVM"><span class="nav-number">1.1.3.</span> <span class="nav-text">常见 JVM</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-JVM%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.</span> <span class="nav-text">2. JVM内存结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="nav-number">1.2.1.</span> <span class="nav-text">程序计数器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88"><span class="nav-number">1.2.2.</span> <span class="nav-text">虚拟机栈</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88%E6%A6%82%E5%BF%B5"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">虚拟机栈概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%88%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">栈内存溢出</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A0%88%E5%B8%A7%E8%BF%87%E5%A4%9A%E5%AF%BC%E8%87%B4%E6%A0%88%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-number">1.2.2.2.1.</span> <span class="nav-text">栈帧过多导致栈内存溢出</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A0%88%E5%B8%A7%E8%BF%87%E5%A4%A7%E5%AF%BC%E8%87%B4%E6%A0%88%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-number">1.2.2.2.2.</span> <span class="nav-text">栈帧过大导致栈内存溢出</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E5%AF%BC%E8%87%B4-StackOverFlowError"><span class="nav-number">1.2.2.2.3.</span> <span class="nav-text">第三方库导致 StackOverFlowError</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E8%BF%90%E8%A1%8C%E8%AF%8A%E6%96%AD"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">线程运行诊断</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88"><span class="nav-number">1.2.3.</span> <span class="nav-text">本地方法栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86"><span class="nav-number">1.2.4.</span> <span class="nav-text">堆</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A0%86%E6%A6%82%E5%BF%B5"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">堆概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A0%86%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">堆内存溢出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A0%86%E5%86%85%E5%AD%98%E8%AF%8A%E6%96%AD"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">堆内存诊断</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E5%8C%BA"><span class="nav-number">1.2.5.</span> <span class="nav-text">方法区</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E5%8C%BA%E6%A6%82%E5%BF%B5"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">方法区概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E5%8C%BA%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-number">1.2.5.2.</span> <span class="nav-text">方法区内存溢出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%B8%B8%E9%87%8F%E6%B1%A0"><span class="nav-number">1.2.5.3.</span> <span class="nav-text">运行时常量池</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#StringTable"><span class="nav-number">1.2.5.4.</span> <span class="nav-text">StringTable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#StringTable-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6"><span class="nav-number">1.2.5.5.</span> <span class="nav-text">StringTable 垃圾回收机制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98"><span class="nav-number">1.2.6.</span> <span class="nav-text">直接内存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98%E6%A6%82%E5%BF%B5"><span class="nav-number">1.2.6.1.</span> <span class="nav-text">直接内存概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98%E5%8E%9F%E7%90%86"><span class="nav-number">1.2.6.2.</span> <span class="nav-text">直接内存原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="nav-number">1.2.6.3.</span> <span class="nav-text">内存溢出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E5%92%8C%E5%9B%9E%E6%94%B6%E5%8E%9F%E7%90%86"><span class="nav-number">1.2.6.4.</span> <span class="nav-text">分配和回收原理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6-GC"><span class="nav-number">1.3.</span> <span class="nav-text">3. 垃圾回收 GC</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9D%A1%E4%BB%B6"><span class="nav-number">1.3.0.1.</span> <span class="nav-text">对象垃圾回收条件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E6%B3%95"><span class="nav-number">1.3.0.1.1.</span> <span class="nav-text">引用计数法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%AF%E8%BE%BE%E6%80%A7%E5%88%86%E6%9E%90%E7%AE%97%E6%B3%95"><span class="nav-number">1.3.0.1.2.</span> <span class="nav-text">可达性分析算法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%94%E7%A7%8D%E5%BC%95%E7%94%A8"><span class="nav-number">1.3.0.1.3.</span> <span class="nav-text">五种引用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95"><span class="nav-number">1.3.1.</span> <span class="nav-text">垃圾回收算法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4%E6%B3%95"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">标记清除法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%87%E8%AE%B0%E6%95%B4%E7%90%86%E6%B3%95"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">标记整理法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6%E5%9B%9E%E6%94%B6%E6%B3%95"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">复制回收法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E4%BB%A3%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6"><span class="nav-number">1.3.2.</span> <span class="nav-text">分代垃圾回收</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E4%BB%A3%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%A6%82%E5%BF%B5"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">分代垃圾回收概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3-JVM-%E5%8F%82%E6%95%B0"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">相关 JVM 参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="nav-number">1.3.3.</span> <span class="nav-text">垃圾回收器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%B2%E8%A1%8C"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">串行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%9E%E5%90%90%E9%87%8F%E4%BC%98%E5%85%88"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">吞吐量优先</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%E4%BC%98%E5%85%88"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">响应时间优先</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#G1"><span class="nav-number">1.3.3.4.</span> <span class="nav-text">G1</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#G1%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%8E%9F%E7%90%86"><span class="nav-number">1.3.3.4.1.</span> <span class="nav-text">G1概念及原理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#G1-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E9%98%B6%E6%AE%B5"><span class="nav-number">1.3.3.4.2.</span> <span class="nav-text">G1 垃圾回收阶段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Full-GC-%E8%BE%A8%E6%9E%90"><span class="nav-number">1.3.3.4.3.</span> <span class="nav-text">Full GC 辨析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Young-Collection-%E8%B7%A8%E4%BB%A3%E5%BC%95%E7%94%A8%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.3.4.4.</span> <span class="nav-text">Young Collection 跨代引用问题</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Remark-%E9%87%8D%E6%A0%87%E8%AE%B0"><span class="nav-number">1.3.3.4.5.</span> <span class="nav-text">Remark 重标记</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C-jdk-G1-%E4%BC%98%E5%8C%96"><span class="nav-number">1.3.3.4.6.</span> <span class="nav-text">不同 jdk G1 优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E8%B0%83%E4%BC%98"><span class="nav-number">1.3.4.</span> <span class="nav-text">垃圾回收调优</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E4%BC%98%E9%A2%86%E5%9F%9F"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">调优领域</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E4%BC%98%E7%9B%AE%E6%A0%87"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">调优目标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%80%E5%BF%AB-GC"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">最快 GC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E7%94%9F%E4%BB%A3%E8%B0%83%E4%BC%98"><span class="nav-number">1.3.4.4.</span> <span class="nav-text">新生代调优</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%80%81%E5%B9%B4%E4%BB%A3%E8%B0%83%E4%BC%98"><span class="nav-number">1.3.4.5.</span> <span class="nav-text">老年代调优</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B"><span class="nav-number">1.3.4.6.</span> <span class="nav-text">案例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%AD%97%E8%8A%82%E7%A0%81"><span class="nav-number">1.4.</span> <span class="nav-text">4. 字节码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-number">1.4.1.</span> <span class="nav-text">类文件结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AD%94%E6%95%B0"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">魔数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%88%E6%9C%AC"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E9%87%8F%E6%B1%A0"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">常量池</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E6%A0%87%E8%AF%86%E4%B8%8E%E7%BB%A7%E6%89%BF%E4%BF%A1%E6%81%AF"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">访问标识与继承信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Field-%E4%BF%A1%E6%81%AF"><span class="nav-number">1.4.1.5.</span> <span class="nav-text">Field 信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Method-%E4%BF%A1%E6%81%AF"><span class="nav-number">1.4.1.6.</span> <span class="nav-text">Method 信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%99%84%E5%8A%A0%E5%B1%9E%E6%80%A7"><span class="nav-number">1.4.1.7.</span> <span class="nav-text">附加属性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4"><span class="nav-number">1.4.2.</span> <span class="nav-text">字节码指令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%90%86%E8%AE%BA"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">字节码指令理论</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#javap-%E5%B7%A5%E5%85%B7"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">javap 工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%BE%E8%A7%A3%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">图解方法执行流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%83%E4%B9%A0-%E5%88%86%E6%9E%90-i"><span class="nav-number">1.4.2.4.</span> <span class="nav-text">练习 - 分析 i++</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E6%8C%87%E4%BB%A4"><span class="nav-number">1.4.2.5.</span> <span class="nav-text">条件判断指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E6%8E%A7%E5%88%B6%E6%8C%87%E4%BB%A4"><span class="nav-number">1.4.2.6.</span> <span class="nav-text">循环控制指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%83%E4%B9%A0-%E5%88%A4%E6%96%AD%E7%BB%93%E6%9E%9C"><span class="nav-number">1.4.2.7.</span> <span class="nav-text">练习 - 判断结果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="nav-number">1.4.2.8.</span> <span class="nav-text">构造方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-cinit-gt-V"><span class="nav-number">1.4.2.8.1.</span> <span class="nav-text">&lt;cinit&gt;()V</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-init-gt-V"><span class="nav-number">1.4.2.8.2.</span> <span class="nav-text">&lt;init&gt;()V</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8"><span class="nav-number">1.4.2.9.</span> <span class="nav-text">方法调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E6%80%81%E5%8E%9F%E7%90%86"><span class="nav-number">1.4.2.10.</span> <span class="nav-text">多态原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">1.4.2.11.</span> <span class="nav-text">异常处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#try-catch"><span class="nav-number">1.4.2.11.1.</span> <span class="nav-text">try-catch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA-single-catch-%E5%9D%97"><span class="nav-number">1.4.2.11.2.</span> <span class="nav-text">多个 single-catch 块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#multi-catch"><span class="nav-number">1.4.2.11.3.</span> <span class="nav-text">multi-catch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#finally"><span class="nav-number">1.4.2.11.4.</span> <span class="nav-text">finally</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%83%E4%B9%A0-finally-%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="nav-number">1.4.2.12.</span> <span class="nav-text">练习 - finally 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#finally-%E4%B8%AD%E5%87%BA%E7%8E%B0-return"><span class="nav-number">1.4.2.12.1.</span> <span class="nav-text">finally 中出现 return</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#finally-%E5%AF%B9%E8%BF%94%E5%9B%9E%E5%80%BC%E5%BD%B1%E5%93%8D"><span class="nav-number">1.4.2.12.2.</span> <span class="nav-text">finally 对返回值影响</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#synchronized"><span class="nav-number">1.4.2.13.</span> <span class="nav-text">synchronized</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E6%9C%9F%E5%A4%84%E7%90%86"><span class="nav-number">1.4.3.</span> <span class="nav-text">编译期处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E6%9E%84%E9%80%A0%E5%99%A8"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">默认构造器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E6%8B%86%E8%A3%85%E7%AE%B1"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">自动拆装箱</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%9B%E5%9E%8B%E9%9B%86%E5%90%88%E5%8F%96%E5%80%BC"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">泛型集合取值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">可变参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#foreach-%E5%BE%AA%E7%8E%AF"><span class="nav-number">1.4.3.5.</span> <span class="nav-text">foreach 循环</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#switch-%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">1.4.3.6.</span> <span class="nav-text">switch 字符串</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#switch-%E6%9E%9A%E4%B8%BE"><span class="nav-number">1.4.3.7.</span> <span class="nav-text">switch 枚举</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E7%B1%BB"><span class="nav-number">1.4.3.8.</span> <span class="nav-text">枚举类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#try-with-resources"><span class="nav-number">1.4.3.9.</span> <span class="nav-text">try-with-resources</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E9%87%8D%E5%86%99%E6%97%B6%E7%9A%84%E6%A1%A5%E6%8E%A5%E6%96%B9%E6%B3%95"><span class="nav-number">1.4.3.10.</span> <span class="nav-text">方法重写时的桥接方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8C%BF%E5%90%8D%E5%86%85%E9%83%A8%E7%B1%BB"><span class="nav-number">1.4.3.11.</span> <span class="nav-text">匿名内部类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E7%B1%BB%E5%8A%A0%E8%BD%BD"><span class="nav-number">1.5.</span> <span class="nav-text">5. 类加载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E9%98%B6%E6%AE%B5"><span class="nav-number">1.5.1.</span> <span class="nav-text">类加载阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">加载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%93%BE%E6%8E%A5"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">链接</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81"><span class="nav-number">1.5.1.2.1.</span> <span class="nav-text">验证</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%87%86%E5%A4%87"><span class="nav-number">1.5.1.2.2.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90"><span class="nav-number">1.5.1.2.3.</span> <span class="nav-text">解析</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-cinit-gt-V-%E6%96%B9%E6%B3%95"><span class="nav-number">1.5.1.3.1.</span> <span class="nav-text">&lt;cinit&gt;()V 方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%91%E7%94%9F%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="nav-number">1.5.1.3.2.</span> <span class="nav-text">发生的时机</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%83%E4%B9%A0-%E5%AD%97%E8%8A%82%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">1.5.1.4.</span> <span class="nav-text">练习 - 字节码分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">1.5.2.</span> <span class="nav-text">类加载器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">启动类加载器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">扩展类加载器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%BC%8F"><span class="nav-number">1.5.2.3.</span> <span class="nav-text">双亲委派模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">1.5.2.4.</span> <span class="nav-text">线程上下文类加载器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">1.5.2.5.</span> <span class="nav-text">自定义类加载器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%9C%9F%E4%BC%98%E5%8C%96"><span class="nav-number">1.5.3.</span> <span class="nav-text">运行期优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">即时编译</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E5%B1%82%E7%BC%96%E8%AF%91"><span class="nav-number">1.5.3.1.1.</span> <span class="nav-text">分层编译</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E5%86%85%E8%81%94"><span class="nav-number">1.5.3.1.2.</span> <span class="nav-text">方法内联</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E4%BC%98%E5%8C%96"><span class="nav-number">1.5.3.1.3.</span> <span class="nav-text">字段优化</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%B0%84%E4%BC%98%E5%8C%96"><span class="nav-number">1.5.3.2.</span> <span class="nav-text">反射优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-JMM"><span class="nav-number">1.6.</span> <span class="nav-text">6. JMM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="nav-number">1.6.1.</span> <span class="nav-text">原子性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="nav-number">1.6.2.</span> <span class="nav-text">可见性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%80%E4%B8%8D%E5%87%BA%E5%BE%AA%E7%8E%AF%E9%97%AE%E9%A2%98"><span class="nav-number">1.6.2.1.</span> <span class="nav-text">退不出循环问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.6.2.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E8%A7%81%E6%80%A7-1"><span class="nav-number">1.6.2.3.</span> <span class="nav-text">可见性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E5%BA%8F%E6%80%A7"><span class="nav-number">1.6.3.</span> <span class="nav-text">有序性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%A1%E5%BC%82%E7%BB%93%E6%9E%9C"><span class="nav-number">1.6.3.1.</span> <span class="nav-text">诡异结果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="nav-number">1.6.3.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%89%E5%BA%8F%E6%80%A7%E7%90%86%E8%A7%A3"><span class="nav-number">1.6.3.3.</span> <span class="nav-text">有序性理解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#happens-before"><span class="nav-number">1.6.3.4.</span> <span class="nav-text">happens-before</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CAS-%E4%B8%8E-%E5%8E%9F%E5%AD%90%E7%B1%BB"><span class="nav-number">1.6.4.</span> <span class="nav-text">CAS 与 原子类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CAS"><span class="nav-number">1.6.4.1.</span> <span class="nav-text">CAS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B9%90%E8%A7%82%E9%94%81%E4%B8%8E%E6%82%B2%E8%A7%82%E9%94%81"><span class="nav-number">1.6.4.2.</span> <span class="nav-text">乐观锁与悲观锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%B1%BB"><span class="nav-number">1.6.4.3.</span> <span class="nav-text">原子操作类</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#synchronized-%E4%BC%98%E5%8C%96"><span class="nav-number">1.6.5.</span> <span class="nav-text">synchronized 优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81"><span class="nav-number">1.6.5.1.</span> <span class="nav-text">轻量级锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%94%81%E8%86%A8%E8%83%80"><span class="nav-number">1.6.5.2.</span> <span class="nav-text">锁膨胀</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E9%87%8F%E9%94%81"><span class="nav-number">1.6.5.3.</span> <span class="nav-text">重量锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%81%8F%E5%90%91%E9%94%81"><span class="nav-number">1.6.5.4.</span> <span class="nav-text">偏向锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E5%AE%83%E4%BC%98%E5%8C%96"><span class="nav-number">1.6.5.5.</span> <span class="nav-text">其它优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%87%8F%E5%B0%91%E4%B8%8A%E9%94%81%E6%97%B6%E9%97%B4"><span class="nav-number">1.6.5.5.1.</span> <span class="nav-text">减少上锁时间</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%87%8F%E5%B0%91%E9%94%81%E7%9A%84%E7%B2%92%E5%BA%A6"><span class="nav-number">1.6.5.5.2.</span> <span class="nav-text">减少锁的粒度</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%94%81%E7%B2%97%E5%8C%96"><span class="nav-number">1.6.5.5.3.</span> <span class="nav-text">锁粗化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%94%81%E6%B6%88%E9%99%A4"><span class="nav-number">1.6.5.5.4.</span> <span class="nav-text">锁消除</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-number">1.6.5.5.5.</span> <span class="nav-text">读写分离</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Linyuxuan"
      src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/252/05.jpg">
  <p class="site-author-name" itemprop="name">Linyuxuan</p>
  <div class="site-description" itemprop="description">Hope Sometimes Love Brain</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa-gift"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Linyuxuan</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  

    </div>
</body>
</html>
